<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</title>
  <link rel="icon" type="image/png" href="favicon1.ico">
  <link rel="apple-touch-icon" href="favicon1.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --text:#f3f6ff;

      /* –∫—Ä–∞—Å–Ω–æ-—Ä–æ–∑–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
      --accent1:#ff2d7a;  /* hot pink */
      --accent2:#ff3656;  /* red-pink */
      --accent3:#ff6ad5;  /* magenta */
      --accentRed:#ff2a3a;

      --shadowSoft: 0 18px 70px rgba(0,0,0,.55);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body{
      min-height:100vh;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      overflow-x:hidden;

      background: url("fon2.png") center / cover no-repeat fixed;
      position:relative;

      filter: brightness(1.08) saturate(1.18) contrast(1.06);
    }

    /* –¥—ã–º–∫–∞/–≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-4;

      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(255,54,86,.22), transparent 62%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,45,122,.22), transparent 58%),
        radial-gradient(900px 520px at 90% 18%, rgba(255,106,213,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.30) 0%, rgba(0,0,0,.22) 45%, rgba(0,0,0,.34) 100%);
      mix-blend-mode: normal;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-3;

      background:
        radial-gradient(700px 420px at 18% 18%, rgba(255,45,122,.16), transparent 60%),
        radial-gradient(760px 520px at 82% 22%, rgba(255,54,86,.12), transparent 62%),
        linear-gradient(115deg,
          rgba(255,45,122,.10) 0%,
          rgba(255,54,86,.08) 40%,
          rgba(255,106,213,.08) 100%
        );

      mix-blend-mode: screen;
      opacity: .95;
      filter: blur(0.2px);
    }

    /* ‚Äú–∂–∏–≤—ã–µ‚Äù —Å–ª–æ–∏ */
    .bg-live{
      position: fixed;
      inset: 0;
      z-index: -3;
      pointer-events:none;
      overflow:hidden;
    }

    .bg-live .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      opacity:.10;
      mix-blend-mode: overlay;
      animation: scanMove 2.8s linear infinite;
    }
    @keyframes scanMove{
      0%   { transform: translateY(0); }
      100% { transform: translateY(18px); }
    }

    .bg-live .particles{
      position:absolute; inset:0;
      opacity:.28;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 42% 76%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 66%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 52%, rgba(255,45,122,.14) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 62%, rgba(255,54,86,.12) 0 1px, transparent 2px);
      background-size: 520px 520px, 680px 680px, 760px 760px, 900px 900px, 700px 700px, 820px 820px;
      animation: particlesDrift 22s linear infinite;
    }
    @keyframes particlesDrift{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-3%, 2%, 0); }
    }

    .bg-live .vignette{
      position:absolute; inset:-2px;
      background: radial-gradient(circle at center, transparent 0 52%, rgba(0,0,0,.45) 78%, rgba(0,0,0,.78) 100%);
      opacity:.95;
    }

    #app{
      width:100%;
      max-width:1200px;
      position:relative;
      z-index:1;
    }

    /* ================= HEADER ================= */
    .page-header{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      margin-bottom: 14px;
      padding-top: 6px;
    }
    .page-title-block{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
    }
    .page-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.01em;
      text-shadow:
        0 0 20px rgba(255,45,122,.20),
        0 0 44px rgba(255,54,86,.12);
    }
    .page-subtitle{
      font-size:20px;
      color: rgba(243,246,255,.75);
      text-shadow: 0 0 18px rgba(255,45,122,.10);
    }
    .user-tag{ font-size:12px; color: rgba(243,246,255,.60); margin-top:2px; }

    .page-header-actions{
      position:absolute;
      right:0;
      top:0;
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* ================= BUTTONS ================= */
    .btn{
      border: 1px solid rgba(255,45,122,.55);
      background: rgba(0,0,0,.10);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 26px rgba(255,45,122,.18);
      color: rgba(243,246,255,.90);
      cursor:pointer;
      border-radius: 12px;
    }
    .btn:hover{
      border-color: rgba(255,54,86,.70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 34px rgba(255,45,122,.24),
        0 0 54px rgba(255,106,213,.16);
    }
    .btn-sm{ padding: 11px 18px; font-size: 14px; }

    .btn-outline{
      padding: 10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.10);
      color: rgba(243,246,255,.88);
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .btn-outline:hover{
      transform: translateY(-1px);
      border-color: rgba(255,45,122,.40);
      box-shadow: 0 0 24px rgba(255,45,122,.16);
    }

    /* ================= PANEL + TABS ================= */
    .leader-panel{
      position:relative;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      overflow: visible;
    }

    .leader-panel-header{
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
      position:relative;
      z-index:1;
    }

    .leader-tabs{
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: center;

      width: min(860px, 100%);
      margin: 0 auto;

      border-radius: 999px;
      padding: 6px;

      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);

      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 16px 46px rgba(0,0,0,.28),
        0 0 26px rgba(255,45,122,.10);

      overflow: hidden;
    }

    .leader-tab{
      flex: 1 1 0;
      min-width: 0;
      white-space: nowrap;

      position:relative;
      border:0;
      background: transparent;
      border-radius: 999px;

      padding: 14px 18px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .10em;
      text-transform: uppercase;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;

      color: rgba(243,246,255,.78);
      cursor:pointer;
      transition: transform .14s ease, color .14s ease, filter .14s ease;
      overflow: hidden;     /* –¥–ª—è SVG */
      isolation: isolate;   /* —á—Ç–æ–±—ã —Å–ª–æ–∏ –Ω–µ –º–µ—à–∞–ª–∏ */
    }

    .leader-tab:hover{
      transform: translateY(-1px);
      color: rgba(255,255,255,.94);
      filter: drop-shadow(0 0 12px rgba(255,45,122,.22));
    }

    /* —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ª–∏–≤–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–∞–±—ã */
    .leader-tab.active::before,
    .leader-tab.active::after{
      content: none !important;
    }

    .leader-date{
      font-size: 18px;
      letter-spacing:.10em;
      color: rgba(243,246,255,.72);
      margin-top: 4px;
      text-shadow: 0 0 18px rgba(255,45,122,.10);
    }

    .leaders-wrapper{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:18px;
      position:relative;
      z-index:1;
    }

    /* ================= LEADER CARDS ================= */
    .leader-card{
      position:relative;
      display:flex;
      align-items:center;
      gap: 22px;
      padding: 18px 24px;

      border-radius: 14px;
      background: transparent;
      border: 0;

      box-shadow: 0 14px 54px rgba(0,0,0,.30);
      overflow:hidden;

      clip-path: polygon(
        0% 0%,
        100% 0%,
        100% calc(100% - 26px),
        calc(100% - 26px) 100%,
        0% 100%,
        0% 0%
      );

      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      isolation: isolate; /* –≤–∞–∂–Ω–æ –¥–ª—è —Å–ª–æ—ë–≤ */
    }

    .leader-card:hover{
      transform: translateY(-7px);
      box-shadow:
        0 24px 80px rgba(0,0,0,.45),
        0 0 46px rgba(255,45,122,.20);
      filter: saturate(1.06) brightness(1.02);
    }

    /* ===== –°–õ–û–ò: emoji (0) -> svg (1) -> sheen (2) -> –∫–æ–Ω—Ç–µ–Ω—Ç (3) ===== */
    .emoji-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 0;
      opacity: 0;
      transition: opacity .12s ease;
    }
    .leader-card:hover .emoji-layer{ opacity: 1; }

    .leader-card .border-svg{
      position:absolute;
      inset:-2px;
      width: calc(100% + 4px);
      height: calc(100% + 4px);
      pointer-events:none;
      z-index: 1;
    }

    .leader-card .sheen{
      position:absolute;
      inset:-40% -60%;
      pointer-events:none;
      background: linear-gradient(115deg,
        transparent 0%,
        rgba(255,255,255,.00) 35%,
        rgba(255,255,255,.12) 45%,
        rgba(255,45,122,.10) 50%,
        rgba(255,54,86,.08) 55%,
        rgba(255,255,255,.00) 65%,
        transparent 100%
      );
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: opacity .16s ease;
      mix-blend-mode: screen;
      z-index: 2;
    }
    .leader-card:hover .sheen{
      opacity: 1;
      animation: sheenSweep .75s ease-out 1;
    }
    @keyframes sheenSweep{
      0%   { transform: translateX(-60%) rotate(10deg); }
      100% { transform: translateX( 60%) rotate(10deg); }
    }

    .leader-card > :not(.emoji-layer):not(.border-svg):not(.sheen){
      position: relative;
      z-index: 3;
    }

    /* ====== SVG —Ä–∞–º–∫–∞: –¥–≤–æ–π–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ + –Ω–µ–æ–Ω–æ–≤—ã–µ —Ö–≤–æ—Å—Ç—ã ====== */
    .border-outer{
      fill:none;
      stroke: rgba(255,45,122,.85);
      stroke-width: 5.2;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
    }
    .border-inner{
      fill:none;
      stroke: rgba(255,160,190,.55);
      stroke-width: 2.0;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 8px rgba(255,45,122,.22));
    }
    .border-glow{
      fill:none;
      stroke: rgba(255,54,86,.18);
      stroke-width: 10;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
      filter: blur(0.8px);
    }

    .border-neon{
      fill:none;
      stroke-width: 5.8;
      vector-effect: non-scaling-stroke;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .96;

      filter:
        drop-shadow(0 0 10px rgba(255,45,122,.50))
        drop-shadow(0 0 18px rgba(255,106,213,.22));
    }

    .border-neon.neon-a{
      stroke: rgba(255,106,213,.95);
      stroke-dasharray: 130 650;
      animation: dashA 5.0s linear infinite;
    }
    .border-neon.neon-b{
      stroke: rgba(255,45,122,.95);
      stroke-width: 4.8;
      stroke-dasharray: 85 560;
      opacity: .80;
      animation: dashB 4.4s linear infinite;
    }
    @keyframes dashA{ to { stroke-dashoffset: -1200; } }
    @keyframes dashB{ to { stroke-dashoffset:  1200; } }

    /* —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏/–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—Ç—É */
    .leader-card.rank-1 .border-svg{
      filter:
        drop-shadow(0 0 12px rgba(255,45,122,.46))
        drop-shadow(0 0 28px rgba(255,106,213,.22));
    }
    .leader-card.rank-1 .border-outer{ stroke: rgba(255,60,120,.92); }

    .leader-card.rank-2 .border-svg{
      filter:
        drop-shadow(0 0 10px rgba(255,45,122,.38))
        drop-shadow(0 0 22px rgba(255,54,86,.18));
    }
    .leader-card.rank-2 .border-outer{ stroke: rgba(255,45,122,.82); }
    .leader-card.rank-2 .border-neon.neon-a{ animation-duration: 5.6s; stroke-dasharray: 110 640; }
    .leader-card.rank-2 .border-neon.neon-b{ animation-duration: 5.0s; stroke-dasharray: 70 540; }

    .leader-card.rank-3 .border-svg{
      filter:
        drop-shadow(0 0 9px rgba(255,45,122,.32))
        drop-shadow(0 0 18px rgba(255,54,86,.14));
    }
    .leader-card.rank-3 .border-outer{ stroke: rgba(255,54,86,.74); }
    .leader-card.rank-3 .border-neon.neon-a{ animation-duration: 6.0s; stroke-dasharray: 95 620; }
    .leader-card.rank-3 .border-neon.neon-b{ animation-duration: 5.2s; stroke-dasharray: 60 520; }

    /* ===== EMOJI STREAM (–±—ã—Å—Ç—Ä–µ–µ –∏ –ø–æ –≤—Å–µ–º—É –±–ª–æ–∫—É) ===== */
    .emoji{
      position: absolute;
      left: 0;
      top: 110%;
      font-size: 22px;
      opacity: .22;
      filter: drop-shadow(0 0 10px rgba(255,45,122,.35));
      will-change: transform, opacity;
      animation-name: emojiUp;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
      user-select:none;
    }
    @keyframes emojiUp{
      0%   { transform: translateY(0) scale(.95); opacity: 0; }
      10%  { opacity: .55; }
      100% { transform: translateY(-160%) scale(1.10); opacity: 0; }
    }

    /* –ò–∫–æ–Ω–∫–∞ –º–µ—Å—Ç–∞ */
    .leader-icon{
      width: 58px;
      height: 58px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;

      background: rgba(0,0,0,.03);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 22px rgba(255,45,122,.10);
      flex-shrink:0;
    }

    /* –ê–≤–∞—Ç–∞—Ä */
    .leader-avatar{
      width: 72px;
      height: 72px;
      border-radius: 14px;
      border: 2px solid rgba(255,45,122,.45);
      background: rgba(0,0,0,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      font-size: 26px;
      flex-shrink:0;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(255,45,122,.10);
    }
    .leader-avatar img{ width:100%; height:100%; object-fit: cover; }

    .leader-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .leader-name-row{
      display:flex;
      flex-wrap:wrap;
      align-items:baseline;
      gap: 12px;
    }

    .leader-nick{
      font-size: 32px;
      font-weight: 900;
      letter-spacing: .01em;
      text-shadow:
        0 0 16px rgba(255,45,122,.12),
        0 0 24px rgba(255,54,86,.10);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    .leader-account{
      font-size: 16px;
      font-weight: 800;
      color: rgba(255,106,213,.92);
      text-shadow: 0 0 14px rgba(255,45,122,.12);
    }

    .dept-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.04);
    }
    .dept-badge.lspd{ color:#28e07a; box-shadow: 0 0 18px rgba(40,224,122,.10); }
    .dept-badge.sfpd{ color:#2fc7ff; box-shadow: 0 0 18px rgba(47,199,255,.10); }
    .dept-badge.lvpd{ color:#ff5a7e; box-shadow: 0 0 18px rgba(255,90,126,.10); }

    .leader-score-block{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      min-width: 220px;
      flex-shrink:0;
    }

    .leader-score{
      display:flex;
      align-items:baseline;
      gap: 10px;
      font-weight: 900;
    }

    .leader-score .value{
      font-size: 56px;
      letter-spacing: .02em;

      background: linear-gradient(90deg, rgba(255,45,122,1), rgba(255,54,86,.98));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;

      filter:
        drop-shadow(0 0 14px rgba(255,45,122,.45))
        drop-shadow(0 0 26px rgba(255,54,86,.25));
    }

    .leader-score .unit{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;

      color: rgba(255,106,213,.95);
      text-shadow:
        0 0 10px rgba(255,45,122,.30),
        0 0 18px rgba(255,106,213,.22);
    }

    .leader-place-label{
      font-size: 16px;
      color: rgba(243,246,255,.72);
      letter-spacing: .06em;
      text-shadow: 0 0 16px rgba(255,45,122,.08);
    }

    .leader-empty{ font-size: 16px; color: rgba(243,246,255,.62); }

    /* ================= MODALS ================= */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width:100%;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      backdrop-filter: blur(14px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 28px 80px rgba(0,0,0,.72);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(255,45,122,.55), rgba(255,54,86,.45), rgba(255,106,213,.55));
      opacity:.14;
      filter: blur(12px);
      pointer-events:none;
    }
    .modal h3{ font-size: 20px; font-weight: 900; margin-bottom: 6px; }
    .modal p{ font-size: 14px; color: rgba(243,246,255,.70); margin-bottom: 10px; }

    .modal-footer{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }

    .field{ margin-bottom: 10px; }
    .field label{ display:block; font-size: 13px; margin-bottom: 4px; color: rgba(243,246,255,.78); }
    .field input, .field select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 14px;
      outline:none;
      backdrop-filter: blur(10px);
    }
    .field input:focus, .field select:focus{
      border-color: rgba(255,45,122,.40);
      box-shadow: 0 0 0 2px rgba(255,45,122,.12);
    }

    .error-text{ font-size: 13px; color: #ff8585; margin-top: 6px; }

    .edit-avatar-preview{
      width: 92px;
      height: 92px;
      border-radius: 22px;
      border: 2px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      cursor:pointer;
      color: rgba(255,255,255,.85);
      position:relative;
      backdrop-filter: blur(10px);
    }
    .edit-avatar-preview img{ width:100%; height:100%; object-fit:cover; }
    .edit-avatar-preview::after{
      content:"‚úé";
      position:absolute;
      right:-2px;
      bottom:-2px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      backdrop-filter: blur(10px);
    }

    .drag-over{ box-shadow: 0 0 0 3px rgba(255,45,122,.35); }

    .week-block{ margin-top: 14px; display:flex; flex-direction:column; gap: 14px; }

    .week-period-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.06);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(0,0,0,.26);
      color: rgba(243,246,255,.78);
      text-shadow: 0 0 14px rgba(255,45,122,.08);
    }
    .week-period-badge .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(255,45,122,.95);
      box-shadow: 0 0 14px rgba(255,45,122,.35);
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 1100px){
      .leader-nick{ font-size: 28px; }
      .leader-score .value{ font-size: 50px; }
      .page-title{ font-size: 48px; }
      .leader-score-block{ min-width: 200px; }
    }
    @media (max-width: 820px){
      .leader-tab{ font-size: 14px; }
      .page-title{ font-size: 40px; }
      .page-subtitle{ font-size: 16px; }
      .leader-score-block{ min-width: 180px; }
    }
    @media (max-width: 720px){
      body{ padding: 12px; }
      .page-header{ justify-content:flex-start; }
      .page-title-block{ text-align:left; align-items:flex-start; }
      .page-title{ font-size: 34px; }
      .page-subtitle{ font-size: 14px; }
      .page-header-actions{ position: static; margin-left:auto; }

      .leader-card{
        display:grid;
        grid-template-columns: 58px 72px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        padding: 14px 14px;
      }
      .leader-icon{ grid-column:1; grid-row:1; }
      .leader-avatar{ grid-column:2; grid-row:1; }
      .leader-main{ grid-column:3; grid-row:1; }
      .leader-score-block{
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        min-width: 0;
      }
      .leader-score .value{ font-size: 40px; }
      .leader-score .unit{ font-size: 16px; }
      .leader-place-label{ font-size: 14px; }
      .leader-tabs{ width:100%; }
      .leader-tab{ flex:1; padding: 12px 12px; letter-spacing: .08em; }
      .leader-nick{ font-size: 24px; }
      .leader-account{ font-size: 14px; }
    }

    /* ================= TAB BORDERS (SVG) ================= */
    .leader-tab .tab-border-svg{
      position:absolute;
      inset:-2px;
      width: calc(100% + 4px);
      height: calc(100% + 4px);
      pointer-events:none;
      z-index:0;
    }

    .leader-tab .tab-border-glow{
      fill:none;
      stroke: rgba(255, 45, 122, .55);
      stroke-width: 7;
      filter: drop-shadow(0 0 18px rgba(255, 45, 122, .55));
      opacity: .85;
    }

    .leader-tab .tab-border-outer{
      fill: rgba(0,0,0,.18);
      stroke: rgba(255, 60, 120, .95);
      stroke-width: 3.2;
      filter: drop-shadow(0 0 10px rgba(255, 60, 120, .35));
      opacity: .95;
    }

    .leader-tab .tab-border-inner{
      fill:none;
      stroke: rgba(255, 150, 200, .65);
      stroke-width: 1.6;
      opacity: .85;
    }

    .leader-tab .tab-border-neon{
      fill:none;
      stroke-linecap: round;
      stroke-width: 5.2;
      filter: drop-shadow(0 0 10px rgba(255, 80, 160, .55));
      opacity: .95;

      stroke-dasharray: 70 420;
      animation: tabNeonRun 3.8s linear infinite;
    }

    .leader-tab .tab-border-neon.neon-b{
      opacity: .55;
      stroke-width: 4.6;
      stroke-dasharray: 40 520;
      animation: tabNeonRunReverse 5.2s linear infinite;
    }

    @keyframes tabNeonRun{
      from { stroke-dashoffset: 0; }
      to   { stroke-dashoffset: -620; }
    }
    @keyframes tabNeonRunReverse{
      from { stroke-dashoffset: 0; }
      to   { stroke-dashoffset: 620; }
    }

    .leader-tab > *{
      position: relative;
      z-index: 1;
    }

    .leader-tab:not(.active) .tab-border-glow{ opacity: .45; }
    .leader-tab:not(.active) .tab-border-outer{ opacity: .45; fill: rgba(0,0,0,.08); }
    .leader-tab:not(.active) .tab-border-inner{ opacity: .35; }
    .leader-tab:not(.active) .tab-border-neon{ opacity: .35; }

    .leader-tab.active .tab-border-glow{ opacity: .95; }
    .leader-tab.active .tab-border-outer{ opacity: .98; }
    .leader-tab.active .tab-border-inner{ opacity: .90; }
    .leader-tab.active .tab-border-neon{ opacity: .95; }

    .leader-tab.active .tab-border-neon.neon-a { animation-duration: 3.2s; }
    .leader-tab.active .tab-border-neon.neon-b { animation-duration: 4.6s; }

    .leader-tab.active .tab-border-glow{
      animation: tabGlowPulse 1.8s ease-in-out infinite;
    }
    @keyframes tabGlowPulse{
      0%,100% { opacity: .92; filter: drop-shadow(0 0 16px rgba(255,45,122,.55)); }
      50%     { opacity: 1;    filter: drop-shadow(0 0 22px rgba(255,45,122,.70)); }
    }

    @media (prefers-reduced-motion: reduce){
      .border-neon.neon-a,
      .border-neon.neon-b,
      .tab-border-neon,
      .bg-live .scanlines,
      .bg-live .particles,
      .leader-card .sheen,
      .emoji{
        animation: none !important;
      }
      .emoji-layer{ opacity: 0 !important; }
    }

    /* ================= FALLING BACKGROUND FX ================= */
    #fall-canvas{
      position: fixed;
      inset: 0;
      z-index: -2;           /* –º–µ–∂–¥—É —Ñ–æ–Ω–æ–º –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
      pointer-events: none;
      width: 100%;
      height: 100%;
      opacity: 1;
    }
    
    /* —á—É—Ç—å ‚Äú–∫–∏–Ω–æ—à–Ω–µ–µ‚Äù */
    #fall-canvas{
      mix-blend-mode: screen;
      filter: saturate(1.05) contrast(1.02);
    }
    
    @media (prefers-reduced-motion: reduce){
      #fall-canvas{ display:none !important; }
    }

    
  </style>
</head>

<body>
  <div class="bg-live" aria-hidden="true">
    <div class="particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
  </div>
  <canvas id="fall-canvas" aria-hidden="true"></canvas>

  <div id="app">
    <div class="page-header">
      <div class="page-title-block">
        <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
        <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
        <div class="user-tag" id="user-tag"></div>
      </div>

      <div class="page-header-actions">
        <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–µ—Ä–æ–≤</button>
      </div>
    </div>

    <div class="leader-panel">
      <div class="leader-panel-header">
        <div class="leader-tabs">
          <button class="leader-tab active" id="tab-day" data-period="day">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
          </button>
          <button class="leader-tab" id="tab-week" data-period="week">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
          </button>
        </div>
        <div class="leader-date" id="leader-date"></div>
      </div>

      <div class="leaders-wrapper" id="leaders-wrapper">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ -->
  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ bulk-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="leaders-bulk-modal" class="modal-backdrop">
    <div class="modal" style="max-width: 720px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤ (LSPD / SFPD / LVPD)</h3>
      <p>–ú–µ–Ω—è—é—Ç—Å—è –Ω–∏–∫, –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤–∞—Ç–∞—Ä. –û—á–∫–∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.</p>

      <div id="bulk-error" class="error-text" style="display:none;"></div>
      <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>

      <div class="modal-footer">
        <button class="btn-outline" id="bulk-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn" id="bulk-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== –°–ï–°–°–ò–Ø ===== */
    let currentUser = null;
    function loadSession() {
      try { return JSON.parse(localStorage.getItem("pp_user")); }
      catch { return null; }
    }
    function canBulkEdit(user) {
      const role = String(user?.role || "").trim().toLowerCase();
      return role === "admin" || role === "creator";
    }

    /* ===== –û–®–ò–ë–ö–ò ===== */
    const errorModal = document.getElementById("error-modal");
    const errorModalText = document.getElementById("error-modal-text");
    const errorModalClose = document.getElementById("error-modal-close");
    function showErrorModal(message) {
      errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
      errorModal.classList.add("active");
    }
    if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

    /* ===== HELPERS WEEK ===== */
    function monthRuUpper(monthIndex) {
      const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
      return m[monthIndex] || "";
    }
    function parseDateOnly(iso) {
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function formatPeriodRu(startISO, endISO) {
      const s = parseDateOnly(startISO);
      const e = parseDateOnly(endISO);
      return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
    }

    /* ===== UI / DATA ===== */
    const leadersWrapper = document.getElementById("leaders-wrapper");
    const dateEl = document.getElementById("leader-date");
    let currentPeriod = "day";

    /* ===== EMOJI STREAM (–±—ã—Å—Ç—Ä–µ–µ, –≤–æ –≤–µ—Å—å –±–ª–æ–∫) ===== */
    const EMOJI_POOL = {
      1: ["üèÜ","üèÜ","üèÜ","‚ú®","üî•"],
      2: ["ü•à","ü•à","üèÖ","‚ú®"],
      3: ["ü•â","ü•â","üéñÔ∏è","‚ú®"],
    };

    function startEmojiStream(card, place){
      const layer = card.querySelector(".emoji-layer");
      if (!layer) return;
      if (card._emojiTimer) return;

      const pool = EMOJI_POOL[place] || ["‚ú®"];

      const perTick = place === 1 ? 8 : place === 2 ? 6 : 5;  // –±–æ–ª—å—à–µ
      const tickMs  = 90;  // —á–∞—â–µ (–±—ã—Å—Ç—Ä–µ–µ –ø–æ—Ç–æ–∫)

      card._emojiTimer = setInterval(() => {
        for (let i = 0; i < perTick; i++){
          const el = document.createElement("div");
          el.className = "emoji";
          el.textContent = pool[(Math.random() * pool.length) | 0];

          // –≤—Å—è —à–∏—Ä–∏–Ω–∞ –∏ –ø–æ –≤—Å–µ–π –Ω–∏–∂–Ω–µ–π –∑–æ–Ω–µ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–∞ ‚Äú–ø–æ–ª–æ—Å–∞‚Äù)
          el.style.left = (Math.random() * 100).toFixed(2) + "%";
          el.style.top  = (105 + Math.random() * 35).toFixed(0) + "%";

          // –±—ã—Å—Ç—Ä–µ–µ: 0.9‚Äì1.6 —Å–µ–∫
          const dur = 0.9 + Math.random() * 0.7;
          el.style.animationDuration = dur.toFixed(2) + "s";

          const fs = 14 + Math.random() * 26;
          el.style.fontSize = fs.toFixed(0) + "px";

          el.style.opacity = (0.18 + Math.random() * 0.45).toFixed(2);

          layer.appendChild(el);
          el.addEventListener("animationend", () => el.remove());
        }
      }, tickMs);
    }

    function stopEmojiStream(card){
      if (card._emojiTimer){
        clearInterval(card._emojiTimer);
        card._emojiTimer = null;
      }
      // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ä–∞–∑—É –æ—á–∏—â–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
      // const layer = card.querySelector(".emoji-layer");
      // if (layer) layer.innerHTML = "";
    }

    function injectBorderAndEmoji(card) {
      // emoji —Å–ª–æ–π (—Å–∞–º—ã–π –Ω–∏–∂–Ω–∏–π)
      const emojiLayer = document.createElement("div");
      emojiLayer.className = "emoji-layer";

      // SVG —Ä–∞–º–∫–∞
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("class", "border-svg");
      svg.setAttribute("aria-hidden", "true");
      svg.setAttribute("preserveAspectRatio", "none");

      const glow = document.createElementNS("http://www.w3.org/2000/svg", "path");
      glow.setAttribute("class", "border-glow");

      const outer = document.createElementNS("http://www.w3.org/2000/svg", "path");
      outer.setAttribute("class", "border-outer");

      const inner = document.createElementNS("http://www.w3.org/2000/svg", "path");
      inner.setAttribute("class", "border-inner");

      const neonA = document.createElementNS("http://www.w3.org/2000/svg", "path");
      neonA.setAttribute("class", "border-neon neon-a");

      const neonB = document.createElementNS("http://www.w3.org/2000/svg", "path");
      neonB.setAttribute("class", "border-neon neon-b");

      svg.appendChild(glow);
      svg.appendChild(outer);
      svg.appendChild(inner);
      svg.appendChild(neonA);
      svg.appendChild(neonB);

      // –í–ê–ñ–ù–û: —Å–ª–æ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –Ω–∞—á–∞–ª–µ –∫–∞—Ä—Ç–æ—á–∫–∏
      card.prepend(svg);
      card.prepend(emojiLayer);

      function updateBorderPath() {
        const r = card.getBoundingClientRect();
        const w = Math.max(1, Math.round(r.width));
        const h = Math.max(1, Math.round(r.height));

        const cut = 26;    // –∫–∞–∫ –≤ clip-path
        const pad = 3;     // —á—Ç–æ–±—ã stroke –Ω–µ —Ä–µ–∑–∞–ª—Å—è

        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

        const d = [
          `M ${pad} ${pad}`,
          `H ${w - pad}`,
          `V ${h - cut - pad}`,
          `L ${w - cut - pad} ${h - pad}`,
          `H ${pad}`,
          `Z`
        ].join(" ");

        glow.setAttribute("d", d);
        outer.setAttribute("d", d);
        inner.setAttribute("d", d);
        neonA.setAttribute("d", d);
        neonB.setAttribute("d", d);
      }

      requestAnimationFrame(updateBorderPath);
      const ro = new ResizeObserver(updateBorderPath);
      ro.observe(card);
      card._borderRO = ro;
    }

    function renderLeaderCard(place, row) {
      const card = document.createElement("div");
      card.className = "leader-card rank-" + place;

      // —Å–ª–æ–∏ (emoji + svg)
      injectBorderAndEmoji(card);

      // sheen (–≤—ã—à–µ —Ä–∞–º–∫–∏/—ç–º–æ–¥–∑–∏)
      const sheen = document.createElement("div");
      sheen.className = "sheen";
      card.appendChild(sheen);

      const icon = document.createElement("div");
      icon.className = "leader-icon";
      icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";

      const main = document.createElement("div");
      main.className = "leader-main";

      const scoreBlock = document.createElement("div");
      scoreBlock.className = "leader-score-block";

      if (row) {
        if (row.avatar_url) {
          const img = document.createElement("img");
          img.src = row.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = row.nick ? row.nick[0] : "?";
        }

        const nameRow = document.createElement("div");
        nameRow.className = "leader-name-row";

        const nickEl = document.createElement("div");
        nickEl.className = "leader-nick";
        nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

        const accEl = document.createElement("div");
        accEl.className = "leader-account";
        accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

        nameRow.appendChild(nickEl);
        nameRow.appendChild(accEl);

        const dept = (row.department || "").trim().toUpperCase();
        const deptEl = document.createElement("div");
        deptEl.className =
          "dept-badge " +
          (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
        deptEl.textContent = dept || "‚Äî";

        main.appendChild(nameRow);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = row.points ?? 0;

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      } else {
        avatar.textContent = "?";

        const emptyTitle = document.createElement("div");
        emptyTitle.className = "leader-empty";
        emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

        const deptEl = document.createElement("div");
        deptEl.className = "dept-badge";
        deptEl.textContent = "‚Äî";

        main.appendChild(emptyTitle);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = "0";

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      }

      card.appendChild(icon);
      card.appendChild(avatar);
      card.appendChild(main);
      card.appendChild(scoreBlock);

      // —ç–º–æ–¥–∑–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ hover
      card.addEventListener("mouseenter", () => startEmojiStream(card, place));
      card.addEventListener("mouseleave", () => stopEmojiStream(card));

      return card;
    }

    async function loadLeaders(period = "day") {
      currentPeriod = period;

      if (dateEl) {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        dateEl.textContent = `${dd}.${mm}.${yyyy}`;
      }

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, nick, account_id, avatar_url, department, points_day")
        .order("points_day", { ascending: false })
        .limit(3);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è (leaderinfo).");
        return;
      }

      const rows = (data || []).map((r) => ({
        id: r.id,
        nick: (r.nick || "").trim(),
        account_id: r.account_id || null,
        avatar_url: r.avatar_url || null,
        department: r.department || null,
        points_day: Number(r.points_day || 0),
        points: Number(r.points_day || 0),
      }));

      const slots = [0,1,2].map((i) => rows[i] || null);

      leadersWrapper.innerHTML = "";
      slots.forEach((row, idx) => {
        leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
      });
    }

    async function loadWeeklyBlocks() {
      currentPeriod = "week";
      if (dateEl) dateEl.textContent = "";

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo_week")
        .select(`
          week_start,
          week_end,
          place,
          points_week,
          leader:leader_id (
            id,
            nick,
            account_id,
            avatar_url,
            department
          )
        `)
        .order("week_start", { ascending: false })
        .order("place", { ascending: true })
        .limit(30);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã leaderinfo_week.");
        return;
      }

      const rows = data || [];
      if (!rows.length) {
        leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º.";
        return;
      }

      const byWeek = new Map();
      for (const r of rows) {
        const key = r.week_start;
        if (!byWeek.has(key)) {
          byWeek.set(key, {
            week_start: r.week_start,
            week_end: r.week_end,
            places: new Map(),
          });
        }
        byWeek.get(key).places.set(Number(r.place), r);
      }

      leadersWrapper.innerHTML = "";

      for (const [, w] of byWeek) {
        const block = document.createElement("div");
        block.className = "week-block";

        const badge = document.createElement("div");
        badge.className = "week-period-badge";
        badge.innerHTML = `<span class="dot"></span>${formatPeriodRu(w.week_start, w.week_end)}`;
        block.appendChild(badge);

        for (let place = 1; place <= 3; place++) {
          const item = w.places.get(place);
          if (item && item.leader) {
            const leader = item.leader;
            const row = {
              id: leader.id,
              nick: leader.nick,
              account_id: leader.account_id,
              avatar_url: leader.avatar_url,
              department: leader.department,
              points: Number(item.points_week || 0),
            };
            block.appendChild(renderLeaderCard(place, row));
          } else {
            block.appendChild(renderLeaderCard(place, null));
          }
        }

        leadersWrapper.appendChild(block);
      }
    }

    /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ ===== */
    const tabDay = document.getElementById("tab-day");
    const tabWeek = document.getElementById("tab-week");
    if (tabDay && tabWeek) {
      const tabs = [tabDay, tabWeek];
      tabs.forEach((btn) => {
        btn.onclick = () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const period = btn.dataset.period;
          if (period === "week") loadWeeklyBlocks();
          else loadLeaders("day");
        };
      });
    }

    /* ===== BULK EDIT (LSPD/SFPD/LVPD) ===== */
    const editLeadersTopBtn = document.getElementById("edit-leaders-top");
    const bulkModal = document.getElementById("leaders-bulk-modal");
    const bulkFormsEl = document.getElementById("bulk-forms");
    const bulkCancelBtn = document.getElementById("bulk-cancel");
    const bulkSaveBtn = document.getElementById("bulk-save");
    const bulkErrorEl = document.getElementById("bulk-error");

    let bulkRows = [];
    let bulkAvatarByDept = {};

    function showBulkError(msg){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "block";
      bulkErrorEl.textContent = msg || "–û—à–∏–±–∫–∞.";
    }
    function hideBulkError(){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "none";
      bulkErrorEl.textContent = "";
    }

    function openBulkModal(){
      if(!canBulkEdit(currentUser)){
        showErrorModal("–ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ admin –∏ creator.");
        return;
      }
      hideBulkError();
      bulkModal.classList.add("active");
    }
    function closeBulkModal(){
      bulkModal.classList.remove("active");
      bulkRows = [];
      bulkAvatarByDept = {};
      if (bulkFormsEl) bulkFormsEl.innerHTML = "";
      hideBulkError();
    }

    async function fetchLeadersForDepts(){
      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, department, nick, account_id, avatar_url")
        .in("department", ["LSPD","SFPD","LVPD"]);

      if (error) throw error;

      const map = new Map((data || []).map(r => [String(r.department||"").trim().toUpperCase(), r]));
      const depts = ["LSPD","SFPD","LVPD"];

      return depts.map(d => {
        const r = map.get(d);
        return r ? {
          id: r.id,
          department: d,
          nick: r.nick || "",
          account_id: r.account_id || "",
          avatar_url: r.avatar_url || null
        } : {
          id: null,
          department: d,
          nick: "",
          account_id: "",
          avatar_url: null
        };
      });
    }

    function createBulkCard(row){
      const dept = row.department;

      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.12)";
      wrap.style.borderRadius = "18px";
      wrap.style.padding = "14px";
      wrap.style.background = "rgba(0,0,0,.10)";
      wrap.style.backdropFilter = "blur(12px)";
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "120px 1fr";
      wrap.style.gap = "14px";
      wrap.style.alignItems = "start";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "10px";
      left.style.alignItems = "center";

      const badge = document.createElement("div");
      badge.className = "dept-badge " + (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : "lvpd");
      badge.textContent = dept;

      const avatar = document.createElement("div");
      avatar.className = "edit-avatar-preview";
      avatar.style.margin = "0";
      avatar.style.width = "92px";
      avatar.style.height = "92px";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";

      const nickInput = document.createElement("input");
      nickInput.type = "text";
      nickInput.value = row.nick || "";
      nickInput.placeholder = "–ò–º—è_–§–∞–º–∏–ª–∏—è";

      const accInput = document.createElement("input");
      accInput.type = "text";
      accInput.value = row.account_id || "";
      accInput.placeholder = "3960680";

      function setAvatarPreview(src){
        avatar.innerHTML = "";
        if(src){
          const img = document.createElement("img");
          img.src = src;
          avatar.appendChild(img);
        } else {
          avatar.textContent = (nickInput.value?.trim()?.[0] || "?");
        }
      }

      setAvatarPreview(row.avatar_url || null);

      function handleFile(file){
        const reader = new FileReader();
        reader.onload = () => {
          bulkAvatarByDept[dept] = reader.result;
          setAvatarPreview(reader.result);
        };
        reader.onerror = () => showBulkError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è " + dept);
        reader.readAsDataURL(file);
      }

      avatar.addEventListener("click", () => fileInput.click());
      avatar.addEventListener("dragover", (e)=>{ e.preventDefault(); avatar.classList.add("drag-over"); });
      avatar.addEventListener("dragleave", ()=> avatar.classList.remove("drag-over"));
      avatar.addEventListener("drop", (e)=>{
        e.preventDefault(); avatar.classList.remove("drag-over");
        const f = e.dataTransfer.files?.[0];
        if(f) handleFile(f);
      });

      fileInput.addEventListener("change", (e)=>{
        const f = e.target.files?.[0];
        if(f) handleFile(f);
        fileInput.value = "";
      });

      nickInput.addEventListener("input", ()=>{
        if(!bulkAvatarByDept[dept] && !row.avatar_url){
          setAvatarPreview(null);
        }
      });

      left.appendChild(badge);
      left.appendChild(avatar);
      left.appendChild(fileInput);

      const right = document.createElement("div");

      const nickField = document.createElement("div");
      nickField.className = "field";
      const nickLabel = document.createElement("label");
      nickLabel.textContent = "–ù–∏–∫ (" + dept + ")";
      nickField.appendChild(nickLabel);
      nickField.appendChild(nickInput);

      const accField = document.createElement("div");
      accField.className = "field";
      const accLabel = document.createElement("label");
      accLabel.textContent = "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (" + dept + ")";
      accField.appendChild(accLabel);
      accField.appendChild(accInput);

      right.appendChild(nickField);
      right.appendChild(accField);

      wrap.appendChild(left);
      wrap.appendChild(right);

      return { wrap, nickInput, accInput };
    }

    async function buildBulkModal(){
      try{
        hideBulkError();
        bulkFormsEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        bulkRows = await fetchLeadersForDepts();
        bulkAvatarByDept = {};

        bulkFormsEl.innerHTML = "";
        bulkRows.forEach((row) => {
          const ui = createBulkCard(row);
          row._ui = ui;
          bulkFormsEl.appendChild(ui.wrap);
        });
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤: " + (e?.message || e));
        bulkFormsEl.innerHTML = "";
      }
    }

    async function saveBulk(){
      if(!canBulkEdit(currentUser)){
        showBulkError("–ù–µ—Ç –ø—Ä–∞–≤.");
        return;
      }
      hideBulkError();

      for(const row of bulkRows){
        const nick = row._ui.nickInput.value.trim();
        const acc = row._ui.accInput.value.trim();
        if(!row.id){
          showBulkError(`–í leaderinfo –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ ${row.department}. –í—ã–ø–æ–ª–Ω–∏ SQL –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å 3 –∑–∞–ø–∏—Å–∏).`);
          return;
        }
        if(!nick || !acc){
          showBulkError(`–ó–∞–ø–æ–ª–Ω–∏ –Ω–∏–∫ –∏ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è ${row.department}.`);
          return;
        }
      }

      try{
        for(const row of bulkRows){
          const dept = row.department;
          const payload = {
            department: dept,
            nick: row._ui.nickInput.value.trim(),
            account_id: row._ui.accInput.value.trim(),
            updated_at: new Date().toISOString(),
          };
          if (bulkAvatarByDept[dept]) payload.avatar_url = bulkAvatarByDept[dept];

          const { error } = await supabaseClient
            .from("leaderinfo")
            .update(payload)
            .eq("id", row.id);

          if(error) throw error;
        }

        closeBulkModal();
        await loadLeaders("day");
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (e?.message || e));
      }
    }

    if (editLeadersTopBtn) {
      editLeadersTopBtn.addEventListener("click", async () => {
        openBulkModal();
        await buildBulkModal();
      });
    }
    if (bulkCancelBtn) bulkCancelBtn.addEventListener("click", closeBulkModal);
    if (bulkSaveBtn) bulkSaveBtn.addEventListener("click", saveBulk);

    /* ===== TAB SVG BORDER INJECT ===== */
    function injectTabBorder(btn, opts = {}) {
      if (!btn || btn.querySelector(".tab-border-svg")) return;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("class", "tab-border-svg");
      svg.setAttribute("aria-hidden", "true");
      svg.setAttribute("preserveAspectRatio", "none");

      const glow = document.createElementNS("http://www.w3.org/2000/svg", "path");
      glow.setAttribute("class", "tab-border-glow");

      const outer = document.createElementNS("http://www.w3.org/2000/svg", "path");
      outer.setAttribute("class", "tab-border-outer");

      const inner = document.createElementNS("http://www.w3.org/2000/svg", "path");
      inner.setAttribute("class", "tab-border-inner");

      const neonA = document.createElementNS("http://www.w3.org/2000/svg", "path");
      neonA.setAttribute("class", "tab-border-neon neon-a");

      const neonB = document.createElementNS("http://www.w3.org/2000/svg", "path");
      neonB.setAttribute("class", "tab-border-neon neon-b");

      svg.appendChild(glow);
      svg.appendChild(outer);
      svg.appendChild(inner);
      svg.appendChild(neonA);
      svg.appendChild(neonB);

      btn.appendChild(svg);

      function updatePath() {
        const r = btn.getBoundingClientRect();
        const w = Math.max(1, Math.round(r.width));
        const h = Math.max(1, Math.round(r.height));

        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);

        const pad = 3;
        const radius = 16;
        const cut = opts.cut ?? 18;

        const rightX = w - pad;
        const cutX = w - cut - pad;

        const d = [
          `M ${pad + radius} ${pad}`,
          `H ${cutX}`,
          `L ${rightX} ${h / 2}`,
          `L ${cutX} ${h - pad}`,
          `H ${pad + radius}`,
          `Q ${pad} ${h - pad} ${pad} ${h - pad - radius}`,
          `V ${pad + radius}`,
          `Q ${pad} ${pad} ${pad + radius} ${pad}`,
          `Z`
        ].join(" ");

        glow.setAttribute("d", d);
        outer.setAttribute("d", d);
        inner.setAttribute("d", d);
        neonA.setAttribute("d", d);
        neonB.setAttribute("d", d);

        neonA.setAttribute("stroke", "rgba(255, 110, 200, 1)");
        neonB.setAttribute("stroke", "rgba(255, 45, 122, 1)");
      }

      requestAnimationFrame(updatePath);
      const ro = new ResizeObserver(updatePath);
      ro.observe(btn);
    }

    function enhanceTabs() {
      injectTabBorder(document.getElementById("tab-day"), { cut: 18 });
      injectTabBorder(document.getElementById("tab-week"), { cut: 18 });
    }

    /* ===== INIT ===== */
    const userTagEl = document.getElementById("user-tag");

    async function initPage() {
      currentUser = loadSession();

      if (editLeadersTopBtn) {
        editLeadersTopBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
      }

      enhanceTabs();
      await loadLeaders("day");
    }

    window.addEventListener("load", initPage);

    /* ================= FALLING FX CANVAS ================= */
/* ================= FALLING FX CANVAS (slow / 10% / mono red) ================= */
(function initFallingFx(){
  const canvas = document.getElementById("fall-canvas");
  if (!canvas) return;

  const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  if (reduceMotion) return;

  const ctx = canvas.getContext("2d", { alpha: true });

  let W = 1, H = 1, DPR = 1;

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    W = Math.max(1, Math.floor(rect.width));
    H = Math.max(1, Math.floor(rect.height));
    canvas.width  = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  resize();
  window.addEventListener("resize", resize);

  // ===== –ú–û–ù–û–•–†–û–ú–ù–´–ï –°–ò–ú–í–û–õ–´ (–Ω–µ —ç–º–æ–¥–∑–∏) =====
  // –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –Ω–∞ –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–±–µ –Ω—Ä–∞–≤—è—Ç—Å—è.
  // –ü—É–ª—è / –∞–≤—Ç–æ–º–∞—Ç / –ø–∏—Å—Ç–æ–ª–µ—Ç / –ø–æ–ª–∏—Ü–∏—è / –∑–≤–µ–∑–¥–∞ / –∫—É–±–∫–∏:
  const ICONS = [
    { t: "‚ú¶", w: 1.10 },   // –∑–≤–µ–∑–¥–∞ (—Å—Ç–∏–ª—å–Ω–æ)
    { t: "‚ú∂", w: 1.05 },   // –∑–≤–µ–∑–¥–∞ 2
    { t: "‚òÖ", w: 1.05 },   // –∑–≤–µ–∑–¥–∞ 3
    { t: "‚ú™", w: 1.00 },   // ‚Äú–∑–Ω–∞—á–æ–∫‚Äù
    { t: "‚úπ", w: 0.95 },

    { t: "‚ñ∏", w: 1.15 },   // –ø—É–ª—è (—Å—Ç—Ä–µ–ª–∫–∞)
    { t: "‚û§", w: 1.05 },   // –ø—É–ª—è 2
    { t: "‚ü°", w: 0.95 },

    { t: "‚åÅ", w: 1.05 },   // –∞–≤—Ç–æ–º–∞—Ç (–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª)
    { t: "‚üû", w: 1.00 },   // –æ—Ä—É–∂–µ–π–Ω—ã–π —Å—Ç–∏–ª—å
    { t: "‚üù", w: 1.00 },

    { t: "‚ôõ", w: 1.05 },   // ‚Äú–∫—É–±–æ–∫‚Äù (–∫–∞–∫ –∫–æ—Ä–æ–Ω–∞)
    { t: "‚öë", w: 1.00 },   // ‚Äú–∫—É–±–æ–∫/—Ñ–ª–∞–≥‚Äù
    { t: "‚ú∫", w: 1.10 },   // ‚Äú—Ç—Ä–æ—Ñ–µ–π‚Äù (—Å–æ–ª–Ω—ã—à–∫–æ)
    { t: "‚Ö°", w: 1.10 },   // 2 –º–µ—Å—Ç–æ
    { t: "‚Ö¢", w: 1.10 },   // 3 –º–µ—Å—Ç–æ
  ];

  function rand(min, max){ return min + Math.random() * (max - min); }

  function pickWeighted(){
    // –ß–∞—â–µ ‚Äú–∑–≤—ë–∑–¥—ã/–ø–æ–ª–∏—Ü–∏—è/—Ç—Ä–æ—Ñ–µ–∏‚Äù, —Ä–µ–∂–µ ‚Äú–ø—É–ª–∏/–æ—Ä—É–∂–∏–µ‚Äù
    const bag = [
      ICONS[0], ICONS[1], ICONS[2], ICONS[3], ICONS[4], // –∑–≤–µ–∑–¥—ã/–∑–Ω–∞—á–∫–∏
      ICONS[0], ICONS[1], ICONS[2],
      ICONS[11], ICONS[12], ICONS[13],                 // ‚Äú–∫—É–±–∫–∏‚Äù
      ICONS[14], ICONS[15],                             // II / III
      ICONS[5], ICONS[6],                               // –ø—É–ª–∏
      ICONS[8], ICONS[9], ICONS[10],                    // ‚Äú–æ—Ä—É–∂–∏–µ‚Äù
      ICONS[5],
    ];
    return bag[(Math.random() * bag.length) | 0];
  }

  const drops = [];
  const smoke = [];
  let spawnAcc = 0;

  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–≥–ª–∞–≤–Ω—ã–µ —Ä—É—á–∫–∏)
  const DROP_ALPHA = 0.10;                 // 10% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
  const BASE_SPEED_MIN = 0.10;             // –ú–ï–î–õ–ï–ù–ù–ï–ï
  const BASE_SPEED_MAX = 0.38;             // –ú–ï–î–õ–ï–ù–ù–ï–ï
  const SMOKE_ALPHA_MIN = 0.02;            // –¥—ã–º —Ç–æ–∂–µ –ª—ë–≥–∫–∏–π
  const SMOKE_ALPHA_MAX = 0.05;

  function spawnDrop(){
    const icon = pickWeighted();
    const size = rand(16, 36) * icon.w;
    const x = rand(0, W);
    const y = rand(-H * 0.35, -40);

    const vy = rand(BASE_SPEED_MIN, BASE_SPEED_MAX) * (size / 24);
    const vx = rand(-0.035, 0.035);

    const rot = rand(-0.7, 0.7);
    const vrot = rand(-0.004, 0.004);

    const willVanish = Math.random() < 0.30;
    const vanishY = willVanish ? rand(H * 0.20, H * 0.90) : null;

    drops.push({
      t: icon.t,
      x, y, vx, vy,
      size,
      rot, vrot,
      a: DROP_ALPHA,
      life: 1,
      willVanish,
      vanishY,
      vanishFade: 0
    });
  }

  function spawnDropAt(x, y){
  const icon = pickWeighted();
  const size = rand(18, 40) * icon.w;

  const vy = rand(BASE_SPEED_MIN, BASE_SPEED_MAX) * (size / 24);
  const vx = rand(-0.04, 0.04);

  const rot = rand(-0.7, 0.7);
  const vrot = rand(-0.004, 0.004);

  const willVanish = Math.random() < 0.30;
  const vanishY = willVanish ? rand(H * 0.20, H * 0.90) : null;

  drops.push({
    t: icon.t,
    x: Math.max(0, Math.min(W, x)),
    y: Math.max(-60, Math.min(H, y)),
    vx, vy,
    size,
    rot, vrot,
    a: DROP_ALPHA,
    life: 1,
    willVanish,
    vanishY,
    vanishFade: 0
  });

  // –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äú–ø—à–∏–∫‚Äù –¥—ã–º–∞ –≤ –º–µ—Å—Ç–µ –ø–æ—è–≤–ª–µ–Ω–∏—è
  puff(x, y);
}


  function spawnSmoke(x, y, intensity = 1){
    const n = Math.max(1, Math.round(rand(1, 2) * intensity));
    for (let i = 0; i < n; i++){
      smoke.push({
        x: x + rand(-6, 6),
        y: y + rand(8, 14),
        vx: rand(-0.05, 0.05),
        vy: rand(-0.08, -0.02),
        r: rand(8, 18),
        a: rand(SMOKE_ALPHA_MIN, SMOKE_ALPHA_MAX),
        life: 1
      });
    }
  }

  function puff(x, y){
    for (let i = 0; i < 8; i++){
      smoke.push({
        x: x + rand(-10, 10),
        y: y + rand(-6, 6),
        vx: rand(-0.12, 0.12),
        vy: rand(-0.18, -0.05),
        r: rand(14, 26),
        a: rand(SMOKE_ALPHA_MIN, SMOKE_ALPHA_MAX + 0.02),
        life: 1
      });
    }
  }

  function drawSmoke(p){
    const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
    g.addColorStop(0, `rgba(255, 45, 122, ${p.a})`);
    g.addColorStop(0.7, `rgba(255, 45, 122, ${p.a * 0.30})`);
    g.addColorStop(1, `rgba(0, 0, 0, 0)`);
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fill();
  }

  function drawDrop(d){
    ctx.save();
    ctx.translate(d.x, d.y);
    ctx.rotate(d.rot);

    // –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π
    ctx.globalAlpha = d.a * d.life;
    ctx.font = `${Math.round(d.size)}px system-ui, "Segoe UI", sans-serif`;

    // –ª—ë–≥–∫–∞—è –Ω–µ–æ–Ω–æ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (—Ç–æ–∂–µ –∫—Ä–∞—Å–Ω–∞—è)
    ctx.shadowColor = "rgba(255,45,122,0.35)";
    ctx.shadowBlur = 10;

    ctx.fillStyle = "rgba(255,45,122,1)";
    ctx.fillText(d.t, -d.size * 0.40, d.size * 0.35);

    ctx.restore();
  }

  let last = performance.now();
  function tick(now){
    const dt = Math.min(40, now - last);
    last = now;

    ctx.clearRect(0, 0, W, H);

    // –°–ø–∞–≤–Ω: –º–µ–Ω—å—à–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å (–∏ –≤—ã–≥–ª—è–¥–µ–ª–æ ‚Äú–º–µ–¥–ª–µ–Ω–Ω–æ‚Äù)
    const targetPerSec = Math.max(5, Math.round(W / 180)); // —Ä–∞–Ω—å—à–µ –±—ã–ª–æ –ø–ª–æ—Ç–Ω–µ–µ
    spawnAcc += (dt / 1000) * targetPerSec;
    while (spawnAcc >= 1){
      spawnDrop();
      spawnAcc -= 1;
    }

    // –¥—ã–º
    for (let i = smoke.length - 1; i >= 0; i--){
      const p = smoke[i];
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.r += 0.010 * dt;
      p.life -= 0.0012 * dt;
      if (p.life <= 0){
        smoke.splice(i, 1);
        continue;
      }
      drawSmoke(p);
    }

    // —ç–ª–µ–º–µ–Ω—Ç—ã
    for (let i = drops.length - 1; i >= 0; i--){
      const d = drops[i];

      d.x += d.vx * dt;
      d.y += d.vy * dt;
      d.rot += d.vrot * dt;

      // –ª—ë–≥–∫–∏–π –¥—ã–º–æ–∫ —Ä–µ–∂–µ
      if (Math.random() < 0.55){
        spawnSmoke(d.x, d.y, 1);
      }

      // –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ ‚Äú–≤ –≤–æ–∑–¥—É—Ö–µ‚Äù
      if (d.willVanish && d.vanishY != null && d.y >= d.vanishY){
        d.vanishFade += 0.0028 * dt;  // –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–∞—Å—Ç–≤–æ—Ä—è–µ—Ç—Å—è
        d.life = Math.max(0, 1 - d.vanishFade);
        if (d.life <= 0.02){
          puff(d.x, d.y);
          drops.splice(i, 1);
          continue;
        }
      }

      // —É—à—ë–ª –≤–Ω–∏–∑ ‚Äî —É–¥–∞–ª—è–µ–º
      if (d.y > H + 80){
        drops.splice(i, 1);
        continue;
      }

      // –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º
      if (d.x < -40) d.x = W + 40;
      if (d.x > W + 40) d.x = -40;

      drawDrop(d);
    }

    requestAnimationFrame(tick);
  }

  requestAnimationFrame(tick);

function canvasToLocal(clientX, clientY){
  const rect = canvas.getBoundingClientRect();
  return {
    x: (clientX - rect.left) * (W / rect.width),
    y: (clientY - rect.top)  * (H / rect.height),
  };
}

// –∫–ª–∏–∫/—Ç–∞–ø –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Üí —Å–ø–∞–≤–Ω –≤ —Ç–æ—á–∫–µ
window.addEventListener("pointerdown", (e) => {
  // –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–∞–º/–∏–Ω–ø—É—Ç–∞–º/–º–æ–¥–∞–ª–∫–∞–º ‚Äî –Ω–µ —Å–ø–∞–≤–Ω–∏–º, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å UI
  const t = e.target;
  if (t && (t.closest("button") || t.closest("a") || t.closest("input") || t.closest("select") || t.closest(".modal") || t.closest(".modal-backdrop"))) {
    return;
  }
  const p = canvasToLocal(e.clientX, e.clientY);
  spawnDropAt(p.x, p.y);
}, { passive: true });

  
})();

    
  </script>
</body>
</html>
