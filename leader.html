<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏–¥–µ—Ä—ã PD</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050816;
      --panel-bg: #070818;
      --panel-border: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent-pink: #ec4899;
      --accent-pink-soft: #f472b6;
      --accent-pink-dark: #db2777;
      --tab-bg: #111827;
      --tab-border: #1f2937;
      --score-color: #f472b6;
      --gold: #facc15;
      --silver: #e5e7eb;
      --bronze: #fb923c;
    }

    @keyframes hoverEffect {
      0% {
        transform: scale(1);
        box-shadow: 0 4px 10px rgba(255, 255, 255, 0.1);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 4px 10px rgba(255, 255, 255, 0.1);
      }
    }
  
    .btn, .leader-tab {
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }
    
    .btn:hover, .leader-tab:hover {
      background: rgba(31, 41, 55, 0.95);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.9);
    }
    
    .leader-tab.active {
      background: rgba(251, 113, 133, 0.85);
      box-shadow: 0 0 22px rgba(236, 72, 153, 0.8), 0 18px 40px rgba(15, 23, 42, 0.9);
      animation: hoverEffect 0.4s ease-in-out forwards;
      transition: background 0.2s ease, box-shadow 0.2s ease; /* –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ */
    }
  
    .leader-card:hover {
      transform: scale(1.02);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.8);
      animation: hoverEffect 0.4s ease-in-out forwards;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #020617;
      overflow: hidden;
    }
    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }
    #bg-rotator img.active { opacity: 1; }

    #app {
      width: 100%;
      max-width: 1100px;
      position: relative;
      z-index: 1;
    }

    a { color: var(--accent-pink-soft); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.75);
    }
    .btn:hover {
      background: rgba(31, 41, 55, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.9);
    }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .btn-outline {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: transparent;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.85);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.85);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }
    .page-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-shadow: 0 0 18px rgba(168, 85, 247, 0.55);
    }
    .page-subtitle { font-size: 13px; color: var(--muted); }
    .user-tag { font-size: 12px; color: var(--muted); }

    /* ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ: –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ –≤ —Ö–µ–¥–µ—Ä–µ */
    .page-header-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .leader-panel {
      border-radius: 32px;
      border: 1px solid var(--panel-border);
      padding: 26px 26px 20px;
      background:
        radial-gradient(circle at top left, rgba(168, 85, 247, 0.35), transparent 55%),
        radial-gradient(circle at top right, rgba(236, 72, 153, 0.35), transparent 55%),
        linear-gradient(145deg, #020617 0%, #020617 40%, #020617 100%);
      box-shadow:
        0 40px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .leader-panel-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }

    .leader-tabs {
      display: inline-flex;
      background: var(--tab-bg);
      border-radius: 999px;
      border: 1px solid var(--tab-border);
      padding: 4px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.6);
    }
    .leader-tab {
      min-width: 160px;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      transition: color 0.12s;
    }
    .leader-tab span.icon { font-size: 14px; }
    .leader-tab.active { color: #f9fafb; }
    .leader-tab.active::before {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(251, 113, 133, 0.85), rgba(236, 72, 153, 0.95));
      box-shadow:
        0 0 22px rgba(236, 72, 153, 0.8),
        0 18px 40px rgba(15, 23, 42, 0.9);
      z-index: -1;
    }
    .leader-tab.active span.label { font-weight: 700; }
    .leader-date { font-size: 14px; color: var(--muted); }

    .leaders-wrapper {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .leader-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 22px;
      border-radius: 20px;
      background: radial-gradient(circle at right, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 22px 40px rgba(15, 23, 42, 0.9);
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è transform –∏ box-shadow */
    }

    .leader-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.35), rgba(15, 23, 42, 0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
    }
    .leader-card.rank-1 .leader-icon { background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.55), rgba(15, 23, 42, 0.9)); }
    .leader-card.rank-2 .leader-icon { background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.55), rgba(15, 23, 42, 0.9)); }
    .leader-card.rank-3 .leader-icon { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.55), rgba(15, 23, 42, 0.9)); }

    .leader-avatar {
      width: 68px;
      height: 68px;
      border-radius: 18px;
      border: 2px solid rgba(236, 72, 153, 0.7);
      background: #020617;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
      position: relative;
      color: #e5e7eb;
    }
    .leader-avatar img { width: 100%; height: 100%; object-fit: cover; }

    .leader-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .leader-name-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }

    .leader-nick {
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 0 14px rgba(15, 23, 42, 0.8);
    }
    .leader-account {
      font-size: 13px;
      color: var(--accent-pink-soft);
      text-shadow: 0 0 10px rgba(236, 72, 153, 0.8);
    }

    .dept-badge {
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-top: 2px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.65);
    }
    .dept-badge.lspd { color:#22c55e; box-shadow: 0 0 18px rgba(34,197,94,.25); }
    .dept-badge.sfpd { color:#38bdf8; box-shadow: 0 0 18px rgba(56,189,248,.25); }
    .dept-badge.lvpd { color:#ef4444; box-shadow: 0 0 18px rgba(239,68,68,.25); }

    .leader-score-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 110px;
    }
    .leader-score {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-weight: 800;
      text-shadow: 0 0 16px rgba(236, 72, 153, 0.85);
    }
    .leader-score .value { font-size: 26px; color: var(--score-color); }
    .leader-score .unit { font-size: 13px; color: #e5e7eb; }
    .leader-place-label { font-size: 12px; color: var(--muted); }

    .leader-empty { font-size: 15px; color: var(--muted); }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.active { display: flex; }
    .modal {
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.96));
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.95);
      padding: 18px 18px 14px;
    }
    .modal h3 { font-size: 18px; margin-bottom: 4px; }
    .modal p { font-size: 13px; color: var(--muted); margin-bottom: 10px; }
    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field { margin-bottom: 8px; }
    .field label { display: block; font-size: 13px; margin-bottom: 3px; }
    .field input, .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: #020617;
      color: var(--text);
      font-size: 14px;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }
    .hint { font-size: 11px; color: var(--muted); margin-bottom: 4px; }

    .edit-avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 22px;
      border: 2px dashed rgba(148, 163, 184, 0.85);
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      color: #e5e7eb;
    }
    .edit-avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .edit-avatar-preview::after {
      content: "‚úé";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .error-text { font-size: 12px; color: #f97373; margin-top: 4px; }

    .week-block { margin-top: 14px; display: flex; flex-direction: column; gap: 14px; }
    .week-period-badge {
      display: inline-flex;
      align-items: center;
      width: fit-content;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: 1px solid rgba(148,163,184,.28);
      background:
        radial-gradient(circle at top left, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(circle at top right, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(239,68,68,.18), transparent 55%),
        rgba(15,23,42,.55);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .75);
    }
    .week-period-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(236,72,153,.9);
      box-shadow: 0 0 14px rgba(236,72,153,.55);
    }

    .drag-over { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.8); }

    @media (max-width: 720px) {
      body { padding: 12px; }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .leader-card {
        display: grid;
        grid-template-columns: 52px 68px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        align-items: start;
        padding: 14px 14px;
      }

      .leader-icon { grid-column: 1; grid-row: 1; }
      .leader-avatar { grid-column: 2; grid-row: 1; }

      .leader-main {
        grid-column: 3;
        grid-row: 1;
        min-width: 0;
      }

      .leader-score-block {
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
      }

      .leader-score .value { font-size: 22px; }
    }
  </style>
</head>

<body>
<div id="bg-rotator"></div>

<div id="app">
  <div class="page-header">
    <div class="page-title-block">
      <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
      <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
      <div class="user-tag" id="user-tag"></div>
    </div>

    <!-- ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ: –∫–Ω–æ–ø–∫–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ -->
    <div class="page-header-actions">
      <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–µ—Ä–æ–≤</button>
    </div>
  </div>

  <div class="leader-panel">
    <div class="leader-panel-header">
      <div class="leader-tabs">
        <button class="leader-tab active" id="tab-day" data-period="day">
          <span class="icon">‚ô•</span>
          <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
        </button>
        <button class="leader-tab" id="tab-week" data-period="week">
          <span class="icon">‚ô•</span>
          <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
        </button>
      </div>
      <div class="leader-date" id="leader-date"></div>
    </div>

    <div class="leaders-wrapper" id="leaders-wrapper">
      –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ -->
<div id="error-modal" class="modal-backdrop">
  <div class="modal">
    <h3>–û—à–∏–±–∫–∞</h3>
    <p id="error-modal-text"></p>
    <div class="modal-footer">
      <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ: –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è 3—Ö –ª–∏–¥–µ—Ä–æ–≤ -->
<div id="leaders-bulk-modal" class="modal-backdrop">
  <div class="modal" style="max-width: 720px;">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤ (LSPD / SFPD / LVPD)</h3>
    <p>–ú–µ–Ω—è—é—Ç—Å—è –Ω–∏–∫, –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤–∞—Ç–∞—Ä. –û—á–∫–∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.</p>

    <div id="bulk-error" class="error-text" style="display:none;"></div>
    <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>

    <div class="modal-footer">
      <button class="btn-outline btn-sm" id="bulk-cancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-sm" id="bulk-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== –¢–ï–ú–ê: —Ñ–æ–Ω + –±—Ä–µ–Ω–¥ ===== */
  let themeConfig = {
    images: [],
    opacity: 80,
    blur: 0,
    borderColor: "#1f2937",
    favicon: null,
    siteTitle: null,
  };
  let bgRotationTimer = null;
  let bgCurrentIndex = 0;
  const bgRotatorEl = document.getElementById("bg-rotator");

  async function loadThemeFromDB() {
    const { data, error } = await supabaseClient
      .from("theme_settings")
      .select("*")
      .eq("id", 1)
      .single();

    if (error || !data) {
      console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã:", error);
      return;
    }

    themeConfig = {
      images: data.images || [],
      opacity: data.opacity ?? 80,
      blur: data.blur ?? 0,
      borderColor: data.border_color || "#1f2937",
      favicon: data.favicon || null,
      siteTitle: data.site_title || null,
    };
  }

  function applyThemeBackground() {
    if (!bgRotatorEl) return;
    bgRotatorEl.innerHTML = "";

    const images = themeConfig.images || [];
    const blurPx = Number(themeConfig.blur || 0);
    const opacityPct = Math.max(0, Math.min(100, Number(themeConfig.opacity ?? 80)));
    const imgOpacity = opacityPct / 100;

    if (!images.length) {
      bgRotatorEl.style.background = "#020617";
      return;
    }

    images.forEach((src, index) => {
      const img = document.createElement("img");
      img.src = src;
      img.style.filter = "blur(" + blurPx + "px)";
      img.style.opacity = "0";
      img.dataset.baseOpacity = String(imgOpacity);

      if (index === 0) {
        img.classList.add("active");
        img.style.opacity = String(imgOpacity);
      }
      bgRotatorEl.appendChild(img);
    });

    if (bgRotationTimer) {
      clearInterval(bgRotationTimer);
      bgRotationTimer = null;
    }

    if (images.length > 1) {
      const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
      bgCurrentIndex = 0;
      bgRotationTimer = setInterval(() => {
        const prev = imgs[bgCurrentIndex];
        bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
        const next = imgs[bgCurrentIndex];

        if (prev) {
          prev.classList.remove("active");
          prev.style.opacity = "0";
        }
        if (next) {
          next.classList.add("active");
          next.style.opacity = next.dataset.baseOpacity || "0.8";
        }
      }, 60 * 1000);
    }
  }

  function applyThemeToBlocks() {
    const borderColor = themeConfig.borderColor || "#1f2937";
    document.documentElement.style.setProperty("--panel-border", borderColor);
  }

  function applySiteBranding() {
    document.title = themeConfig.siteTitle || "–†–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤ PD";

    if (themeConfig.favicon) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement("link");
        link.rel = "icon";
        document.head.appendChild(link);
      }
      link.href = themeConfig.favicon;
    }
  }

  /* ===== –°–ï–°–°–ò–Ø ===== */
  let currentUser = null;
  function loadSession() {
    try { return JSON.parse(localStorage.getItem("pp_user")); }
    catch { return null; }
  }
  function roleLabel(role) {
    role = String(role || "").trim().toLowerCase();
    if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
    if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
    if (role === "creator") return "–†–µ–¥–∞–∫—Ç–æ—Ä";
    return "–û—Ñ–∏—Ü–µ—Ä";
  }

  // ‚úÖ –ø—Ä–∞–≤–∞ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π –∫–Ω–æ–ø–∫–∏: —Ç–æ–ª—å–∫–æ admin –∏ creator
  function canBulkEdit(user) {
    const role = String(user?.role || "").trim().toLowerCase();
    return role === "admin" || role === "creator";
  }

  /* ===== –û–®–ò–ë–ö–ò ===== */
  const errorModal = document.getElementById("error-modal");
  const errorModalText = document.getElementById("error-modal-text");
  const errorModalClose = document.getElementById("error-modal-close");
  function showErrorModal(message) {
    errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
    errorModal.classList.add("active");
  }
  if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

  /* ===== HELPERS WEEK ===== */
  function monthRuUpper(monthIndex) {
    const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
    return m[monthIndex] || "";
  }
  function parseDateOnly(iso) {
    const [y,m,d] = String(iso).split("-").map(Number);
    return new Date(y, (m || 1) - 1, d || 1);
  }
  function formatPeriodRu(startISO, endISO) {
    const s = parseDateOnly(startISO);
    const e = parseDateOnly(endISO);
    return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
  }

  /* ===== UI / DATA ===== */
  const leadersWrapper = document.getElementById("leaders-wrapper");
  const dateEl = document.getElementById("leader-date");
  let currentPeriod = "day";

  function renderLeaderCard(place, row) {
    const card = document.createElement("div");
    card.className = "leader-card rank-" + place;

    const icon = document.createElement("div");
    icon.className = "leader-icon";
    icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

    const avatar = document.createElement("div");
    avatar.className = "leader-avatar";

    const main = document.createElement("div");
    main.className = "leader-main";

    const scoreBlock = document.createElement("div");
    scoreBlock.className = "leader-score-block";

    if (row) {
      if (row.avatar_url) {
        const img = document.createElement("img");
        img.src = row.avatar_url;
        avatar.appendChild(img);
      } else {
        avatar.textContent = row.nick ? row.nick[0] : "?";
      }

      const nameRow = document.createElement("div");
      nameRow.className = "leader-name-row";

      const nickEl = document.createElement("div");
      nickEl.className = "leader-nick";
      nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

      const accEl = document.createElement("div");
      accEl.className = "leader-account";
      accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

      nameRow.appendChild(nickEl);
      nameRow.appendChild(accEl);

      const dept = (row.department || "").trim().toUpperCase();
      const deptEl = document.createElement("div");
      deptEl.className =
        "dept-badge " +
        (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
      deptEl.textContent = dept || "‚Äî";

      main.appendChild(nameRow);
      main.appendChild(deptEl);

      const scoreRow = document.createElement("div");
      scoreRow.className = "leader-score";

      const valueEl = document.createElement("span");
      valueEl.className = "value";
      valueEl.textContent = row.points ?? 0;

      const unitEl = document.createElement("span");
      unitEl.className = "unit";
      unitEl.textContent = "–ê–®";

      scoreRow.appendChild(valueEl);
      scoreRow.appendChild(unitEl);

      const placeLabel = document.createElement("div");
      placeLabel.className = "leader-place-label";
      placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

      scoreBlock.appendChild(scoreRow);
      scoreBlock.appendChild(placeLabel);
    } else {
      avatar.textContent = "?";

      const emptyTitle = document.createElement("div");
      emptyTitle.className = "leader-empty";
      emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

      const deptEl = document.createElement("div");
      deptEl.className = "dept-badge";
      deptEl.textContent = "‚Äî";

      main.appendChild(emptyTitle);
      main.appendChild(deptEl);

      const scoreRow = document.createElement("div");
      scoreRow.className = "leader-score";

      const valueEl = document.createElement("span");
      valueEl.className = "value";
      valueEl.textContent = "0";

      const unitEl = document.createElement("span");
      unitEl.className = "unit";
      unitEl.textContent = "–ê–®";

      scoreRow.appendChild(valueEl);
      scoreRow.appendChild(unitEl);

      const placeLabel = document.createElement("div");
      placeLabel.className = "leader-place-label";
      placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

      scoreBlock.appendChild(scoreRow);
      scoreBlock.appendChild(placeLabel);
    }

    card.appendChild(icon);
    card.appendChild(avatar);
    card.appendChild(main);
    card.appendChild(scoreBlock);

    return card;
  }

  async function loadLeaders(period = "day") {
    currentPeriod = period;

    if (dateEl) {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      dateEl.textContent = `${dd}.${mm}.${yyyy}`;
    }

    if (!leadersWrapper) return;
    leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    const { data, error } = await supabaseClient
      .from("leaderinfo")
      .select("id, nick, account_id, avatar_url, department, points_day")
      .order("points_day", { ascending: false })
      .limit(3);

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.";
      showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è (leaderinfo).");
      return;
    }

    const rows = (data || []).map((r) => ({
      id: r.id,
      nick: (r.nick || "").trim(),
      account_id: r.account_id || null,
      avatar_url: r.avatar_url || null,
      department: r.department || null,
      points_day: Number(r.points_day || 0),
      points: Number(r.points_day || 0),
    }));

    const slots = [0,1,2].map((i) => rows[i] || null);

    leadersWrapper.innerHTML = "";
    slots.forEach((row, idx) => {
      leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
    });
  }

  async function loadWeeklyBlocks() {
    currentPeriod = "week";
    if (dateEl) dateEl.textContent = "";

    if (!leadersWrapper) return;
    leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    const { data, error } = await supabaseClient
      .from("leaderinfo_week")
      .select(`
        week_start,
        week_end,
        place,
        points_week,
        leader:leader_id (
          id,
          nick,
          account_id,
          avatar_url,
          department
        )
      `)
      .order("week_start", { ascending: false })
      .order("place", { ascending: true })
      .limit(30);

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏.";
      showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã leaderinfo_week.");
      return;
    }

    const rows = data || [];
    if (!rows.length) {
      leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º.";
      return;
    }

    const tabs = document.querySelectorAll('.leader-tab');
    
    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        tabs.forEach((t) => t.classList.remove('active'));
        tab.classList.add('active');
      });
    });
    
    // –ü—Ä–∏–º–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
    const buttons = document.querySelectorAll('.btn');
    
    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        buttons.forEach((b) => b.classList.remove('active'));
        button.classList.add('active');
      });
    });

    const byWeek = new Map();
    for (const r of rows) {
      const key = r.week_start;
      if (!byWeek.has(key)) {
        byWeek.set(key, {
          week_start: r.week_start,
          week_end: r.week_end,
          places: new Map(),
        });
      }
      byWeek.get(key).places.set(Number(r.place), r);
    }

    leadersWrapper.innerHTML = "";

    for (const [, w] of byWeek) {
      const block = document.createElement("div");
      block.className = "week-block";

      const badge = document.createElement("div");
      badge.className = "week-period-badge";
      badge.innerHTML = `<span class="dot"></span>${formatPeriodRu(w.week_start, w.week_end)}`;
      block.appendChild(badge);

      for (let place = 1; place <= 3; place++) {
        const item = w.places.get(place);
        if (item && item.leader) {
          const leader = item.leader;
          const row = {
            id: leader.id,
            nick: leader.nick,
            account_id: leader.account_id,
            avatar_url: leader.avatar_url,
            department: leader.department,
            points: Number(item.points_week || 0),
          };
          block.appendChild(renderLeaderCard(place, row));
        } else {
          block.appendChild(renderLeaderCard(place, null));
        }
      }

      leadersWrapper.appendChild(block);
    }
  }

  /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ ===== */
  const tabDay = document.getElementById("tab-day");
  const tabWeek = document.getElementById("tab-week");
  if (tabDay && tabWeek) {
    const tabs = [tabDay, tabWeek];
    tabs.forEach((btn) => {
      btn.onclick = () => {
        tabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period;
        if (period === "week") loadWeeklyBlocks();
        else loadLeaders("day");
      };
    });
  }

  /* ===== BULK EDIT (LSPD/SFPD/LVPD) ===== */
  const editLeadersTopBtn = document.getElementById("edit-leaders-top");
  const bulkModal = document.getElementById("leaders-bulk-modal");
  const bulkFormsEl = document.getElementById("bulk-forms");
  const bulkCancelBtn = document.getElementById("bulk-cancel");
  const bulkSaveBtn = document.getElementById("bulk-save");
  const bulkErrorEl = document.getElementById("bulk-error");

  let bulkRows = []; // [{id, department, nick, account_id, avatar_url, _ui}]
  let bulkAvatarByDept = {}; // {LSPD: base64|null, ...}

  function showBulkError(msg){
    if(!bulkErrorEl) return;
    bulkErrorEl.style.display = "block";
    bulkErrorEl.textContent = msg || "–û—à–∏–±–∫–∞.";
  }
  function hideBulkError(){
    if(!bulkErrorEl) return;
    bulkErrorEl.style.display = "none";
    bulkErrorEl.textContent = "";
  }

  function openBulkModal(){
    if(!canBulkEdit(currentUser)){
      showErrorModal("–ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ admin –∏ creator.");
      return;
    }
    hideBulkError();
    bulkModal.classList.add("active");
  }
  function closeBulkModal(){
    bulkModal.classList.remove("active");
    bulkRows = [];
    bulkAvatarByDept = {};
    if (bulkFormsEl) bulkFormsEl.innerHTML = "";
    hideBulkError();
  }

  async function fetchLeadersForDepts(){
    const { data, error } = await supabaseClient
      .from("leaderinfo")
      .select("id, department, nick, account_id, avatar_url")
      .in("department", ["LSPD","SFPD","LVPD"]);

    if (error) throw error;

    const map = new Map((data || []).map(r => [String(r.department||"").trim().toUpperCase(), r]));
    const depts = ["LSPD","SFPD","LVPD"];

    return depts.map(d => {
      const r = map.get(d);
      return r ? {
        id: r.id,
        department: d,
        nick: r.nick || "",
        account_id: r.account_id || "",
        avatar_url: r.avatar_url || null
      } : {
        id: null,
        department: d,
        nick: "",
        account_id: "",
        avatar_url: null
      };
    });
  }

  function createBulkCard(row){
    const dept = row.department;

    const wrap = document.createElement("div");
    wrap.style.border = "1px solid rgba(31,41,55,.9)";
    wrap.style.borderRadius = "16px";
    wrap.style.padding = "12px";
    wrap.style.background = "rgba(15,23,42,.55)";
    wrap.style.display = "grid";
    wrap.style.gridTemplateColumns = "110px 1fr";
    wrap.style.gap = "12px";
    wrap.style.alignItems = "start";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.style.gap = "10px";
    left.style.alignItems = "center";

    const badge = document.createElement("div");
    badge.className = "dept-badge " + (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : "lvpd");
    badge.textContent = dept;

    const avatar = document.createElement("div");
    avatar.className = "edit-avatar-preview";
    avatar.style.margin = "0";
    avatar.style.width = "92px";
    avatar.style.height = "92px";

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.style.display = "none";

    const nickInput = document.createElement("input");
    nickInput.type = "text";
    nickInput.value = row.nick || "";
    nickInput.placeholder = "–ò–º—è_–§–∞–º–∏–ª–∏—è";

    const accInput = document.createElement("input");
    accInput.type = "text";
    accInput.value = row.account_id || "";
    accInput.placeholder = "3960680";

    function setAvatarPreview(src){
      avatar.innerHTML = "";
      if(src){
        const img = document.createElement("img");
        img.src = src;
        avatar.appendChild(img);
      } else {
        avatar.textContent = (nickInput.value?.trim()?.[0] || "?");
      }
    }

    setAvatarPreview(row.avatar_url || null);

    function handleFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        bulkAvatarByDept[dept] = reader.result;
        setAvatarPreview(reader.result);
      };
      reader.onerror = () => showBulkError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è " + dept);
      reader.readAsDataURL(file);
    }

    avatar.addEventListener("click", () => fileInput.click());
    avatar.addEventListener("dragover", (e)=>{ e.preventDefault(); avatar.classList.add("drag-over"); });
    avatar.addEventListener("dragleave", ()=> avatar.classList.remove("drag-over"));
    avatar.addEventListener("drop", (e)=>{
      e.preventDefault(); avatar.classList.remove("drag-over");
      const f = e.dataTransfer.files?.[0];
      if(f) handleFile(f);
    });

    fileInput.addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) handleFile(f);
      fileInput.value = "";
    });

    nickInput.addEventListener("input", ()=>{
      if(!bulkAvatarByDept[dept] && !row.avatar_url){
        setAvatarPreview(null);
      }
    });

    left.appendChild(badge);
    left.appendChild(avatar);
    left.appendChild(fileInput);

    const right = document.createElement("div");

    const nickField = document.createElement("div");
    nickField.className = "field";
    const nickLabel = document.createElement("label");
    nickLabel.textContent = "–ù–∏–∫ (" + dept + ")";
    nickField.appendChild(nickLabel);
    nickField.appendChild(nickInput);

    const accField = document.createElement("div");
    accField.className = "field";
    const accLabel = document.createElement("label");
    accLabel.textContent = "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (" + dept + ")";
    accField.appendChild(accLabel);
    accField.appendChild(accInput);

    right.appendChild(nickField);
    right.appendChild(accField);

    wrap.appendChild(left);
    wrap.appendChild(right);

    return { wrap, nickInput, accInput };
  }

  async function buildBulkModal(){
    try{
      hideBulkError();
      bulkFormsEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      bulkRows = await fetchLeadersForDepts();
      bulkAvatarByDept = {};

      bulkFormsEl.innerHTML = "";
      bulkRows.forEach((row) => {
        const ui = createBulkCard(row);
        row._ui = ui;
        bulkFormsEl.appendChild(ui.wrap);
      });
    }catch(e){
      console.error(e);
      showBulkError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤: " + (e?.message || e));
      bulkFormsEl.innerHTML = "";
    }
  }

  async function saveBulk(){
    if(!canBulkEdit(currentUser)){
      showBulkError("–ù–µ—Ç –ø—Ä–∞–≤.");
      return;
    }
    hideBulkError();

    for(const row of bulkRows){
      const nick = row._ui.nickInput.value.trim();
      const acc = row._ui.accInput.value.trim();
      if(!row.id){
        showBulkError(`–í leaderinfo –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ ${row.department}. –í—ã–ø–æ–ª–Ω–∏ SQL –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å 3 –∑–∞–ø–∏—Å–∏).`);
        return;
      }
      if(!nick || !acc){
        showBulkError(`–ó–∞–ø–æ–ª–Ω–∏ –Ω–∏–∫ –∏ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è ${row.department}.`);
        return;
      }
    }

    try{
      for(const row of bulkRows){
        const dept = row.department;
        const payload = {
          department: dept,
          nick: row._ui.nickInput.value.trim(),
          account_id: row._ui.accInput.value.trim(),
          updated_at: new Date().toISOString(),
        };
        if (bulkAvatarByDept[dept]) payload.avatar_url = bulkAvatarByDept[dept];

        const { error } = await supabaseClient
          .from("leaderinfo")
          .update(payload)
          .eq("id", row.id);

        if(error) throw error;
      }

      closeBulkModal();
      await loadLeaders("day");
    }catch(e){
      console.error(e);
      showBulkError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (e?.message || e));
    }
  }

  if (editLeadersTopBtn) {
    editLeadersTopBtn.addEventListener("click", async () => {
      openBulkModal();
      await buildBulkModal();
    });
  }
  if (bulkCancelBtn) bulkCancelBtn.addEventListener("click", closeBulkModal);
  if (bulkSaveBtn) bulkSaveBtn.addEventListener("click", saveBulk);

  /* ===== INIT ===== */
  const userTagEl = document.getElementById("user-tag");

  async function initPage() {
    await loadThemeFromDB();
    applyThemeBackground();
    applyThemeToBlocks();
    applySiteBranding();

    currentUser = loadSession();
    if (userTagEl) {
      if (!currentUser) {
        userTagEl.textContent = "";
      } else {
        userTagEl.textContent = "";
      }
    }

    // ‚úÖ –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å–≤–µ—Ä—Ö—É
    if (editLeadersTopBtn) {
      editLeadersTopBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
    }

    await loadLeaders("day");
  }

  window.addEventListener("load", initPage);
</script>
</body>
</html>
