<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</title>
  <link rel="icon" type="image/png" href="favicon1.ico">
  <link rel="apple-touch-icon" href="favicon1.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --text:#f3f6ff;

      --accent1:#ff2d7a;
      --accent2:#ff4d5e;
      --accent3:#ff6ad5;

      --violet:#a855f7;

      --rXL: 30px;
      --rL: 24px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body{
      min-height:100vh;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      overflow-x:hidden;

      background: url("fon.png") center / cover no-repeat fixed;
      position:relative;
      filter: none;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-4;
      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(124,58,237,.28), transparent 62%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,58,168,.26), transparent 58%),
        radial-gradient(900px 520px at 90% 18%, rgba(46,249,255,.20), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.30) 0%, rgba(0,0,0,.22) 45%, rgba(0,0,0,.34) 100%);
      mix-blend-mode: normal;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-3;
      background:
        radial-gradient(700px 420px at 18% 18%, rgba(255,58,168,.22), transparent 60%),
        radial-gradient(760px 520px at 82% 22%, rgba(46,249,255,.18), transparent 62%),
        linear-gradient(115deg,
          rgba(255,58,168,.10) 0%,
          rgba(46,249,255,.08) 40%,
          rgba(124,58,237,.10) 100%
        ),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14));
      mix-blend-mode: screen;
      opacity: .95;
      filter: blur(0.2px);
    }

    .bg-live{
      position: fixed;
      inset: 0;
      z-index: -3;
      pointer-events:none;
      overflow:hidden;
    }

    .bg-live .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      opacity:.06;
      mix-blend-mode: overlay;
      animation: scanMove 7s linear infinite;
    }
    @keyframes scanMove{
      0%   { transform: translateY(0); }
      100% { transform: translateY(18px); }
    }

    .bg-live .particles{
      position:absolute; inset:0;
      opacity:.16;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 42% 76%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 66%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 52%, rgba(255,58,168,.16) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 62%, rgba(46,249,255,.14) 0 1px, transparent 2px);
      background-size: 520px 520px, 680px 680px, 760px 760px, 900px 900px, 700px 700px, 820px 820px;
      animation: particlesDrift 45s linear infinite;
    }
    @keyframes particlesDrift{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-3%, 2%, 0); }
    }

    .bg-live .vignette{
      position:absolute; inset:-2px;
      background: radial-gradient(circle at center, transparent 0 52%, rgba(0,0,0,.45) 78%, rgba(0,0,0,.78) 100%);
      opacity:.95;
    }

    @media (max-width: 900px){
      body{ background-attachment: scroll; }
    }

    #app{
      width:100%;
      max-width:1200px;
      position:relative;
      z-index:1;
    }
    .page-header{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      margin-bottom: 14px;
      padding-top: 6px;
    }
    .page-title-block{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
    }
    .page-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.01em;
      text-shadow:
        0 0 20px rgba(255,58,168,.20),
        0 0 44px rgba(46,249,255,.12);
    }
    .user-tag{ font-size:12px; color: rgba(243,246,255,.60); margin-top:2px; }

    .page-header-actions{
      position:absolute;
      right:0;
      top:0;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn{
      border: 1px solid rgba(255,45,122,.45);
      background: rgba(0,0,0,.10);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 26px rgba(255,45,122,.18);
      color: rgba(243,246,255,.90);
      cursor:pointer;
      border-radius: 12px;
    }
    .btn:hover{
      border-color: rgba(255,77,94,.55);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 34px rgba(255,45,122,.24),
        0 0 54px rgba(255,106,213,.16);
    }
    .btn-sm{ padding: 11px 18px; font-size: 14px; }

    .leader-panel{ background: transparent; border: none; box-shadow: none; }

    .leader-panel-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
      position:relative;
      z-index:1;
      width: 100%;
    }

    .leader-tabs{
      display: flex !important;
      flex-direction: row !important;
      align-items: stretch;
      justify-content: center;

      width: min(860px, 100%);
      margin: 0 auto;

      border-radius: 999px;
      padding: 6px;

      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 16px 46px rgba(0,0,0,.28),
        0 0 26px rgba(255,45,122,.10);

      overflow: hidden;
    }

    .leader-tab{
      flex: 1 1 0;
      min-width: 0 !important;
      white-space: nowrap;

      position:relative;
      border:0;
      background: transparent;
      border-radius: 999px;

      padding: 14px 18px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .10em;
      text-transform: uppercase;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;

      color: rgba(243,246,255,.78);
      cursor:pointer;
      transition: transform .14s ease, color .14s ease, filter .14s ease;
      z-index:1;
    }

    .leader-tab:hover{
      transform: translateY(-1px);
      color: rgba(255,255,255,.94);
      filter: drop-shadow(0 0 12px rgba(255,45,122,.22));
    }

    .leader-tab.active{
      color: #fff;
      text-shadow: 0 0 18px rgba(255,45,122,.22);
    }

    .leader-tab.active::before{
      content:"";
      position:absolute;
      inset:-2px -10px -2px -2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,45,122,.95), rgba(255,77,94,.85));
      box-shadow:
        0 0 30px rgba(255,45,122,.30),
        0 0 44px rgba(255,77,94,.18);
      z-index:-2;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
    }

    .leader-tab.active::after{
      content:"";
      position:absolute;
      inset: 2px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      z-index:-1;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .leader-date{
      font-size: 18px;
      letter-spacing:.10em;
      color: rgba(243,246,255,.72);
      margin-top: 4px;
      text-shadow: 0 0 18px rgba(46,249,255,.10);
    }

    .leaders-wrapper{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:18px;
      position:relative;
      z-index:1;
    }


    .leader-card{
      position:relative;
      display:flex;
      align-items:center;
      gap: 22px;
      padding: 18px 24px;
      border-radius: var(--rL);

      background: rgba(0,0,0,.08);
      border: 2px solid rgba(255,255,255,.10);

      box-shadow: 0 14px 54px rgba(0,0,0,.30);
      overflow:hidden;

      clip-path: polygon(
        0% 0%,
        100% 0%,
        100% calc(100% - 26px),
        calc(100% - 26px) 100%,
        0% 100%,
        0% 0%
      );

      transition:
        transform .18s ease,
        box-shadow .18s ease,
        background .18s ease,
        border-color .18s ease,
        filter .18s ease;

      contain: paint;
      will-change: transform;
    }

    .leader-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--rL) + 2px);

      background: linear-gradient(90deg,
        rgba(255,45,122,0) 0%,
        rgba(255,45,122,.95) 14%,
        rgba(255,77,94,.95) 34%,
        rgba(255,106,213,.95) 54%,
        rgba(168,85,247,.90) 72%,
        rgba(255,45,122,.95) 88%,
        rgba(255,45,122,0) 100%
      );

      background-size: 380% 100%;
      background-position: 0% 50%;

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      padding: 3px;
      opacity: .98;
      filter: blur(.16px);
      pointer-events:none;

      animation: borderFlow 10s linear infinite;
      animation-play-state: paused;
    }

    .leader-card:hover::before{ animation-play-state: running; }

    @keyframes borderFlow{
      0%   { background-position:   0% 50%; }
      100% { background-position: 380% 50%; }
    }

    .leader-card:hover{
      transform: translateY(-7px);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(0,0,0,.06);
      border-color: rgba(46,249,255,.22);
      box-shadow:
        0 24px 80px rgba(0,0,0,.45),
        0 0 44px rgba(46,249,255,.20),
        0 0 52px rgba(255,58,168,.18);
      filter: saturate(1.10) brightness(1.02);
    }

    .leader-card .sheen{
      position:absolute;
      inset:-40% -60%;
      pointer-events:none;
      background: linear-gradient(115deg,
        transparent 0%,
        rgba(255,255,255,.00) 35%,
        rgba(255,255,255,.16) 45%,
        rgba(255,58,168,.12) 50%,
        rgba(46,249,255,.12) 55%,
        rgba(255,255,255,.00) 65%,
        transparent 100%
      );
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: opacity .16s ease;
      mix-blend-mode: screen;
    }
    .leader-card:hover .sheen{
      opacity: 1;
      animation: sheenSweep .75s ease-out 1;
    }
    @keyframes sheenSweep{
      0%   { transform: translateX(-60%) rotate(10deg); }
      100% { transform: translateX( 60%) rotate(10deg); }
    }

    .leader-icon{
      width: 58px;
      height: 58px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;
      background: rgba(0,0,0,.03);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 22px rgba(46,249,255,.10);
      flex-shrink:0;
    }

    .leader-avatar{
      width: 72px;
      height: 72px;
      border-radius: 18px;
      border: 2px solid rgba(255,58,168,.32);
      background: rgba(0,0,0,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      font-size: 26px;
      flex-shrink:0;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(255,58,168,.10);
    }
    .leader-avatar img{ width:100%; height:100%; object-fit: cover; }

    .leader-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .leader-name-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 12px;
    }

    .leader-nick{
      font-size: 32px;
      font-weight: 900;
      letter-spacing: .01em;
      text-shadow:
        0 0 16px rgba(255,58,168,.12),
        0 0 24px rgba(46,249,255,.10);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    .leader-account{
      font-size: 16px;
      font-weight: 800;
      color: rgba(255,102,214,.92);
      text-shadow: 0 0 14px rgba(255,58,168,.12);
    }

    .dept-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.04);
    }
    .dept-badge.lspd{ color:#28e07a; box-shadow: 0 0 18px rgba(40,224,122,.10); }
    .dept-badge.sfpd{ color:#2fc7ff; box-shadow: 0 0 18px rgba(47,199,255,.10); }
    .dept-badge.lvpd{ color:#ff5a7e; box-shadow: 0 0 18px rgba(255,90,126,.10); }

    .leader-score-block{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      min-width: 220px;
      flex-shrink:0;
    }

    .leader-score{
      display:flex;
      align-items:baseline;
      gap: 10px;
      font-weight: 900;
    }

    .leader-score .value{
      font-size: 56px;
      letter-spacing: .02em;
      background: linear-gradient(90deg, rgba(255,45,122,1), rgba(255,77,94,.98));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;
      filter:
        drop-shadow(0 0 14px rgba(255,45,122,.45))
        drop-shadow(0 0 26px rgba(255,77,94,.25));
    }

    .leader-score .unit{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,106,213,.95);
      text-shadow:
        0 0 10px rgba(255,45,122,.30),
        0 0 18px rgba(255,106,213,.22);
    }

    .leader-place-label{
      font-size: 16px;
      color: rgba(243,246,255,.72);
      letter-spacing: .06em;
      text-shadow: 0 0 16px rgba(46,249,255,.08);
    }

    .leader-empty{ font-size: 16px; color: rgba(243,246,255,.62); }


    .week-summary{
      position: relative;
      border-radius: 26px;
      padding: 16px 18px 14px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;

      box-shadow: 0 18px 70px rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease, background .16s ease;
      contain: paint;
      will-change: transform;
    }

    .week-summary::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 28px;

      background: conic-gradient(
        from 0deg,
        rgba(255,45,122,0) 0deg,
        rgba(255,45,122,.90) 55deg,
        rgba(46,249,255,.85) 110deg,
        rgba(168,85,247,.85) 165deg,
        rgba(255,106,213,.85) 235deg,
        rgba(255,77,94,.90) 300deg,
        rgba(255,45,122,0) 360deg
      );

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      padding: 2px;
      opacity: .70;
      filter: blur(.25px);
      pointer-events:none;

      animation: weekBorderSpin 10s linear infinite;
      animation-play-state: paused;
    }
    .week-summary:hover::before{ animation-play-state: running; opacity:.92; }
    @keyframes weekBorderSpin { to { transform: rotate(360deg); } }

    .week-summary:hover{
      transform: translateY(-5px);
      border-color: rgba(46,249,255,.22);
      background: rgba(0,0,0,.05);
      box-shadow:
        0 26px 88px rgba(0,0,0,.42),
        0 0 40px rgba(255,45,122,.14),
        0 0 46px rgba(46,249,255,.12);
    }

    .week-summary .sheen{
      position:absolute;
      inset:-60% -70%;
      pointer-events:none;
      background: linear-gradient(115deg,
        transparent 0%,
        rgba(255,255,255,.00) 35%,
        rgba(255,255,255,.14) 45%,
        rgba(255,45,122,.10) 52%,
        rgba(46,249,255,.10) 58%,
        rgba(255,255,255,.00) 70%,
        transparent 100%
      );
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: opacity .16s ease;
      mix-blend-mode: screen;
    }
    .week-summary:hover .sheen{
      opacity: 1;
      animation: weekSheen .8s ease-out 1;
    }
    @keyframes weekSheen{
      0%   { transform: translateX(-60%) rotate(10deg); }
      100% { transform: translateX( 60%) rotate(10deg); }
    }

    .week-summary-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 12px;
      position:relative;
      padding-right: 140px;
      min-height: 54px;
    }

    .week-summary-period{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(243,246,255,.78);
      text-shadow: 0 0 14px rgba(46,249,255,.08);
      line-height: 1.1;
    }
    .week-summary-period .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,45,122,.95);
      box-shadow: 0 0 14px rgba(255,45,122,.35);
      flex: 0 0 auto;
    }


    .week-total-orbit{
      position:absolute;
      top: 4px;
      right: 10px;

      width: 124px;
      height: 56px;

      pointer-events:none; 
      z-index: 2;
    }

    .week-total-chip{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);

      display:inline-flex;
      align-items:baseline;
      gap: 10px;

      padding: 12px 14px;
      border-radius: 999px;

      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);

      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(255,45,122,.20),
        0 0 26px rgba(46,249,255,.10);

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      will-change: transform;
      animation: chipHover 4.2s ease-in-out infinite;
    }

    .week-total-chip::before{
      content:"";
      position:absolute;
      inset:-10px -14px;
      border-radius: 999px;
      background:
        radial-gradient(closest-side, rgba(255,45,122,.22), transparent 70%),
        radial-gradient(closest-side, rgba(46,249,255,.14), transparent 72%);
      filter: blur(6px);
      opacity: .95;
      pointer-events:none;
    }

    .week-total-chip::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 999px;
      background: conic-gradient(
        from 0deg,
        rgba(255,45,122,0) 0deg,
        rgba(255,45,122,.85) 70deg,
        rgba(46,249,255,.75) 140deg,
        rgba(168,85,247,.70) 210deg,
        rgba(255,77,94,.80) 290deg,
        rgba(255,45,122,0) 360deg
      );

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      padding: 2px;
      opacity: .55;
      filter: blur(.25px);
      pointer-events:none;

      animation: chipBorderSpin 8s linear infinite;
    }
    @keyframes chipBorderSpin{ to { transform: rotate(360deg); } }

    @keyframes chipHover{
      0%   { transform: translate(calc(-50% + 0px),   calc(-50% - 2px)); }
      25%  { transform: translate(calc(-50% + 6px),   calc(-50% + 2px)); }
      50%  { transform: translate(calc(-50% + 0px),   calc(-50% + 6px)); }
      75%  { transform: translate(calc(-50% - 6px),   calc(-50% + 2px)); }
      100% { transform: translate(calc(-50% + 0px),   calc(-50% - 2px)); }
    }

    .week-total-chip .label{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(243,246,255,.72);
      text-shadow: 0 0 14px rgba(46,249,255,.08);
      white-space: nowrap;
    }

    .week-total-chip .num{
      font-size: 24px;
      letter-spacing: .02em;
      background: linear-gradient(90deg, rgba(255,45,122,1), rgba(255,77,94,.98));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 14px rgba(255,45,122,.45)) drop-shadow(0 0 26px rgba(255,77,94,.25));
      white-space: nowrap;
    }

    .week-top3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .week-slot{
      position:relative;
      padding: 12px 12px 10px;
      border-radius: 18px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      box-shadow: 0 10px 34px rgba(0,0,0,.22);
    }

    .week-slot::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;
      opacity:.8;
    }

    .week-slot .rank{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
      color: rgba(243,246,255,.80);
      letter-spacing: .08em;
      text-transform: uppercase;
      font-weight: 900;
      font-size: 12px;
    }

    .week-slot .emoji{
      font-size: 20px;
      filter: drop-shadow(0 0 10px rgba(46,249,255,.12));
    }

    .week-slot .name-line{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      margin-bottom: 8px;
    }

    .week-slot .nick{
      font-size: 20px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 0 14px rgba(46,249,255,.08);
      min-width: 0;
    }

    .week-slot .dept-pill{
      display:inline-flex;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      white-space: nowrap;
      flex: 0 0 auto;
      box-shadow: 0 0 16px rgba(255,45,122,.10);
    }
    .week-slot .dept-pill.lspd{ color:#28e07a; box-shadow: 0 0 16px rgba(40,224,122,.10); }
    .week-slot .dept-pill.sfpd{ color:#2fc7ff; box-shadow: 0 0 16px rgba(47,199,255,.10); }
    .week-slot .dept-pill.lvpd{ color:#ff5a7e; box-shadow: 0 0 16px rgba(255,90,126,.10); }
    .week-slot .dept-pill.unk { color: rgba(243,246,255,.72); }

    .week-slot .ash{
      display:flex;
      align-items:baseline;
      gap:8px;
      font-weight: 900;
    }
    .week-slot .ash .num{
      font-size: 30px;
      background: linear-gradient(90deg, rgba(255,45,122,1), rgba(255,77,94,.98));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 12px rgba(255,45,122,.35)) drop-shadow(0 0 22px rgba(255,77,94,.18));
    }
    .week-slot .ash .unit{
      font-size: 13px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,106,213,.92);
      text-shadow: 0 0 12px rgba(255,45,122,.20);
    }

    @media (max-width: 980px){
      .week-top3{ grid-template-columns: 1fr; }
      .week-summary-head{ padding-right: 0; }
      .week-total-orbit{
        position: static;
        width: auto;
        height: auto;
        margin-left: auto;
      }
      .week-total-chip{
        position: relative;
        left: auto; top: auto;
        transform: none;
        animation: chipHover 4.2s ease-in-out infinite;
      }
      @keyframes chipHover{
        0%   { transform: translate(0px, -2px); }
        25%  { transform: translate(6px,  2px); }
        50%  { transform: translate(0px,  6px); }
        75%  { transform: translate(-6px, 2px); }
        100% { transform: translate(0px, -2px); }
      }
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width:100%;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 28px 80px rgba(0,0,0,.72);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }

    @media (prefers-reduced-motion: reduce){
      .bg-live .scanlines,
      .bg-live .particles,
      .leader-card::before,
      .leader-card .sheen,
      .week-summary::before,
      .week-summary .sheen,
      .week-total-chip,
      .week-total-chip::after{
        animation: none !important;
      }
    }

    @media (max-width: 720px){
  
      .leader-tabs{
        flex-direction: column !important;
        gap: 10px;
        padding: 10px;
        border-radius: 22px;
      }
    
      .leader-tab{
        width: 100%;
        font-size: 14px;
        padding: 14px 16px;
        letter-spacing: .08em;
      }
    
      .leader-card{
        position: relative;
        flex-direction: row;
        align-items: center;
        padding: 16px 14px;
        gap: 14px;
      }

      .leader-icon{
        width: 46px;
        height: 46px;
        font-size: 22px;
        flex-shrink: 0;
      }
    
      .leader-main{
        flex: 1;
        align-items: center;
        text-align: center;
        gap: 6px;
        transform: translateX(6px);
      }
    
      .leader-avatar{
        width: 64px;
        height: 64px;
        margin: 0 auto 4px;
        transform: translateX(6px);
      }
    
      .leader-name-row{
        justify-content: center;
        gap: 6px;
      }
    
      .leader-nick{
        font-size: 22px;
      }
    
      .leader-account{
        font-size: 13px;
      }
    
      .dept-badge{
        font-size: 11px;
        padding: 6px 10px;
      }
    
      .leader-score-block{
        align-items: flex-end;
        min-width: auto;
        padding-top: 12px;
        margin-right: -6px;
      }
    
      .leader-score .value{
        font-size: 42px;
      }
    
      .leader-score .unit{
        font-size: 13px;
      }
    
      .leader-place-label{
        position: absolute;
        top: 10px;
        right: 12px;
        font-size: 12px;
        letter-spacing: .08em;
        opacity: .9;
      }
    
    }

    .btn-outline{
      border: 1px solid rgba(255,255,255,.22);
      background: transparent;
      color: rgba(243,246,255,.9);
      cursor:pointer;
      border-radius: 12px;
      padding: 11px 18px;
      font-size: 14px;
    }
    .btn-outline:hover{ border-color: rgba(255,77,94,.55); }
    
    .field{ margin-bottom: 8px; }
    .field label{ display:block; font-size:13px; margin-bottom:3px; color: rgba(243,246,255,.75); }
    .field input{
      width:100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(243,246,255,.92);
    }
    .error-text{ font-size:12px; color:#ff7b7b; margin-top: 6px; }
    
    .edit-avatar-preview{
      width: 92px; height: 92px;
      border-radius: 18px;
      border: 2px dashed rgba(255,255,255,.25);
      background: rgba(0,0,0,.20);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; cursor:pointer;
    }
    .edit-avatar-preview img{ width:100%; height:100%; object-fit:cover; }
    .drag-over{ outline: 3px solid rgba(46,249,255,.6); }

    .reactions-panel{
      margin-top: 18px;
      border-radius: 22px;
      padding: 14px 14px 12px;
    
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 54px rgba(0,0,0,.22);
      overflow: hidden;
    }
    
    .reactions-title{
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(243,246,255,.78);
      margin-bottom: 12px;
      text-shadow: 0 0 14px rgba(46,249,255,.08);
    }
    
    .reactions-grid{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    .reaction-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    
      padding: 12px 12px;
      border-radius: 16px;
    
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.12);
    
      color: rgba(243,246,255,.88);
      cursor: pointer;
    
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    
    .reaction-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,77,94,.40);
      box-shadow: 0 0 22px rgba(255,45,122,.14);
    }
    
    .reaction-btn.active{
      border-color: rgba(255,45,122,.55);
      box-shadow:
        0 0 22px rgba(255,45,122,.18),
        0 0 26px rgba(46,249,255,.10);
    }
    
    .reaction-emoji{ font-size: 18px; }
    .reaction-label{ font-weight: 900; letter-spacing: .06em; text-transform: uppercase; font-size: 12px; opacity: .92; }
    .reaction-count{
      margin-left: 2px;
      min-width: 28px;
      text-align:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,45,122,.10);
      border: 1px solid rgba(255,45,122,.18);
      font-weight: 900;
    }
    
    .reactions-hint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(243,246,255,.62);
    }
    
    @media (max-width: 900px){
      .reactions-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    
        

        
  </style>
</head>

<body>
  <div class="bg-live" aria-hidden="true">
    <div class="particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
  </div>

  <div id="app">
    <div class="page-header">
      <div class="page-title-block">
        <div class="page-title">–¢–û–ü –õ–ò–î–ï–†–û–í PD</div>
        <div class="user-tag" id="user-tag"></div>
      </div>

      <div id="leaders-bulk-modal" class="modal-backdrop">
        <div class="modal" style="max-width: 720px;">
          <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤</h3>
          <p>–ú–µ–Ω—è—é—Ç—Å—è –Ω–∏–∫, –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤–∞—Ç–∞—Ä</p>
      
          <div id="bulk-error" class="error-text" style="display:none;"></div>
          <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>
      
          <div class="modal-footer">
            <button class="btn-outline btn-sm" id="bulk-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-sm" id="bulk-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>


      <div class="page-header-actions">
        <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–µ—Ä–æ–≤</button>
      </div>
    </div>

    <div class="leader-panel">
      <div class="leader-panel-header">
        <div class="leader-tabs">
          <button class="leader-tab active" id="tab-day" data-period="day">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
          </button>
          <button class="leader-tab" id="tab-week" data-period="week">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
          </button>
        </div>
        <div class="leader-date" id="leader-date"></div>
      </div>

      <div class="leaders-wrapper" id="leaders-wrapper">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

      <div class="reactions-panel" id="reactions-panel">
    
      <div class="reactions-grid">
        <button class="reaction-btn" data-reaction="like" type="button">
          <span class="reaction-emoji">üëç</span>
          <span class="reaction-count" id="rc-like">0</span>
        </button>
    
        <button class="reaction-btn" data-reaction="dislike" type="button">
          <span class="reaction-emoji">üëé</span>
          <span class="reaction-count" id="rc-dislike">0</span>
        </button>
    
        <button class="reaction-btn" data-reaction="ura" type="button">
          <span class="reaction-emoji">üéâ</span>
          <span class="reaction-count" id="rc-ura">0</span>
        </button>
    
        <button class="reaction-btn" data-reaction="govno" type="button">
          <span class="reaction-emoji">üí©</span>
          <span class="reaction-count" id="rc-govno">0</span>
        </button>
      </div>
    
      <div class="reactions-hint" id="reactions-hint"></div>
    </div>

      
    </div>
  </div>

  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>

    let currentUser = null;
    function loadSession() {
      try { return JSON.parse(localStorage.getItem("pp_user")); }
      catch { return null; }
    }
    function canBulkEdit(user) {
      const role = String(user?.role || "").trim().toLowerCase();
      return role === "admin" || role === "creator";
    }

    const API_BASE = "/api"; 

    async function apiGet(path) {
      const r = await fetch(API_BASE + path, { credentials: "include" });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    
    async function apiPost(path, body) {
      const r = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body),
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }


    const errorModal = document.getElementById("error-modal");
    const errorModalText = document.getElementById("error-modal-text");
    const errorModalClose = document.getElementById("error-modal-close");
    function showErrorModal(message) {
      errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
      errorModal.classList.add("active");
    }
    if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

    function monthRuUpper(monthIndex) {
      const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
      return m[monthIndex] || "";
    }
    function parseDateOnly(iso) {
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function formatPeriodRu(startISO, endISO) {
      const s = parseDateOnly(startISO);
      const e = parseDateOnly(endISO);
      return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
    }

    const leadersWrapper = document.getElementById("leaders-wrapper");
    const dateEl = document.getElementById("leader-date");
    let currentPeriod = "day";

    function renderLeaderCard(place, row) {
      const card = document.createElement("div");
      card.className = "leader-card rank-" + place;

      const sheen = document.createElement("div");
      sheen.className = "sheen";
      card.appendChild(sheen);

      const icon = document.createElement("div");
      icon.className = "leader-icon";
      icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";

      const main = document.createElement("div");
      main.className = "leader-main";

      const scoreBlock = document.createElement("div");
      scoreBlock.className = "leader-score-block";

      if (row) {
        if (row.avatar_url) {
          const img = document.createElement("img");
          img.src = row.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = row.nick ? row.nick[0] : "?";
        }

        const nameRow = document.createElement("div");
        nameRow.className = "leader-name-row";

        const nickEl = document.createElement("div");
        nickEl.className = "leader-nick";
        nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

        const accEl = document.createElement("div");
        accEl.className = "leader-account";
        accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

        nameRow.appendChild(nickEl);
        nameRow.appendChild(accEl);

        const dept = (row.department || "").trim().toUpperCase();
        const deptEl = document.createElement("div");
        deptEl.className =
          "dept-badge " +
          (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
        deptEl.textContent = dept || "‚Äî";

        main.appendChild(nameRow);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = row.points ?? 0;

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      } else {
        avatar.textContent = "?";
        const emptyTitle = document.createElement("div");
        emptyTitle.className = "leader-empty";
        emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
        main.appendChild(emptyTitle);
      }

      card.appendChild(icon);
      card.appendChild(avatar);
      card.appendChild(main);
      card.appendChild(scoreBlock);

      return card;
    }

    async function loadLeaders(period = "day") {
      currentPeriod = period;
    
      if (dateEl) {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        dateEl.textContent = `${dd}.${mm}.${yyyy}`;
      }
    
      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    
      try {
        // –æ–∂–∏–¥–∞–µ–º: [{id,nick,account_id,avatar_url,department,points}]
        const rows = await apiGet("/leaders/day?limit=3");
    
        const slots = [0,1,2].map((i) => rows?.[i] || null);
        leadersWrapper.innerHTML = "";
        slots.forEach((row, idx) => leadersWrapper.appendChild(renderLeaderCard(idx + 1, row)));
      } catch (e) {
        console.error(e);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è!");
      }
    }


    function deptClass(dept){
      const d = String(dept || "").trim().toUpperCase();
      if (d === "LSPD") return "lspd";
      if (d === "SFPD") return "sfpd";
      if (d === "LVPD") return "lvpd";
      return "unk";
    }

    function renderWeeklySummaryBlock(row){
      const wrap = document.createElement("div");
      wrap.className = "week-summary";

      const sheen = document.createElement("div");
      sheen.className = "sheen";
      wrap.appendChild(sheen);

      const head = document.createElement("div");
      head.className = "week-summary-head";

      const period = document.createElement("div");
      period.className = "week-summary-period";
      period.innerHTML = `<span class="dot"></span>${formatPeriodRu(row.week_start, row.week_end)}`;

      const orbit = document.createElement("div");
      orbit.className = "week-total-orbit";

      const chip = document.createElement("div");
      chip.className = "week-total-chip";
      chip.innerHTML = `<span class="label">–û–ë–©–ï–ï</span><span class="num">${Number(row.total_ash || 0)}</span>`;

      orbit.appendChild(chip);

      head.appendChild(period);
      head.appendChild(orbit);
      wrap.appendChild(head);

      const top3 = document.createElement("div");
      top3.className = "week-top3";

      const slots = [
        { place: 1, nick: row.nick_1, dept: row.dept_1, ash: row.ash_1 },
        { place: 2, nick: row.nick_2, dept: row.dept_2, ash: row.ash_2 },
        { place: 3, nick: row.nick_3, dept: row.dept_3, ash: row.ash_3 },
      ];

      for (const s of slots){
        const slot = document.createElement("div");
        slot.className = "week-slot";

        const rank = document.createElement("div");
        rank.className = "rank";
        const emoji = s.place === 1 ? "üèÜ" : (s.place === 2 ? "ü•à" : "ü•â");
        rank.innerHTML = `<span class="emoji">${emoji}</span><span>${s.place} –º–µ—Å—Ç–æ</span>`;

        const nameLine = document.createElement("div");
        nameLine.className = "name-line";

        const nick = document.createElement("div");
        nick.className = "nick";
        nick.textContent = (s.nick || "‚Äî").trim() || "‚Äî";

        const deptPill = document.createElement("div");
        deptPill.className = "dept-pill " + deptClass(s.dept);
        deptPill.textContent = (String(s.dept || "").trim().toUpperCase() || "‚Äî");

        nameLine.appendChild(nick);
        nameLine.appendChild(deptPill);

        const ash = document.createElement("div");
        ash.className = "ash";
        ash.innerHTML = `<span class="num">${Number(s.ash || 0)}</span><span class="unit">–ê–®</span>`;

        slot.appendChild(rank);
        slot.appendChild(nameLine);
        slot.appendChild(ash);

        top3.appendChild(slot);
      }

      wrap.appendChild(top3);
      return wrap;
    }

    async function loadWeeklyBlocks() {
      currentPeriod = "week";
      if (dateEl) dateEl.textContent = "";
    
      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    
      try {
        // –æ–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –∏–∑ leader_weekly_summary
        const data = await apiGet("/leaders/week?limit=8");
    
        if (!data || !data.length) {
          leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º";
          return;
        }
    
        leadersWrapper.innerHTML = "";
        for (const row of data) leadersWrapper.appendChild(renderWeeklySummaryBlock(row));
      } catch (e) {
        console.error(e);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏!";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!");
      }
    }


    const tabDay = document.getElementById("tab-day");
    const tabWeek = document.getElementById("tab-week");
    if (tabDay && tabWeek) {
      const tabs = [tabDay, tabWeek];
      tabs.forEach((btn) => {
        btn.onclick = () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const period = btn.dataset.period;
          if (period === "week") loadWeeklyBlocks();
          else loadLeaders("day");
        };
      });
    }

    const editLeadersTopBtn = document.getElementById("edit-leaders-top");
    const bulkModal = document.getElementById("leaders-bulk-modal");
    const bulkFormsEl = document.getElementById("bulk-forms");
    const bulkCancelBtn = document.getElementById("bulk-cancel");
    const bulkSaveBtn = document.getElementById("bulk-save");
    const bulkErrorEl = document.getElementById("bulk-error");
    
    let bulkRows = [];
    let bulkAvatarByDept = {};
    
    function showBulkError(msg){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "block";
      bulkErrorEl.textContent = msg || "–û—à–∏–±–∫–∞.";
    }
    function hideBulkError(){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "none";
      bulkErrorEl.textContent = "";
    }
    
    function openBulkModal(){
      if(!canBulkEdit(currentUser)){
        showErrorModal("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.");
        return;
      }
      hideBulkError();
      bulkModal.classList.add("active");
    }
    
    function closeBulkModal(){
      bulkModal.classList.remove("active");
      bulkRows = [];
      bulkAvatarByDept = {};
      if (bulkFormsEl) bulkFormsEl.innerHTML = "";
      hideBulkError();
    }
    
    async function fetchLeadersForDepts(){
      // –æ–∂–∏–¥–∞–µ–º: [{id, department, nick, account_id, avatar_url}]
      return apiGet("/leaders/by-depts?depts=LSPD,SFPD,LVPD");
    }

    
    function createBulkCard(row){
      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.12)";
      wrap.style.borderRadius = "14px";
      wrap.style.padding = "12px";
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "100px 1fr";
      wrap.style.gap = "12px";
    
      const avatar = document.createElement("div");
      avatar.className = "edit-avatar-preview";
      avatar.textContent = row.nick?.[0] || "?";
    
      if(row.avatar_url){
        avatar.innerHTML = `<img src="${row.avatar_url}">`;
      }
    
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
    
      avatar.onclick = () => fileInput.click();
      fileInput.onchange = e => {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          bulkAvatarByDept[row.department] = reader.result;
          avatar.innerHTML = `<img src="${reader.result}">`;
        };
        reader.readAsDataURL(f);
      };
    
      const nickInput = document.createElement("input");
      nickInput.value = row.nick || "";
      const accInput = document.createElement("input");
      accInput.value = row.account_id || "";
    
      const right = document.createElement("div");
      right.innerHTML = `
        <div class="field"><label>${row.department} –Ω–∏–∫</label></div>
        <div class="field"><label>${row.department} –∞–∫–∫–∞—É–Ω—Ç</label></div>
      `;
      right.children[0].appendChild(nickInput);
      right.children[1].appendChild(accInput);
    
      wrap.appendChild(avatar);
      wrap.appendChild(fileInput);
      wrap.appendChild(right);
    
      return { wrap, nickInput, accInput };
    }
    
    async function buildBulkModal(){
      bulkFormsEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      bulkRows = await fetchLeadersForDepts();
      bulkFormsEl.innerHTML = "";
    
      bulkRows.forEach(row => {
        const ui = createBulkCard(row);
        row._ui = ui;
        bulkFormsEl.appendChild(ui.wrap);
      });
    }
    
    async function saveBulk(){
      hideBulkError();
    
      for(const row of bulkRows){
        if(!row.id) return showBulkError(`–ù–µ—Ç –∑–∞–ø–∏—Å–∏ leaderinfo –¥–ª—è ${row.department}`);
        if(!row._ui.nickInput.value || !row._ui.accInput.value) return showBulkError(`–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è (${row.department})`);
      }
    
      const rows = bulkRows.map(row => ({
        id: row.id,
        department: row.department,
        nick: row._ui.nickInput.value.trim(),
        account_id: row._ui.accInput.value.trim(),
        avatar_base64: bulkAvatarByDept[row.department] || null
      }));
    
      try {
        await apiPost("/leaders/bulk", { rows });
        closeBulkModal();
        currentPeriod === "week" ? loadWeeklyBlocks() : loadLeaders("day");
      } catch (e) {
        console.error(e);
        showBulkError(String(e.message || e));
      }
    }

    
    if(editLeadersTopBtn){
      editLeadersTopBtn.onclick = async () => {
        openBulkModal();
        await buildBulkModal();
      };
    }
    if(bulkCancelBtn) bulkCancelBtn.onclick = closeBulkModal;
    if(bulkSaveBtn) bulkSaveBtn.onclick = saveBulk;

    /* ================= REACTIONS ================= */
    const REACTIONS_PAGE_KEY = "leaders_pd"; // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    
    function getOrCreateAnonId(){
      const k = "pp_anon_id";
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random().toString(16).slice(2)));
        localStorage.setItem(k, v);
      }
      return v;
    }
    
    function getUserKey(){
      // –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏
      // (–ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É pp_user, –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω—ã–µ –ø–æ–ª—è)
      return (
        currentUser?.id ||
        currentUser?.account_id ||
        currentUser?.accountId ||
        currentUser?.login ||
        currentUser?.nick ||
        getOrCreateAnonId()
      ).toString();
    }
    
    function setReactionButtonsActive(activeReaction){
      document.querySelectorAll(".reaction-btn").forEach(btn => {
        const r = btn.getAttribute("data-reaction");
        btn.classList.toggle("active", r === activeReaction);
      });
    }
    
    function setCountsFromMap(map){
      const safe = (x) => (Number.isFinite(x) ? x : 0);
      document.getElementById("rc-like").textContent = safe(map.like);
      document.getElementById("rc-dislike").textContent = safe(map.dislike);
      document.getElementById("rc-ura").textContent = safe(map.ura);
      document.getElementById("rc-govno").textContent = safe(map.govno);
    }
    
    async function refreshReactionCounts(){
      try {
        const data = await apiGet(`/reactions/counts?page=${encodeURIComponent(REACTIONS_PAGE_KEY)}`);
        // –æ–∂–∏–¥–∞–µ–º: [{reaction:"like", cnt:123}, ...]
        const map = { like:0, dislike:0, ura:0, govno:0 };
        (data || []).forEach(row => { map[row.reaction] = Number(row.cnt || 0); });
        setCountsFromMap(map);
      } catch (e) {
        console.error("counts error:", e);
      }
    }

    
    async function fetchMyReaction(){
      try {
        const userKey = getUserKey();
        const data = await apiGet(`/reactions/my?page=${encodeURIComponent(REACTIONS_PAGE_KEY)}&user_key=${encodeURIComponent(userKey)}`);
        return data?.reaction || null; // –æ–∂–∏–¥–∞–µ–º {reaction:"like"} –∏–ª–∏ {}
      } catch (e) {
        console.error("my reaction error:", e);
        return null;
      }
    }

    
    async function setMyReaction(nextReaction){
      const userKey = getUserKey();
      const hint = document.getElementById("reactions-hint");
    
      try {
        const current = await fetchMyReaction();
    
        // toggle: –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ —Ç—É –∂–µ ‚Äî —É–¥–∞–ª—è–µ–º
        if (current === nextReaction) {
          await apiPost("/reactions/set", {
            page: REACTIONS_PAGE_KEY,
            user_key: userKey,
            reaction: null
          });
          setReactionButtonsActive(null);
          if (hint) hint.textContent = "–†–µ–∞–∫—Ü–∏—è —É–±—Ä–∞–Ω–∞.";
          await refreshReactionCounts();
          return;
        }
    
        await apiPost("/reactions/set", {
          page: REACTIONS_PAGE_KEY,
          user_key: userKey,
          reaction: nextReaction
        });
    
        setReactionButtonsActive(nextReaction);
        if (hint) hint.textContent = "–†–µ–∞–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.";
        await refreshReactionCounts();
      } catch (e) {
        console.error("reaction set error:", e);
        if (hint) hint.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é.";
      }
    }

    
    function bindReactionButtons(){
      document.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const r = btn.getAttribute("data-reaction");
          await setMyReaction(r);
        });
      });
    }
    
    async function initReactions(){
      bindReactionButtons();
    
      // 1) —Å—á—ë—Ç—á–∏–∫–∏
      await refreshReactionCounts();
    
      // 2) –º–æ—è —Ä–µ–∞–∫—Ü–∏—è (–ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å)
      const my = await fetchMyReaction();
      setReactionButtonsActive(my);
    }



    const userTagEl = document.getElementById("user-tag");
    async function initPage() {
      currentUser = loadSession();
      if (userTagEl) userTagEl.textContent = "";
      const editBtn = document.getElementById("edit-leaders-top");
      if (editBtn) editBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
      await loadLeaders("day");
      await initReactions();
    }
    window.addEventListener("load", initPage);
  </script>
</body>
</html>
