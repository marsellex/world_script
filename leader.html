<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Лидеры PD</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050816;
      --panel-bg: #070818;
      --panel-border: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent-pink: #ec4899;
      --accent-pink-soft: #f472b6;
      --accent-pink-dark: #db2777;
      --tab-bg: #111827;
      --tab-border: #1f2937;
      --score-color: #f472b6;
      --gold: #facc15;
      --silver: #e5e7eb;
      --bronze: #fb923c;
      --highlight: #f472b6; /* Розовый цвет для акцентов */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #020617;
      overflow: hidden;
    }

    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    #bg-rotator img.active {
      opacity: 1;
    }

    #app {
      width: 100%;
      max-width: 1100px;
      position: relative;
      z-index: 1;
    }

    a {
      color: var(--accent-pink-soft);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .leader-tab.active {
      color: var(--text); /* Цвет текста */
      background: rgba(236, 72, 153, 0.85); /* Розовый неоновый цвет */
      box-shadow: 0 0 22px rgba(236, 72, 153, 0.8), 0 18px 40px rgba(15, 23, 42, 0.9); /* Неоновый светящийся эффект */
    }

    .btn {
      background: var(--highlight); /* Розовый цвет для кнопок */
      color: var(--text);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.75); /* Легкая тень для кнопок */
    }

    .btn:hover {
      background: rgba(31, 41, 55, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.9);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-outline {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: transparent;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }

    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.85);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.85);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .page-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--highlight); /* Использовать акцентный цвет */
      text-shadow: 0 0 18px rgba(168, 85, 247, 0.55); /* Неоновый эффект */
    }

    .page-subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .user-tag {
      font-size: 12px;
      color: var(--muted);
    }

    /* ✅ добавлено: блок кнопок в хедере */
    .page-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .leader-panel {
      border-radius: 32px;
      border: 1px solid var(--panel-border);
      padding: 26px 26px 20px;
      background:
        radial-gradient(circle at top left, rgba(168, 85, 247, 0.35), transparent 55%),
        radial-gradient(circle at top right, rgba(236, 72, 153, 0.35), transparent 55%),
        linear-gradient(145deg, #020617 0%, #020617 40%, #020617 100%);
      box-shadow:
        0 40px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .leader-panel-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }

    .leader-tabs {
      display: inline-flex;
      background: var(--tab-bg);
      border-radius: 999px;
      border: 1px solid var(--tab-border);
      padding: 4px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.6);
    }

    .leader-tab {
      min-width: 160px;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      transition: color 0.12s;
    }

    .leader-tab span.icon {
      font-size: 14px;
    }

    .leader-tab.active {
      color: #f9fafb;
    }

    .leader-tab.active::before {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(251, 113, 133, 0.85), rgba(236, 72, 153, 0.95));
      box-shadow:
        0 0 22px rgba(236, 72, 153, 0.8),
        0 18px 40px rgba(15, 23, 42, 0.9);
      z-index: -1;
    }

    .leader-tab.active span.label {
      font-weight: 700;
    }

    .leader-date {
      font-size: 14px;
      color: var(--muted);
    }

    .leaders-wrapper {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .leader-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 22px;
      border-radius: 20px;
      background: radial-gradient(circle at right, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.98)); /* Темный фон с градиентом */
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 22px 40px rgba(15, 23, 42, 0.9); /* Неоновая тень */
    }

    .leader-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.35), rgba(15, 23, 42, 0.95)); /* Золотистый градиент */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
    }

    .leader-card.rank-1 .leader-icon {
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.55), rgba(15, 23, 42, 0.9));
    }

    .leader-card.rank-2 .leader-icon {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.55), rgba(15, 23, 42, 0.9));
    }

    .leader-card.rank-3 .leader-icon {
      background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.55), rgba(15, 23, 42, 0.9));
    }

    .leader-avatar {
      width: 68px;
      height: 68px;
      border-radius: 18px;
      border: 2px solid rgba(236, 72, 153, 0.7); /* Розовая граница */
      background: #020617;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      color: #e5e7eb;
    }

    .leader-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .leader-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .leader-name-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }

    .leader-nick {
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 0 14px rgba(15, 23, 42, 0.8);
    }

    .leader-account {
      font-size: 13px;
      color: var(--accent-pink-soft);
      text-shadow: 0 0 10px rgba(236, 72, 153, 0.8);
    }

    .dept-badge {
      display: inline-flex;
      align-items: center;
      width: fit-content;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-top: 2px;
      border: 1px solid rgba(148, 163, 184, .25);
      background: rgba(15, 23, 42, .65);
    }

    .dept-badge.lspd {
      color: #22c55e;
      box-shadow: 0 0 18px rgba(34, 197, 94, .25);
    }

    .dept-badge.sfpd {
      color: #38bdf8;
      box-shadow: 0 0 18px rgba(56, 189, 248, .25);
    }

    .dept-badge.lvpd {
      color: #ef4444;
      box-shadow: 0 0 18px rgba(239, 68, 68, .25);
    }

    .leader-score-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 110px;
    }

    .leader-score {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-weight: 800;
      text-shadow: 0 0 16px rgba(236, 72, 153, 0.85);
    }

    .leader-score .value {
      font-size: 26px;
      color: var(--score-color);
    }

    .leader-score .unit {
      font-size: 13px;
      color: #e5e7eb;
    }

    .leader-place-label {
      font-size: 12px;
      color: var(--muted);
    }

    .leader-empty {
      font-size: 15px;
      color: var(--muted);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.96));
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.95);
      padding: 18px 18px 14px;
    }

    .modal h3 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .modal p {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: #020617;
      color: var(--text);
      font-size: 14px;
    }

    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .edit-avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 22px;
      border: 2px dashed rgba(148, 163, 184, 0.85);
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      color: #e5e7eb;
    }

    .edit-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .edit-avatar-preview::after {
      content: "✎";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .error-text {
      font-size: 12px;
      color: #f97373;
      margin-top: 4px;
    }

    .week-block {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .week-period-badge {
      display: inline-flex;
      align-items: center;
      width: fit-content;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, .28);
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, .18), transparent 55%),
        radial-gradient(circle at top right, rgba(56, 189, 248, .18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(239, 68, 68, .18), transparent 55%),
        rgba(15, 23, 42, .55);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .75);
    }

    .week-period-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(236, 72, 153, .9);
      box-shadow: 0 0 14px rgba(236, 72, 153, .55);
    }

    .drag-over {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.8);
    }

    @media (max-width: 720px) {
      body {
        padding: 12px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .leader-card {
        display: grid;
        grid-template-columns: 52px 68px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        align-items: start;
        padding: 14px 14px;
      }

      .leader-icon {
        grid-column: 1;
        grid-row: 1;
      }

      .leader-avatar {
        grid-column: 2;
        grid-row: 1;
      }

      .leader-main {
        grid-column: 3;
        grid-row: 1;
        min-width: 0;
      }

      .leader-score-block {
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
      }

      .leader-score .value {
        font-size: 22px;
      }
    }
  </style>
</head>

<body>
<div id="bg-rotator"></div>

<div id="app">
  <div class="page-header">
    <div class="page-title-block">
      <div class="page-title">Топ лидеров PD</div>
      <div class="page-subtitle">Кто сегодня набрал больше всех АШ.</div>
      <div class="user-tag" id="user-tag"></div>
    </div>

    <!-- ✅ добавлено: кнопка в верхней панели -->
    <div class="page-header-actions">
      <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">Редактировать лидеров</button>
    </div>
  </div>

  <div class="leader-panel">
    <div class="leader-panel-header">
      <div class="leader-tabs">
        <button class="leader-tab active" id="tab-day" data-period="day">
          <span class="icon">♥</span>
          <span class="label">Активность дня</span>
        </button>
        <button class="leader-tab" id="tab-week" data-period="week">
          <span class="icon">♥</span>
          <span class="label">Активность недели</span>
        </button>
      </div>
      <div class="leader-date" id="leader-date"></div>
    </div>

    <div class="leaders-wrapper" id="leaders-wrapper">
      Загрузка…
    </div>
  </div>
</div>

<!-- Модалка ошибки -->
<div id="error-modal" class="modal-backdrop">
  <div class="modal">
    <h3>Ошибка</h3>
    <p id="error-modal-text"></p>
    <div class="modal-footer">
      <button class="btn btn-sm" id="error-modal-close">Закрыть</button>
    </div>
  </div>
</div>

<!-- ✅ добавлено: Модалка редактирования 3х лидеров -->
<div id="leaders-bulk-modal" class="modal-backdrop">
  <div class="modal" style="max-width: 720px;">
    <h3>Редактирование лидеров (LSPD / SFPD / LVPD)</h3>
    <p>Меняются ник, аккаунт и аватар. Очки не трогаем.</p>

    <div id="bulk-error" class="error-text" style="display:none;"></div>
    <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>

    <div class="modal-footer">
      <button class="btn-outline btn-sm" id="bulk-cancel">Отмена</button>
      <button class="btn btn-sm" id="bulk-save">Сохранить</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== ТЕМА: фон + бренд ===== */
  let themeConfig = {
    images: [],
    opacity: 80,
    blur: 0,
    borderColor: "#1f2937",
    favicon: null,
    siteTitle: null,
  };
  let bgRotationTimer = null;
  let bgCurrentIndex = 0;
  const bgRotatorEl = document.getElementById("bg-rotator");

  async function loadThemeFromDB() {
    const { data, error } = await supabaseClient
      .from("theme_settings")
      .select("*")
      .eq("id", 1)
      .single();

    if (error || !data) {
      console.warn("Ошибка загрузки темы:", error);
      return;
    }

    themeConfig = {
      images: data.images || [],
      opacity: data.opacity ?? 80,
      blur: data.blur ?? 0,
      borderColor: data.border_color || "#1f2937",
      favicon: data.favicon || null,
      siteTitle: data.site_title || null,
    };
  }

  function applyThemeBackground() {
    if (!bgRotatorEl) return;
    bgRotatorEl.innerHTML = "";

    const images = themeConfig.images || [];
    const blurPx = Number(themeConfig.blur || 0);
    const opacityPct = Math.max(0, Math.min(100, Number(themeConfig.opacity ?? 80)));
    const imgOpacity = opacityPct / 100;

    if (!images.length) {
      bgRotatorEl.style.background = "#020617";
      return;
    }

    images.forEach((src, index) => {
      const img = document.createElement("img");
      img.src = src;
      img.style.filter = "blur(" + blurPx + "px)";
      img.style.opacity = "0";
      img.dataset.baseOpacity = String(imgOpacity);

      if (index === 0) {
        img.classList.add("active");
        img.style.opacity = String(imgOpacity);
      }
      bgRotatorEl.appendChild(img);
    });

    if (bgRotationTimer) {
      clearInterval(bgRotationTimer);
      bgRotationTimer = null;
    }

    if (images.length > 1) {
      const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
      bgCurrentIndex = 0;
      bgRotationTimer = setInterval(() => {
        const prev = imgs[bgCurrentIndex];
        bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
        const next = imgs[bgCurrentIndex];

        if (prev) {
          prev.classList.remove("active");
          prev.style.opacity = "0";
        }
        if (next) {
          next.classList.add("active");
          next.style.opacity = next.dataset.baseOpacity || "0.8";
        }
      }, 60 * 1000);
    }
  }

  function applyThemeToBlocks() {
    const borderColor = themeConfig.borderColor || "#1f2937";
    document.documentElement.style.setProperty("--panel-border", borderColor);
  }

  function applySiteBranding() {
    document.title = themeConfig.siteTitle || "Рейтинг лидеров PD";

    if (themeConfig.favicon) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement("link");
        link.rel = "icon";
        document.head.appendChild(link);
      }
      link.href = themeConfig.favicon;
    }
  }

  /* ===== СЕССИЯ ===== */
  let currentUser = null;
  function loadSession() {
    try { return JSON.parse(localStorage.getItem("pp_user")); }
    catch { return null; }
  }

  // ✅ права для верхней кнопки: только admin и creator
  function canBulkEdit(user) {
    const role = String(user?.role || "").trim().toLowerCase();
    return role === "admin" || role === "creator";
  }

  async function loadLeaders(period = "day") {
    currentPeriod = period;

    const { data, error } = await supabaseClient
      .from("leaderinfo")
      .select("id, nick, account_id, avatar_url, department, points_day")
      .order("points_day", { ascending: false })
      .limit(3);

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "Ошибка загрузки рейтинга.";
      return;
    }

    const rows = (data || []).map((r) => ({
      id: r.id,
      nick: (r.nick || "").trim(),
      account_id: r.account_id || null,
      avatar_url: r.avatar_url || null,
      department: r.department || null,
      points_day: Number(r.points_day || 0),
      points: Number(r.points_day || 0),
    }));

    leadersWrapper.innerHTML = "";
    rows.forEach((row, idx) => {
      leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
    });
  }

  /* ===== INIT ===== */
  async function initPage() {
    await loadThemeFromDB();
    applyThemeBackground();
    applyThemeToBlocks();
    applySiteBranding();

    currentUser = loadSession();
    if (editLeadersTopBtn) {
      editLeadersTopBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
    }

    await loadLeaders("day");
  }

  window.addEventListener("load", initPage);
</script>
</body>
</html>
