<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–†–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤ PD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ====== CSS –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (1 –í 1 –ö–ê–ö –£ –¢–ï–ë–Ø) ====== */
:root {
  --bg:#050816;--panel-bg:#070818;--panel-border:#1f2937;--text:#f9fafb;
  --muted:#9ca3af;--accent-pink:#ec4899;--accent-pink-soft:#f472b6;
  --accent-pink-dark:#db2777;--tab-bg:#111827;--tab-border:#1f2937;
  --score-color:#f472b6;--gold:#facc15;--silver:#e5e7eb;--bronze:#fb923c;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}
body{min-height:100vh;background:radial-gradient(circle at top,#1f2937 0,#020617 55%,#020617 100%);color:var(--text);display:flex;justify-content:center;align-items:flex-start;padding:20px;}
#bg-rotator{position:fixed;inset:0;z-index:-1;background:#020617;overflow:hidden;}
#bg-rotator img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 1s ease-in-out;pointer-events:none;}
#app{width:100%;max-width:1100px;position:relative;z-index:1;}
/* ---- –æ—Å—Ç–∞–ª—å–Ω–æ–π CSS –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω ---- */
/* (–∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ —Å–∏–º–≤–æ–ª–æ–≤ —è –Ω–µ –æ–±—Ä–µ–∑–∞—é ‚Äî —É —Ç–µ–±—è –æ–Ω —É–∂–µ –µ—Å—Ç—å, –æ–Ω –Ω–µ –º–µ–Ω—è–ª—Å—è) */
</style>
</head>

<body>
<div id="bg-rotator"></div>

<div id="app">
  <div class="page-header">
    <div class="page-title-block">
      <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
      <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
      <div class="user-tag" id="user-tag"></div>
    </div>
  </div>

  <div class="leader-panel">
    <div class="leader-panel-header">
      <div class="leader-tabs">
        <button class="leader-tab active" data-period="day">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</button>
        <button class="leader-tab" data-period="week">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</button>
      </div>
      <div class="leader-date" id="leader-date"></div>
    </div>
    <div class="leaders-wrapper" id="leaders-wrapper">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
const SUPABASE_ANON_KEY = "–¢–í–û–ô_ANON_KEY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= SESSION ================= */
let currentUser = null;
function loadSession(){
  try{ return JSON.parse(localStorage.getItem("pp_user")); }
  catch{ return null; }
}
function isAdminLike(){
  return currentUser && ["admin","moderator","creator"].includes(currentUser.role);
}

/* ================= THEME ================= */
let themeConfig={images:[],opacity:80,blur:0,borderColor:"#1f2937",favicon:null,siteTitle:null};
const bgEl=document.getElementById("bg-rotator");
let bgTimer=null, bgIndex=0;

async function loadThemeFromDB(){
  const {data}=await supabase.from("theme_settings").select("*").eq("id",1).single();
  if(!data)return;
  themeConfig={
    images:data.images||[],
    opacity:data.opacity??80,
    blur:data.blur??0,
    borderColor:data.border_color||"#1f2937",
    favicon:data.favicon||null,
    siteTitle:data.site_title||null
  };
}

function applyTheme(){
  bgEl.innerHTML="";
  const opacity=Number(themeConfig.opacity)/100;
  if(!themeConfig.images.length)return;

  themeConfig.images.forEach((src,i)=>{
    const img=document.createElement("img");
    img.src=src;
    img.style.filter=`blur(${themeConfig.blur}px)`;
    if(i===0){ img.style.opacity=opacity; img.classList.add("active"); }
    img.dataset.opacity=opacity;
    bgEl.appendChild(img);
  });

  if(bgTimer) clearInterval(bgTimer);
  if(themeConfig.images.length>1){
    const imgs=[...bgEl.querySelectorAll("img")];
    bgIndex=0;
    bgTimer=setInterval(()=>{
      imgs[bgIndex].style.opacity=0;
      imgs[bgIndex].classList.remove("active");
      bgIndex=(bgIndex+1)%imgs.length;
      imgs[bgIndex].style.opacity=imgs[bgIndex].dataset.opacity;
      imgs[bgIndex].classList.add("active");
    },60000);
  }
}

/* ================= EDIT STATE ================= */
let editingRow=null;
let editingAvatarData=null;

/* ================= RENDER ================= */
const wrapper=document.getElementById("leaders-wrapper");
const dateEl=document.getElementById("leader-date");

function renderCard(place,row){
  const div=document.createElement("div");
  div.className="leader-card rank-"+place;
  div.innerHTML=`
    <div class="leader-icon">${place===1?"üèÜ":place===2?"ü•à":"ü•â"}</div>
    <div class="leader-avatar">${row?.avatar_url?`<img src="${row.avatar_url}">`:(row?row.nick[0]:"?")}</div>
    <div class="leader-main">
      <div class="leader-name-row">
        <div class="leader-nick">${row?.nick||"‚Äî"}</div>
        <div class="leader-account">${row?.account_id?`[${row.account_id}]`:""}</div>
      </div>
      <div class="dept-badge ${row?.department?.toLowerCase()||""}">${row?.department||"‚Äî"}</div>
    </div>
    <div class="leader-score-block">
      <div class="leader-score"><span class="value">${row?.points||0}</span><span class="unit">–ê–®</span></div>
      <div class="leader-place-label">${place} –º–µ—Å—Ç–æ</div>
    </div>`;
  return div;
}

/* ================= LOAD DAY ================= */
async function loadDay(){
  dateEl.textContent=new Date().toLocaleDateString("ru-RU");
  wrapper.textContent="–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

  const {data}=await supabase
    .from("leaderinfo")
    .select("*")
    .order("points_day",{ascending:false})
    .limit(3);

  wrapper.innerHTML="";
  [0,1,2].forEach(i=>{
    const r=data?.[i];
    wrapper.appendChild(renderCard(i+1,r?{...r,points:r.points_day}:null));
  });
}

/* ================= LOAD WEEK ================= */
function parseDate(d){const [y,m,da]=d.split("-").map(Number);return new Date(y,m-1,da);}
function fmtWeek(s,e){
  const a=parseDate(s),b=parseDate(e);
  const m=["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
  return `–° ${a.getDate()} ${m[a.getMonth()]} ${a.getFullYear()} –ø–æ ${b.getDate()} ${m[b.getMonth()]} ${b.getFullYear()}`;
}

async function loadWeek(){
  dateEl.textContent="";
  wrapper.textContent="–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

  const {data}=await supabase
    .from("leaderinfo_week")
    .select(`week_start,week_end,place,points_week,leader:leader_id(nick,account_id,avatar_url,department)`)
    .order("week_start",{ascending:false})
    .order("place",{ascending:true});

  if(!data?.length){ wrapper.textContent="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö."; return; }

  wrapper.innerHTML="";
  const map=new Map();
  data.forEach(r=>{
    if(!map.has(r.week_start)) map.set(r.week_start,{end:r.week_end,rows:{}});
    map.get(r.week_start).rows[r.place]=r;
  });

  for(const [ws,v] of map){
    const block=document.createElement("div");
    block.className="week-block";
    block.innerHTML=`<div class="week-period-badge">${fmtWeek(ws,v.end)}</div>`;
    for(let i=1;i<=3;i++){
      const r=v.rows[i];
      block.appendChild(renderCard(i,r?{...r.leader,points:r.points_week}:null));
    }
    wrapper.appendChild(block);
  }
}

/* ================= TABS ================= */
document.querySelectorAll(".leader-tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".leader-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    btn.dataset.period==="week"?loadWeek():loadDay();
  };
});

/* ================= INIT ================= */
window.onload=async()=>{
  currentUser=loadSession();
  await loadThemeFromDB();
  applyTheme();
  loadDay();
};
</script>
</body>
</html>
