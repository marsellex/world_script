<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ===============================
       CYBERPUNK LIVE BACKGROUND (CSS)
       + –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
       + "–Ω–µ–æ–Ω –±–µ–∂–∏—Ç –ø–æ –æ–±–≤–æ–¥–∫–µ"
       + hover: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ + –ø–æ–¥—ä–µ–º + –±–ª–∏–∫
       =============================== */

    :root{
      --bg0:#050816;
      --bg1:#070a23;

      --text:#f3f6ff;
      --muted: rgba(243,246,255,.72);

      --pink:#ff3aa8;
      --pink2:#ff66d6;
      --blue:#2aa8ff;
      --cyan:#2ef9ff;
      --violet:#7c3aed;

      --stroke: rgba(255,255,255,.14);
      --strokeSoft: rgba(255,255,255,.08);

      --shadow: 0 26px 80px rgba(0,0,0,.65);

      --rXL: 30px;
      --rL: 24px;
      --rM: 18px;

      --cardBg: rgba(0,0,0,.12);   /* —Å—Ç–∞–ª–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
      --panelBg: rgba(0,0,0,.08);  /* —Å—Ç–∞–ª–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ */
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body{
      min-height:100vh;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      overflow-x:hidden;

      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,58,168,.14), transparent 55%),
        radial-gradient(900px 520px at 90% 18%, rgba(42,168,255,.14), transparent 55%),
        radial-gradient(1200px 700px at 50% 110%, rgba(46,249,255,.06), transparent 55%),
        linear-gradient(180deg, #040515 0%, #030414 50%, #020212 100%);
    }

    /* –ñ–ò–í–û–ô –§–û–ù (–∫–∞–∫ –Ω–∞ 1 —Ñ–æ—Ç–æ): –¥–∏–∞–≥–æ–Ω–∞–ª–∏ + –≥–ª–∏—Ç—á-–±–∞—Ä—Å—ã + —Å–∫–∞–Ω–ª–∞–π–Ω—ã + —á–∞—Å—Ç–∏—Ü—ã */
    .bg-live{
      position: fixed;
      inset: 0;
      z-index: -5;
      pointer-events:none;
      overflow:hidden;
    }

    /* –ë–∞–∑–æ–≤–∞—è –¥—ã–º–∫–∞ + –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ ‚Äú–ø–ª–æ—Å–∫–æ—Å—Ç–∏‚Äù */
    .bg-live::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(255,58,168,.10), transparent 60%),
        radial-gradient(900px 520px at 85% 18%, rgba(42,168,255,.10), transparent 60%),
        radial-gradient(800px 520px at 55% 65%, rgba(124,58,237,.08), transparent 62%),
        linear-gradient(115deg,
          rgba(255,58,168,.10) 0%,
          rgba(255,58,168,0) 18%,
          rgba(42,168,255,.10) 34%,
          rgba(42,168,255,0) 52%,
          rgba(255,102,214,.08) 68%,
          rgba(255,102,214,0) 86%
        );
      filter: blur(10px) saturate(1.05);
      opacity:.95;
      transform: rotate(-8deg);
      animation: bgFloat 10s ease-in-out infinite alternate;
    }

    @keyframes bgFloat{
      0%   { transform: translate3d(-1.5%, -1%, 0) rotate(-8deg) scale(1.02); }
      100% { transform: translate3d( 1.5%,  1%, 0) rotate(-8deg) scale(1.03); }
    }

    /* –°–∫–∞–Ω–ª–∞–π–Ω—ã */
    .bg-live .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      opacity:.10;
      mix-blend-mode: overlay;
      animation: scanMove 2.8s linear infinite;
    }
    @keyframes scanMove{
      0%   { transform: translateY(0); }
      100% { transform: translateY(18px); }
    }

    /* –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–µ–æ–Ω-—Å—Ç—Ä–æ–∫–∏ (–∫–∞–∫ ‚Äú—Ä–µ–π–∫–∏‚Äù –Ω–∞ 1 —Ñ–æ—Ç–æ) */
    .bg-live .diag{
      position:absolute; inset:-15%;
      background:
        repeating-linear-gradient(125deg,
          rgba(255,58,168,.18) 0 2px,
          rgba(255,58,168,0) 2px 26px
        ),
        repeating-linear-gradient(125deg,
          rgba(42,168,255,.14) 0 2px,
          rgba(42,168,255,0) 2px 34px
        ),
        repeating-linear-gradient(125deg,
          rgba(124,58,237,.10) 0 1px,
          rgba(124,58,237,0) 1px 18px
        );
      opacity:.25;
      filter: blur(.2px);
      transform: rotate(-10deg);
      animation: diagDrift 14s linear infinite;
    }
    @keyframes diagDrift{
      0%   { transform: translate3d(-2%, -1%, 0) rotate(-10deg); }
      100% { transform: translate3d( 2%,  1%, 0) rotate(-10deg); }
    }

    /* –ì–ª–∏—Ç—á –±–∞—Ä—ã */
    .bg-live .glitch{
      position:absolute; inset:0;
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(.2px);
      background:
        linear-gradient(90deg,
          transparent 0%,
          rgba(255,58,168,.0) 20%,
          rgba(255,58,168,.35) 24%,
          rgba(46,249,255,.35) 28%,
          rgba(255,255,255,.12) 30%,
          rgba(255,58,168,.0) 36%,
          transparent 100%
        );
      transform: translateX(-30%);
      animation: glitchSweep 4.2s ease-in-out infinite;
    }
    @keyframes glitchSweep{
      0%   { transform: translateX(-40%) translateY( 8%); opacity:.25; }
      25%  { transform: translateX(  0%) translateY(12%); opacity:.55; }
      50%  { transform: translateX( 35%) translateY(10%); opacity:.35; }
      75%  { transform: translateX( 10%) translateY(14%); opacity:.60; }
      100% { transform: translateX(-40%) translateY( 8%); opacity:.25; }
    }

    /* –ß–∞—Å—Ç–∏—Ü—ã (–∑–≤—ë–∑–¥–Ω–∞—è –ø—ã–ª—å) */
    .bg-live .particles{
      position:absolute; inset:0;
      opacity:.55;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 42% 76%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 66%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 52%, rgba(255,58,168,.14) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 62%, rgba(42,168,255,.14) 0 1px, transparent 2px);
      background-size: 520px 520px, 680px 680px, 760px 760px, 900px 900px, 700px 700px, 820px 820px;
      animation: particlesDrift 22s linear infinite;
    }
    @keyframes particlesDrift{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-3%, 2%, 0); }
    }

    /* –ª—ë–≥–∫–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ */
    .bg-live .vignette{
      position:absolute; inset:-2px;
      background: radial-gradient(circle at center, transparent 0 55%, rgba(0,0,0,.45) 85%, rgba(0,0,0,.70) 100%);
      opacity:.9;
    }

    #app{
      width:100%;
      max-width:1200px;
      position:relative;
      z-index:1;
    }

    /* ================= HEADER ================= */
    .page-header{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      margin-bottom: 14px;
      padding-top: 6px;
    }
    .page-title-block{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
    }
    .page-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.01em;
      text-shadow:
        0 0 20px rgba(255,58,168,.20),
        0 0 44px rgba(42,168,255,.12);
    }
    .page-subtitle{
      font-size:20px;
      color: rgba(243,246,255,.68);
      text-shadow: 0 0 18px rgba(42,168,255,.08);
    }
    .user-tag{ font-size:12px; color: rgba(243,246,255,.60); margin-top:2px; }

    .page-header-actions{
      position:absolute;
      right:0;
      top:0;
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* ================= BUTTONS ================= */
    .btn{
      padding: 12px 18px;
      border-radius: 999px;
      border: 1px solid rgba(42,168,255,.45);
      background: rgba(6, 10, 30, .18);
      color: rgba(243,246,255,.90);
      font-size: 14px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      backdrop-filter: blur(10px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 24px rgba(42,168,255,.14);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(46,249,255,.55);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 30px rgba(42,168,255,.22),
        0 0 48px rgba(255,58,168,.10);
    }
    .btn-sm{ padding: 11px 18px; font-size: 14px; }

    .btn-outline{
      padding: 10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(6,10,30,.14);
      color: rgba(243,246,255,.88);
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .btn-outline:hover{
      transform: translateY(-1px);
      border-color: rgba(255,58,168,.40);
      box-shadow: 0 0 24px rgba(255,58,168,.14);
    }

    /* ================= PANEL + TABS ================= */
    .leader-panel{
      position:relative;
      border-radius: var(--rXL);
      padding: 22px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .leader-panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 230px at 25% 0%, rgba(255,58,168,.28), transparent 62%),
        radial-gradient(700px 230px at 75% 0%, rgba(42,168,255,.22), transparent 62%),
        linear-gradient(90deg, rgba(255,58,168,.50), rgba(42,168,255,.50), rgba(255,102,214,.50));
      opacity:.12;
      filter: blur(14px);
      pointer-events:none;
    }

    .leader-panel-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
    }

    .leader-tabs{
      position:relative;
      display:flex;
      gap:0;
      border-radius: 999px;
      padding: 6px;
      background: rgba(6, 10, 30, .22);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 16px 46px rgba(0,0,0,.35);
    }

    .leader-tab{
      position:relative;
      border:0;
      background: transparent;
      color: rgba(243,246,255,.72);
      cursor:pointer;
      padding: 14px 26px;
      min-width: 320px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .10em;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      transition: transform .14s ease, color .14s ease, filter .14s ease;
      z-index:1;
    }
    .leader-tab span.icon{ font-size: 14px; opacity:.9; }
    .leader-tab:hover{ transform: translateY(-1px); color: rgba(255,255,255,.92); filter: drop-shadow(0 0 10px rgba(42,168,255,.15)); }

    .leader-tab.active{
      color:#fff;
      text-shadow: 0 0 18px rgba(255,58,168,.22);
    }
    .leader-tab.active::before{
      content:"";
      position:absolute;
      inset: -2px -10px -2px -2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,58,168,.95), rgba(255,102,214,.85));
      box-shadow:
        0 0 26px rgba(255,58,168,.32),
        0 0 34px rgba(255,102,214,.18);
      z-index:-2;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
    }
    .leader-tab.active::after{
      content:"";
      position:absolute;
      inset: 2px 2px 2px 2px;
      border-radius: 999px;
      background: rgba(7, 10, 36, .30);
      z-index:-1;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
      backdrop-filter: blur(10px);
    }

    .leader-date{
      font-size: 18px;
      letter-spacing:.10em;
      color: rgba(243,246,255,.70);
      margin-top: 4px;
    }

    .leaders-wrapper{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* ================= LEADER CARDS =================
       - —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ
       - –æ—Å—Ç–∞–µ—Ç—Å—è ‚Äú–æ–±–≤–æ–¥–∫–∞‚Äù
       - –Ω–µ–æ–Ω –±–µ–∂–∏—Ç –ø–æ –æ–±–≤–æ–¥–∫–µ (conic-gradient + mask)
       - hover: –ø–æ–¥—Å–≤–µ—Ç–∫–∞, –ø–æ–¥—ä–µ–º, –±–ª–∏–∫
    ================================================== */

    .leader-card{
      position:relative;
      display:flex;
      align-items:center;
      gap: 22px;
      padding: 18px 24px;
      border-radius: var(--rL);

      /* –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è ‚Äú–ø–ª–∞—Å—Ç–∏–Ω–∞‚Äù, –æ—á–µ–Ω—å —Å–ª–∞–±–∞—è */
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(10px);

      /* –±–∞–∑–æ–≤–∞—è —Ç–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è */
      border: 1px solid rgba(255,255,255,.10);

      box-shadow: 0 16px 54px rgba(0,0,0,.38);
      overflow:hidden;

      /* —Å–∫–æ—Å —Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É */
      clip-path: polygon(
        0% 0%,
        100% 0%,
        100% calc(100% - 26px),
        calc(100% - 26px) 100%,
        0% 100%,
        0% 0%
      );

      transition:
        transform .18s ease,
        box-shadow .18s ease,
        background .18s ease,
        border-color .18s ease;
    }

    /* –ë–ï–ì–£–©–ò–ô –ù–ï–û–ù –ü–û –û–ë–í–û–î–ö–ï */
    .leader-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--rL) + 2px);

      /* –±–µ–≥—É—â–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
      background:
        conic-gradient(
          from 0deg,
          rgba(255,58,168,0) 0deg,
          rgba(255,58,168,.95) 40deg,
          rgba(46,249,255,.95) 90deg,
          rgba(124,58,237,.90) 140deg,
          rgba(255,102,214,.95) 200deg,
          rgba(42,168,255,.85) 260deg,
          rgba(255,58,168,0) 320deg,
          rgba(255,58,168,0) 360deg
        );

      /* –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ‚Äú—Ä–∞–º–∫—É‚Äù (–≤—ã—Ä–µ–∑ –ø–æ —Ü–µ–Ω—Ç—Ä—É) */
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      padding: 2px; /* —Ç–æ–ª—â–∏–Ω–∞ –Ω–µ–æ–Ω–∞ */
      filter: blur(.2px);
      opacity: .85;
      animation: borderRun 3.2s linear infinite;
      pointer-events:none;
    }

    @keyframes borderRun{
      to { transform: rotate(360deg); }
    }

    /* –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è */
    .leader-card::after{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--rL);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      pointer-events:none;
      opacity:.8;
    }

    /* Hover: –ø–æ–¥–Ω–∏–º–∞–µ–º, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º, –¥–æ–±–∞–≤–ª—è–µ–º ‚Äú–±–ª–∏–∫‚Äù */
    .leader-card:hover{
      transform: translateY(-7px);
      background: rgba(0,0,0,.14);
      border-color: rgba(46,249,255,.22);
      box-shadow:
        0 24px 80px rgba(0,0,0,.55),
        0 0 28px rgba(42,168,255,.12),
        0 0 32px rgba(255,58,168,.10);
    }

    /* –ë–ª–∏–∫-—Å–≤–∞–π–ø (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç) */
    .leader-card .sheen{
      content:"";
      position:absolute;
      inset:-40% -60%;
      pointer-events:none;
      background: linear-gradient(115deg,
        transparent 0%,
        rgba(255,255,255,.00) 35%,
        rgba(255,255,255,.14) 45%,
        rgba(255,58,168,.10) 50%,
        rgba(46,249,255,.10) 55%,
        rgba(255,255,255,.00) 65%,
        transparent 100%
      );
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: opacity .16s ease;
      mix-blend-mode: screen;
    }
    .leader-card:hover .sheen{
      opacity: 1;
      animation: sheenSweep .75s ease-out 1;
    }
    @keyframes sheenSweep{
      0%   { transform: translateX(-60%) rotate(10deg); }
      100% { transform: translateX( 60%) rotate(10deg); }
    }

    /* –ß—Ç–æ–±—ã –Ω–µ–æ–Ω ‚Äú–∂–∏–ª‚Äù –∏ –±–µ–∑ hover */
    .leader-card:hover::before{ filter: blur(.15px) saturate(1.1); }
    .leader-card.rank-1::before{ animation-duration: 3.0s; }
    .leader-card.rank-2::before{ animation-duration: 3.6s; }
    .leader-card.rank-3::before{ animation-duration: 4.2s; }

    /* –ò–∫–æ–Ω–∫–∞ –º–µ—Å—Ç–∞ */
    .leader-icon{
      width: 58px;
      height: 58px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 22px rgba(42,168,255,.10);
      flex-shrink:0;
    }

    /* –ê–≤–∞—Ç–∞—Ä */
    .leader-avatar{
      width: 72px;
      height: 72px;
      border-radius: 18px;
      border: 2px solid rgba(255,58,168,.38);
      background: rgba(0,0,0,.14);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      font-size: 26px;
      flex-shrink:0;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 22px rgba(255,58,168,.12);
    }
    .leader-avatar img{ width:100%; height:100%; object-fit: cover; }

    .leader-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .leader-name-row{
      display:flex;
      flex-wrap:wrap;
      align-items:baseline;
      gap: 12px;
    }

    .leader-nick{
      font-size: 38px;
      font-weight: 900;
      letter-spacing: .01em;
      text-shadow:
        0 0 18px rgba(255,58,168,.14),
        0 0 28px rgba(42,168,255,.10);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    .leader-account{
      font-size: 18px;
      font-weight: 800;
      color: rgba(255,102,214,.92);
      text-shadow: 0 0 14px rgba(255,58,168,.12);
    }

    .dept-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
    }
    .dept-badge.lspd{ color:#28e07a; box-shadow: 0 0 18px rgba(40,224,122,.10); }
    .dept-badge.sfpd{ color:#2fc7ff; box-shadow: 0 0 18px rgba(47,199,255,.10); }
    .dept-badge.lvpd{ color:#ff5a7e; box-shadow: 0 0 18px rgba(255,90,126,.10); }

    .leader-score-block{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      min-width: 220px;
      flex-shrink:0;
    }

    .leader-score{
      display:flex;
      align-items:baseline;
      gap: 12px;
      font-weight: 900;
      text-shadow: 0 0 22px rgba(255,58,168,.16);
    }

    .leader-score .value{
      font-size: 64px;
      color: rgba(255,102,214,.95);
      letter-spacing: .02em;
    }
    .leader-score .unit{
      font-size: 22px;
      font-weight: 900;
      color: rgba(243,246,255,.85);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .leader-place-label{
      font-size: 18px;
      color: rgba(243,246,255,.72);
      letter-spacing: .06em;
    }

    .leader-empty{ font-size: 16px; color: rgba(243,246,255,.62); }

    /* ================= MODALS ================= */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width:100%;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(7,10,36,.60), rgba(5,7,22,.35));
      backdrop-filter: blur(12px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 28px 80px rgba(0,0,0,.72);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(255,58,168,.55), rgba(42,168,255,.45), rgba(255,102,214,.55));
      opacity:.18;
      filter: blur(12px);
      pointer-events:none;
    }
    .modal h3{ font-size: 20px; font-weight: 900; margin-bottom: 6px; }
    .modal p{ font-size: 14px; color: rgba(243,246,255,.70); margin-bottom: 10px; }

    .modal-footer{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }

    .field{ margin-bottom: 10px; }
    .field label{ display:block; font-size: 13px; margin-bottom: 4px; color: rgba(243,246,255,.78); }
    .field input, .field select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 14px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(46,249,255,.40);
      box-shadow: 0 0 0 2px rgba(46,249,255,.12);
    }

    .error-text{ font-size: 13px; color: #ff8585; margin-top: 6px; }

    .edit-avatar-preview{
      width: 92px;
      height: 92px;
      border-radius: 22px;
      border: 2px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      cursor:pointer;
      color: rgba(255,255,255,.85);
      position:relative;
    }
    .edit-avatar-preview img{ width:100%; height:100%; object-fit:cover; }
    .edit-avatar-preview::after{
      content:"‚úé";
      position:absolute;
      right:-2px;
      bottom:-2px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      backdrop-filter: blur(10px);
    }

    .drag-over{ box-shadow: 0 0 0 3px rgba(46,249,255,.35); }

    .week-block{ margin-top: 14px; display:flex; flex-direction:column; gap: 14px; }

    .week-period-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,.32);
      color: rgba(243,246,255,.78);
    }
    .week-period-badge .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(255,58,168,.95);
      box-shadow: 0 0 14px rgba(255,58,168,.35);
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 1100px){
      .leader-tab{ min-width: 260px; }
      .leader-nick{ font-size: 32px; }
      .leader-score .value{ font-size: 56px; }
      .page-title{ font-size: 48px; }
      .leader-score-block{ min-width: 200px; }
    }
    @media (max-width: 820px){
      .leader-tab{ min-width: 200px; font-size: 14px; }
      .page-title{ font-size: 40px; }
      .page-subtitle{ font-size: 16px; }
      .leader-score-block{ min-width: 180px; }
    }
    @media (max-width: 720px){
      body{ padding: 12px; }
      .page-header{ justify-content:flex-start; }
      .page-title-block{ text-align:left; align-items:flex-start; }
      .page-title{ font-size: 34px; }
      .page-subtitle{ font-size: 14px; }
      .page-header-actions{ position: static; margin-left:auto; }

      .leader-card{
        display:grid;
        grid-template-columns: 58px 72px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        padding: 14px 14px;
      }
      .leader-icon{ grid-column:1; grid-row:1; }
      .leader-avatar{ grid-column:2; grid-row:1; }
      .leader-main{ grid-column:3; grid-row:1; }
      .leader-score-block{
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        min-width: 0;
      }
      .leader-score .value{ font-size: 44px; }
      .leader-score .unit{ font-size: 18px; }
      .leader-place-label{ font-size: 16px; }
      .leader-tabs{ width:100%; }
      .leader-tab{ min-width: 0; flex:1; padding: 12px 12px; }
    }
  </style>
</head>

<body>
  <!-- –ñ–∏–≤–æ–π –∫–∏–±–µ—Ä–ø–∞–Ω–∫-—Ñ–æ–Ω (–±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π) -->
  <div class="bg-live" aria-hidden="true">
    <div class="diag"></div>
    <div class="glitch"></div>
    <div class="particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
  </div>

  <div id="app">
    <div class="page-header">
      <div class="page-title-block">
        <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
        <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
        <div class="user-tag" id="user-tag"></div>
      </div>

      <div class="page-header-actions">
        <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–µ—Ä–æ–≤</button>
      </div>
    </div>

    <div class="leader-panel">
      <div class="leader-panel-header">
        <div class="leader-tabs">
          <button class="leader-tab active" id="tab-day" data-period="day">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
          </button>
          <button class="leader-tab" id="tab-week" data-period="week">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
          </button>
        </div>
        <div class="leader-date" id="leader-date"></div>
      </div>

      <div class="leaders-wrapper" id="leaders-wrapper">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ -->
  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ bulk-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="leaders-bulk-modal" class="modal-backdrop">
    <div class="modal" style="max-width: 720px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤ (LSPD / SFPD / LVPD)</h3>
      <p>–ú–µ–Ω—è—é—Ç—Å—è –Ω–∏–∫, –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤–∞—Ç–∞—Ä. –û—á–∫–∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.</p>

      <div id="bulk-error" class="error-text" style="display:none;"></div>
      <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>

      <div class="modal-footer">
        <button class="btn-outline" id="bulk-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn" id="bulk-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== –°–ï–°–°–ò–Ø ===== */
    let currentUser = null;
    function loadSession() {
      try { return JSON.parse(localStorage.getItem("pp_user")); }
      catch { return null; }
    }
    function roleLabel(role) {
      role = String(role || "").trim().toLowerCase();
      if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
      if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
      if (role === "creator") return "–†–µ–¥–∞–∫—Ç–æ—Ä";
      return "–û—Ñ–∏—Ü–µ—Ä";
    }
    function canBulkEdit(user) {
      const role = String(user?.role || "").trim().toLowerCase();
      return role === "admin" || role === "creator";
    }

    /* ===== –û–®–ò–ë–ö–ò ===== */
    const errorModal = document.getElementById("error-modal");
    const errorModalText = document.getElementById("error-modal-text");
    const errorModalClose = document.getElementById("error-modal-close");
    function showErrorModal(message) {
      errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
      errorModal.classList.add("active");
    }
    if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

    /* ===== HELPERS WEEK ===== */
    function monthRuUpper(monthIndex) {
      const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
      return m[monthIndex] || "";
    }
    function parseDateOnly(iso) {
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function formatPeriodRu(startISO, endISO) {
      const s = parseDateOnly(startISO);
      const e = parseDateOnly(endISO);
      return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
    }

    /* ===== UI / DATA ===== */
    const leadersWrapper = document.getElementById("leaders-wrapper");
    const dateEl = document.getElementById("leader-date");
    let currentPeriod = "day";

    function renderLeaderCard(place, row) {
      const card = document.createElement("div");
      card.className = "leader-card rank-" + place;

      // ‚Äú–±–ª–∏–∫‚Äù –¥–ª—è hover (–∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è CSS)
      const sheen = document.createElement("div");
      sheen.className = "sheen";
      card.appendChild(sheen);

      const icon = document.createElement("div");
      icon.className = "leader-icon";
      icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";

      const main = document.createElement("div");
      main.className = "leader-main";

      const scoreBlock = document.createElement("div");
      scoreBlock.className = "leader-score-block";

      if (row) {
        if (row.avatar_url) {
          const img = document.createElement("img");
          img.src = row.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = row.nick ? row.nick[0] : "?";
        }

        const nameRow = document.createElement("div");
        nameRow.className = "leader-name-row";

        const nickEl = document.createElement("div");
        nickEl.className = "leader-nick";
        nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

        const accEl = document.createElement("div");
        accEl.className = "leader-account";
        accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

        nameRow.appendChild(nickEl);
        nameRow.appendChild(accEl);

        const dept = (row.department || "").trim().toUpperCase();
        const deptEl = document.createElement("div");
        deptEl.className =
          "dept-badge " +
          (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
        deptEl.textContent = dept || "‚Äî";

        main.appendChild(nameRow);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = row.points ?? 0;

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      } else {
        avatar.textContent = "?";

        const emptyTitle = document.createElement("div");
        emptyTitle.className = "leader-empty";
        emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

        const deptEl = document.createElement("div");
        deptEl.className = "dept-badge";
        deptEl.textContent = "‚Äî";

        main.appendChild(emptyTitle);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = "0";

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      }

      card.appendChild(icon);
      card.appendChild(avatar);
      card.appendChild(main);
      card.appendChild(scoreBlock);

      return card;
    }

    async function loadLeaders(period = "day") {
      currentPeriod = period;

      if (dateEl) {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        dateEl.textContent = `${dd}.${mm}.${yyyy}`;
      }

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, nick, account_id, avatar_url, department, points_day")
        .order("points_day", { ascending: false })
        .limit(3);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è (leaderinfo).");
        return;
      }

      const rows = (data || []).map((r) => ({
        id: r.id,
        nick: (r.nick || "").trim(),
        account_id: r.account_id || null,
        avatar_url: r.avatar_url || null,
        department: r.department || null,
        points_day: Number(r.points_day || 0),
        points: Number(r.points_day || 0),
      }));

      const slots = [0,1,2].map((i) => rows[i] || null);

      leadersWrapper.innerHTML = "";
      slots.forEach((row, idx) => {
        leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
      });
    }

    async function loadWeeklyBlocks() {
      currentPeriod = "week";
      if (dateEl) dateEl.textContent = "";

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo_week")
        .select(`
          week_start,
          week_end,
          place,
          points_week,
          leader:leader_id (
            id,
            nick,
            account_id,
            avatar_url,
            department
          )
        `)
        .order("week_start", { ascending: false })
        .order("place", { ascending: true })
        .limit(30);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã leaderinfo_week.");
        return;
      }

      const rows = data || [];
      if (!rows.length) {
        leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º.";
        return;
      }

      const byWeek = new Map();
      for (const r of rows) {
        const key = r.week_start;
        if (!byWeek.has(key)) {
          byWeek.set(key, {
            week_start: r.week_start,
            week_end: r.week_end,
            places: new Map(),
          });
        }
        byWeek.get(key).places.set(Number(r.place), r);
      }

      leadersWrapper.innerHTML = "";

      for (const [, w] of byWeek) {
        const block = document.createElement("div");
        block.className = "week-block";

        const badge = document.createElement("div");
        badge.className = "week-period-badge";
        badge.innerHTML = `<span class="dot"></span>${formatPeriodRu(w.week_start, w.week_end)}`;
        block.appendChild(badge);

        for (let place = 1; place <= 3; place++) {
          const item = w.places.get(place);
          if (item && item.leader) {
            const leader = item.leader;
            const row = {
              id: leader.id,
              nick: leader.nick,
              account_id: leader.account_id,
              avatar_url: leader.avatar_url,
              department: leader.department,
              points: Number(item.points_week || 0),
            };
            block.appendChild(renderLeaderCard(place, row));
          } else {
            block.appendChild(renderLeaderCard(place, null));
          }
        }

        leadersWrapper.appendChild(block);
      }
    }

    /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ ===== */
    const tabDay = document.getElementById("tab-day");
    const tabWeek = document.getElementById("tab-week");
    if (tabDay && tabWeek) {
      const tabs = [tabDay, tabWeek];
      tabs.forEach((btn) => {
        btn.onclick = () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const period = btn.dataset.period;
          if (period === "week") loadWeeklyBlocks();
          else loadLeaders("day");
        };
      });
    }

    /* ===== BULK EDIT (LSPD/SFPD/LVPD) ===== */
    const editLeadersTopBtn = document.getElementById("edit-leaders-top");
    const bulkModal = document.getElementById("leaders-bulk-modal");
    const bulkFormsEl = document.getElementById("bulk-forms");
    const bulkCancelBtn = document.getElementById("bulk-cancel");
    const bulkSaveBtn = document.getElementById("bulk-save");
    const bulkErrorEl = document.getElementById("bulk-error");

    let bulkRows = [];
    let bulkAvatarByDept = {};

    function showBulkError(msg){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "block";
      bulkErrorEl.textContent = msg || "–û—à–∏–±–∫–∞.";
    }
    function hideBulkError(){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "none";
      bulkErrorEl.textContent = "";
    }

    function openBulkModal(){
      if(!canBulkEdit(currentUser)){
        showErrorModal("–ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ admin –∏ creator.");
        return;
      }
      hideBulkError();
      bulkModal.classList.add("active");
    }
    function closeBulkModal(){
      bulkModal.classList.remove("active");
      bulkRows = [];
      bulkAvatarByDept = {};
      if (bulkFormsEl) bulkFormsEl.innerHTML = "";
      hideBulkError();
    }

    async function fetchLeadersForDepts(){
      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, department, nick, account_id, avatar_url")
        .in("department", ["LSPD","SFPD","LVPD"]);

      if (error) throw error;

      const map = new Map((data || []).map(r => [String(r.department||"").trim().toUpperCase(), r]));
      const depts = ["LSPD","SFPD","LVPD"];

      return depts.map(d => {
        const r = map.get(d);
        return r ? {
          id: r.id,
          department: d,
          nick: r.nick || "",
          account_id: r.account_id || "",
          avatar_url: r.avatar_url || null
        } : {
          id: null,
          department: d,
          nick: "",
          account_id: "",
          avatar_url: null
        };
      });
    }

    function createBulkCard(row){
      const dept = row.department;

      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.12)";
      wrap.style.borderRadius = "18px";
      wrap.style.padding = "14px";
      wrap.style.background = "rgba(0,0,0,.12)";
      wrap.style.backdropFilter = "blur(10px)";
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "120px 1fr";
      wrap.style.gap = "14px";
      wrap.style.alignItems = "start";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "10px";
      left.style.alignItems = "center";

      const badge = document.createElement("div");
      badge.className = "dept-badge " + (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : "lvpd");
      badge.textContent = dept;

      const avatar = document.createElement("div");
      avatar.className = "edit-avatar-preview";
      avatar.style.margin = "0";
      avatar.style.width = "92px";
      avatar.style.height = "92px";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";

      const nickInput = document.createElement("input");
      nickInput.type = "text";
      nickInput.value = row.nick || "";
      nickInput.placeholder = "–ò–º—è_–§–∞–º–∏–ª–∏—è";

      const accInput = document.createElement("input");
      accInput.type = "text";
      accInput.value = row.account_id || "";
      accInput.placeholder = "3960680";

      function setAvatarPreview(src){
        avatar.innerHTML = "";
        if(src){
          const img = document.createElement("img");
          img.src = src;
          avatar.appendChild(img);
        } else {
          avatar.textContent = (nickInput.value?.trim()?.[0] || "?");
        }
      }

      setAvatarPreview(row.avatar_url || null);

      function handleFile(file){
        const reader = new FileReader();
        reader.onload = () => {
          bulkAvatarByDept[dept] = reader.result;
          setAvatarPreview(reader.result);
        };
        reader.onerror = () => showBulkError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è " + dept);
        reader.readAsDataURL(file);
      }

      avatar.addEventListener("click", () => fileInput.click());
      avatar.addEventListener("dragover", (e)=>{ e.preventDefault(); avatar.classList.add("drag-over"); });
      avatar.addEventListener("dragleave", ()=> avatar.classList.remove("drag-over"));
      avatar.addEventListener("drop", (e)=>{
        e.preventDefault(); avatar.classList.remove("drag-over");
        const f = e.dataTransfer.files?.[0];
        if(f) handleFile(f);
      });

      fileInput.addEventListener("change", (e)=>{
        const f = e.target.files?.[0];
        if(f) handleFile(f);
        fileInput.value = "";
      });

      nickInput.addEventListener("input", ()=>{
        if(!bulkAvatarByDept[dept] && !row.avatar_url){
          setAvatarPreview(null);
        }
      });

      left.appendChild(badge);
      left.appendChild(avatar);
      left.appendChild(fileInput);

      const right = document.createElement("div");

      const nickField = document.createElement("div");
      nickField.className = "field";
      const nickLabel = document.createElement("label");
      nickLabel.textContent = "–ù–∏–∫ (" + dept + ")";
      nickField.appendChild(nickLabel);
      nickField.appendChild(nickInput);

      const accField = document.createElement("div");
      accField.className = "field";
      const accLabel = document.createElement("label");
      accLabel.textContent = "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (" + dept + ")";
      accField.appendChild(accLabel);
      accField.appendChild(accInput);

      right.appendChild(nickField);
      right.appendChild(accField);

      wrap.appendChild(left);
      wrap.appendChild(right);

      return { wrap, nickInput, accInput };
    }

    async function buildBulkModal(){
      try{
        hideBulkError();
        bulkFormsEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        bulkRows = await fetchLeadersForDepts();
        bulkAvatarByDept = {};

        bulkFormsEl.innerHTML = "";
        bulkRows.forEach((row) => {
          const ui = createBulkCard(row);
          row._ui = ui;
          bulkFormsEl.appendChild(ui.wrap);
        });
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤: " + (e?.message || e));
        bulkFormsEl.innerHTML = "";
      }
    }

    async function saveBulk(){
      if(!canBulkEdit(currentUser)){
        showBulkError("–ù–µ—Ç –ø—Ä–∞–≤.");
        return;
      }
      hideBulkError();

      for(const row of bulkRows){
        const nick = row._ui.nickInput.value.trim();
        const acc = row._ui.accInput.value.trim();
        if(!row.id){
          showBulkError(`–í leaderinfo –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ ${row.department}. –í—ã–ø–æ–ª–Ω–∏ SQL –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å 3 –∑–∞–ø–∏—Å–∏).`);
          return;
        }
        if(!nick || !acc){
          showBulkError(`–ó–∞–ø–æ–ª–Ω–∏ –Ω–∏–∫ –∏ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è ${row.department}.`);
          return;
        }
      }

      try{
        for(const row of bulkRows){
          const dept = row.department;
          const payload = {
            department: dept,
            nick: row._ui.nickInput.value.trim(),
            account_id: row._ui.accInput.value.trim(),
            updated_at: new Date().toISOString(),
          };
          if (bulkAvatarByDept[dept]) payload.avatar_url = bulkAvatarByDept[dept];

          const { error } = await supabaseClient
            .from("leaderinfo")
            .update(payload)
            .eq("id", row.id);

          if(error) throw error;
        }

        closeBulkModal();
        await loadLeaders("day");
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (e?.message || e));
      }
    }

    if (editLeadersTopBtn) {
      editLeadersTopBtn.addEventListener("click", async () => {
        openBulkModal();
        await buildBulkModal();
      });
    }
    if (bulkCancelBtn) bulkCancelBtn.addEventListener("click", closeBulkModal);
    if (bulkSaveBtn) bulkSaveBtn.addEventListener("click", saveBulk);

    /* ===== INIT ===== */
    const userTagEl = document.getElementById("user-tag");

    async function initPage() {
      await loadThemeFromDB();
      applyThemeBackground();
      applyThemeToBlocks();
      applySiteBranding();

      currentUser = loadSession();
      if (userTagEl) {
        if (!currentUser) {
          userTagEl.textContent = "";
        } else {
          // –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–æ–ª—å/–Ω–∏–∫ ‚Äî –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å:
          // userTagEl.textContent = `${currentUser?.name || ""} ‚Ä¢ ${roleLabel(currentUser?.role)}`;
          userTagEl.textContent = "";
        }
      }

      if (editLeadersTopBtn) {
        editLeadersTopBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
      }

      await loadLeaders("day");
    }

    window.addEventListener("load", initPage);
  </script>
</body>
</html>
