<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤ PD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050816;
      --panel-bg: #070818;
      --panel-border: #1f2937;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent-pink: #ec4899;
      --accent-pink-soft: #f472b6;
      --accent-pink-dark: #db2777;
      --tab-bg: #111827;
      --tab-border: #1f2937;
      --score-color: #f472b6;
      --gold: #facc15;
      --silver: #e5e7eb;
      --bronze: #fb923c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #020617;
      overflow: hidden;
    }
    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }
    #bg-rotator img.active { opacity: 1; }

    #app {
      width: 100%;
      max-width: 1100px;
      position: relative;
      z-index: 1;
    }

    a { color: var(--accent-pink-soft); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.75);
    }
    .btn:hover {
      background: rgba(31, 41, 55, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.9);
    }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .btn-outline {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: transparent;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.85);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.85);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }
    .page-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-shadow: 0 0 18px rgba(168, 85, 247, 0.55);
    }
    .page-subtitle { font-size: 13px; color: var(--muted); }
    .user-tag { font-size: 12px; color: var(--muted); }

    .leader-panel {
      border-radius: 32px;
      border: 1px solid var(--panel-border);
      padding: 26px 26px 20px;
      background:
        radial-gradient(circle at top left, rgba(168, 85, 247, 0.35), transparent 55%),
        radial-gradient(circle at top right, rgba(236, 72, 153, 0.35), transparent 55%),
        linear-gradient(145deg, #020617 0%, #020617 40%, #020617 100%);
      box-shadow:
        0 40px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .leader-panel-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }

    .leader-tabs {
      display: inline-flex;
      background: var(--tab-bg);
      border-radius: 999px;
      border: 1px solid var(--tab-border);
      padding: 4px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.6);
    }
    .leader-tab {
      min-width: 160px;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      transition: color 0.12s;
    }
    .leader-tab span.icon { font-size: 14px; }
    .leader-tab.active { color: #f9fafb; }
    .leader-tab.active::before {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(251, 113, 133, 0.85), rgba(236, 72, 153, 0.95));
      box-shadow:
        0 0 22px rgba(236, 72, 153, 0.8),
        0 18px 40px rgba(15, 23, 42, 0.9);
      z-index: -1;
    }
    .leader-tab.active span.label { font-weight: 700; }
    .leader-date { font-size: 14px; color: var(--muted); }

    .leaders-wrapper {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .leader-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 22px;
      border-radius: 20px;
      background: radial-gradient(circle at right, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 22px 40px rgba(15, 23, 42, 0.9);
    }

    .leader-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.35), rgba(15, 23, 42, 0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
    }
    .leader-card.rank-1 .leader-icon { background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.55), rgba(15, 23, 42, 0.9)); }
    .leader-card.rank-2 .leader-icon { background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.55), rgba(15, 23, 42, 0.9)); }
    .leader-card.rank-3 .leader-icon { background: radial-gradient(circle at top left, rgba(249, 115, 22, 0.55), rgba(15, 23, 42, 0.9)); }

    .leader-avatar {
      width: 68px;
      height: 68px;
      border-radius: 18px;
      border: 2px solid rgba(236, 72, 153, 0.7);
      background: #020617;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
      position: relative;
      color: #e5e7eb;
    }
    .leader-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .leader-avatar.editable { cursor: pointer; border-style: solid; }
    .leader-avatar.editable::after {
      content: "‚úé";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .leader-avatar.drag-over { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.8); }

    .leader-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .leader-name-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }

    .leader-nick {
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 0 14px rgba(15, 23, 42, 0.8);
    }
    .leader-account {
      font-size: 13px;
      color: var(--accent-pink-soft);
      text-shadow: 0 0 10px rgba(236, 72, 153, 0.8);
    }

    .dept-badge {
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-top: 2px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.65);
    }
    .dept-badge.lspd { color:#22c55e; box-shadow: 0 0 18px rgba(34,197,94,.25); }
    .dept-badge.sfpd { color:#38bdf8; box-shadow: 0 0 18px rgba(56,189,248,.25); }
    .dept-badge.lvpd { color:#ef4444; box-shadow: 0 0 18px rgba(239,68,68,.25); }

    .leader-score-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 110px;
    }
    .leader-score {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-weight: 800;
      text-shadow: 0 0 16px rgba(236, 72, 153, 0.85);
    }
    .leader-score .value { font-size: 26px; color: var(--score-color); }
    .leader-score .unit { font-size: 13px; color: #e5e7eb; }
    .leader-place-label { font-size: 12px; color: var(--muted); }

    .leader-actions {
      position: absolute;
      right: 20px;
      bottom: 10px;
    }

    .leader-empty { font-size: 15px; color: var(--muted); }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.active { display: flex; }
    .modal {
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.3), rgba(15, 23, 42, 0.96));
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.95);
      padding: 18px 18px 14px;
    }
    .modal h3 { font-size: 18px; margin-bottom: 4px; }
    .modal p { font-size: 13px; color: var(--muted); margin-bottom: 10px; }
    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field { margin-bottom: 8px; }
    .field label { display: block; font-size: 13px; margin-bottom: 3px; }
    .field input, .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: #020617;
      color: var(--text);
      font-size: 14px;
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }
    .hint { font-size: 11px; color: var(--muted); margin-bottom: 4px; }

    .edit-avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 22px;
      border: 2px dashed rgba(148, 163, 184, 0.85);
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-bottom: 6px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      color: #e5e7eb;
    }
    .edit-avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .edit-avatar-preview::after {
      content: "‚úé";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .error-text { font-size: 12px; color: #f97373; margin-top: 4px; }

    .week-block { margin-top: 14px; display: flex; flex-direction: column; gap: 14px; }
    .week-period-badge {
      display: inline-flex;
      align-items: center;
      width: fit-content;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: 1px solid rgba(148,163,184,.28);
      background:
        radial-gradient(circle at top left, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(circle at top right, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(239,68,68,.18), transparent 55%),
        rgba(15,23,42,.55);
      box-shadow: 0 14px 30px rgba(15, 23, 42, .75);
    }
    .week-period-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(236,72,153,.9);
      box-shadow: 0 0 14px rgba(236,72,153,.55);
    }

    @media (max-width: 720px) {
      body { padding: 12px; }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .leader-card {
        display: grid;
        grid-template-columns: 52px 68px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        align-items: start;
        padding: 14px 14px;
      }

      .leader-icon { grid-column: 1; grid-row: 1; }
      .leader-avatar { grid-column: 2; grid-row: 1; }

      .leader-main {
        grid-column: 3;
        grid-row: 1;
        min-width: 0;
      }

      .leader-score-block {
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
      }

      .leader-actions {
        position: static;
        grid-column: 1 / -1;
        grid-row: 3;
        margin-top: 2px;
        justify-self: end;
      }

      .leader-score .value { font-size: 22px; }
    }
  </style>
</head>

<body>
<div id="bg-rotator"></div>

<div id="app">
  <div class="page-header">
    <div class="page-title-block">
      <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
      <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
      <div class="user-tag" id="user-tag"></div>
    </div>
  </div>

  <div class="leader-panel">
    <div class="leader-panel-header">
      <div class="leader-tabs">
        <button class="leader-tab active" id="tab-day" data-period="day">
          <span class="icon">‚ô•</span>
          <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
        </button>
        <button class="leader-tab" id="tab-week" data-period="week">
          <span class="icon">‚ô•</span>
          <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
        </button>
      </div>
      <div class="leader-date" id="leader-date"></div>
    </div>

    <div class="leaders-wrapper" id="leaders-wrapper">
      –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ -->
<div id="error-modal" class="modal-backdrop">
  <div class="modal">
    <h3>–û—à–∏–±–∫–∞</h3>
    <p id="error-modal-text"></p>
    <div class="modal-footer">
      <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–¥–µ—Ä–∞ -->
<div id="leader-edit-modal" class="modal-backdrop">
  <div class="modal">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–∞</h3>
    <p>–î–æ—Å—Ç—É–ø–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º (creator).</p>

    <div class="edit-avatar-preview" id="edit-avatar-preview"><span>?</span></div>
    <div class="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä.</div>
    <input type="file" id="edit-avatar-file" accept="image/*" style="display:none;" />

    <div class="field">
      <label for="edit-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
      <select id="edit-dept">
        <option value="LSPD">LSPD</option>
        <option value="SFPD">SFPD</option>
        <option value="LVPD">LVPD</option>
      </select>
    </div>

    <div class="field">
      <label for="edit-nick">–ù–∏–∫</label>
      <input id="edit-nick" type="text" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" />
    </div>

    <div class="field">
      <label for="edit-account">–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞</label>
      <input id="edit-account" type="text" placeholder="3960680" />
    </div>

    <div class="field">
      <label for="edit-points">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ê–®</label>
      <input id="edit-points" type="number" min="0" step="1" value="0" />
      <div class="hint">–û—á–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ leaderinfo.points_day –∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –∑–¥–µ—Å—å.</div>
    </div>

    <div class="error-text" id="edit-error" style="display:none;"></div>

    <div class="modal-footer">
      <button class="btn-outline btn-sm" id="leader-edit-cancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-sm" id="leader-edit-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== –¢–ï–ú–ê: —Ñ–æ–Ω + –±—Ä–µ–Ω–¥ ===== */
  let themeConfig = {
    images: [],
    opacity: 80,      // % (0-100)
    blur: 0,
    borderColor: "#1f2937",
    favicon: null,
    siteTitle: null,
  };
  let bgRotationTimer = null;
  let bgCurrentIndex = 0;
  const bgRotatorEl = document.getElementById("bg-rotator");

  async function loadThemeFromDB() {
    const { data, error } = await supabaseClient
      .from("theme_settings")
      .select("*")
      .eq("id", 1)
      .single();

    if (error || !data) {
      console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã:", error);
      return;
    }

    themeConfig = {
      images: data.images || [],
      opacity: data.opacity ?? 80,
      blur: data.blur ?? 0,
      borderColor: data.border_color || "#1f2937",
      favicon: data.favicon || null,
      siteTitle: data.site_title || null,
    };
  }

  function applyThemeBackground() {
    if (!bgRotatorEl) return;
    bgRotatorEl.innerHTML = "";

    const images = themeConfig.images || [];
    const blurPx = Number(themeConfig.blur || 0);
    const opacityPct = Math.max(0, Math.min(100, Number(themeConfig.opacity ?? 80)));
    const imgOpacity = opacityPct / 100;

    if (!images.length) {
      bgRotatorEl.style.background = "#020617";
      return;
    }

    images.forEach((src, index) => {
      const img = document.createElement("img");
      img.src = src;
      img.style.filter = "blur(" + blurPx + "px)";
      img.style.opacity = "0";
      // –ü—Ä–∏–º–µ–Ω—è–µ–º "–æ–±—â—É—é" –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–º—ã –ø–æ–≤–µ—Ä—Ö active-–ª–æ–≥–∏–∫–∏:
      img.dataset.baseOpacity = String(imgOpacity);

      if (index === 0) {
        img.classList.add("active");
        img.style.opacity = String(imgOpacity);
      }
      bgRotatorEl.appendChild(img);
    });

    if (bgRotationTimer) {
      clearInterval(bgRotationTimer);
      bgRotationTimer = null;
    }

    if (images.length > 1) {
      const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
      bgCurrentIndex = 0;
      bgRotationTimer = setInterval(() => {
        const prev = imgs[bgCurrentIndex];
        bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
        const next = imgs[bgCurrentIndex];

        if (prev) {
          prev.classList.remove("active");
          prev.style.opacity = "0";
        }
        if (next) {
          next.classList.add("active");
          next.style.opacity = next.dataset.baseOpacity || "0.8";
        }
      }, 60 * 1000);
    }
  }

  function applyThemeToBlocks() {
    const borderColor = themeConfig.borderColor || "#1f2937";
    document.documentElement.style.setProperty("--panel-border", borderColor);
  }

  function applySiteBranding() {
    document.title = themeConfig.siteTitle || "–†–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤ PD";

    if (themeConfig.favicon) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement("link");
        link.rel = "icon";
        document.head.appendChild(link);
      }
      link.href = themeConfig.favicon;
    }
  }

  /* ===== –°–ï–°–°–ò–Ø ===== */
  let currentUser = null;
  function loadSession() {
    try { return JSON.parse(localStorage.getItem("pp_user")); }
    catch { return null; }
  }
  function roleLabel(role) {
    if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
    if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
    if (role === "creator") return "–†–µ–¥–∞–∫—Ç–æ—Ä";
    return "–û—Ñ–∏—Ü–µ—Ä";
  }
  function isAdminLike(user) {
    return !!user && (user.role === "admin" || user.role === "moderator" || user.role === "creator");
  }

  /* ===== –û–®–ò–ë–ö–ò ===== */
  const errorModal = document.getElementById("error-modal");
  const errorModalText = document.getElementById("error-modal-text");
  const errorModalClose = document.getElementById("error-modal-close");
  function showErrorModal(message) {
    errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
    errorModal.classList.add("active");
  }
  if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

  /* ===== HELPERS WEEK ===== */
  function monthRuUpper(monthIndex) {
    const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
    return m[monthIndex] || "";
  }
  function formatPeriodRu(startISO, endISO) {
    const s = new Date(startISO);
    const e = new Date(endISO);
    return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
  }

  /* ===== UI / DATA ===== */
  const leadersWrapper = document.getElementById("leaders-wrapper");
  const dateEl = document.getElementById("leader-date");
  let currentPeriod = "day";

  // edit state
  const editModal = document.getElementById("leader-edit-modal");
  const editAvatarPreview = document.getElementById("edit-avatar-preview");
  const editAvatarFile = document.getElementById("edit-avatar-file");
  const editDept = document.getElementById("edit-dept");
  const editNick = document.getElementById("edit-nick");
  const editAccount = document.getElementById("edit-account");
  const editPoints = document.getElementById("edit-points");
  const editError = document.getElementById("edit-error");
  const editCancelBtn = document.getElementById("leader-edit-cancel");
  const editSaveBtn = document.getElementById("leader-edit-save");

  let editingAvatarData = null;
  let editingRow = null; // —Ç–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ (–æ–±—ä–µ–∫—Ç leaderinfo)

  function setEditAvatarPreview(src, nickInitial) {
    editAvatarPreview.innerHTML = "";
    if (src) {
      const img = document.createElement("img");
      img.src = src;
      editAvatarPreview.appendChild(img);
    } else {
      const span = document.createElement("span");
      span.textContent = nickInitial || "?";
      editAvatarPreview.appendChild(span);
    }
  }

  function openEditModal(row) {
    if (!isAdminLike(currentUser)) {
      showErrorModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º.");
      return;
    }
    if (!row || !row.id) {
      showErrorModal("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ª–∏–¥–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      return;
    }

    // —Ñ–∏–∫—Å "—É—Ç–µ—á–∫–∏" —Å–æ—Å—Ç–æ—è–Ω–∏—è: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä—Ç—É–µ–º —á–∏—Å—Ç–æ
    editingRow = row;
    if (!editingAvatarData) editingAvatarData = null;

    editDept.value = (row.department || "LSPD").trim().toUpperCase();
    editNick.value = row.nick || "";
    editAccount.value = row.account_id || "";

    editPoints.value = (row.points_day ?? 0);
    editPoints.disabled = true;

    const initialAvatar = editingAvatarData || row.avatar_url || null;
    setEditAvatarPreview(initialAvatar, (row.nick ? row.nick[0] : "?"));

    editError.style.display = "none";
    editModal.classList.add("active");
  }

  function closeEditModal() {
    editModal.classList.remove("active");
    editingAvatarData = null;
    editingRow = null;
    setEditAvatarPreview(null, "?");
  }

  function handleEditAvatarFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      editingAvatarData = reader.result;
      const nickInitial = editNick.value ? editNick.value[0] : "?";
      setEditAvatarPreview(editingAvatarData, nickInitial);
    };
    reader.onerror = () => showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞.");
    reader.readAsDataURL(file);
  }

  if (editAvatarPreview) {
    editAvatarPreview.addEventListener("click", () => {
      if (!isAdminLike(currentUser)) return;
      editAvatarFile.click();
    });
    editAvatarPreview.addEventListener("dragover", (e) => {
      e.preventDefault();
      editAvatarPreview.classList.add("drag-over");
    });
    editAvatarPreview.addEventListener("dragleave", () => editAvatarPreview.classList.remove("drag-over"));
    editAvatarPreview.addEventListener("drop", (e) => {
      e.preventDefault();
      editAvatarPreview.classList.remove("drag-over");
      if (!isAdminLike(currentUser)) return;
      const file = e.dataTransfer.files[0];
      if (file) handleEditAvatarFile(file);
    });
  }
  if (editAvatarFile) {
    editAvatarFile.onchange = (e) => {
      const file = e.target.files[0];
      if (file) handleEditAvatarFile(file);
      editAvatarFile.value = "";
    };
  }
  if (editCancelBtn) editCancelBtn.onclick = closeEditModal;

  // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ leaderinfo (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ id)
  if (editSaveBtn) {
    editSaveBtn.onclick = async () => {
      if (!isAdminLike(currentUser)) {
        showErrorModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º.");
        return;
      }
      if (!editingRow?.id) {
        showErrorModal("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: –ª–∏–¥–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω.");
        return;
      }

      const dept = (editDept.value || "LSPD").trim().toUpperCase();
      const newNick = editNick.value.trim();
      const account = editAccount.value.trim();

      if (!newNick || !account) {
        editError.style.display = "block";
        editError.textContent = "–ù–∏–∫ –∏ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.";
        return;
      }
      editError.style.display = "none";

      const payload = {
        department: dept,
        nick: newNick,
        account_id: account,
        updated_at: new Date().toISOString(),
      };
      if (editingAvatarData) payload.avatar_url = editingAvatarData;

      try {
        const { error } = await supabaseClient
          .from("leaderinfo")
          .update(payload)
          .eq("id", editingRow.id);

        if (error) {
          console.error("leaderinfo update error:", error);
          showErrorModal(
            "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞: " +
            (error.message || "unknown") +
            (error.details ? "\n" + error.details : "")
          );
          return;
        }

        closeEditModal();
        await loadLeaders("day"); // –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ –¥–Ω–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      } catch (e) {
        console.error(e);
        showErrorModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞: " + (e?.message || e));
      }
    };
  }

  function attachAvatarHandlers(avatarEl, row) {
    if (!isAdminLike(currentUser)) return;
    avatarEl.classList.add("editable");

    const startWithFile = (file) => {
      const reader = new FileReader();
      reader.onload = () => {
        // —Ñ–∏–∫—Å "—É—Ç–µ—á–∫–∏": –∞–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
        editingAvatarData = reader.result;
        openEditModal(row);
      };
      reader.onerror = () => showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞.");
      reader.readAsDataURL(file);
    };

    avatarEl.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.style.display = "none";
      document.body.appendChild(input);
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) startWithFile(file);
        document.body.removeChild(input);
      };
      input.click();
    });

    avatarEl.addEventListener("dragover", (e) => {
      e.preventDefault();
      avatarEl.classList.add("drag-over");
    });
    avatarEl.addEventListener("dragleave", () => avatarEl.classList.remove("drag-over"));
    avatarEl.addEventListener("drop", (e) => {
      e.preventDefault();
      avatarEl.classList.remove("drag-over");
      const file = e.dataTransfer.files[0];
      if (file) startWithFile(file);
    });
  }

  function renderLeaderCard(place, row) {
    const card = document.createElement("div");
    card.className = "leader-card rank-" + place;

    const icon = document.createElement("div");
    icon.className = "leader-icon";
    icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

    const avatar = document.createElement("div");
    avatar.className = "leader-avatar";

    const main = document.createElement("div");
    main.className = "leader-main";

    const scoreBlock = document.createElement("div");
    scoreBlock.className = "leader-score-block";

    if (row) {
      if (row.avatar_url) {
        const img = document.createElement("img");
        img.src = row.avatar_url;
        avatar.appendChild(img);
      } else {
        avatar.textContent = row.nick ? row.nick[0] : "?";
      }

      const nameRow = document.createElement("div");
      nameRow.className = "leader-name-row";

      const nickEl = document.createElement("div");
      nickEl.className = "leader-nick";
      nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

      const accEl = document.createElement("div");
      accEl.className = "leader-account";
      accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

      nameRow.appendChild(nickEl);
      nameRow.appendChild(accEl);

      const dept = (row.department || "").trim().toUpperCase();
      const deptEl = document.createElement("div");
      deptEl.className =
        "dept-badge " +
        (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
      deptEl.textContent = dept || "‚Äî";

      main.appendChild(nameRow);
      main.appendChild(deptEl);

      const scoreRow = document.createElement("div");
      scoreRow.className = "leader-score";

      const valueEl = document.createElement("span");
      valueEl.className = "value";
      // points –¥–ª—è –¥–Ω—è/–Ω–µ–¥–µ–ª–∏ –∫–ª–∞–¥—ë–º –∑–∞—Ä–∞–Ω–µ–µ –≤ row.points
      valueEl.textContent = row.points ?? 0;

      const unitEl = document.createElement("span");
      unitEl.className = "unit";
      unitEl.textContent = "–ê–®";

      scoreRow.appendChild(valueEl);
      scoreRow.appendChild(unitEl);

      const placeLabel = document.createElement("div");
      placeLabel.className = "leader-place-label";
      placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

      scoreBlock.appendChild(scoreRow);
      scoreBlock.appendChild(placeLabel);
    } else {
      avatar.textContent = "?";

      const emptyTitle = document.createElement("div");
      emptyTitle.className = "leader-empty";
      emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

      const deptEl = document.createElement("div");
      deptEl.className = "dept-badge";
      deptEl.textContent = "‚Äî";

      main.appendChild(emptyTitle);
      main.appendChild(deptEl);

      const scoreRow = document.createElement("div");
      scoreRow.className = "leader-score";

      const valueEl = document.createElement("span");
      valueEl.className = "value";
      valueEl.textContent = "0";

      const unitEl = document.createElement("span");
      unitEl.className = "unit";
      unitEl.textContent = "–ê–®";

      scoreRow.appendChild(valueEl);
      scoreRow.appendChild(unitEl);

      const placeLabel = document.createElement("div");
      placeLabel.className = "leader-place-label";
      placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

      scoreBlock.appendChild(scoreRow);
      scoreBlock.appendChild(placeLabel);
    }

    card.appendChild(icon);
    card.appendChild(avatar);
    card.appendChild(main);
    card.appendChild(scoreBlock);

    // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ "–¥–µ–Ω—å"
    if (isAdminLike(currentUser) && currentPeriod === "day" && row) {
      attachAvatarHandlers(avatar, row);

      const actions = document.createElement("div");
      actions.className = "leader-actions";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn-outline btn-sm";
      btn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      btn.onclick = () => {
        editingAvatarData = null; // —Ñ–∏–∫—Å: —á–∏—Å—Ç–∏–º –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        openEditModal(row);
      };

      actions.appendChild(btn);
      card.appendChild(actions);
    }

    return card;
  }

  async function loadLeaders(period = "day") {
    currentPeriod = period;

    if (dateEl) {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      dateEl.textContent = `${dd}.${mm}.${yyyy}`;
    }

    if (!leadersWrapper) return;
    leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    // –¢–û–ü-3 –∏–∑ leaderinfo –ø–æ points_day
    const { data, error } = await supabaseClient
      .from("leaderinfo")
      .select("id, nick, account_id, avatar_url, department, points_day")
      .order("points_day", { ascending: false })
      .limit(3);

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.";
      showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è (leaderinfo).");
      return;
    }

    // –°–ª–æ—Ç—ã –≤—Å–µ–≥–¥–∞ 3 ‚Äî –µ—Å–ª–∏ –≤ –±–∞–∑–µ –º–µ–Ω—å—à–µ, –¥–æ–±–∏–≤–∞–µ–º –ø—É—Å—Ç—ã–º–∏
    const rows = (data || []).map((r) => ({
      id: r.id,
      nick: (r.nick || "").trim(),
      account_id: r.account_id || null,
      avatar_url: r.avatar_url || null,
      department: r.department || null,
      points_day: Number(r.points_day || 0),
      points: Number(r.points_day || 0),
    }));

    const slots = [0,1,2].map((i) => rows[i] || null);

    leadersWrapper.innerHTML = "";
    slots.forEach((row, idx) => {
      leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
    });
  }

  async function loadWeeklyBlocks() {
    currentPeriod = "week";
    if (dateEl) dateEl.textContent = "";

    if (!leadersWrapper) return;
    leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –Ω–µ–¥–µ–ª—å * 3 –º–µ—Å—Ç–∞ = 30 —Å—Ç—Ä–æ–∫
    // –°—Ä–∞–∑—É —Å join –Ω–∞ leaderinfo –ø–æ FK leader_id
    const { data, error } = await supabaseClient
      .from("leaderinfo_week")
      .select(`
        week_start,
        week_end,
        place,
        points_week,
        leader:leader_id (
          id,
          nick,
          account_id,
          avatar_url,
          department
        )
      `)
      .order("week_start", { ascending: false })
      .order("place", { ascending: true })
      .limit(30);

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏.";
      showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã leaderinfo_week.");
      return;
    }

    const rows = data || [];
    if (!rows.length) {
      leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º.";
      return;
    }

    // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ week_start
    const byWeek = new Map();
    for (const r of rows) {
      const key = r.week_start;
      if (!byWeek.has(key)) {
        byWeek.set(key, {
          week_start: r.week_start,
          week_end: r.week_end,
          places: new Map(),
        });
      }
      byWeek.get(key).places.set(Number(r.place), r);
    }

    leadersWrapper.innerHTML = "";

    // –ø–æ—Ä—è–¥–æ–∫ —É–∂–µ desc –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ ‚Äî –Ω–æ Map —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤—Å—Ç–∞–≤–∫–∏
    for (const [, w] of byWeek) {
      const block = document.createElement("div");
      block.className = "week-block";

      const badge = document.createElement("div");
      badge.className = "week-period-badge";
      badge.innerHTML = `<span class="dot"></span>${formatPeriodRu(w.week_start, w.week_end)}`;
      block.appendChild(badge);

      // 3 –º–µ—Å—Ç–∞ –≤—Å–µ–≥–¥–∞
      for (let place = 1; place <= 3; place++) {
        const item = w.places.get(place);
        if (item && item.leader) {
          const leader = item.leader;
          const row = {
            id: leader.id,
            nick: leader.nick,
            account_id: leader.account_id,
            avatar_url: leader.avatar_url,
            department: leader.department,
            points: Number(item.points_week || 0),
          };
          block.appendChild(renderLeaderCard(place, row));
        } else {
          block.appendChild(renderLeaderCard(place, null));
        }
      }

      leadersWrapper.appendChild(block);
    }
  }

  /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ ===== */
  const tabDay = document.getElementById("tab-day");
  const tabWeek = document.getElementById("tab-week");
  if (tabDay && tabWeek) {
    const tabs = [tabDay, tabWeek];
    tabs.forEach((btn) => {
      btn.onclick = () => {
        tabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period;
        if (period === "week") loadWeeklyBlocks();
        else loadLeaders("day");
      };
    });
  }

  /* ===== INIT ===== */
  const userTagEl = document.getElementById("user-tag");

  async function initPage() {
    await loadThemeFromDB();
    applyThemeBackground();
    applyThemeToBlocks();
    applySiteBranding();

    currentUser = loadSession();
    if (userTagEl) {
      if (!currentUser) {
        userTagEl.textContent = "–†–µ–∂–∏–º –≥–æ—Å—Ç—è ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞.";
      } else {
        userTagEl.textContent = "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ " + currentUser.nick + " (" + roleLabel(currentUser.role) + ")";
      }
    }

    await loadLeaders("day");
  }

  window.addEventListener("load", initPage);
</script>
</body>
</html>
