<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</title>
  <link rel="icon" type="image/png" href="favicon1.ico">
  <link rel="apple-touch-icon" href="favicon1.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --text:#f3f6ff;

      /* –∫—Ä–∞—Å–Ω–æ-—Ä–æ–∑–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
      --accent1:#ff2d7a;  /* hot pink */
      --accent2:#ff3656;  /* red-pink */
      --accent3:#ff6ad5;  /* magenta */
      --accentRed:#ff2a3a;

      --shadowSoft: 0 18px 70px rgba(0,0,0,.55);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body{
      min-height:100vh;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      overflow-x:hidden;

      background: url("fon2.png") center / cover no-repeat fixed;
      position:relative;

      filter: brightness(1.08) saturate(1.18) contrast(1.06);
    }

    /* –¥—ã–º–∫–∞/–≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-4;

      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(255,54,86,.22), transparent 62%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,45,122,.22), transparent 58%),
        radial-gradient(900px 520px at 90% 18%, rgba(255,106,213,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.30) 0%, rgba(0,0,0,.22) 45%, rgba(0,0,0,.34) 100%);

      mix-blend-mode: normal;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-3;

      background:
        radial-gradient(700px 420px at 18% 18%, rgba(255,45,122,.16), transparent 60%),
        radial-gradient(760px 520px at 82% 22%, rgba(255,54,86,.12), transparent 62%),
        linear-gradient(115deg,
          rgba(255,45,122,.10) 0%,
          rgba(255,54,86,.08) 40%,
          rgba(255,106,213,.08) 100%
        );

      mix-blend-mode: screen;
      opacity: .95;
      filter: blur(0.2px);
    }

    /* ‚Äú–∂–∏–≤—ã–µ‚Äù —Å–ª–æ–∏ */
    .bg-live{
      position: fixed;
      inset: 0;
      z-index: -3;
      pointer-events:none;
      overflow:hidden;
    }

    .bg-live .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.05) 0px,
          rgba(255,255,255,.05) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      opacity:.10;
      mix-blend-mode: overlay;
      animation: scanMove 2.8s linear infinite;
    }
    @keyframes scanMove{
      0%   { transform: translateY(0); }
      100% { transform: translateY(18px); }
    }

    .bg-live .particles{
      position:absolute; inset:0;
      opacity:.28;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 42% 76%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 66%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 52%, rgba(255,45,122,.14) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 62%, rgba(255,54,86,.12) 0 1px, transparent 2px);
      background-size: 520px 520px, 680px 680px, 760px 760px, 900px 900px, 700px 700px, 820px 820px;
      animation: particlesDrift 22s linear infinite;
    }
    @keyframes particlesDrift{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-3%, 2%, 0); }
    }

    .bg-live .vignette{
      position:absolute; inset:-2px;
      background: radial-gradient(circle at center, transparent 0 52%, rgba(0,0,0,.45) 78%, rgba(0,0,0,.78) 100%);
      opacity:.95;
    }

    #app{
      width:100%;
      max-width:1200px;
      position:relative;
      z-index:1;
    }

    /* ================= HEADER ================= */
    .page-header{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      margin-bottom: 14px;
      padding-top: 6px;
    }
    .page-title-block{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
    }
    .page-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.01em;
      text-shadow:
        0 0 20px rgba(255,45,122,.20),
        0 0 44px rgba(255,54,86,.12);
    }
    .page-subtitle{
      font-size:20px;
      color: rgba(243,246,255,.75);
      text-shadow: 0 0 18px rgba(255,45,122,.10);
    }
    .user-tag{ font-size:12px; color: rgba(243,246,255,.60); margin-top:2px; }

    .page-header-actions{
      position:absolute;
      right:0;
      top:0;
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* ================= BUTTONS ================= */
    .btn{
      border: 1px solid rgba(255,45,122,.55);
      background: rgba(0,0,0,.10);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 26px rgba(255,45,122,.18);
      color: rgba(243,246,255,.90);
      cursor:pointer;
      border-radius: 12px;
    }
    .btn:hover{
      border-color: rgba(255,54,86,.70);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 34px rgba(255,45,122,.24),
        0 0 54px rgba(255,106,213,.16);
    }
    .btn-sm{ padding: 11px 18px; font-size: 14px; }

    .btn-outline{
      padding: 10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.10);
      color: rgba(243,246,255,.88);
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .btn-outline:hover{
      transform: translateY(-1px);
      border-color: rgba(255,45,122,.40);
      box-shadow: 0 0 24px rgba(255,45,122,.16);
    }

    /* ================= PANEL + TABS ================= */
    .leader-panel{
      position:relative;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
      overflow: visible;
    }

    .leader-panel-header{
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
      position:relative;
      z-index:1;
    }

    .leader-tabs{
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: center;

      width: min(860px, 100%);
      margin: 0 auto;

      border-radius: 999px;
      padding: 6px;

      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);

      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 16px 46px rgba(0,0,0,.28),
        0 0 26px rgba(255,45,122,.10);

      overflow: hidden;
    }

    .leader-tab{
      flex: 1 1 0;
      min-width: 0;
      white-space: nowrap;

      position:relative;
      border:0;
      background: transparent;
      border-radius: 999px;

      padding: 14px 18px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .10em;
      text-transform: uppercase;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;

      color: rgba(243,246,255,.78);
      cursor:pointer;
      transition: transform .14s ease, color .14s ease, filter .14s ease;
    }

    .leader-tab:hover{
      transform: translateY(-1px);
      color: rgba(255,255,255,.94);
      filter: drop-shadow(0 0 12px rgba(255,45,122,.22));
    }

    .leader-tab.active{
      color:#fff;
      text-shadow: 0 0 18px rgba(255,45,122,.22);
    }

    .leader-tab.active::before{
      content:"";
      position:absolute;
      inset:-2px -10px -2px -2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,45,122,.95), rgba(255,54,86,.85));
      box-shadow:
        0 0 30px rgba(255,45,122,.30),
        0 0 44px rgba(255,54,86,.18);
      z-index:-2;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
    }

    .leader-tab.active::after{
      content:"";
      position:absolute;
      inset: 2px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      z-index:-1;
      clip-path: polygon(0% 0%, 92% 0%, 100% 50%, 92% 100%, 0% 100%, 0% 0%);
      backdrop-filter: blur(12px);
    }

    .leader-date{
      font-size: 18px;
      letter-spacing:.10em;
      color: rgba(243,246,255,.72);
      margin-top: 4px;
      text-shadow: 0 0 18px rgba(255,45,122,.10);
    }

    .leaders-wrapper{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:18px;
      position:relative;
      z-index:1;
    }

    /* ================= LEADER CARDS ================= */

    .leader-card{
      position:relative;
      display:flex;
      align-items:center;
      gap: 22px;
      padding: 18px 24px;

      /* –±–æ–ª–µ–µ ‚Äú–∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è‚Äù –≥–µ–æ–º–µ—Ç—Ä–∏—è */
      border-radius: 14px;

      /* –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è/–∑–∞–ª–∏–≤–∫–∏ */
      background: transparent;
      backdrop-filter: none;
      border: 0;

      box-shadow: 0 14px 54px rgba(0,0,0,.30);
      overflow:hidden;

      clip-path: polygon(
        0% 0%,
        100% 0%,
        100% calc(100% - 26px),
        calc(100% - 26px) 100%,
        0% 100%,
        0% 0%
      );

      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }

    .leader-card:hover{
      transform: translateY(-7px);
      box-shadow:
        0 24px 80px rgba(0,0,0,.45),
        0 0 46px rgba(255,45,122,.20);
      filter: saturate(1.06) brightness(1.02);
    }

    /* –ë–ª–∏–∫ (–æ—Å—Ç–∞–≤–∏–º, –Ω–æ –æ–Ω –Ω–µ ‚Äú—Ä–∞–∑–º—ã–≤–∞–µ—Ç‚Äù –±–ª–æ–∫) */
    .leader-card .sheen{
      position:absolute;
      inset:-40% -60%;
      pointer-events:none;
      background: linear-gradient(115deg,
        transparent 0%,
        rgba(255,255,255,.00) 35%,
        rgba(255,255,255,.12) 45%,
        rgba(255,45,122,.10) 50%,
        rgba(255,54,86,.08) 55%,
        rgba(255,255,255,.00) 65%,
        transparent 100%
      );
      transform: translateX(-60%) rotate(10deg);
      opacity: 0;
      transition: opacity .16s ease;
      mix-blend-mode: screen;
      z-index: 0;
    }
    .leader-card:hover .sheen{
      opacity: 1;
      animation: sheenSweep .75s ease-out 1;
    }
    @keyframes sheenSweep{
      0%   { transform: translateX(-60%) rotate(10deg); }
      100% { transform: translateX( 60%) rotate(10deg); }
    }

    /* ====== SVG —Ä–∞–º–∫–∞: –¥–≤–æ–π–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ + —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –ø–æ –º–µ—Å—Ç—É + —Ö–≤–æ—Å—Ç—ã ====== */

    .leader-card .border-svg{
      position:absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events:none;
      z-index: 0;
      filter:
        drop-shadow(0 0 10px rgba(255,45,122,.38))
        drop-shadow(0 0 22px rgba(255,45,122,.22));
    }

    .leader-card > *{
      position:relative;
      z-index: 1;
    }

    /* –≤–Ω–µ—à–Ω—è—è –æ–±–≤–æ–¥–∫–∞ (—Ç–æ–ª—Å—Ç–∞—è) */
    .border-outer{
      fill:none;
      stroke: rgba(255,45,122,.85);
      stroke-width: 5.2;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
    }

    /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–±–≤–æ–¥–∫–∞ (—Ç–æ–Ω–∫–∞—è, —Å–≤–µ—Ç–ª–µ–µ) */
    .border-inner{
      fill:none;
      stroke: rgba(255,160,190,.55);
      stroke-width: 2.0;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 8px rgba(255,45,122,.22));
    }

    /* –º—è–≥–∫–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–¥–æ–ª—å —Ä–∞–º–∫–∏ */
    .border-glow{
      fill:none;
      stroke: rgba(255,54,86,.18);
      stroke-width: 10;
      vector-effect: non-scaling-stroke;
      stroke-linejoin: round;
      filter: blur(0.8px);
    }

    /* –Ω–µ–æ–Ω–æ–≤—ã–µ –±–µ–≥—É—â–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã (2 —Å–ª–æ—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã) */
    .border-neon{
      fill:none;
      stroke-width: 5.8;
      vector-effect: non-scaling-stroke;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .96;

      filter:
        drop-shadow(0 0 10px rgba(255,45,122,.50))
        drop-shadow(0 0 18px rgba(255,106,213,.22));
    }

    /* ‚Äú—Ö–≤–æ—Å—Ç‚Äù –¥–ª–∏–Ω–Ω–µ–µ/–∫–æ—Ä–æ—á–µ —Ä–µ–≥—É–ª–∏—Ä—É–µ–º dasharray */
    .border-neon.neon-a{
      stroke: rgba(255,106,213,.95);
      stroke-dasharray: 110 620;       /* –î–õ–ò–ù–ù–´–ô —Ö–≤–æ—Å—Ç */
      animation: dashA 5.4s linear infinite;
    }
    .border-neon.neon-b{
      stroke: rgba(255,45,122,.95);
      stroke-width: 4.8;
      stroke-dasharray: 70 520;        /* –ß–£–¢–¨ –∫–æ—Ä–æ—á–µ */
      opacity: .85;
      animation: dashB 4.8s linear infinite;
    }

    @keyframes dashA{ to { stroke-dashoffset: -1100; } }
    @keyframes dashB{ to { stroke-dashoffset:  1100; } }

    /* —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏/–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—Ç—É */
    .leader-card.rank-1 .border-svg{
      filter:
        drop-shadow(0 0 12px rgba(255,45,122,.46))
        drop-shadow(0 0 28px rgba(255,106,213,.22));
    }
    .leader-card.rank-1 .border-outer{ stroke: rgba(255,60,120,.92); }
    .leader-card.rank-1 .border-neon.neon-a{ animation-duration: 5.0s; stroke-dasharray: 130 650; }
    .leader-card.rank-1 .border-neon.neon-b{ animation-duration: 4.4s; stroke-dasharray: 85 560; }

    .leader-card.rank-2 .border-svg{
      filter:
        drop-shadow(0 0 10px rgba(255,45,122,.38))
        drop-shadow(0 0 22px rgba(255,54,86,.18));
    }
    .leader-card.rank-2 .border-outer{ stroke: rgba(255,45,122,.82); }
    .leader-card.rank-2 .border-neon.neon-a{ animation-duration: 5.6s; stroke-dasharray: 110 640; }
    .leader-card.rank-2 .border-neon.neon-b{ animation-duration: 5.0s; stroke-dasharray: 70 540; }

    .leader-card.rank-3 .border-svg{
      filter:
        drop-shadow(0 0 9px rgba(255,45,122,.32))
        drop-shadow(0 0 18px rgba(255,54,86,.14));
    }
    .leader-card.rank-3 .border-outer{ stroke: rgba(255,54,86,.74); }
    .leader-card.rank-3 .border-neon.neon-a{ animation-duration: 6.0s; stroke-dasharray: 95 620; }
    .leader-card.rank-3 .border-neon.neon-b{ animation-duration: 5.2s; stroke-dasharray: 60 520; }

    /* ====== EMOJI hover layer ====== */
    .leader-card .emoji-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 0;
      opacity: 0;
      transition: opacity .15s ease;
    }
    .leader-card:hover .emoji-layer{
      opacity: 1;
    }
    .leader-card .emoji-layer span{
      position:absolute;
      bottom: -26px;
      animation-name: floatUp;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      will-change: transform, opacity;
      filter: drop-shadow(0 0 10px rgba(255,45,122,.25));
      user-select:none;
    }
    @keyframes floatUp{
      0%   { transform: translateY(0);      opacity: 0; }
      12%  { opacity: .65; }
      100% { transform: translateY(-140%);  opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce){
      .border-neon.neon-a,
      .border-neon.neon-b,
      .leader-card .emoji-layer span,
      .bg-live .scanlines,
      .bg-live .particles{
        animation: none !important;
      }
    }

    /* –ò–∫–æ–Ω–∫–∞ –º–µ—Å—Ç–∞ */
    .leader-icon{
      width: 58px;
      height: 58px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;

      background: rgba(0,0,0,.03);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 22px rgba(255,45,122,.10);
      flex-shrink:0;
    }

    /* –ê–≤–∞—Ç–∞—Ä */
    .leader-avatar{
      width: 72px;
      height: 72px;
      border-radius: 14px;
      border: 2px solid rgba(255,45,122,.45);
      background: rgba(0,0,0,.03);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.85);
      font-size: 26px;
      flex-shrink:0;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 22px rgba(255,45,122,.10);
    }
    .leader-avatar img{ width:100%; height:100%; object-fit: cover; }

    .leader-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .leader-name-row{
      display:flex;
      flex-wrap:wrap;
      align-items:baseline;
      gap: 12px;
    }

    .leader-nick{
      font-size: 32px;
      font-weight: 900;
      letter-spacing: .01em;
      text-shadow:
        0 0 16px rgba(255,45,122,.12),
        0 0 24px rgba(255,54,86,.10);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    .leader-account{
      font-size: 16px;
      font-weight: 800;
      color: rgba(255,106,213,.92);
      text-shadow: 0 0 14px rgba(255,45,122,.12);
    }

    .dept-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.04);
    }
    .dept-badge.lspd{ color:#28e07a; box-shadow: 0 0 18px rgba(40,224,122,.10); }
    .dept-badge.sfpd{ color:#2fc7ff; box-shadow: 0 0 18px rgba(47,199,255,.10); }
    .dept-badge.lvpd{ color:#ff5a7e; box-shadow: 0 0 18px rgba(255,90,126,.10); }

    .leader-score-block{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
      min-width: 220px;
      flex-shrink:0;
    }

    .leader-score{
      display:flex;
      align-items:baseline;
      gap: 10px;
      font-weight: 900;
    }

    .leader-score .value{
      font-size: 56px;
      letter-spacing: .02em;

      background: linear-gradient(90deg, rgba(255,45,122,1), rgba(255,54,86,.98));
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;

      filter:
        drop-shadow(0 0 14px rgba(255,45,122,.45))
        drop-shadow(0 0 26px rgba(255,54,86,.25));
    }

    .leader-score .unit{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;

      color: rgba(255,106,213,.95);
      text-shadow:
        0 0 10px rgba(255,45,122,.30),
        0 0 18px rgba(255,106,213,.22);
    }

    .leader-place-label{
      font-size: 16px;
      color: rgba(243,246,255,.72);
      letter-spacing: .06em;
      text-shadow: 0 0 16px rgba(255,45,122,.08);
    }

    .leader-empty{ font-size: 16px; color: rgba(243,246,255,.62); }

    /* ================= MODALS ================= */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width:100%;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      backdrop-filter: blur(14px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 28px 80px rgba(0,0,0,.72);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(255,45,122,.55), rgba(255,54,86,.45), rgba(255,106,213,.55));
      opacity:.14;
      filter: blur(12px);
      pointer-events:none;
    }
    .modal h3{ font-size: 20px; font-weight: 900; margin-bottom: 6px; }
    .modal p{ font-size: 14px; color: rgba(243,246,255,.70); margin-bottom: 10px; }

    .modal-footer{
      margin-top: 12px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }

    .field{ margin-bottom: 10px; }
    .field label{ display:block; font-size: 13px; margin-bottom: 4px; color: rgba(243,246,255,.78); }
    .field input, .field select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 14px;
      outline:none;
      backdrop-filter: blur(10px);
    }
    .field input:focus, .field select:focus{
      border-color: rgba(255,45,122,.40);
      box-shadow: 0 0 0 2px rgba(255,45,122,.12);
    }

    .error-text{ font-size: 13px; color: #ff8585; margin-top: 6px; }

    .edit-avatar-preview{
      width: 92px;
      height: 92px;
      border-radius: 22px;
      border: 2px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      cursor:pointer;
      color: rgba(255,255,255,.85);
      position:relative;
      backdrop-filter: blur(10px);
    }
    .edit-avatar-preview img{ width:100%; height:100%; object-fit:cover; }
    .edit-avatar-preview::after{
      content:"‚úé";
      position:absolute;
      right:-2px;
      bottom:-2px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      backdrop-filter: blur(10px);
    }

    .drag-over{ box-shadow: 0 0 0 3px rgba(255,45,122,.35); }

    .week-block{ margin-top: 14px; display:flex; flex-direction:column; gap: 14px; }

    .week-period-badge{
      display:inline-flex;
      align-items:center;
      width: fit-content;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.06);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 40px rgba(0,0,0,.26);
      color: rgba(243,246,255,.78);
      text-shadow: 0 0 14px rgba(255,45,122,.08);
    }
    .week-period-badge .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 10px;
      background: rgba(255,45,122,.95);
      box-shadow: 0 0 14px rgba(255,45,122,.35);
    }

    /* ================= RESPONSIVE ================= */
    @media (max-width: 1100px){
      .leader-nick{ font-size: 28px; }
      .leader-score .value{ font-size: 50px; }
      .page-title{ font-size: 48px; }
      .leader-score-block{ min-width: 200px; }
    }
    @media (max-width: 820px){
      .leader-tab{ font-size: 14px; }
      .page-title{ font-size: 40px; }
      .page-subtitle{ font-size: 16px; }
      .leader-score-block{ min-width: 180px; }
    }
    @media (max-width: 720px){
      body{ padding: 12px; }
      .page-header{ justify-content:flex-start; }
      .page-title-block{ text-align:left; align-items:flex-start; }
      .page-title{ font-size: 34px; }
      .page-subtitle{ font-size: 14px; }
      .page-header-actions{ position: static; margin-left:auto; }

      .leader-card{
        display:grid;
        grid-template-columns: 58px 72px 1fr;
        grid-template-rows: auto auto auto;
        column-gap: 12px;
        row-gap: 10px;
        padding: 14px 14px;
      }
      .leader-icon{ grid-column:1; grid-row:1; }
      .leader-avatar{ grid-column:2; grid-row:1; }
      .leader-main{ grid-column:3; grid-row:1; }
      .leader-score-block{
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        min-width: 0;
      }
      .leader-score .value{ font-size: 40px; }
      .leader-score .unit{ font-size: 16px; }
      .leader-place-label{ font-size: 14px; }
      .leader-tabs{ width:100%; }
      .leader-tab{ flex:1; padding: 12px 12px; letter-spacing: .08em; }
      .leader-nick{ font-size: 24px; }
      .leader-account{ font-size: 14px; }
    }
  </style>
</head>

<body>
  <div class="bg-live" aria-hidden="true">
    <div class="particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
  </div>

  <div id="app">
    <div class="page-header">
      <div class="page-title-block">
        <div class="page-title">–¢–æ–ø –ª–∏–¥–µ—Ä–æ–≤ PD</div>
        <div class="page-subtitle">–ö—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–±—Ä–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö –ê–®.</div>
        <div class="user-tag" id="user-tag"></div>
      </div>

      <div class="page-header-actions">
        <button class="btn btn-sm" id="edit-leaders-top" style="display:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏–¥–µ—Ä–æ–≤</button>
      </div>
    </div>

    <div class="leader-panel">
      <div class="leader-panel-header">
        <div class="leader-tabs">
          <button class="leader-tab active" id="tab-day" data-period="day">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è</span>
          </button>
          <button class="leader-tab" id="tab-week" data-period="week">
            <span class="icon">‚ô•</span>
            <span class="label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏</span>
          </button>
        </div>
        <div class="leader-date" id="leader-date"></div>
      </div>

      <div class="leaders-wrapper" id="leaders-wrapper">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ -->
  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ bulk-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="leaders-bulk-modal" class="modal-backdrop">
    <div class="modal" style="max-width: 720px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤ (LSPD / SFPD / LVPD)</h3>
      <p>–ú–µ–Ω—è—é—Ç—Å—è –Ω–∏–∫, –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤–∞—Ç–∞—Ä. –û—á–∫–∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.</p>

      <div id="bulk-error" class="error-text" style="display:none;"></div>
      <div id="bulk-forms" style="display:flex; flex-direction:column; gap:12px; margin-top:12px;"></div>

      <div class="modal-footer">
        <button class="btn-outline" id="bulk-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn" id="bulk-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== –°–ï–°–°–ò–Ø ===== */
    let currentUser = null;
    function loadSession() {
      try { return JSON.parse(localStorage.getItem("pp_user")); }
      catch { return null; }
    }
    function canBulkEdit(user) {
      const role = String(user?.role || "").trim().toLowerCase();
      return role === "admin" || role === "creator";
    }

    /* ===== –û–®–ò–ë–ö–ò ===== */
    const errorModal = document.getElementById("error-modal");
    const errorModalText = document.getElementById("error-modal-text");
    const errorModalClose = document.getElementById("error-modal-close");
    function showErrorModal(message) {
      errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
      errorModal.classList.add("active");
    }
    if (errorModalClose) errorModalClose.onclick = () => errorModal.classList.remove("active");

    /* ===== HELPERS WEEK ===== */
    function monthRuUpper(monthIndex) {
      const m = ["–Ø–ù–í–ê–†–¨","–§–ï–í–†–ê–õ–¨","–ú–ê–†–¢","–ê–ü–†–ï–õ–¨","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì–£–°–¢","–°–ï–ù–¢–Ø–ë–†–¨","–û–ö–¢–Ø–ë–†–¨","–ù–û–Ø–ë–†–¨","–î–ï–ö–ê–ë–†–¨"];
      return m[monthIndex] || "";
    }
    function parseDateOnly(iso) {
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }
    function formatPeriodRu(startISO, endISO) {
      const s = parseDateOnly(startISO);
      const e = parseDateOnly(endISO);
      return `–° ${s.getDate()} ${monthRuUpper(s.getMonth())} ${s.getFullYear()} –ø–æ ${e.getDate()} ${monthRuUpper(e.getMonth())} ${e.getFullYear()}`;
    }

    /* ===== UI / DATA ===== */
    const leadersWrapper = document.getElementById("leaders-wrapper");
    const dateEl = document.getElementById("leader-date");
    let currentPeriod = "day";

    function injectBorderAndEmoji(card, place) {
      // SVG —Ä–∞–º–∫–∞ (–¥–≤–æ–π–Ω–∞—è) + 2 –±–µ–≥—É—â–∏—Ö –Ω–µ–æ–Ω–∞ –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("class", "border-svg");
      svg.setAttribute("viewBox", "0 0 100 100");
      svg.setAttribute("preserveAspectRatio", "none");
      svg.setAttribute("aria-hidden", "true");

      const d = "M2 2 H98 V74 L74 98 H2 Z"; // —Å—Ä–µ–∑–∞–Ω–Ω—ã–π —É–≥–æ–ª —Å–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞

      const glow = document.createElementNS("http://www.w3.org/2000/svg","path");
      glow.setAttribute("class","border-glow");
      glow.setAttribute("d", d);

      const outer = document.createElementNS("http://www.w3.org/2000/svg","path");
      outer.setAttribute("class","border-outer");
      outer.setAttribute("d", d);

      const inner = document.createElementNS("http://www.w3.org/2000/svg","path");
      inner.setAttribute("class","border-inner");
      inner.setAttribute("d", d);

      const neonA = document.createElementNS("http://www.w3.org/2000/svg","path");
      neonA.setAttribute("class","border-neon neon-a");
      neonA.setAttribute("d", d);

      const neonB = document.createElementNS("http://www.w3.org/2000/svg","path");
      neonB.setAttribute("class","border-neon neon-b");
      neonB.setAttribute("d", d);

      svg.appendChild(glow);
      svg.appendChild(outer);
      svg.appendChild(inner);
      svg.appendChild(neonA);
      svg.appendChild(neonB);

      card.appendChild(svg);

      // Emoji —Å–ª–æ–π
      const emojiLayer = document.createElement("div");
      emojiLayer.className = "emoji-layer";
      card.appendChild(emojiLayer);

      const emojiByPlace = { 1: "üèÜ", 2: "ü•à", 3: "ü•â" };
      const countByPlace = { 1: 22, 2: 18, 3: 14 };

      const emoji = emojiByPlace[place] || "‚ú®";
      const count = countByPlace[place] || 12;

      // —É–º–µ—Ä–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: 2.6s..4.8s, —á—É—Ç—å —Ä–∞–∑–±—Ä–æ—Å
      for (let i = 0; i < count; i++) {
        const s = document.createElement("span");
        s.textContent = emoji;

        s.style.left = (Math.random() * 100).toFixed(2) + "%";
        s.style.animationDelay = (Math.random() * 1.6).toFixed(2) + "s";
        s.style.animationDuration = (2.6 + Math.random() * 2.2).toFixed(2) + "s";
        s.style.fontSize = (12 + Math.random() * 16).toFixed(0) + "px";
        s.style.opacity = (0.22 + Math.random() * 0.55).toFixed(2);

        emojiLayer.appendChild(s);
      }
    }

    function renderLeaderCard(place, row) {
      const card = document.createElement("div");
      card.className = "leader-card rank-" + place;

      // sheen
      const sheen = document.createElement("div");
      sheen.className = "sheen";
      card.appendChild(sheen);

      // —Ä–∞–º–∫–∞ + —ç–º–æ–¥–∑–∏-—Å–ª–æ–π
      injectBorderAndEmoji(card, place);

      const icon = document.createElement("div");
      icon.className = "leader-icon";
      icon.textContent = place === 1 ? "üèÜ" : place === 2 ? "ü•à" : "ü•â";

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";

      const main = document.createElement("div");
      main.className = "leader-main";

      const scoreBlock = document.createElement("div");
      scoreBlock.className = "leader-score-block";

      if (row) {
        if (row.avatar_url) {
          const img = document.createElement("img");
          img.src = row.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = row.nick ? row.nick[0] : "?";
        }

        const nameRow = document.createElement("div");
        nameRow.className = "leader-name-row";

        const nickEl = document.createElement("div");
        nickEl.className = "leader-nick";
        nickEl.textContent = row.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏";

        const accEl = document.createElement("div");
        accEl.className = "leader-account";
        accEl.textContent = row.account_id ? `[${row.account_id}]` : "[‚Äî]";

        nameRow.appendChild(nickEl);
        nameRow.appendChild(accEl);

        const dept = (row.department || "").trim().toUpperCase();
        const deptEl = document.createElement("div");
        deptEl.className =
          "dept-badge " +
          (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : dept === "LVPD" ? "lvpd" : "");
        deptEl.textContent = dept || "‚Äî";

        main.appendChild(nameRow);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = row.points ?? 0;

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      } else {
        avatar.textContent = "?";

        const emptyTitle = document.createElement("div");
        emptyTitle.className = "leader-empty";
        emptyTitle.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

        const deptEl = document.createElement("div");
        deptEl.className = "dept-badge";
        deptEl.textContent = "‚Äî";

        main.appendChild(emptyTitle);
        main.appendChild(deptEl);

        const scoreRow = document.createElement("div");
        scoreRow.className = "leader-score";

        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = "0";

        const unitEl = document.createElement("span");
        unitEl.className = "unit";
        unitEl.textContent = "–ê–®";

        scoreRow.appendChild(valueEl);
        scoreRow.appendChild(unitEl);

        const placeLabel = document.createElement("div");
        placeLabel.className = "leader-place-label";
        placeLabel.textContent = place + " –º–µ—Å—Ç–æ";

        scoreBlock.appendChild(scoreRow);
        scoreBlock.appendChild(placeLabel);
      }

      card.appendChild(icon);
      card.appendChild(avatar);
      card.appendChild(main);
      card.appendChild(scoreBlock);

      return card;
    }

    async function loadLeaders(period = "day") {
      currentPeriod = period;

      if (dateEl) {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        dateEl.textContent = `${dd}.${mm}.${yyyy}`;
      }

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, nick, account_id, avatar_url, department, points_day")
        .order("points_day", { ascending: false })
        .limit(3);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É –¥–Ω—è (leaderinfo).");
        return;
      }

      const rows = (data || []).map((r) => ({
        id: r.id,
        nick: (r.nick || "").trim(),
        account_id: r.account_id || null,
        avatar_url: r.avatar_url || null,
        department: r.department || null,
        points_day: Number(r.points_day || 0),
        points: Number(r.points_day || 0),
      }));

      const slots = [0,1,2].map((i) => rows[i] || null);

      leadersWrapper.innerHTML = "";
      slots.forEach((row, idx) => {
        leadersWrapper.appendChild(renderLeaderCard(idx + 1, row));
      });
    }

    async function loadWeeklyBlocks() {
      currentPeriod = "week";
      if (dateEl) dateEl.textContent = "";

      if (!leadersWrapper) return;
      leadersWrapper.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

      const { data, error } = await supabaseClient
        .from("leaderinfo_week")
        .select(`
          week_start,
          week_end,
          place,
          points_week,
          leader:leader_id (
            id,
            nick,
            account_id,
            avatar_url,
            department
          )
        `)
        .order("week_start", { ascending: false })
        .order("place", { ascending: true })
        .limit(30);

      if (error) {
        console.error(error);
        leadersWrapper.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ–¥–µ–ª–∏.";
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã leaderinfo_week.");
        return;
      }

      const rows = data || [];
      if (!rows.length) {
        leadersWrapper.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–µ–¥–µ–ª—è–º.";
        return;
      }

      const byWeek = new Map();
      for (const r of rows) {
        const key = r.week_start;
        if (!byWeek.has(key)) {
          byWeek.set(key, {
            week_start: r.week_start,
            week_end: r.week_end,
            places: new Map(),
          });
        }
        byWeek.get(key).places.set(Number(r.place), r);
      }

      leadersWrapper.innerHTML = "";

      for (const [, w] of byWeek) {
        const block = document.createElement("div");
        block.className = "week-block";

        const badge = document.createElement("div");
        badge.className = "week-period-badge";
        badge.innerHTML = `<span class="dot"></span>${formatPeriodRu(w.week_start, w.week_end)}`;
        block.appendChild(badge);

        for (let place = 1; place <= 3; place++) {
          const item = w.places.get(place);
          if (item && item.leader) {
            const leader = item.leader;
            const row = {
              id: leader.id,
              nick: leader.nick,
              account_id: leader.account_id,
              avatar_url: leader.avatar_url,
              department: leader.department,
              points: Number(item.points_week || 0),
            };
            block.appendChild(renderLeaderCard(place, row));
          } else {
            block.appendChild(renderLeaderCard(place, null));
          }
        }

        leadersWrapper.appendChild(block);
      }
    }

    /* ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–∞–±–æ–≤ ===== */
    const tabDay = document.getElementById("tab-day");
    const tabWeek = document.getElementById("tab-week");
    if (tabDay && tabWeek) {
      const tabs = [tabDay, tabWeek];
      tabs.forEach((btn) => {
        btn.onclick = () => {
          tabs.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const period = btn.dataset.period;
          if (period === "week") loadWeeklyBlocks();
          else loadLeaders("day");
        };
      });
    }

    /* ===== BULK EDIT (LSPD/SFPD/LVPD) ===== */
    const editLeadersTopBtn = document.getElementById("edit-leaders-top");
    const bulkModal = document.getElementById("leaders-bulk-modal");
    const bulkFormsEl = document.getElementById("bulk-forms");
    const bulkCancelBtn = document.getElementById("bulk-cancel");
    const bulkSaveBtn = document.getElementById("bulk-save");
    const bulkErrorEl = document.getElementById("bulk-error");

    let bulkRows = [];
    let bulkAvatarByDept = {};

    function showBulkError(msg){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "block";
      bulkErrorEl.textContent = msg || "–û—à–∏–±–∫–∞.";
    }
    function hideBulkError(){
      if(!bulkErrorEl) return;
      bulkErrorEl.style.display = "none";
      bulkErrorEl.textContent = "";
    }

    function openBulkModal(){
      if(!canBulkEdit(currentUser)){
        showErrorModal("–ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ admin –∏ creator.");
        return;
      }
      hideBulkError();
      bulkModal.classList.add("active");
    }
    function closeBulkModal(){
      bulkModal.classList.remove("active");
      bulkRows = [];
      bulkAvatarByDept = {};
      if (bulkFormsEl) bulkFormsEl.innerHTML = "";
      hideBulkError();
    }

    async function fetchLeadersForDepts(){
      const { data, error } = await supabaseClient
        .from("leaderinfo")
        .select("id, department, nick, account_id, avatar_url")
        .in("department", ["LSPD","SFPD","LVPD"]);

      if (error) throw error;

      const map = new Map((data || []).map(r => [String(r.department||"").trim().toUpperCase(), r]));
      const depts = ["LSPD","SFPD","LVPD"];

      return depts.map(d => {
        const r = map.get(d);
        return r ? {
          id: r.id,
          department: d,
          nick: r.nick || "",
          account_id: r.account_id || "",
          avatar_url: r.avatar_url || null
        } : {
          id: null,
          department: d,
          nick: "",
          account_id: "",
          avatar_url: null
        };
      });
    }

    function createBulkCard(row){
      const dept = row.department;

      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.12)";
      wrap.style.borderRadius = "18px";
      wrap.style.padding = "14px";
      wrap.style.background = "rgba(0,0,0,.10)";
      wrap.style.backdropFilter = "blur(12px)";
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "120px 1fr";
      wrap.style.gap = "14px";
      wrap.style.alignItems = "start";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "10px";
      left.style.alignItems = "center";

      const badge = document.createElement("div");
      badge.className = "dept-badge " + (dept === "LSPD" ? "lspd" : dept === "SFPD" ? "sfpd" : "lvpd");
      badge.textContent = dept;

      const avatar = document.createElement("div");
      avatar.className = "edit-avatar-preview";
      avatar.style.margin = "0";
      avatar.style.width = "92px";
      avatar.style.height = "92px";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";

      const nickInput = document.createElement("input");
      nickInput.type = "text";
      nickInput.value = row.nick || "";
      nickInput.placeholder = "–ò–º—è_–§–∞–º–∏–ª–∏—è";

      const accInput = document.createElement("input");
      accInput.type = "text";
      accInput.value = row.account_id || "";
      accInput.placeholder = "3960680";

      function setAvatarPreview(src){
        avatar.innerHTML = "";
        if(src){
          const img = document.createElement("img");
          img.src = src;
          avatar.appendChild(img);
        } else {
          avatar.textContent = (nickInput.value?.trim()?.[0] || "?");
        }
      }

      setAvatarPreview(row.avatar_url || null);

      function handleFile(file){
        const reader = new FileReader();
        reader.onload = () => {
          bulkAvatarByDept[dept] = reader.result;
          setAvatarPreview(reader.result);
        };
        reader.onerror = () => showBulkError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è " + dept);
        reader.readAsDataURL(file);
      }

      avatar.addEventListener("click", () => fileInput.click());
      avatar.addEventListener("dragover", (e)=>{ e.preventDefault(); avatar.classList.add("drag-over"); });
      avatar.addEventListener("dragleave", ()=> avatar.classList.remove("drag-over"));
      avatar.addEventListener("drop", (e)=>{
        e.preventDefault(); avatar.classList.remove("drag-over");
        const f = e.dataTransfer.files?.[0];
        if(f) handleFile(f);
      });

      fileInput.addEventListener("change", (e)=>{
        const f = e.target.files?.[0];
        if(f) handleFile(f);
        fileInput.value = "";
      });

      nickInput.addEventListener("input", ()=>{
        if(!bulkAvatarByDept[dept] && !row.avatar_url){
          setAvatarPreview(null);
        }
      });

      left.appendChild(badge);
      left.appendChild(avatar);
      left.appendChild(fileInput);

      const right = document.createElement("div");

      const nickField = document.createElement("div");
      nickField.className = "field";
      const nickLabel = document.createElement("label");
      nickLabel.textContent = "–ù–∏–∫ (" + dept + ")";
      nickField.appendChild(nickLabel);
      nickField.appendChild(nickInput);

      const accField = document.createElement("div");
      accField.className = "field";
      const accLabel = document.createElement("label");
      accLabel.textContent = "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (" + dept + ")";
      accField.appendChild(accLabel);
      accField.appendChild(accInput);

      right.appendChild(nickField);
      right.appendChild(accField);

      wrap.appendChild(left);
      wrap.appendChild(right);

      return { wrap, nickInput, accInput };
    }

    async function buildBulkModal(){
      try{
        hideBulkError();
        bulkFormsEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        bulkRows = await fetchLeadersForDepts();
        bulkAvatarByDept = {};

        bulkFormsEl.innerHTML = "";
        bulkRows.forEach((row) => {
          const ui = createBulkCard(row);
          row._ui = ui;
          bulkFormsEl.appendChild(ui.wrap);
        });
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤: " + (e?.message || e));
        bulkFormsEl.innerHTML = "";
      }
    }

    async function saveBulk(){
      if(!canBulkEdit(currentUser)){
        showBulkError("–ù–µ—Ç –ø—Ä–∞–≤.");
        return;
      }
      hideBulkError();

      for(const row of bulkRows){
        const nick = row._ui.nickInput.value.trim();
        const acc = row._ui.accInput.value.trim();
        if(!row.id){
          showBulkError(`–í leaderinfo –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ ${row.department}. –í—ã–ø–æ–ª–Ω–∏ SQL –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å 3 –∑–∞–ø–∏—Å–∏).`);
          return;
        }
        if(!nick || !acc){
          showBulkError(`–ó–∞–ø–æ–ª–Ω–∏ –Ω–∏–∫ –∏ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è ${row.department}.`);
          return;
        }
      }

      try{
        for(const row of bulkRows){
          const dept = row.department;
          const payload = {
            department: dept,
            nick: row._ui.nickInput.value.trim(),
            account_id: row._ui.accInput.value.trim(),
            updated_at: new Date().toISOString(),
          };
          if (bulkAvatarByDept[dept]) payload.avatar_url = bulkAvatarByDept[dept];

          const { error } = await supabaseClient
            .from("leaderinfo")
            .update(payload)
            .eq("id", row.id);

          if(error) throw error;
        }

        closeBulkModal();
        await loadLeaders("day");
      }catch(e){
        console.error(e);
        showBulkError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (e?.message || e));
      }
    }

    if (editLeadersTopBtn) {
      editLeadersTopBtn.addEventListener("click", async () => {
        openBulkModal();
        await buildBulkModal();
      });
    }
    if (bulkCancelBtn) bulkCancelBtn.addEventListener("click", closeBulkModal);
    if (bulkSaveBtn) bulkSaveBtn.addEventListener("click", saveBulk);

    /* ===== INIT ===== */
    const userTagEl = document.getElementById("user-tag");

    async function initPage() {
      currentUser = loadSession();

      if (editLeadersTopBtn) {
        editLeadersTopBtn.style.display = canBulkEdit(currentUser) ? "inline-flex" : "none";
      }

      await loadLeaders("day");
    }

    window.addEventListener("load", initPage);
  </script>
</body>
</html>
