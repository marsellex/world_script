<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Рейтинг лидеров PD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #0b1220;
      --bg-light: #111827;
      --bg-lighter: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #374151;
      --accent: #2563eb;
      --accent-hover: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
      --input-bg: #020617;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      background: #0f172a;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #0f172a;
      overflow: hidden;
    }

    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    #bg-rotator img.active {
      opacity: 1;
    }

    #app {
      width: 100%;
      max-width: 900px;
    }

    a {
      color: var(--accent-hover);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .btn {
      padding: 8px 16px;
      background: var(--accent);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.7);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-outline {
      padding: 8px 16px;
      background: var(--bg-lighter);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.6);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn-outline:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    .card {
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 16px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.8);
    }

    /* Верхняя панель */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
    }

    .top-bar-title {
      font-size: 20px;
      font-weight: 500;
    }

    .top-bar-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }

    .top-bar-left {
      display: flex;
      flex-direction: column;
    }

    .user-tag {
      font-size: 12px;
      color: var(--muted);
    }

    /* Лидеры (3 плашки сверху вниз) */
    .leaders-wrapper {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .leader-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
    }

    .leader-rank-badge {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 12px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(249, 250, 251, 0.08);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .leader-rank-badge span.place-number {
      font-size: 13px;
    }

    .leader-rank-1 .leader-rank-badge {
      border-color: #facc15;
      color: #facc15;
    }

    .leader-rank-2 .leader-rank-badge {
      border-color: #9ca3af;
      color: #e5e7eb;
    }

    .leader-rank-3 .leader-rank-badge {
      border-color: #f97316;
      color: #fed7aa;
    }

    .leader-main-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .leader-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-lighter);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }

    .leader-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .leader-avatar-editable {
      cursor: pointer;
      border-style: dashed;
    }

    .leader-avatar-editable::after {
      content: "✎";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .leader-avatar.drag-over {
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.8);
    }

    .leader-info-block {
      flex: 1;
      min-width: 0;
    }

    .leader-nick {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .leader-account {
      font-size: 13px;
      color: var(--muted);
    }

    .leader-dept-tag {
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-top: 4px;
      background: rgba(15, 23, 42, 0.9);
    }

    .leader-score-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
    }

    .score-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .score-value {
      font-size: 20px;
      font-weight: 700;
    }

    .leader-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
    }

    .leader-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .leader-empty-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--muted);
    }

    /* Статистика (ТОПы) */

    .stats-section {
      margin-top: 16px;
    }

    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .stats-title {
      font-size: 16px;
      font-weight: 500;
    }

    .stats-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .stats-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: var(--bg-lighter);
    }

    .stats-tab {
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--muted);
    }

    .stats-tab.active {
      background: var(--accent);
      color: var(--text);
    }

    .stats-list {
      margin-top: 8px;
    }

    .stats-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      background: rgba(15, 23, 42, 0.9);
      font-size: 13px;
      margin-bottom: 6px;
    }

    .stats-place {
      width: 22px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
    }

    .stats-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-lighter);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .stats-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .stats-main {
      flex: 1;
    }

    .stats-nick {
      font-weight: 500;
    }

    .stats-account {
      font-size: 12px;
      color: var(--muted);
    }

    .stats-points {
      font-size: 13px;
      font-weight: 600;
    }

    .stats-empty {
      font-size: 13px;
      color: var(--muted);
    }

    /* Модалки */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 16px;
    }
    .modal h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    .modal p {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
    }
    .field input,
    .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
    }
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
    }

    .edit-avatar-preview {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px dashed var(--border);
      background: var(--bg-lighter);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .edit-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .edit-avatar-preview::after {
      content: "✎";
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .error-text {
      font-size: 12px;
      color: var(--danger);
      margin-top: 3px;
    }

    @media (max-width: 600px) {
      body {
        padding: 8px;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div id="bg-rotator"></div>

<div id="app">
  <div class="card">
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="top-bar-title">Рейтинг лидеров PD</div>
        <div class="top-bar-subtitle">
          Топ-3 лидеров по АШ. У кого больше АШ — тот выше в списке.
        </div>
        <div class="user-tag" id="user-tag"></div>
      </div>
      <button class="btn-outline btn-sm" id="back-to-panel">
        ⟵ К панели офицера
      </button>
    </div>

    <!-- 3 плашки лидеров сверху вниз -->
    <div class="leaders-wrapper" id="leaders-wrapper">
      Загрузка лидеров...
    </div>

    <!-- Статистика / ТОПы -->
    <div class="stats-section">
      <div class="stats-header">
        <div>
          <div class="stats-title">Статистика</div>
          <div class="stats-subtitle">Топ по АШ за период</div>
        </div>
        <div class="stats-tabs">
          <button class="stats-tab active" data-period="day" id="stats-tab-day">За день</button>
          <button class="stats-tab" data-period="week" id="stats-tab-week">За неделю</button>
        </div>
      </div>

      <div class="stats-list" id="stats-list">
        Загрузка статистики...
      </div>
    </div>
  </div>
</div>

<!-- Модалка ошибки -->
<div id="error-modal" class="modal-backdrop">
  <div class="modal">
    <h3>Ошибка</h3>
    <p id="error-modal-text"></p>
    <div class="modal-footer">
      <button class="btn btn-sm" id="error-modal-close">Закрыть</button>
    </div>
  </div>
</div>

<!-- Модалка редактирования лидера -->
<div id="leader-edit-modal" class="modal-backdrop">
  <div class="modal">
    <h3>Редактирование лидера</h3>
    <p>Доступно администраторам, модераторам и редакторам (creator).</p>

    <div class="edit-avatar-preview" id="edit-avatar-preview">
      <span>?</span>
    </div>
    <div class="hint">Кликните или перетащите картинку, чтобы изменить аватар.</div>

    <input type="file" id="edit-avatar-file" accept="image/*" style="display:none;" />

    <div class="field">
      <label for="edit-dept">Департамент</label>
      <select id="edit-dept">
        <option value="LSPD">LSPD</option>
        <option value="SFPD">SFPD</option>
        <option value="LVPD">LVPD</option>
      </select>
    </div>

    <div class="field">
      <label for="edit-nick">Ник</label>
      <input id="edit-nick" type="text" placeholder="Имя_Фамилия" />
    </div>

    <div class="field">
      <label for="edit-account">Номер аккаунта</label>
      <input id="edit-account" type="text" placeholder="123456" />
    </div>

    <div class="field">
      <label for="edit-points">Текущее количество АШ</label>
      <input id="edit-points" type="number" min="0" step="1" value="0" />
    </div>

    <div class="error-text" id="edit-error" style="display:none;"></div>

    <div class="modal-footer">
      <button class="btn-outline btn-sm" id="leader-edit-cancel">Отмена</button>
      <button class="btn btn-sm" id="leader-edit-save">Сохранить</button>
    </div>
  </div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ====== ТЕМА (та же, что и на главной) ====== */
  let themeConfig = {
    images: [],
    opacity: 80,
    blur: 0,
    borderColor: "#374151",
    favicon: null,
    siteTitle: null
  };
  let bgRotationTimer = null;
  let bgCurrentIndex = 0;

  const bgRotatorEl = document.getElementById("bg-rotator");

  async function loadThemeFromDB() {
    const { data, error } = await supabaseClient
      .from("theme_settings")
      .select("*")
      .eq("id", 1)
      .single();

    if (error || !data) {
      console.warn("Ошибка загрузки темы:", error);
      return;
    }

    themeConfig = {
      images: data.images || [],
      opacity: data.opacity ?? 80,
      blur: data.blur ?? 0,
      borderColor: data.border_color || "#374151",
      favicon: data.favicon || null,
      siteTitle: data.site_title || null
    };
  }

  function applyThemeBackground() {
    if (!bgRotatorEl) return;
    bgRotatorEl.innerHTML = "";

    const images = themeConfig.images || [];
    const blurPx = themeConfig.blur || 0;

    if (!images.length) {
      bgRotatorEl.style.background = "#0f172a";
      return;
    }

    images.forEach((src, index) => {
      const img = document.createElement("img");
      img.src = src;
      img.style.filter = `blur(${blurPx}px)`;
      if (index === 0) img.classList.add("active");
      bgRotatorEl.appendChild(img);
    });

    if (bgRotationTimer) {
      clearInterval(bgRotationTimer);
      bgRotationTimer = null;
    }

    if (images.length > 1) {
      const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
      bgCurrentIndex = 0;

      bgRotationTimer = setInterval(() => {
        const prev = imgs[bgCurrentIndex];
        bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
        const next = imgs[bgCurrentIndex];

        if (prev) prev.classList.remove("active");
        if (next) next.classList.add("active");
      }, 60 * 1000);
    }
  }

  function applyThemeToBlocks() {
    const opacity = (themeConfig.opacity || 80) / 100;
    const borderColor = themeConfig.borderColor || "#374151";
    document.documentElement.style.setProperty("--border", borderColor);

    const blocks = document.querySelectorAll(".card");
    blocks.forEach((el) => {
      el.style.backgroundColor = `rgba(15,23,42,${opacity})`;
    });
  }

  function applySiteBranding() {
    if (themeConfig.siteTitle) {
      document.title = themeConfig.siteTitle;
    } else {
      document.title = "Рейтинг лидеров PD";
    }

    if (themeConfig.favicon) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) {
        link = document.createElement("link");
        link.rel = "icon";
        document.head.appendChild(link);
      }
      link.href = themeConfig.favicon;
    }
  }

  /* ======= СЕССИЯ ПОЛЬЗОВАТЕЛЯ (как в index.html) ======= */

  let currentUser = null;

  function loadSession() {
    try {
      return JSON.parse(localStorage.getItem("pp_user"));
    } catch {
      return null;
    }
  }

  function roleLabel(role) {
    if (role === "admin") return "Администратор";
    if (role === "moderator") return "Модератор";
    if (role === "creator") return "Редактор";
    return "Офицер";
  }

  function isAdminLike(user) {
    if (!user) return false;
    return (
      user.role === "admin" ||
      user.role === "moderator" ||
      user.role === "creator"
    );
  }

  /* ======= ОШИБКИ ======= */

  const errorModal = document.getElementById("error-modal");
  const errorModalText = document.getElementById("error-modal-text");
  const errorModalClose = document.getElementById("error-modal-close");

  function showErrorModal(message) {
    errorModalText.textContent = message || "Неизвестная ошибка.";
    errorModal.classList.add("active");
  }

  if (errorModalClose) {
    errorModalClose.onclick = () => {
      errorModal.classList.remove("active");
    };
  }

  /* ======= ЛИДЕРЫ (pd_leaders) ======= */

  const leadersWrapper = document.getElementById("leaders-wrapper");
  let leadersCache = [];
  let editingLeaderId = null;
  let editingSlotIndex = null;
  let editingAvatarData = null;

  const leaderEditModal = document.getElementById("leader-edit-modal");
  const editAvatarPreview = document.getElementById("edit-avatar-preview");
  const editAvatarFile = document.getElementById("edit-avatar-file");
  const editDept = document.getElementById("edit-dept");
  const editNick = document.getElementById("edit-nick");
  const editAccount = document.getElementById("edit-account");
  const editPoints = document.getElementById("edit-points");
  const editError = document.getElementById("edit-error");
  const editCancelBtn = document.getElementById("leader-edit-cancel");
  const editSaveBtn = document.getElementById("leader-edit-save");

  function setEditAvatarPreview(src, nickInitial) {
    editAvatarPreview.innerHTML = "";
    if (src) {
      const img = document.createElement("img");
      img.src = src;
      editAvatarPreview.appendChild(img);
    } else {
      const span = document.createElement("span");
      span.textContent = nickInitial || "?";
      editAvatarPreview.appendChild(span);
    }
  }

  function openLeaderEditModal(leader, slotIndex) {
    if (!isAdminLike(currentUser)) {
      showErrorModal("Редактирование доступно только администраторам, модераторам и редакторам.");
      return;
    }

    editingLeaderId = leader ? leader.id : null;
    editingSlotIndex = slotIndex != null ? slotIndex : null;

    const initialNick = leader?.nick || "";
    const initialAccount = leader?.account_id || "";
    const initialDept = leader?.department || "LSPD";
    const initialPoints = leader?.points ?? 0;

    editDept.value = initialDept;
    editNick.value = initialNick;
    editAccount.value = initialAccount;
    editPoints.value = initialPoints;

    if (editingAvatarData) {
      // уже выбрали новый аватар через плашку
      setEditAvatarPreview(editingAvatarData, initialNick ? initialNick[0] : "?");
    } else if (leader && leader.avatar_url) {
      setEditAvatarPreview(leader.avatar_url, initialNick ? initialNick[0] : "?");
    } else {
      setEditAvatarPreview(null, initialNick ? initialNick[0] : "?");
    }

    editError.style.display = "none";
    leaderEditModal.classList.add("active");
  }

  function closeLeaderEditModal() {
    leaderEditModal.classList.remove("active");
    editingLeaderId = null;
    editingSlotIndex = null;
    editingAvatarData = null;
    setEditAvatarPreview(null, "?");
  }

  // Клик / дроп по аватару в модалке
  if (editAvatarPreview) {
    editAvatarPreview.addEventListener("click", () => {
      if (!isAdminLike(currentUser)) return;
      editAvatarFile.click();
    });

    editAvatarPreview.addEventListener("dragover", (e) => {
      e.preventDefault();
      editAvatarPreview.classList.add("drag-over");
    });
    editAvatarPreview.addEventListener("dragleave", () => {
      editAvatarPreview.classList.remove("drag-over");
    });
    editAvatarPreview.addEventListener("drop", (e) => {
      e.preventDefault();
      editAvatarPreview.classList.remove("drag-over");
      if (!isAdminLike(currentUser)) return;
      const file = e.dataTransfer.files[0];
      if (file) handleAvatarFileForEdit(file);
    });
  }

  if (editAvatarFile) {
    editAvatarFile.onchange = (e) => {
      const file = e.target.files[0];
      if (file) handleAvatarFileForEdit(file);
      editAvatarFile.value = "";
    };
  }

  function handleAvatarFileForEdit(file) {
    const reader = new FileReader();
    reader.onload = () => {
      editingAvatarData = reader.result;
      const nickInitial = editNick.value ? editNick.value[0] : "?";
      setEditAvatarPreview(editingAvatarData, nickInitial);
    };
    reader.onerror = () => {
      showErrorModal("Не удалось прочитать файл аватара.");
    };
    reader.readAsDataURL(file);
  }

  if (editCancelBtn) {
    editCancelBtn.onclick = () => {
      closeLeaderEditModal();
    };
  }

  if (editSaveBtn) {
    editSaveBtn.onclick = async () => {
      if (!isAdminLike(currentUser)) {
        showErrorModal("Редактирование доступно только администраторам, модераторам и редакторам.");
        return;
      }

      const dept = editDept.value || "LSPD";
      const nick = editNick.value.trim();
      const account = editAccount.value.trim();
      let pointsVal = parseInt(editPoints.value, 10);
      if (isNaN(pointsVal) || pointsVal < 0) pointsVal = 0;

      if (!nick || !account) {
        editError.style.display = "block";
        editError.textContent = "Ник и номер аккаунта обязательны.";
        return;
      }

      editError.style.display = "none";

      const payload = {
        department: dept,
        nick,
        account_id: account,
        points: pointsVal,
      };

      if (editingAvatarData) {
        payload.avatar_url = editingAvatarData;
      }

      let error = null;
      if (editingLeaderId) {
        const { error: updError } = await supabaseClient
          .from("pd_leaders")
          .update(payload)
          .eq("id", editingLeaderId);
        error = updError;
      } else {
        const { error: insError } = await supabaseClient
          .from("pd_leaders")
          .insert(payload);
        error = insError;
      }

      if (error) {
        console.error(error);
        showErrorModal("Ошибка сохранения данных лидера.");
        return;
      }

      closeLeaderEditModal();
      await loadLeaders();
      await loadStats(currentStatsPeriod);
    };
  }

  function attachAvatarHandlers(avatarEl, leader, slotIndex) {
    if (!isAdminLike(currentUser)) return;

    avatarEl.classList.add("leader-avatar-editable");

    const startEditWithFile = (file) => {
      const reader = new FileReader();
      reader.onload = () => {
        editingAvatarData = reader.result;
        // открываем модалку, чтобы заполнить остальные поля и сохранить
        openLeaderEditModal(leader, slotIndex);
      };
      reader.onerror = () => {
        showErrorModal("Не удалось прочитать файл аватара.");
      };
      reader.readAsDataURL(file);
    };

    avatarEl.addEventListener("click", () => {
      // создаём одноразовый input
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      document.body.appendChild(fileInput);
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) startEditWithFile(file);
        document.body.removeChild(fileInput);
      };
      fileInput.click();
    });

    avatarEl.addEventListener("dragover", (e) => {
      e.preventDefault();
      avatarEl.classList.add("drag-over");
    });
    avatarEl.addEventListener("dragleave", () => {
      avatarEl.classList.remove("drag-over");
    });
    avatarEl.addEventListener("drop", (e) => {
      e.preventDefault();
      avatarEl.classList.remove("drag-over");
      const file = e.dataTransfer.files[0];
      if (file) startEditWithFile(file);
    });
  }

  async function loadLeaders() {
    leadersWrapper.textContent = "Загрузка лидеров...";

    const { data, error } = await supabaseClient
      .from("pd_leaders")
      .select("*");

    if (error) {
      console.error(error);
      leadersWrapper.textContent = "Ошибка загрузки лидеров.";
      showErrorModal("Ошибка загрузки лидеров. Проверьте базу данных.");
      return;
    }

    leadersCache = data || [];

    // сортируем по АШ (points) по убыванию
    const sorted = [...leadersCache].sort((a, b) => {
      const pa = a.points ?? 0;
      const pb = b.points ?? 0;
      return pb - pa;
    });

    const slots = [
      sorted[0] || null,
      sorted[1] || null,
      sorted[2] || null
    ];

    leadersWrapper.innerHTML = "";

    slots.forEach((leader, index) => {
      const place = index + 1;
      const card = document.createElement("div");
      card.className = "leader-card leader-rank-" + place;

      const badge = document.createElement("div");
      badge.className = "leader-rank-badge";
      const placeSpan = document.createElement("span");
      placeSpan.className = "place-number";
      placeSpan.textContent = place;
      const labelSpan = document.createElement("span");
      labelSpan.textContent =
        place === 1 ? "место" :
        place === 2 ? "место" :
        "место";
      badge.appendChild(placeSpan);
      badge.appendChild(labelSpan);

      const mainRow = document.createElement("div");
      mainRow.className = "leader-main-row";

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";

      const infoBlock = document.createElement("div");
      infoBlock.className = "leader-info-block";

      const scoreBlock = document.createElement("div");
      scoreBlock.className = "leader-score-block";

      const metaRow = document.createElement("div");
      metaRow.className = "leader-meta-row";

      const actionsRow = document.createElement("div");
      actionsRow.className = "leader-actions";

      let canEdit = isAdminLike(currentUser);

      if (leader) {
        if (leader.avatar_url) {
          const img = document.createElement("img");
          img.src = leader.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = leader.nick ? leader.nick[0] : "?";
        }

        const nickEl = document.createElement("div");
        nickEl.className = "leader-nick";
        nickEl.textContent = leader.nick || "Без имени";

        const accountEl = document.createElement("div");
        accountEl.className = "leader-account";
        const acc = leader.account_id || "—";
        accountEl.textContent = `[${acc}]`;

        const deptTag = document.createElement("div");
        deptTag.className = "leader-dept-tag";
        deptTag.textContent = leader.department || "Департамент не указан";

        infoBlock.appendChild(nickEl);
        infoBlock.appendChild(accountEl);
        infoBlock.appendChild(deptTag);

        const scoreLabel = document.createElement("div");
        scoreLabel.className = "score-label";
        scoreLabel.textContent = "АШ";

        const scoreValue = document.createElement("div");
        scoreValue.className = "score-value";
        scoreValue.textContent = leader.points ?? 0;

        scoreBlock.appendChild(scoreLabel);
        scoreBlock.appendChild(scoreValue);

        const updatedText = document.createElement("div");
        updatedText.textContent = leader.updated_at
          ? "Обновлено: " + new Date(leader.updated_at).toLocaleString()
          : "Обновлено: —";

        metaRow.appendChild(updatedText);
      } else {
        avatar.textContent = "?";

        const emptyTitle = document.createElement("div");
        emptyTitle.className = "leader-empty-title";
        emptyTitle.textContent = "Лидер не назначен";

        const deptTag = document.createElement("div");
        deptTag.className = "leader-dept-tag";
        deptTag.textContent = "Департамент не указан";

        infoBlock.appendChild(emptyTitle);
        infoBlock.appendChild(deptTag);

        const scoreLabel = document.createElement("div");
        scoreLabel.className = "score-label";
        scoreLabel.textContent = "АШ";

        const scoreValue = document.createElement("div");
        scoreValue.className = "score-value";
        scoreValue.textContent = "0";

        scoreBlock.appendChild(scoreLabel);
        scoreBlock.appendChild(scoreValue);

        const updatedText = document.createElement("div");
        updatedText.textContent = "Обновлено: —";
        metaRow.appendChild(updatedText);
      }

      mainRow.appendChild(avatar);
      mainRow.appendChild(infoBlock);
      mainRow.appendChild(scoreBlock);

      card.appendChild(badge);
      card.appendChild(mainRow);
      card.appendChild(metaRow);

      if (canEdit) {
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-outline btn-sm";
        editBtn.textContent = leader ? "Редактировать" : "Назначить лидера";
        editBtn.onclick = () => {
          openLeaderEditModal(leader, index);
        };
        actionsRow.appendChild(editBtn);
        card.appendChild(actionsRow);

        attachAvatarHandlers(avatar, leader, index);
      }

      leadersWrapper.appendChild(card);
    });
  }

  /* ======= СТАТИСТИКА (leader_stats) ======= */

  const statsListEl = document.getElementById("stats-list");
  const statsTabDay = document.getElementById("stats-tab-day");
  const statsTabWeek = document.getElementById("stats-tab-week");
  let currentStatsPeriod = "day";

  async function loadStats(period) {
    currentStatsPeriod = period;
    statsListEl.textContent = "Загрузка статистики...";

    const { data, error } = await supabaseClient
      .from("leader_stats")
      .select("*")
      .eq("period", period)
      .order("points", { ascending: false })
      .limit(10);

    if (error) {
      console.error(error);
      statsListEl.textContent = "Ошибка загрузки статистики.";
      return;
    }

    const rows = data || [];

    if (!rows.length) {
      statsListEl.innerHTML = "";
      const empty = document.createElement("div");
      empty.className = "stats-empty";
      empty.textContent = "Пока нет данных для этого периода.";
      statsListEl.appendChild(empty);
      return;
    }

    statsListEl.innerHTML = "";

    rows.forEach((row, idx) => {
      const item = document.createElement("div");
      item.className = "stats-item";

      const placeEl = document.createElement("div");
      placeEl.className = "stats-place";
      placeEl.textContent = idx + 1;

      const avatar = document.createElement("div");
      avatar.className = "stats-avatar";
      if (row.avatar_url) {
        const img = document.createElement("img");
        img.src = row.avatar_url;
        avatar.appendChild(img);
      } else {
        avatar.textContent = row.nick ? row.nick[0] : "?";
      }

      const main = document.createElement("div");
      main.className = "stats-main";
      const nickEl = document.createElement("div");
      nickEl.className = "stats-nick";
      nickEl.textContent = row.nick || "Без имени";
      const accEl = document.createElement("div");
      accEl.className = "stats-account";
      accEl.textContent = row.account_id ? `[${row.account_id}]` : "[—]";
      main.appendChild(nickEl);
      main.appendChild(accEl);

      const pointsEl = document.createElement("div");
      pointsEl.className = "stats-points";
      pointsEl.textContent = `${row.points ?? 0} АШ`;

      item.appendChild(placeEl);
      item.appendChild(avatar);
      item.appendChild(main);
      item.appendChild(pointsEl);

      statsListEl.appendChild(item);
    });
  }

  if (statsTabDay && statsTabWeek) {
    const tabs = [statsTabDay, statsTabWeek];
    tabs.forEach((btn) => {
      btn.onclick = () => {
        tabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const period = btn.dataset.period;
        loadStats(period);
      };
    });
  }

  /* ======= ПРОЧЕЕ ======= */

  const backToPanelBtn = document.getElementById("back-to-panel");
  if (backToPanelBtn) {
    backToPanelBtn.onclick = () => {
      window.location.href = "index.html";
    };
  }

  const userTagEl = document.getElementById("user-tag");

  async function initPage() {
    await loadThemeFromDB();
    applyThemeBackground();
    applyThemeToBlocks();
    applySiteBranding();

    currentUser = loadSession();
    if (userTagEl) {
      if (!currentUser) {
        userTagEl.textContent = "Режим гостя — только просмотр.";
      } else {
        userTagEl.textContent = `Вы вошли как ${currentUser.nick} (${roleLabel(currentUser.role)})`;
      }
    }

    await loadLeaders();
    await loadStats("day");
  }

  window.addEventListener("load", initPage);
</script>
</body>
</html>
