<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Police Platinum ‚Äî –†–µ–π—Ç–∏–Ω–≥ –ª–∏–¥–µ—Ä–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --bg-light: #020617;
      --bg-lighter: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #374151;
      --accent: #2563eb;
      --accent-hover: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px;
    }

    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #020617;
      overflow: hidden;
    }

    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    #bg-rotator img.active {
      opacity: 1;
    }

    #leader-app {
      width: 100%;
      max-width: 780px;
    }

    a {
      color: var(--accent-hover);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .page-header {
      margin-bottom: 18px;
      text-align: center;
    }

    .page-title {
      font-size: 26px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .page-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* –°—Ç–µ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ */

    .leaders-stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 10px;
    }

    .leader-card {
      position: relative;
      border-radius: 22px;
      padding: 14px 16px 14px 16px;
      background: radial-gradient(circle at top left, rgba(148,163,184,0.22), rgba(15,23,42,0.96));
      border: 1px solid rgba(148,163,184,0.5);
      box-shadow:
        0 18px 40px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,0.7);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .leader-rank-badge {
      position: absolute;
      top: 10px;
      left: 14px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.8);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .leader-rank-badge span.rank-num {
      font-weight: 700;
    }

    .leader-rank-1 .leader-rank-badge {
      border-color: #facc15;
      box-shadow: 0 0 16px rgba(250,204,21,0.6);
    }
    .leader-rank-2 .leader-rank-badge {
      border-color: #e5e7eb;
      box-shadow: 0 0 14px rgba(148,163,184,0.5);
    }
    .leader-rank-3 .leader-rank-badge {
      border-color: #a855f7;
      box-shadow: 0 0 14px rgba(168,85,247,0.55);
    }

    .leader-avatar {
      width: 76px;
      height: 76px;
      border-radius: 50%;
      border: 2px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top, #1f2937, #020617);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: default;
      position: relative;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .leader-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .leader-avatar.editable {
      cursor: pointer;
    }
    .leader-avatar.editable:hover {
      transform: translateY(-2px) scale(1.03);
      border-color: var(--accent-hover);
      box-shadow: 0 10px 22px rgba(15,23,42,0.95);
    }
    .leader-avatar.avatar-drop-hover {
      border-style: dashed;
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250,204,21,0.8), 0 12px 26px rgba(15,23,42,1);
    }

    .leader-avatar-placeholder {
      font-size: 36px;
      color: #4b5563;
    }

    .leader-main {
      flex: 1;
      min-width: 0;
    }

    .leader-row-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      padding-left: 72px;
    }

    .leader-name-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .leader-nick {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .leader-nick-main {
      white-space: nowrap;
    }

    .leader-account {
      font-size: 13px;
      color: var(--muted);
    }

    .leader-empty-text {
      font-size: 15px;
      color: var(--muted);
      font-style: italic;
    }

    .leader-dept-badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.96);
      white-space: nowrap;
    }

    .leader-dept-lspd {
      border-color: rgba(34,197,94,0.8);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.22), rgba(15,23,42,0.96));
      color: #bbf7d0;
      text-shadow: 0 0 10px rgba(22,163,74,0.7);
    }

    .leader-dept-sfpd {
      border-color: rgba(59,130,246,0.8);
      background: radial-gradient(circle at top left, rgba(59,130,246,0.22), rgba(15,23,42,0.96));
      color: #bfdbfe;
      text-shadow: 0 0 10px rgba(37,99,235,0.75);
    }

    .leader-dept-lvpd {
      border-color: rgba(239,68,68,0.85);
      background: radial-gradient(circle at top left, rgba(239,68,68,0.22), rgba(15,23,42,0.96));
      color: #fecaca;
      text-shadow: 0 0 10px rgba(220,38,38,0.75);
    }

    .leader-row-bottom {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) auto;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .leader-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .leader-stat-card {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.9);
      box-shadow: 0 12px 24px rgba(15,23,42,0.9);
    }

    .leader-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.09em;
      margin-bottom: 2px;
    }

    .leader-stat-value {
      font-size: 16px;
      font-weight: 600;
    }

    .leader-stat-value span.suffix {
      font-size: 11px;
      font-weight: 400;
      margin-left: 4px;
      color: var(--muted);
    }

    .leader-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(15,23,42,0.9);
      transition: background 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 10px 22px rgba(15,23,42,0.95);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .note-guest {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 40;
    }
    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: rgba(15,23,42,0.98);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.9);
      padding: 16px 16px 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,1);
    }

    .modal h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .modal p {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--muted);
    }

    .field input,
    .field select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      background: #020617;
      color: var(--text);
      font-size: 14px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-outline {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: transparent;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.12s ease;
    }
    .btn-outline:hover {
      background: rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .modal-error {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
      min-height: 16px;
    }

    @media (max-width: 640px) {
      body {
        padding: 16px 8px;
      }
      .leader-card {
        flex-direction: row;
        align-items: flex-start;
      }
      .leader-row-top {
        flex-direction: column;
        align-items: flex-start;
        padding-left: 64px;
      }
      .leader-row-bottom {
        grid-template-columns: 1fr;
      }
      .leader-actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<div id="bg-rotator"></div>

<div id="leader-app">
  <header class="page-header">
    <div class="page-title">–†–ï–ô–¢–ò–ù–ì –õ–ò–î–ï–†–û–í PD</div>
    <div class="page-subtitle">
      –¢–æ–ø-3 –ª–∏–¥–µ—Ä–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ê–®. –î–∞–Ω–Ω—ã–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.
    </div>
  </header>

  <div class="leaders-stack" id="leaders-stack">
    <!-- —Å—é–¥–∞ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è 3 –ø–ª–∞—à–∫–∏ -->
  </div>

  <div class="note-guest" id="guest-note" style="display:none;">
    –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–¥–µ—Ä–æ–≤ –≤–æ–π–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞ –ø–æ–¥ –∞–∫–∫–∞—É–Ω—Ç–æ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è.
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–¥–µ—Ä–∞ -->
<div id="edit-modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–∞</h3>
    <p id="edit-modal-subtitle">–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–µ—Ä–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</p>

    <div class="field">
      <label for="edit-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
      <select id="edit-dept">
        <option value="LSPD">LSPD</option>
        <option value="SFPD">SFPD</option>
        <option value="LVPD">LVPD</option>
      </select>
    </div>

    <div class="field">
      <label for="edit-nick">–ù–∏–∫</label>
      <input id="edit-nick" type="text" placeholder="Marsello_Nelson" />
    </div>

    <div class="field">
      <label for="edit-account">–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (–≤ —Å–∫–æ–±–∫–∞—Ö)</label>
      <input id="edit-account" type="text" placeholder="123456" />
    </div>

    <div class="field">
      <label for="edit-ash">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ê–®</label>
      <input id="edit-ash" type="number" min="0" step="1" placeholder="0" />
    </div>

    <div class="field">
      <label for="edit-avatar-file">–ê–≤–∞—Ç–∞—Ä–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
      <input id="edit-avatar-file" type="file" accept="image/*" />
      <div style="font-size:11px; color:var(--muted); margin-top:3px;">
        –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ –∞–≤–∞—Ç–∞—Ä–∫–µ –Ω–∞ –ø–ª–∞—à–∫–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª.
      </div>
    </div>

    <div class="modal-error" id="edit-error"></div>

    <div class="modal-footer">
      <button class="btn-outline" id="edit-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="edit-save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∫–∏ –∫–ª–∏–∫–æ–º –ø–æ –ø–ª–∞—à–∫–µ -->
<input id="avatar-hidden-input" type="file" accept="image/*" style="display:none;" />

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

  const { createClient } = window.supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const defaultDepts = ["LSPD", "SFPD", "LVPD"];

  let currentUser = null;
  let leadersCache = [];
  let bgRotationTimer = null;
  let bgCurrentIndex = 0;

  const bgRotatorEl = document.getElementById("bg-rotator");
  const leadersStack = document.getElementById("leaders-stack");
  const guestNote = document.getElementById("guest-note");

  const editModalBackdrop = document.getElementById("edit-modal-backdrop");
  const editDept = document.getElementById("edit-dept");
  const editNick = document.getElementById("edit-nick");
  const editAccount = document.getElementById("edit-account");
  const editAsh = document.getElementById("edit-ash");
  const editAvatarFile = document.getElementById("edit-avatar-file");
  const editError = document.getElementById("edit-error");
  const editCancelBtn = document.getElementById("edit-cancel-btn");
  const editSaveBtn = document.getElementById("edit-save-btn");
  const editSubtitle = document.getElementById("edit-modal-subtitle");
  const avatarHiddenInput = document.getElementById("avatar-hidden-input");

  let editingPosition = null;
  let editingLeaderId = null;
  let pendingAvatarLeaderId = null;

  function isAdminLike(user) {
    if (!user) return false;
    return (
      user.role === "admin" ||
      user.role === "moderator" ||
      user.role === "creator"
    );
  }

  /* ===== –¢–µ–º–∞ ===== */

  async function loadThemeFromDB() {
    try {
      const { data, error } = await supabaseClient
        .from("theme_settings")
        .select("images, blur")
        .eq("id", 1)
        .single();

      if (error || !data) {
        console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ theme_settings:", error);
        return;
      }

      const images = data.images || [];
      const blur = data.blur || 0;
      applyThemeBackground(images, blur);
    } catch (e) {
      console.error("Theme load error:", e);
    }
  }

  function applyThemeBackground(images, blurPx) {
    if (!bgRotatorEl) return;
    bgRotatorEl.innerHTML = "";

    if (!images || !images.length) {
      bgRotatorEl.style.background = "#020617";
      return;
    }

    images.forEach((src, index) => {
      const img = document.createElement("img");
      img.src = src;
      img.style.filter = `blur(${blurPx || 0}px)`;
      if (index === 0) img.classList.add("active");
      bgRotatorEl.appendChild(img);
    });

    if (bgRotationTimer) {
      clearInterval(bgRotationTimer);
      bgRotationTimer = null;
    }

    if (images.length > 1) {
      const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
      bgCurrentIndex = 0;
      bgRotationTimer = setInterval(() => {
        const prev = imgs[bgCurrentIndex];
        bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
        const next = imgs[bgCurrentIndex];
        if (prev) prev.classList.remove("active");
        if (next) next.classList.add("active");
      }, 60000);
    }
  }

  /* ===== –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ Supabase auth ===== */

  async function loadCurrentUser() {
    try {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error || !data || !data.user) {
        console.warn("auth.getUser => –≥–æ—Å—Ç—å", error);
        currentUser = null;
        return;
      }

      const userId = data.user.id;
      const { data: row, error: rowErr } = await supabaseClient
        .from("users")
        .select("*")
        .eq("id", userId)
        .single();

      if (rowErr || !row) {
        console.warn("–ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–∞–±–ª–∏—Ü–µ users:", rowErr);
        currentUser = null;
        return;
      }

      currentUser = row;
      console.log("–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", currentUser);
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
      currentUser = null;
    }
  }

  /* ===== –õ–∏–¥–µ—Ä—ã ===== */

  function getSortedLeaders() {
    const arr = [...leadersCache];
    arr.sort((a, b) => {
      const aAsh = a.ash || 0;
      const bAsh = b.ash || 0;
      if (bAsh !== aAsh) return bAsh - aAsh;
      return (a.id || 0) - (b.id || 0);
    });
    return arr;
  }

  function getLeaderForPosition(pos) {
    const sorted = getSortedLeaders();
    return sorted[pos] || null;
  }

  function deptBadgeClass(dept) {
    if (dept === "LSPD") return "leader-dept-badge leader-dept-lspd";
    if (dept === "SFPD") return "leader-dept-badge leader-dept-sfpd";
    if (dept === "LVPD") return "leader-dept-badge leader-dept-lvpd";
    return "leader-dept-badge";
  }

  function rankEmblem(rank) {
    if (rank === 1) return "ü•á";
    if (rank === 2) return "ü•à";
    if (rank === 3) return "ü•â";
    return "‚≠ê";
  }

  function renderLeaders() {
    if (!leadersStack) return;
    leadersStack.innerHTML = "";

    const sorted = getSortedLeaders();
    const canEdit = isAdminLike(currentUser);
    guestNote.style.display = canEdit ? "none" : "block";

    for (let i = 0; i < 3; i++) {
      const rank = i + 1;
      const leader = sorted[i] || null;
      const card = document.createElement("div");
      card.className = `leader-card leader-rank-${rank}`;

      const rankBadge = document.createElement("div");
      rankBadge.className = "leader-rank-badge";
      rankBadge.innerHTML =
        `<span>${rankEmblem(rank)}</span><span class="rank-num">${rank} –º–µ—Å—Ç–æ</span>`;
      card.appendChild(rankBadge);

      const avatar = document.createElement("div");
      avatar.className = "leader-avatar";
      avatar.dataset.position = String(i);

      if (leader && leader.avatar_url) {
        const img = document.createElement("img");
        img.src = leader.avatar_url;
        avatar.appendChild(img);
      } else {
        const span = document.createElement("div");
        span.className = "leader-avatar-placeholder";
        span.textContent = "‚òÜ";
        avatar.appendChild(span);
      }

      if (canEdit) {
        avatar.classList.add("editable");
      }

      card.appendChild(avatar);

      const main = document.createElement("div");
      main.className = "leader-main";

      const rowTop = document.createElement("div");
      rowTop.className = "leader-row-top";

      const nameBlock = document.createElement("div");
      nameBlock.className = "leader-name-block";

      if (leader && leader.nick) {
        const nickRow = document.createElement("div");
        nickRow.className = "leader-nick";

        const nickSpan = document.createElement("span");
        nickSpan.className = "leader-nick-main";
        nickSpan.textContent = leader.nick;

        const accSpan = document.createElement("span");
        accSpan.className = "leader-account";
        accSpan.textContent = leader.account_number
          ? `[${leader.account_number}]`
          : "[–Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω]";

        nickRow.appendChild(nickSpan);
        nickRow.appendChild(accSpan);
        nameBlock.appendChild(nickRow);
      } else {
        const empty = document.createElement("div");
        empty.className = "leader-empty-text";
        empty.textContent = "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
        nameBlock.appendChild(empty);
      }

      rowTop.appendChild(nameBlock);

      const deptText = leader && leader.dept ? leader.dept : defaultDepts[i];
      const deptBadge = document.createElement("div");
      deptBadge.className = deptBadgeClass(deptText);
      deptBadge.textContent = deptText;
      rowTop.appendChild(deptBadge);

      main.appendChild(rowTop);

      const rowBottom = document.createElement("div");
      rowBottom.className = "leader-row-bottom";

      const statsGrid = document.createElement("div");
      statsGrid.className = "leader-stats-grid";

      const ashValue = leader && typeof leader.ash === "number"
        ? leader.ash
        : null;

      const statDay = document.createElement("div");
      statDay.className = "leader-stat-card";
      const labelDay = document.createElement("div");
      labelDay.className = "leader-stat-label";
      labelDay.textContent = "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–Ω—è";
      const valueDay = document.createElement("div");
      valueDay.className = "leader-stat-value";
      valueDay.innerHTML = ashValue !== null
        ? `${ashValue}<span class="suffix">–ê–®</span>`
        : `‚Äî<span class="suffix">–ê–®</span>`;
      statDay.appendChild(labelDay);
      statDay.appendChild(valueDay);

      const statWeek = document.createElement("div");
      statWeek.className = "leader-stat-card";
      const labelWeek = document.createElement("div");
      labelWeek.className = "leader-stat-label";
      labelWeek.textContent = "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏";
      const valueWeek = document.createElement("div");
      valueWeek.className = "leader-stat-value";
      valueWeek.innerHTML = ashValue !== null
        ? `${ashValue}<span class="suffix">–ê–®</span>`
        : `‚Äî<span class="suffix">–ê–®</span>`;
      statWeek.appendChild(labelWeek);
      statWeek.appendChild(valueWeek);

      statsGrid.appendChild(statDay);
      statsGrid.appendChild(statWeek);

      rowBottom.appendChild(statsGrid);

      const actions = document.createElement("div");
      actions.className = "leader-actions";

      if (canEdit) {
        const editBtn = document.createElement("button");
        editBtn.className = "btn";
        editBtn.type = "button";
        editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.dataset.position = String(i);
        editBtn.onclick = () => openEditModal(i);
        actions.appendChild(editBtn);
      }

      rowBottom.appendChild(actions);
      main.appendChild(rowBottom);
      card.appendChild(main);

      leadersStack.appendChild(card);
    }
  }

  async function loadLeadersFromDB() {
    try {
      const { data, error } = await supabaseClient
        .from("leaders")
        .select("*")
        .order("ash", { ascending: false })
        .order("id", { ascending: true });

      if (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ leaders:", error);
        return;
      }

      leadersCache = data || [];
      renderLeaders();
    } catch (e) {
      console.error("leaders load error:", e);
    }
  }

  /* ===== –ú–æ–¥–∞–ª–∫–∞ ===== */

  function openEditModal(position) {
    if (!isAdminLike(currentUser)) return;

    editingPosition = position;
    const leader = getLeaderForPosition(position);

    if (leader) {
      editingLeaderId = leader.id;
      editDept.value = leader.dept || defaultDepts[position];
      editNick.value = leader.nick || "";
      editAccount.value = leader.account_number || "";
      editAsh.value = typeof leader.ash === "number" ? leader.ash : "";
      editSubtitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–∞ #${position + 1}`;
    } else {
      editingLeaderId = null;
      editDept.value = defaultDepts[position];
      editNick.value = "";
      editAccount.value = "";
      editAsh.value = "";
      editSubtitle.textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–∞ #${position + 1}`;
    }

    editAvatarFile.value = "";
    editError.textContent = "";
    editModalBackdrop.classList.add("active");
  }

  function closeEditModal() {
    editModalBackdrop.classList.remove("active");
    editingPosition = null;
    editingLeaderId = null;
    editError.textContent = "";
  }

  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error("File read error"));
      reader.readAsDataURL(file);
    });
  }

  if (editCancelBtn) {
    editCancelBtn.onclick = () => closeEditModal();
  }

  if (editModalBackdrop) {
    editModalBackdrop.addEventListener("click", (e) => {
      if (e.target === editModalBackdrop) {
        closeEditModal();
      }
    });
  }

  if (editSaveBtn) {
    editSaveBtn.onclick = async () => {
      editError.textContent = "";

      const dept = (editDept.value || "").trim();
      const nick = (editNick.value || "").trim();
      const acc = (editAccount.value || "").trim();
      let ashVal = parseInt(editAsh.value, 10);
      if (isNaN(ashVal) || ashVal < 0) ashVal = 0;

      if (!dept || !nick || !acc) {
        editError.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç, –Ω–∏–∫ –∏ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞.";
        return;
      }

      let avatarData = null;
      if (editAvatarFile.files && editAvatarFile.files[0]) {
        try {
          avatarData = await fileToDataURL(editAvatarFile.files[0]);
        } catch (e) {
          console.error(e);
          editError.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∫–∏.";
          return;
        }
      }

      editSaveBtn.disabled = true;

      try {
        let payload = {
          dept,
          nick,
          account_number: acc,
          ash: ashVal
        };

        if (avatarData) {
          payload.avatar_url = avatarData;
        }

        if (editingLeaderId) {
          const { error } = await supabaseClient
            .from("leaders")
            .update(payload)
            .eq("id", editingLeaderId);

          if (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞:", error);
            editError.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞.";
            editSaveBtn.disabled = false;
            return;
          }
        } else {
          const { data, error } = await supabaseClient
            .from("leaders")
            .insert(payload)
            .select("*")
            .single();

          if (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏–¥–µ—Ä–∞:", error);
            editError.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞.";
            editSaveBtn.disabled = false;
            return;
          }

          leadersCache.push(data);
        }

        closeEditModal();
        await loadLeadersFromDB();
      } catch (e) {
        console.error("leader save error:", e);
        editError.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞.";
      } finally {
        editSaveBtn.disabled = false;
      }
    };
  }

  /* ===== –ê–≤–∞—Ç–∞—Ä–∫–∞ –ø–æ –∫–ª–∏–∫—É ===== */

  document.addEventListener("click", (e) => {
    const avatarEl = e.target.closest(".leader-avatar");
    if (!avatarEl) return;
    if (!isAdminLike(currentUser)) return;

    const pos = parseInt(avatarEl.dataset.position, 10);
    if (isNaN(pos)) return;

    const leader = getLeaderForPosition(pos);
    if (!leader) {
      openEditModal(pos);
      return;
    }

    pendingAvatarLeaderId = leader.id;
    avatarHiddenInput.value = "";
    avatarHiddenInput.click();
  });

  if (avatarHiddenInput) {
    avatarHiddenInput.addEventListener("change", async () => {
      if (!pendingAvatarLeaderId) return;
      const file = avatarHiddenInput.files && avatarHiddenInput.files[0];
      if (!file) return;

      try {
        const dataUrl = await fileToDataURL(file);
        await supabaseClient
          .from("leaders")
          .update({ avatar_url: dataUrl })
          .eq("id", pendingAvatarLeaderId);

        pendingAvatarLeaderId = null;
        await loadLeadersFromDB();
      } catch (e) {
        console.error("avatar update error:", e);
        pendingAvatarLeaderId = null;
      }
    });
  }

  /* ===== Drag&Drop –ø–æ –∞–≤–∞—Ç–∞—Ä–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ===== */

  document.addEventListener("dragover", (e) => {
    const avatarEl = e.target.closest(".leader-avatar");
    if (!avatarEl || !isAdminLike(currentUser)) return;
    e.preventDefault();
    avatarEl.classList.add("avatar-drop-hover");
  });

  document.addEventListener("dragleave", (e) => {
    const avatarEl = e.target.closest(".leader-avatar");
    if (!avatarEl) return;
    avatarEl.classList.remove("avatar-drop-hover");
  });

  document.addEventListener("drop", async (e) => {
    const avatarEl = e.target.closest(".leader-avatar");
    if (!avatarEl || !isAdminLike(currentUser)) return;
    e.preventDefault();
    avatarEl.classList.remove("avatar-drop-hover");

    const pos = parseInt(avatarEl.dataset.position, 10);
    if (isNaN(pos)) return;

    const leader = getLeaderForPosition(pos);
    if (!leader) {
      openEditModal(pos);
      return;
    }

    const files = e.dataTransfer && e.dataTransfer.files;
    if (!files || !files.length) return;

    try {
      const dataUrl = await fileToDataURL(files[0]);
      await supabaseClient
        .from("leaders")
        .update({ avatar_url: dataUrl })
        .eq("id", leader.id);

      await loadLeadersFromDB();
    } catch (err) {
      console.error("avatar drop update error:", err);
    }
  });

  /* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */

  window.addEventListener("load", async () => {
    // 1) —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 3 –ø–ª–∞—à–∫–∏ "–õ–∏–¥–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"
    renderLeaders();

    // 2) –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–µ—Ä–æ–≤
    await loadThemeFromDB();
    await loadCurrentUser();
    renderLeaders();       // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä —Å —É—á—ë—Ç–æ–º —Ä–æ–ª–∏
    await loadLeadersFromDB();
  });
</script>
</body>
</html>
