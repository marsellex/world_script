<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Police Platinum ‚Äî –û—Ñ–∏—Ü–µ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 10% 0, #0ea5e9 0, transparent 55%),
        radial-gradient(circle at 90% 100%, #22c55e 0, transparent 55%),
        linear-gradient(135deg, #020617, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      color: #e5e7eb;
    }

    /* ---------- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---------- */

    #auth-root {
      width: 100%;
      max-width: 520px;
    }

    .app-card {
      width: 100%;
      background: radial-gradient(circle at top, rgba(148,163,184,0.15), transparent 65%),
                  rgba(15,23,42,0.97);
      border-radius: 20px;
      border: 1px solid rgba(30,64,175,0.7);
      box-shadow: 0 18px 40px rgba(0,0,0,0.9);
      padding: 22px 22px 34px;
      position: relative;
      overflow: hidden;
    }

    .badge {
      position: absolute;
      right: 18px;
      top: 18px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316 50%, #b91c1c);
      box-shadow: 0 0 14px rgba(250,204,21,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #111827;
      border: 2px solid #fef9c3;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34,197,94,0.9);
    }

    .auth-screen { display: none; }
    .auth-screen.active { display: block; }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
      background: rgba(15,23,42,0.98);
    }

    input[type="file"] {
      font-size: 12px;
      color: #e5e7eb;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .error {
      font-size: 11px;
      color: #f97373;
    }

    .btn {
      margin-top: 4px;
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: radial-gradient(circle at 0 0, #f97316, #2563eb);
      color: #f9fafb;
      box-shadow: 0 12px 24px rgba(37,99,235,0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 30px rgba(37,99,235,0.9);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(15,23,42,0.9);
    }

    .small-note {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .password-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .password-row input { flex: 1; }

    .password-toggle {
      width: 40px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at 30% 0, rgba(148,163,184,0.35), transparent 70%),
                  rgba(15,23,42,0.95);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      color: #e5e7eb;
      transition: transform 0.1s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .password-toggle:hover {
      transform: translateY(-1px);
      background: radial-gradient(circle at 30% 0, rgba(56,189,248,0.65), transparent 70%),
                  rgba(15,23,42,0.98);
      box-shadow: 0 10px 22px rgba(15,23,42,0.95);
    }

    .departments {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .dept-option {
      flex: 1;
      min-width: 0;
      padding: 7px 8px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      font-size: 13px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.12s ease, border-color 0.12s ease;
      user-select: none;
    }

    .dept-option span {
      display: block;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .dept-option:hover {
      transform: translateY(-1px);
      background: rgba(30,64,175,0.9);
      box-shadow: 0 8px 16px rgba(15,23,42,0.8);
    }

    .dept-option.active {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
      background: rgba(15,23,42,1);
    }

    .avatar-preview {
      margin-top: 8px;
      width: 120px;
      height: 120px;
      border-radius: 16px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-size: 11px;
      color: #6b7280;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .auth-link {
      font-size: 12px;
      color: #93c5fd;
      cursor: pointer;
      margin-top: 8px;
      text-align: right;
    }

    .auth-link:hover { text-decoration: underline; }

    #personal-file-auth-btn {
      position: absolute;
      left: 18px;
      bottom: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.9);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.35), transparent 60%),
        rgba(15,23,42,0.98);
      color: #e5e7eb;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.6),
        0 0 18px rgba(56,189,248,0.8);
      transition: transform 0.1s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.15s ease;
    }

    #personal-file-auth-btn.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #personal-file-auth-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(129,230,217,0.8),
        0 0 28px rgba(56,189,248,1);
    }

    /* ---------- –ü–ê–ù–ï–õ–¨ ---------- */

    #panel-root {
      display: none;
      width: 100%;
      max-width: 1240px;
    }

    #panel-root.active {
      display: block;
    }

    .frame {
      width: 100%;
      max-width: 1240px;
      height: 680px;
      max-height: 95vh;
      background: radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 60%);
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 22px 55px rgba(0, 0, 0, 0.95);
      display: grid;
      grid-template-columns: 230px 1fr;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      backdrop-filter: blur(6px);
    }

    .sidebar {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(8, 47, 73, 0.98));
      padding: 18px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-right: 1px solid rgba(30,64,175,0.9);
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316 50%, #b91c1c);
      box-shadow: 0 0 14px rgba(250,204,21,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #111827;
      border: 2px solid #fef9c3;
      flex-shrink: 0;
    }

    .logo-text-title {
      font-size: 15px;
      font-weight: 600;
    }

    .logo-text-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .sidebar-section-title {
      margin-top: 12px;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #6b7280;
    }

    .nav-btn {
      margin-top: 6px;
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      text-align: left;
      transition: transform 0.1s ease, box-shadow 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-btn span.icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .nav-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent, rgba(56,189,248,0.45), transparent);
      opacity: 0;
      transform: translateX(-120%);
      transition: transform 0.45s ease, opacity 0.45s ease;
      pointer-events: none;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      background: rgba(30,64,175,0.96);
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 12px 22px rgba(15,23,42,0.9);
    }

    .nav-btn:hover::after {
      opacity: 1;
      transform: translateX(120%);
    }

    .nav-btn.primary {
      background: radial-gradient(circle at 0 0, rgba(56,189,248,0.35), transparent 60%),
                  rgba(15,23,42,0.98);
      border-color: rgba(56,189,248,0.9);
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.5),
        0 0 18px rgba(56,189,248,0.8);
    }

    .nav-btn.active-tab {
      border-color: rgba(59,130,246,0.9);
      background: rgba(30,64,175,0.95);
    }

    #admin-panel-btn {
      display: none;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-footer button {
      border: none;
      background: transparent;
      color: #9ca3af;
      text-align: left;
      padding: 0;
      font-size: 12px;
      cursor: pointer;
    }

    .sidebar-footer button:hover {
      text-decoration: underline;
      color: #e5e7eb;
    }

    .main {
      padding: 16px 18px 50px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .top-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .top-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #9ca3af;
      flex-shrink: 0;
    }

    .top-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .top-user-text-title {
      font-size: 14px;
      font-weight: 500;
    }

    .top-user-text-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .top-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.65);
      background: rgba(15,23,42,0.9);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .top-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34,197,94,0.9);
    }

    .panel-card {
      flex: 1;
      border-radius: 18px;
      background:
        radial-gradient(circle at top, rgba(148,163,184,0.2), transparent 70%),
        linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border: 1px solid rgba(51, 65, 85, 0.95);
      box-shadow:
        inset 0 0 0 1px rgba(148, 163, 184, 0.4),
        0 18px 34px rgba(0, 0, 0, 0.95);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-title {
      font-size: 16px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .panel-body {
      font-size: 14px;
      color: #e5e7eb;
      max-width: 700px;
      line-height: 1.6;
      padding-right: 6px;
    }

    .panel-body ul {
      margin-top: 10px;
      margin-left: 18px;
      list-style: disc;
    }

    .panel-body li {
      margin-bottom: 4px;
    }

    .panel-footer {
      margin-top: auto;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .section { display: none; }
    .section.active { display: block; }

    .rules-block {
      font-size: 13px;
      color: #e5e7eb;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .rules-block p { margin-bottom: 6px; }

    .rules-block ul {
      margin-left: 20px;
      margin-bottom: 6px;
      list-style: disc;
    }

    .personal-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    .personal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .personal-label {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .personal-input, .personal-select, .personal-textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .personal-input:focus,
    .personal-select:focus,
    .personal-textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
      background: rgba(15,23,42,0.98);
    }

    .personal-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .personal-header-preview {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px dashed rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.8);
    }

    .promo-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .promo-row {
      display: grid;
      grid-template-columns: 130px minmax(0, 1.6fr) minmax(0, 1.5fr);
      gap: 6px;
      align-items: center;
    }

    .promo-row input[type="date"],
    .promo-row select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      font-size: 12px;
    }

    .promo-row input[type="file"] {
      font-size: 11px;
    }

    .promo-add-btn {
      margin-top: 6px;
      align-self: flex-start;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.8);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .promo-add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(15,23,42,0.8);
      background: rgba(30,64,175,0.96);
    }

    .personal-save-btn {
      margin-top: 10px;
      align-self: flex-start;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      background: radial-gradient(circle at 0 0, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 12px 22px rgba(22,163,74,0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .personal-save-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .personal-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .personal-files-list-wrapper {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid rgba(55,65,81,0.8);
    }

    .personal-files-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .personal-file-item {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .personal-file-item.me {
      border-color: rgba(56,189,248,0.9);
      box-shadow:
        0 0 0 1px rgba(56,189,248,0.5),
        0 0 12px rgba(56,189,248,0.6);
    }

    .personal-file-item-title {
      font-weight: 500;
    }

    .personal-file-item-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    /* –ö–Ω–æ–ø–∫–∞ —Ä—è–¥–æ–≤—ã—Ö */

    #rookie-info-btn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(234,179,8,0.9);
      background:
        radial-gradient(circle at 0 0, rgba(250,204,21,0.3), transparent 60%),
        rgba(15,23,42,0.98);
      color: #fef9c3;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(250,204,21,0.7),
        0 0 22px rgba(250,204,21,0.9);
      transition: transform 0.1s ease, box-shadow 0.12s ease, background 0.12s ease;
      z-index: 5;
      text-align: center;
    }

    #rookie-info-btn span.note {
      font-size: 11px;
      color: #facc15;
    }

    #rookie-info-btn:hover {
      transform: translateX(-50%) translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(252,211,77,0.9),
        0 0 30px rgba(250,204,21,1);
    }

    /* –ú–æ–¥–∞–ª–∫–∏ */

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal-backdrop.active { display: flex; }

    .modal {
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), transparent 65%),
                  rgba(15,23,42,0.98);
      border-radius: 18px;
      border: 1px solid rgba(56,189,248,0.8);
      box-shadow: 0 22px 40px rgba(0,0,0,0.95);
      padding: 18px 18px 14px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-title {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .modal-sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .modal-content {
      font-size: 13px;
      line-height: 1.6;
      color: #e5e7eb;
      overflow-y: auto;
      padding-right: 4px;
      max-height: 55vh;
    }

    .modal-content p { margin-bottom: 6px; }
    .modal-content ul { margin-left: 18px; margin-bottom: 6px; list-style: disc; }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
      gap: 8px;
    }

    .modal-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .modal-btn.primary {
      background: radial-gradient(circle at 0 0, #f97316, #2563eb);
      border-color: rgba(59,130,246,0.9);
      box-shadow: 0 10px 24px rgba(37,99,235,0.8);
    }

    .modal-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15,23,42,0.9);
    }

    .step-link {
      font-size: 12px;
      color: #93c5fd;
      cursor: pointer;
      text-decoration: underline;
    }

    /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */

    #section-admin .admin-note {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .admin-users-list {
      margin-top: 10px;
      max-height: 340px;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .admin-user-card {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      align-items: center;
    }

    .admin-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #9ca3af;
      flex-shrink: 0;
    }

    .admin-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admin-user-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .admin-user-nick {
      font-weight: 500;
      font-size: 13px;
    }

    .admin-role-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
    }

    .admin-role-badge.admin {
      border-color: rgba(248,250,252,0.9);
      background: linear-gradient(135deg, #f97316, #ef4444);
    }

    .admin-role-badge.moderator {
      border-color: rgba(96,165,250,0.9);
      background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
    }

    .admin-user-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .admin-user-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .admin-btn-sm {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .admin-btn-sm:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 10px rgba(15,23,42,0.9);
      background: rgba(30,64,175,0.96);
    }

    .admin-avatar-input {
      font-size: 11px;
    }

    @media (max-width: 1024px) {
      #panel-root.active .frame { transform: scale(0.9); transform-origin: center; }
    }
    @media (max-width: 860px) {
      #panel-root.active .frame { transform: scale(0.8); }
    }
    @media (max-width: 720px) {
      body { padding: 8px; }
      #panel-root.active .frame { transform: scale(0.7); }
    }
  </style>
</head>
<body>
  <!-- AUTH ROOT -->
  <div id="auth-root">
    <div class="app-card">
      <div class="badge">PP</div>

      <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <section id="register-screen" class="auth-screen">
        <h1>Police Platinum</h1>
        <p class="subtitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ñ–∏—Ü–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏.</p>

        <div class="pill">
          <span class="pill-dot"></span>
          –ù–∏–∫ —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: <strong>–ò–º—è_–§–∞–º–∏–ª–∏—è</strong> (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –±–µ–∑ —Ü–∏—Ñ—Ä)
        </div>

        <form id="register-form" novalidate>
          <div class="field">
            <label for="reg-nick">–ù–∏–∫</label>
            <input id="reg-nick" type="text" placeholder="Marsello_Nelson" autocomplete="off" />
            <div class="hint">
              –†—É—Å—Å–∫–∏–µ –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ. –ü—Ä–∏–º–µ—Ä: <code>John_Smith</code>.
            </div>
            <div class="error" id="reg-nick-error"></div>
          </div>

          <div class="field">
            <label for="reg-password">–ü–∞—Ä–æ–ª—å</label>
            <div class="password-row">
              <input id="reg-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" />
              <button type="button" class="password-toggle" id="reg-password-toggle" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
            </div>
            <div class="error" id="reg-password-error"></div>
          </div>

          <div class="field">
            <label>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç (–∏–≥—Ä–æ–≤–æ–π)</label>
            <div class="departments" id="reg-departments">
              <div class="dept-option" data-value="LSPD">
                LSPD
                <span>Los Santos PD</span>
              </div>
              <div class="dept-option" data-value="SFPD">
                SFPD
                <span>San Fierro PD</span>
              </div>
              <div class="dept-option" data-value="LVPD">
                LVPD
                <span>Las Venturas PD</span>
              </div>
            </div>
            <div class="error" id="reg-department-error"></div>
          </div>

          <div class="field">
            <label for="reg-avatar">–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
            <input id="reg-avatar" type="file" accept="image/*" />
            <div class="hint">
              –ö–∞—Ä—Ç–∏–Ω–∫–∞ –±—É–¥–µ—Ç –æ–±—Ä–µ–∑–∞–Ω–∞ –¥–æ 500√ó500 –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ Supabase (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ).
            </div>
            <div class="error" id="reg-avatar-error"></div>
            <div class="avatar-preview" id="reg-avatar-preview">
              –ê–≤–∞—Ç–∞—Ä –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω
            </div>
          </div>

          <button type="submit" class="btn">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
          </button>

          <p class="small-note">
            –õ–æ–∫–∞–ª—å–Ω–æ –¥–∞–Ω–Ω—ã–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –ø–ª—é—Å —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∫–æ–ø–∏—è –≤ Supabase (users + –ª–∏—á–Ω—ã–µ –¥–µ–ª–∞).
          </p>

          <div class="auth-link" id="to-login-link">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏
          </div>
        </form>
      </section>

      <!-- –õ–æ–≥–∏–Ω -->
      <section id="login-screen" class="auth-screen">
        <h1>Police Platinum</h1>
        <p class="subtitle">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞.</p>

        <form id="login-form" novalidate>
          <div class="field">
            <label for="login-nick">–ù–∏–∫</label>
            <input id="login-nick" type="text" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" autocomplete="off" />
            <div class="error" id="login-nick-error"></div>
          </div>

          <div class="field">
            <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
            <div class="password-row">
              <input id="login-password" type="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
              <button type="button" class="password-toggle" id="login-password-toggle" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
            </div>
            <div class="error" id="login-password-error"></div>
          </div>

          <button type="submit" class="btn">
            –í–æ–π—Ç–∏
          </button>

          <div class="auth-link" id="login-reset">
            –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
          </div>
        </form>
      </section>

      <button id="personal-file-auth-btn" class="hidden">
        üìÇ –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
      </button>
    </div>
  </div>

  <!-- PANEL ROOT -->
  <div id="panel-root">
    <div class="frame">
      <!-- –º–æ–¥–∞–ª–∫–∞ –æ–±—É—á–µ–Ω–∏—è –∫–æ–ø–∞ -->
      <div class="modal-backdrop" id="onboarding-modal">
        <div class="modal">
          <h2 class="modal-title">–î–∞–≤–∞–π –æ–±—É—á–∏–º—Å—è –∏–≥—Ä–µ –∑–∞ –∫–æ–ø–∞</h2>
          <p class="modal-sub">
            –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤–æ—Ä–≤–∞—Ç—å—Å—è –≤ –ø–∞—Ç—Ä—É–ª—å, –Ω–∞—Å—Ç—Ä–æ–∏–º –±–∞–∑–æ–≤—ã–µ –≤–µ—â–∏. –≠—Ç–æ –∑–∞–π–º—ë—Ç –ø–∞—Ä—É –º–∏–Ω—É—Ç.
          </p>
          <div class="modal-content">
            <ol>
              <li>
                <strong>–°–æ–∑–¥–∞–π –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ.</strong><br />
                –í –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É
                <em>¬´–°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ¬ª</em>, –µ—Å–ª–∏ –æ–Ω–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è.
              </li>
              <li>
                <strong>–°–∫–∞—á–∞–π –±–∏–Ω–¥–µ—Ä.</strong><br />
                –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É <span class="step-link" id="step-open-binder">¬´–°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä¬ª</span> –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏.
              </li>
              <li>
                <strong>–û—Å–≤–æ–π –±–∏–Ω–¥–µ—Ä.</strong><br />
                –û—Ç–∫—Ä–æ–π –±–∏–Ω–¥–µ—Ä, –∏–∑—É—á–∏ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –∏ –ø—Ä–æ–ø–∏—à–∏ –ø–æ–¥ —Å–µ–±—è –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã:
                –¥–æ–∫–ª–∞–¥—ã, –∑–∞–¥–µ—Ä–∂–∞–Ω–∏—è, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è, –≤—ã–∑–æ–≤—ã –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É.
              </li>
            </ol>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" id="onboarding-close-soft">–ù–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–∑–∂–µ</button>
            <button class="modal-btn primary" id="onboarding-close">–ü–æ–≥–Ω–∞–ª–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
          </div>
        </div>
      </div>

      <!-- –º–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö -->
      <div class="modal-backdrop" id="rookie-modal">
        <div class="modal">
          <h2 class="modal-title">–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö</h2>
          <p class="modal-sub">
            –ù–∞–∂–º–∏, –µ—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ –≤—Å—Ç—É–ø–∏–ª –≤ PD. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å–ª—É–∂–±—ã.
          </p>
          <div class="modal-content">
            <p><strong>Police Academy [PA][1-2] ‚Äî –ü–æ–ª–∏—Ü–µ–π—Å–∫–∞—è –∞–∫–∞–¥–µ–º–∏—è</strong></p>
            <p>
              Police Academy [PA][1-2] (–Ω–æ–≤–æ–±—Ä–∞–Ω—Ü—ã) ‚Äî –æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
              –Ω–æ–≤–∏—á–∫–æ–≤, —Ç–æ–ª—å–∫–æ –≤—Å—Ç—É–ø–∏–≤—à–∏—Ö –≤ —Ä—è–¥—ã –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞. –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç —ç–∫–∑–∞–º–µ–Ω—ã,
              —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –æ–±—É—á–µ–Ω–∏–µ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é —Å –æ—Ä—É–∂–∏–µ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º –ø–æ–≤–µ–¥–µ–Ω–∏—è
              –≤ –ø–∞—Ç—Ä—É–ª–µ (—Å–æ –∑–≤–∞–Ω–∏—è –°–µ—Ä–∂–∞–Ω—Ç [2]).
            </p>
            <p>
              –ê–∫–∞–¥–µ–º–∏—è –≥–æ—Ç–æ–≤–∏—Ç –Ω–æ–≤–æ–±—Ä–∞–Ω—Ü–µ–≤ –≤ –æ—Ç–¥–µ–ª –ø–∞—Ç—Ä—É–ª—å–Ω–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (PD), –≤ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–∏
              –±—É–¥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —ç–∫–∑–∞–º–µ–Ω–æ–≤.
            </p>
            <p>
              –í –æ—Ç–¥–µ–ª –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –æ–±—É—á–µ–Ω–∏–µ –≤ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π
              –∞–∫–∞–¥–µ–º–∏–∏ (1‚Äì2 —Ä–∞–Ω–≥).
            </p>
            <p><strong>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Ü–∏–∏:</strong><br />
              –ü–æ–∑—ã–≤–Ω–æ–π Police Academy: <code>[PA]</code><br />
              –ü—Ä–∏–º–µ—Ä: <code>![PA] –ü—Ä–∏–µ–º...</code>
            </p>
            <p><strong>–û—Ç—ã–≥—Ä–æ–≤–∫–∞ –∑–Ω–∞—á–∫–∞ (–ø—Ä–∏–º–µ—Ä):</strong><br />
              <code>/me –ù–∞ –ø–æ—è—Å–µ –∑–Ω–∞—á–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ LVPD —Å –Ω–æ–º–µ—Ä–æ–º [–Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]</code>
            </p>
          </div>
          <div class="modal-footer">
            <button class="modal-btn primary" id="rookie-close">–ü–æ–Ω—è–ª, –ø—Ä–∏–Ω—è–ª</button>
          </div>
        </div>
      </div>

      <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <aside class="sidebar">
        <div class="logo-row">
          <div class="logo-badge">PP</div>
          <div>
            <div class="logo-text-title">Police Platinum</div>
            <div class="logo-text-sub">–ü–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞</div>
          </div>
        </div>

        <div class="sidebar-section-title">–ù–ê–í–ò–ì–ê–¶–ò–Ø</div>

        <button class="nav-btn primary" id="download-binder-btn">
          <span class="icon">‚¨á</span>
          <span>–°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä</span>
        </button>

        <button class="nav-btn" id="personal-file-btn">
          <span class="icon">üìÇ</span>
          <span id="personal-file-btn-text">–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ</span>
        </button>

        <button class="nav-btn" id="admin-panel-btn">
          <span class="icon">‚öôÔ∏è</span>
          <span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
        </button>

        <div class="sidebar-section-title">–°–ï–°–°–ò–Ø</div>

        <div class="sidebar-footer">
          <button id="sidebar-logout">–í—ã–π—Ç–∏ –≤ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞</button>
          <span>–ï—Å–ª–∏ –Ω–µ –∑–∞—Ö–æ–¥–∏—à—å –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫ ‚Äî –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –ø–æ –Ω–∏–∫—É –∏ –ø–∞—Ä–æ–ª—é.</span>
        </div>
      </aside>

      <!-- –ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å -->
      <main class="main">
        <div class="top-bar">
          <div class="top-user">
            <div class="top-avatar" id="top-avatar">PP</div>
            <div>
              <div class="top-user-text-title" id="top-nick">–û—Ñ–∏—Ü–µ—Ä</div>
              <div class="top-user-text-sub" id="top-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</div>
            </div>
          </div>
          <div class="top-pill" id="top-role-pill">
            <span class="top-dot"></span>
            –°—Ç–∞—Ç—É—Å: –≤ —Å–µ—Ç–∏
          </div>
        </div>

        <div class="panel-card">
          <div class="panel-title">–≥–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</div>

          <!-- —Å–µ–∫—Ü–∏—è "–¥–æ–º" -->
          <div id="section-home" class="panel-body section active">
            –≠—Ç–æ –≥–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å Police Platinum. –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –±–∏–Ω–¥–µ—Ä, –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ,
            –∑–∞–¥–∞—á–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É. –°–µ–π—á–∞—Å –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–∏–Ω–¥–µ—Ä –∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ –¥–∞–Ω–Ω—ã–µ –æ—Ñ–∏—Ü–µ—Ä–∞.
            <ul>
              <li>–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É <strong>¬´–°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä¬ª</strong> —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –∞—Ä—Ö–∏–≤ —Å –±–∏–Ω–¥–µ—Ä–æ–º.</li>
              <li>–ó–∞–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª <strong>¬´–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ¬ª</strong>, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å —Å–≤–æ—é —Ç–µ–º—É –ø–æ —Ñ–æ—Ä–º–µ.</li>
              <li>–ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—Å—Ç—É–ø–∏–ª –≤ PD ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <strong>¬´–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö¬ª</strong> –≤–Ω–∏–∑—É.</li>
            </ul>
          </div>

          <!-- —Å–µ–∫—Ü–∏—è "–ª–∏—á–Ω–æ–µ –¥–µ–ª–æ" -->
          <div id="section-personal" class="panel-body section">
            <div class="rules-block">
              <p><strong>–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–¥–µ–ª–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª</strong></p>
              <p>
                –í –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ –∫–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –≤—Å—Ç—É–ø–∏–≤—à–∏–π –Ω–∞ —Å–ª—É–∂–±—É –≤ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç,
                –æ–±—è–∑–∞–Ω —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å—Ç—Ä–æ–≥–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å –µ–≥–æ.
                –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ—Ç—á—ë—Ç—ã –æ —Ä–∞–±–æ—Ç–µ (–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ, –ø—Ä–µ–º–∏–∏, —á–∏—Å—Ç–∫–∏) –æ—Ñ–æ—Ä–º–ª—è—é—Ç—Å—è –≤ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª.
              </p>
              <ul>
                <li>–ö–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±—è–∑–∞–Ω —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.</li>
                <li>–ü—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ —É–¥–∞–ª—è–µ—Ç—Å—è (–∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç—Å—è).</li>
                <li>–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –≤ –ü–î –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ.</li>
              </ul>
              <p>
                –ü—Ä–æ–≤–µ—Ä–∫–æ–π –æ—Ç—á—ë—Ç–æ–≤ –≤ –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ –∑–∞–Ω–∏–º–∞—é—Ç—Å—è –æ—Ñ–∏—Ü–µ—Ä—ã —Å–æ –∑–≤–∞–Ω–∏—è
                <strong>–ü–æ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫ [8]</strong>.
              </p>
              <ul>
                <li>–ü—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ –æ—Ç—á—ë—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç–æ–π, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Å—Ç.</li>
                <li>–§–ª—É–¥, –º–∞—Ç—ã, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, Offtop ‚Äî —É–¥–∞–ª—è—é—Ç—Å—è, –∞–∫–∫–∞—É–Ω—Ç—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.</li>
                <li>–¢–µ–º—ã –Ω–µ –ø–æ —Ñ–æ—Ä–º–µ ‚Äî —É–¥–∞–ª—è—é—Ç—Å—è.</li>
              </ul>
              <p><strong>–û—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –æ—à–∏–±–æ–∫. –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è.</strong></p>
            </div>

            <div class="personal-form">
              <div>
                <div class="personal-label"><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã</strong> (—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</div>
                <div class="personal-header-preview" id="personal-header-preview">
                  [–û—Ç–¥–µ–ª] –ò–º—è_–§–∞–º–∏–ª–∏—è [–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞]
                </div>
              </div>

              <div class="personal-grid">
                <div>
                  <div class="personal-label">–û—Ç–¥–µ–ª (—Ñ–æ—Ä—É–º–Ω—ã–π)</div>
                  <select id="pf-dept" class="personal-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª‚Ä¶</option>
                    <option value="SWAT">SWAT</option>
                    <option value="PD">PD</option>
                    <option value="PA">PA</option>
                    <option value="CHIEF">CHIEF</option>
                    <option value="IAG">IAG</option>
                    <option value="Cmdr.SWAT">Cmdr.SWAT</option>
                    <option value="DCmdr.SWAT">DCmdr.SWAT</option>
                  </select>
                </div>

                <div>
                  <div class="personal-label">–ò–º—è_–§–∞–º–∏–ª–∏—è (–∫–∞–∫ –≤ –∏–≥—Ä–µ)</div>
                  <input id="pf-nick" type="text" class="personal-input" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" />
                </div>

                <div>
                  <div class="personal-label">–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</div>
                  <input id="pf-account" type="text" class="personal-input" placeholder="522501" />
                </div>

                <div>
                  <div class="personal-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                  <input id="pf-birth" type="text" class="personal-input" placeholder="01.01.2000" />
                </div>

                <div>
                  <div class="personal-label">–ù–æ–º–µ—Ä –∑–Ω–∞—á–∫–∞ / –∞–∫–∫–∞—É–Ω—Ç–∞ (—Å—Å—ã–ª–∫–∞)</div>
                  <input id="pf-badge-link" type="text" class="personal-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç / –ø—Ä–æ—Ñ–∏–ª—å" />
                </div>

                <div>
                  <div class="personal-label">–¢–µ–∫—É—â–µ–µ –∑–≤–∞–Ω–∏–µ</div>
                  <input id="pf-rank" type="text" class="personal-input" placeholder="–°–µ—Ä–∂–∞–Ω—Ç / –ö–∞–ø–∏—Ç–∞–Ω / ..." />
                </div>

                <div>
                  <div class="personal-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
                  <input id="pf-phone" type="text" class="personal-input" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
                </div>

                <div>
                  <div class="personal-label">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ —Å–≤—è–∑–∏</div>
                  <input id="pf-contact" type="text" class="personal-input" placeholder="VK / Discord" />
                </div>
              </div>

              <div>
                <div class="personal-label">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–≤—ã—à–µ–Ω–∏–π</div>
                <div class="personal-note">
                  –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–∞—Ç—É –ø–æ–≤—ã—à–µ–Ω–∏—è –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç (—Å–∫—Ä–∏–Ω ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω).
                </div>
                <div id="promo-list" class="promo-list"></div>
                <button type="button" id="add-promo-btn" class="promo-add-btn">
                  + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø–æ–≤—ã—à–µ–Ω–∏–∏
                </button>
              </div>

              <button type="button" id="save-personal-btn" class="personal-save-btn">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
              </button>
              <div class="personal-note" id="personal-save-note"></div>

              <div class="personal-files-list-wrapper">
                <div class="personal-label">
                  <strong>–°–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ª–∏—á–Ω—ã—Ö –¥–µ–ª (–∏–∑ Supabase)</strong>
                </div>
                <div class="personal-note">
                  –í–∞—à–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–≤–µ—Ä—Ö—É —Å–ø–∏—Å–∫–∞ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –≤–∞—Å.
                </div>
                <div id="personal-files-list" class="personal-files-list"></div>
              </div>
            </div>
          </div>

          <!-- —Å–µ–∫—Ü–∏—è "–∞–¥–º–∏–Ω–∫–∞" -->
          <div id="section-admin" class="panel-body section">
            <div class="personal-label"><strong>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong></div>
            <div class="admin-note">
              –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –º–µ–Ω—è—Ç—å –∏–º —Ä–æ–ª—å –∏ –∞–≤–∞—Ç–∞—Ä–∫–∏.
              ‚ö† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ –≤—Å—ë –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ, —Ç–∞–∫ —á—Ç–æ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Ç—É—Ç —Å—É–ø–µ—Ä—Å–µ–∫—Ä–µ—Ç—ã.
            </div>
            <div id="admin-users-list" class="admin-users-list">
              –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
            </div>
          </div>

          <div class="panel-footer">
            <span>–í–µ—Ä—Å–∏—è –ø–∞–Ω–µ–ª–∏: 0.5 (Supabase: —Ä–æ–ª–∏, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, —Å–º–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–æ–∫).</span>
            <span>–ë–∏–Ω–¥–µ—Ä: –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª <code>binder.zip</code> —Ä—è–¥–æ–º —Å —Å–∞–π—Ç–æ–º –¥–ª—è —Ä–∞–±–æ—á–µ–π –∫–Ω–æ–ø–∫–∏.</span>
          </div>
        </div>

        <button id="rookie-info-btn">
          ‚Ñπ –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö
          <span class="note">(–Ω–∞–∂–º–∏, –µ—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ –≤—Å—Ç—É–ø–∏–ª –≤ PD ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
        </button>
      </main>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    const DAY_MS = 24 * 60 * 60 * 1000;
    const STORAGE_KEY = "pp_user";

    function loadUser() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function saveUser(user) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
    }

    function clearUser() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function normalizeNick(raw) {
      if (!raw) return null;
      let s = raw.trim();
      s = s.replace(/[^A-Za-z–ê-–Ø–∞-—è–Å—ë_]+/g, "");
      s = s.replace(/_+/g, "_");
      const parts = s.split("_").filter(Boolean);
      if (parts.length < 2) return null;
      const first = parts[0];
      const last = parts[1];

      function capitalize(word) {
        if (!word) return "";
        const lower = word.toLowerCase();
        return lower[0].toUpperCase() + lower.slice(1);
      }

      const name = capitalize(first);
      const surname = capitalize(last);
      const result = name + "_" + surname;

      const finalPattern = /^[A-Za-z–ê-–Ø–∞-—è–Å—ë]+_[A-Za-z–ê-–Ø–∞-—è–Å—ë]+$/;
      if (!finalPattern.test(result)) return null;
      return result;
    }

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const authRoot = document.getElementById("auth-root");
    const panelRoot = document.getElementById("panel-root");

    const registerScreen = document.getElementById("register-screen");
    const loginScreen = document.getElementById("login-screen");

    const regForm = document.getElementById("register-form");
    const regNick = document.getElementById("reg-nick");
    const regPass = document.getElementById("reg-password");
    const regNickError = document.getElementById("reg-nick-error");
    const regPassError = document.getElementById("reg-password-error");
    const regDeptError = document.getElementById("reg-department-error");
    const regAvatarInput = document.getElementById("reg-avatar");
    const regAvatarError = document.getElementById("reg-avatar-error");
    const regAvatarPreview = document.getElementById("reg-avatar-preview");
    const deptContainer = document.getElementById("reg-departments");

    const loginForm = document.getElementById("login-form");
    const loginNick = document.getElementById("login-nick");
    const loginNickError = document.getElementById("login-nick-error");
    const loginPass = document.getElementById("login-password");
    const loginPassError = document.getElementById("login-password-error");

    const toLoginLink = document.getElementById("to-login-link");
    const loginReset = document.getElementById("login-reset");

    const regPassToggle = document.getElementById("reg-password-toggle");
    const loginPassToggle = document.getElementById("login-password-toggle");

    const personalFileAuthBtn = document.getElementById("personal-file-auth-btn");

    let selectedDept = null;
    let avatarDataUrl = null;
    let currentUser = loadUser();

    function showAuthScreen(which) {
      registerScreen.classList.remove("active");
      loginScreen.classList.remove("active");
      if (which === "register") {
        registerScreen.classList.add("active");
      } else {
        loginScreen.classList.add("active");
      }
    }

    function showAuthRoot() {
      authRoot.style.display = "block";
      panelRoot.classList.remove("active");
      panelRoot.style.display = "none";
    }

    function showPanelRoot() {
      authRoot.style.display = "none";
      panelRoot.style.display = "block";
      panelRoot.classList.add("active");
    }

    function updatePersonalFileAuthBtn() {
      if (currentUser && !currentUser.personalFile) {
        personalFileAuthBtn.classList.remove("hidden");
      } else {
        personalFileAuthBtn.classList.add("hidden");
      }
    }

    deptContainer.addEventListener("click", (e) => {
      const option = e.target.closest(".dept-option");
      if (!option) return;
      const value = option.getAttribute("data-value");
      selectedDept = value;
      Array.from(deptContainer.querySelectorAll(".dept-option")).forEach(el => {
        el.classList.toggle("active", el === option);
      });
      regDeptError.textContent = "";
    });

    regPassToggle.addEventListener("mouseenter", () => { regPass.type = "text"; });
    regPassToggle.addEventListener("mouseleave", () => { regPass.type = "password"; });

    loginPassToggle.addEventListener("mouseenter", () => { loginPass.type = "text"; });
    loginPassToggle.addEventListener("mouseleave", () => { loginPass.type = "password"; });

    // –ö—Ä–æ–ø —Ñ–∞–π–ª–∞ ‚Üí dataURL 500x500
    function cropImageFileToDataUrl(file, size = 500) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement("canvas");
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext("2d");

            const scale = Math.max(size / img.width, size / img.height);
            const x = (size - img.width * scale) / 2;
            const y = (size - img.height * scale) / 2;

            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = () => reject(new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞"));
        reader.readAsDataURL(file);
      });
    }

    regAvatarInput.addEventListener("change", async () => {
      regAvatarError.textContent = "";
      const file = regAvatarInput.files[0];
      if (!file) {
        avatarDataUrl = null;
        regAvatarPreview.innerHTML = "–ê–≤–∞—Ç–∞—Ä –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω";
        return;
      }

      try {
        avatarDataUrl = await cropImageFileToDataUrl(file, 500);
        regAvatarPreview.innerHTML = "";
        const previewImg = document.createElement("img");
        previewImg.src = avatarDataUrl;
        regAvatarPreview.appendChild(previewImg);
      } catch {
        regAvatarError.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.";
        avatarDataUrl = null;
      }
    });

    toLoginLink.addEventListener("click", () => {
      showAuthScreen("login");
    });

    loginReset.addEventListener("click", () => {
      clearUser();
      currentUser = null;
      selectedDept = null;
      avatarDataUrl = null;
      regForm.reset();
      regAvatarPreview.innerHTML = "–ê–≤–∞—Ç–∞—Ä –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω";
      Array.from(deptContainer.querySelectorAll(".dept-option")).forEach(el =>
        el.classList.remove("active")
      );
      showAuthScreen("register");
      updatePersonalFileAuthBtn();
      regNick.focus();
    });

    personalFileAuthBtn.addEventListener("click", () => {
      const now = Date.now();
      if (!currentUser) return;
      if (!currentUser.lastLoginAt || now - currentUser.lastLoginAt >= DAY_MS) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –ø–æ –Ω–∏–∫—É –∏ –ø–∞—Ä–æ–ª—é, –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ.");
        showAuthScreen("login");
        loginNick.value = currentUser.nick || "";
        loginNick.focus();
        return;
      }
      goToPanel("personal");
    });

    async function uploadAvatarToSupabase(nick, avatarDataUrl) {
      if (!avatarDataUrl) return null;
      try {
        const res = await fetch(avatarDataUrl);
        const blob = await res.blob();
        const fileName = `${nick}_avatar_${Date.now()}.png`;

        const { data: storageData, error: storageError } = await supabase.storage
          .from("avatars")
          .upload(fileName, blob, {
            contentType: "image/png",
            upsert: true
          });

        if (storageError) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:", storageError);
          return null;
        }
        const { data: publicUrlData } = supabase.storage
          .from("avatars")
          .getPublicUrl(storageData.path);
        return publicUrlData.publicUrl;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞:", e);
        return null;
      }
    }

    async function registerOnServer(nick, password, department, avatarDataUrl) {
      let avatar_url = null;
      if (avatarDataUrl) {
        avatar_url = await uploadAvatarToSupabase(nick, avatarDataUrl);
      }

      const { data, error } = await supabase
        .from("users")
        .insert({
          nick,
          department,
          password_hash: password,
          avatar_url,
          role: "user"
        })
        .select()
        .single();

      if (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ Supabase: " + error.message);
        return null;
      }

      return data;
    }

    async function loginOnServer(nick, password) {
      const { data, error } = await supabase
        .from("users")
        .select("*")
        .eq("nick", nick)
        .single();

      if (error) {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
        return { ok: false, reason: "not_found" };
      }

      if (data.password_hash !== password) {
        return { ok: false, reason: "bad_password" };
      }

      return { ok: true, user: data };
    }

    regForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      regNickError.textContent = "";
      regPassError.textContent = "";
      regDeptError.textContent = "";
      regAvatarError.textContent = "";

      let valid = true;

      const normalizedNick = normalizeNick(regNick.value);
      if (!normalizedNick) {
        regNickError.textContent =
          "–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ò–º—è_–§–∞–º–∏–ª–∏—è, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –±–µ–∑ —Ü–∏—Ñ—Ä.";
        valid = false;
      }

      const password = regPass.value;
      if (!password) {
        regPassError.textContent = "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.";
        valid = false;
      } else if (password.length < 6) {
        regPassError.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.";
        valid = false;
      }

      if (!selectedDept) {
        regDeptError.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç.";
        valid = false;
      }

      if (!valid) return;

      regNick.value = normalizedNick;
      const now = Date.now();

      let serverUser = null;
      try {
        serverUser = await registerOnServer(normalizedNick, password, selectedDept, avatarDataUrl);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
      }

      currentUser = {
        nick: normalizedNick,
        password: password,
        department: selectedDept,
        avatar: avatarDataUrl || (serverUser ? serverUser.avatar_url : null),
        registeredAt: now,
        lastLoginAt: now,
        personalFile: null,
        justRegistered: true,
        serverId: serverUser ? serverUser.id : null,
        role: serverUser ? serverUser.role || "user" : "user"
      };
      saveUser(currentUser);
      updatePersonalFileAuthBtn();
      goToPanel("home");
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginNickError.textContent = "";
      loginPassError.textContent = "";

      const stored = loadUser();
      const normalizedNick = normalizeNick(loginNick.value);
      if (!normalizedNick) {
        loginNickError.textContent =
          "–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ò–º—è_–§–∞–º–∏–ª–∏—è, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã.";
        return;
      }

      if (!loginPass.value) {
        loginPassError.textContent = "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.";
        return;
      }

      let serverResult = null;
      try {
        serverResult = await loginOnServer(normalizedNick, loginPass.value);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
      }

      if (serverResult && serverResult.ok) {
        const now = Date.now();
        const serverUser = serverResult.user;

        currentUser = {
          nick: serverUser.nick,
          password: loginPass.value,
          department: serverUser.department,
          avatar: serverUser.avatar_url || stored?.avatar || null,
          registeredAt: stored?.registeredAt || now,
          lastLoginAt: now,
          personalFile: stored?.personalFile || null,
          justRegistered: false,
          serverId: serverUser.id,
          role: serverUser.role || "user"
        };
        saveUser(currentUser);
        updatePersonalFileAuthBtn();
        goToPanel("home");
        return;
      }

      if (serverResult && serverResult.reason === "bad_password") {
        loginPassError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å (Supabase).";
        return;
      }

      if (!stored) {
        loginNickError.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å–Ω–∞—á–∞–ª–∞.";
        return;
      }

      if (normalizedNick !== stored.nick) {
        loginNickError.textContent = "–¢–∞–∫–æ–π –Ω–∏–∫ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ).";
        return;
      }

      if (loginPass.value !== stored.password) {
        loginPassError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å (–ª–æ–∫–∞–ª—å–Ω—ã–π).";
        return;
      }

      stored.lastLoginAt = Date.now();
      stored.justRegistered = false;
      currentUser = stored;
      saveUser(currentUser);
      updatePersonalFileAuthBtn();
      goToPanel("home");
    });

    // –ü–∞–Ω–µ–ª—å
    const topNick = document.getElementById("top-nick");
    const topDept = document.getElementById("top-dept");
    const topAvatar = document.getElementById("top-avatar");
    const topRolePill = document.getElementById("top-role-pill");

    const downloadBinderBtn = document.getElementById("download-binder-btn");
    const personalFileBtn = document.getElementById("personal-file-btn");
    const personalFileBtnText = document.getElementById("personal-file-btn-text");
    const adminPanelBtn = document.getElementById("admin-panel-btn");
    const sidebarLogout = document.getElementById("sidebar-logout");

    const sectionHome = document.getElementById("section-home");
    const sectionPersonal = document.getElementById("section-personal");
    const sectionAdmin = document.getElementById("section-admin");

    const onboardingModal = document.getElementById("onboarding-modal");
    const onboardingClose = document.getElementById("onboarding-close");
    const onboardingCloseSoft = document.getElementById("onboarding-close-soft");
    const stepOpenBinder = document.getElementById("step-open-binder");

    const rookieBtn = document.getElementById("rookie-info-btn");
    const rookieModal = document.getElementById("rookie-modal");
    const rookieClose = document.getElementById("rookie-close");

    // –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
    const pfDept = document.getElementById("pf-dept");
    const pfNick = document.getElementById("pf-nick");
    const pfAccount = document.getElementById("pf-account");
    const pfBirth = document.getElementById("pf-birth");
    const pfBadgeLink = document.getElementById("pf-badge-link");
    const pfRank = document.getElementById("pf-rank");
    const pfPhone = document.getElementById("pf-phone");
    const pfContact = document.getElementById("pf-contact");
    const pfHeaderPreview = document.getElementById("personal-header-preview");
    const promoList = document.getElementById("promo-list");
    const addPromoBtn = document.getElementById("add-promo-btn");
    const savePersonalBtn = document.getElementById("save-personal-btn");
    const personalSaveNote = document.getElementById("personal-save-note");
    const personalFilesList = document.getElementById("personal-files-list");

    // –∞–¥–º–∏–Ω–∫–∞
    const adminUsersList = document.getElementById("admin-users-list");

    function setActiveSection(section) {
      sectionHome.classList.remove("active");
      sectionPersonal.classList.remove("active");
      sectionAdmin.classList.remove("active");

      if (section === "personal") {
        sectionPersonal.classList.add("active");
      } else if (section === "admin") {
        sectionAdmin.classList.add("active");
      } else {
        sectionHome.classList.add("active");
      }

      if (section === "personal") {
        fillPersonalFileForm();
      }
      if (section === "admin") {
        renderAdminUsers();
      }
    }

    function roleLabel(role) {
      if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
      if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
      return "–û—Ñ–∏—Ü–µ—Ä";
    }

    function updateTopBar() {
      if (!currentUser) return;
      topNick.textContent = currentUser.nick || "–û—Ñ–∏—Ü–µ—Ä";
      topDept.textContent = "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + (currentUser.department || "‚Äî");
      topAvatar.innerHTML = "";
      if (currentUser.avatar) {
        const img = document.createElement("img");
        img.src = currentUser.avatar;
        topAvatar.appendChild(img);
      } else {
        topAvatar.textContent = currentUser.nick ? currentUser.nick[0] : "P";
      }

      const role = currentUser.role || "user";
      topRolePill.innerHTML = "";
      const dot = document.createElement("span");
      dot.className = "top-dot";
      const text = document.createElement("span");
      text.textContent = roleLabel(role);
      topRolePill.appendChild(dot);
      topRolePill.appendChild(text);
    }

    function isAdmin() {
      return currentUser && (currentUser.role === "admin" || currentUser.role === "moderator");
    }

    function updateAdminVisibility() {
      if (isAdmin()) {
        adminPanelBtn.style.display = "flex";
      } else {
        adminPanelBtn.style.display = "none";
      }
    }

    function updatePersonalFileNavButton() {
      if (currentUser && currentUser.personalFile) {
        personalFileBtnText.textContent = "–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ";
        personalFileBtn.classList.remove("primary");
      } else {
        personalFileBtnText.textContent = "–°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ";
        personalFileBtn.classList.add("primary");
      }
    }

    function updateHeaderPreview() {
      const dept = pfDept.value || "–û—Ç–¥–µ–ª";
      const nickRaw = pfNick.value;
      const normalized = normalizeNick(nickRaw) || nickRaw || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
      const acc = pfAccount.value || "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞";
      pfHeaderPreview.textContent = `[${dept}] ${normalized} [${acc}]`;
    }

    pfDept.addEventListener("change", updateHeaderPreview);
    pfNick.addEventListener("input", updateHeaderPreview);
    pfAccount.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D+/g, "");
      updateHeaderPreview();
    });

    function addPromotionRow(data) {
      const row = document.createElement("div");
      row.className = "promo-row";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = data && data.date ? data.date : "";

      const rankSelect = document.createElement("select");
      const ranks = [
        "[1] –†—è–¥–æ–≤–æ–π",
        "[2] –°–µ—Ä–∂–∞–Ω—Ç",
        "[3] –°—Ç. —Å–µ—Ä–∂–∞–Ω—Ç",
        "[4] –õ–µ–π—Ç–µ–Ω–∞–Ω—Ç",
        "[5] –°—Ç. –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç",
        "[6] –ö–∞–ø–∏—Ç–∞–Ω",
        "[7] –ú–∞–π–æ—Ä",
        "[8] –ü–æ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫",
        "[9] –ü–æ–ª–∫–æ–≤–Ω–∏–∫",
        "[10] –ì–µ–Ω–µ—Ä–∞–ª"
      ];
      const emptyOpt = document.createElement("option");
      emptyOpt.value = "";
      emptyOpt.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–Ω–≥‚Ä¶";
      rankSelect.appendChild(emptyOpt);
      ranks.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        rankSelect.appendChild(opt);
      });
      rankSelect.value = data && data.rank ? data.rank : "";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";

      row.appendChild(dateInput);
      row.appendChild(rankSelect);
      row.appendChild(fileInput);

      promoList.appendChild(row);
    }

    addPromoBtn.addEventListener("click", () => addPromotionRow());

    async function fetchPersonalFilesFromServer() {
      try {
        const { data, error } = await supabase
          .from("personal_files")
          .select("forum_dept, forum_nick, account_number, rank")
          .order("updated_at", { ascending: false });

        if (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª:", error);
          return [];
        }

        return data.map(row => ({
          dept: row.forum_dept,
          nick: row.forum_nick,
          account: row.account_number,
          rank: row.rank || ""
        }));
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ fetchPersonalFilesFromServer:", e);
        return [];
      }
    }

    async function renderPersonalFilesList() {
      if (!personalFilesList) return;

      personalFilesList.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª...";

      const list = await fetchPersonalFilesFromServer();

      personalFilesList.innerHTML = "";

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "personal-note";
        empty.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
        personalFilesList.appendChild(empty);
        return;
      }

      const myNick =
        currentUser && currentUser.personalFile
          ? currentUser.personalFile.nick
          : currentUser
          ? currentUser.nick
          : null;

      list.sort((a, b) => {
        if (myNick && a.nick === myNick && b.nick !== myNick) return -1;
        if (myNick && b.nick === myNick && a.nick !== myNick) return 1;
        return (a.nick || "").localeCompare(b.nick || "", "ru");
      });

      list.forEach(entry => {
        const item = document.createElement("div");
        item.className = "personal-file-item";
        if (myNick && entry.nick === myNick) {
          item.classList.add("me");
        }

        const title = document.createElement("div");
        title.className = "personal-file-item-title";
        const dept = entry.dept || "–û—Ç–¥–µ–ª";
        const nick = entry.nick || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
        const account = entry.account || "–Ω–æ–º–µ—Ä";
        title.textContent = `[${dept}] ${nick} [${account}]`;

        const meta = document.createElement("div");
        meta.className = "personal-file-item-meta";
        const rank = entry.rank ? `–ó–≤–∞–Ω–∏–µ: ${entry.rank}` : "";
        meta.textContent = rank || "–ó–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ";

        item.appendChild(title);
        item.appendChild(meta);
        personalFilesList.appendChild(item);
      });
    }

    function fillPersonalFileForm() {
      personalSaveNote.textContent = "";
      promoList.innerHTML = "";
      if (!currentUser || !currentUser.personalFile) {
        if (currentUser) {
          pfDept.value = "";
          pfNick.value = currentUser.nick || "";
          pfAccount.value = "";
        } else {
          pfDept.value = "";
          pfNick.value = "";
          pfAccount.value = "";
        }
        pfBirth.value = "";
        pfBadgeLink.value = "";
        pfRank.value = "";
        pfPhone.value = "";
        pfContact.value = "";
        updateHeaderPreview();
        addPromotionRow();
      } else {
        const pf = currentUser.personalFile;
        pfDept.value = pf.dept || "";
        pfNick.value = pf.nick || "";
        pfAccount.value = pf.account || "";
        pfBirth.value = pf.birth || "";
        pfBadgeLink.value = pf.badgeLink || "";
        pfRank.value = pf.rank || "";
        pfPhone.value = pf.phone || "";
        pfContact.value = pf.contact || "";
        updateHeaderPreview();
        if (pf.promotions && pf.promotions.length) {
          pf.promotions.forEach(p => addPromotionRow(p));
        } else {
          addPromotionRow();
        }
      }
      renderPersonalFilesList();
    }

    async function savePersonalFileOnServer() {
      if (!currentUser || !currentUser.personalFile) return;

      let userId = currentUser.serverId;
      if (!userId) {
        const { data: userRow, error: userError } = await supabase
          .from("users")
          .select("id")
          .eq("nick", currentUser.nick)
          .single();
        if (userError || !userRow) {
          console.error("–ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞", userError);
          return;
        }
        userId = userRow.id;
        currentUser.serverId = userId;
        saveUser(currentUser);
      }

      const pf = currentUser.personalFile;

      const { data: existing, error: pfError } = await supabase
        .from("personal_files")
        .select("*")
        .eq("user_id", userId)
        .single();

      if (pfError || !existing) {
        const { error: createError } = await supabase
          .from("personal_files")
          .insert({
            user_id: userId,
            forum_dept: pf.dept,
            forum_nick: pf.nick,
            account_number: pf.account,
            birth_date: pf.birth,
            badge_link: pf.badgeLink,
            rank: pf.rank,
            phone: pf.phone,
            contact: pf.contact
          });

        if (createError) {
          console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞:", createError);
          return;
        }
      } else {
        const { error: updateError } = await supabase
          .from("personal_files")
          .update({
            forum_dept: pf.dept,
            forum_nick: pf.nick,
            account_number: pf.account,
            birth_date: pf.birth,
            badge_link: pf.badgeLink,
            rank: pf.rank,
            phone: pf.phone,
            contact: pf.contact,
            updated_at: new Date().toISOString()
          })
          .eq("id", existing.id);

        if (updateError) {
          console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞:", updateError);
          return;
        }
      }
    }

    savePersonalBtn.addEventListener("click", async () => {
      personalSaveNote.style.color = "#9ca3af";
      personalSaveNote.textContent = "";

      if (!currentUser) return;

      const dept = pfDept.value.trim();
      const nickNormalized = normalizeNick(pfNick.value);
      const account = pfAccount.value.trim();

      if (!dept || !nickNormalized || !account) {
        personalSaveNote.style.color = "#f97373";
        personalSaveNote.textContent =
          "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º: –û—Ç–¥–µ–ª, –ò–º—è_–§–∞–º–∏–ª–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (—Ü–∏—Ñ—Ä—ã).";
        return;
      }

      const promotions = [];
      const rows = promoList.querySelectorAll(".promo-row");
      for (const row of rows) {
        const inputs = row.querySelectorAll("input, select");
        const dateInput = inputs[0];
        const rankSelect = inputs[1];
        const fileInput = inputs[2];

        const date = dateInput.value;
        const rank = rankSelect.value;
        if (!date && !rank && (!fileInput || !fileInput.files.length)) continue;

        promotions.push({ date, rank, hasScreenshot: !!(fileInput && fileInput.files && fileInput.files[0]) });
      }

      currentUser.personalFile = {
        dept,
        nick: nickNormalized,
        account,
        birth: pfBirth.value.trim(),
        badgeLink: pfBadgeLink.value.trim(),
        rank: pfRank.value.trim(),
        phone: pfPhone.value.trim(),
        contact: pfContact.value.trim(),
        promotions
      };

      currentUser.nick = nickNormalized;

      saveUser(currentUser);
      updateTopBar();
      updatePersonalFileNavButton();
      updatePersonalFileAuthBtn();

      try {
        await savePersonalFileOnServer();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", err);
      }

      renderPersonalFilesList();

      personalSaveNote.style.color = "#22c55e";
      personalSaveNote.textContent = "–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –í–∞—à–µ –¥–µ–ª–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –≤–≤–µ—Ä—Ö—É —Å–ø–∏—Å–∫–∞.";
      setTimeout(() => {
        personalSaveNote.textContent = "";
      }, 3000);
    });

    // –ê–¥–º–∏–Ω–∫–∞

    async function fetchAllUsersForAdmin() {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("id, nick, department, role, avatar_url, created_at")
          .order("created_at", { ascending: true });

        if (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —é–∑–µ—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏:", error);
          return [];
        }

        return data || [];
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ fetchAllUsersForAdmin:", e);
        return [];
      }
    }

    async function updateUserRole(userId, newRole) {
      try {
        const { error } = await supabase
          .from("users")
          .update({ role: newRole })
          .eq("id", userId);

        if (error) {
          console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏:", error);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å: " + error.message);
          return false;
        }
        return true;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ updateUserRole:", e);
        return false;
      }
    }

    async function adminChangeAvatarForUser(user, file) {
      try {
        const dataUrl = await cropImageFileToDataUrl(file, 500);
        const url = await uploadAvatarToSupabase(user.nick, dataUrl);
        if (!url) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä.";
          return;
        }

        const { error } = await supabase
          .from("users")
          .update({ avatar_url: url })
          .eq("id", user.id);

        if (error) {
          console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è avatar_url:", error);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –≤ –ë–î: " + error.message);
          return;
        }

        if (currentUser && currentUser.serverId === user.id) {
          currentUser.avatar = dataUrl;
          saveUser(currentUser);
          updateTopBar();
        }

        await renderAdminUsers();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ adminChangeAvatarForUser:", e);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.");
      }
    }

    async function renderAdminUsers() {
      if (!adminUsersList) return;
      adminUsersList.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...";

      if (!isAdmin()) {
        adminUsersList.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.";
        return;
      }

      const users = await fetchAllUsersForAdmin();
      adminUsersList.innerHTML = "";

      if (!users.length) {
        adminUsersList.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.";
        return;
      }

      users.forEach(user => {
        const card = document.createElement("div");
        card.className = "admin-user-card";

        const avatar = document.createElement("div");
        avatar.className = "admin-user-avatar";
        if (user.avatar_url) {
          const img = document.createElement("img");
          img.src = user.avatar_url;
          avatar.appendChild(img);
        } else {
          avatar.textContent = user.nick ? user.nick[0] : "?";
        }

        const main = document.createElement("div");
        main.className = "admin-user-main";

        const header = document.createElement("div");
        header.className = "admin-user-header";

        const nickEl = document.createElement("div");
        nickEl.className = "admin-user-nick";
        nickEl.textContent = user.nick;

        const roleBadge = document.createElement("div");
        roleBadge.className = "admin-role-badge " + (user.role || "user");
        roleBadge.textContent = roleLabel(user.role || "user");

        header.appendChild(nickEl);
        header.appendChild(roleBadge);

        const meta = document.createElement("div");
        meta.className = "admin-user-meta";
        meta.textContent =
          `–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: ${user.department || "‚Äî"} ¬∑ –°–æ–∑–¥–∞–Ω: ${user.created_at ? new Date(user.created_at).toLocaleString() : "‚Äî"}`;

        const actions = document.createElement("div");
        actions.className = "admin-user-actions";

        const makeUserBtn = document.createElement("button");
        makeUserBtn.className = "admin-btn-sm";
        makeUserBtn.textContent = "–û–±—ã—á–Ω—ã–π";
        makeUserBtn.addEventListener("click", async () => {
          if (await updateUserRole(user.id, "user")) {
            if (currentUser && currentUser.serverId === user.id) {
              currentUser.role = "user";
              saveUser(currentUser);
              updateTopBar();
              updateAdminVisibility();
            }
            renderAdminUsers();
          }
        });

        const makeModBtn = document.createElement("button");
        makeModBtn.className = "admin-btn-sm";
        makeModBtn.textContent = "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
        makeModBtn.addEventListener("click", async () => {
          if (await updateUserRole(user.id, "moderator")) {
            if (currentUser && currentUser.serverId === user.id) {
              currentUser.role = "moderator";
              saveUser(currentUser);
              updateTopBar();
              updateAdminVisibility();
            }
            renderAdminUsers();
          }
        });

        const makeAdminBtn = document.createElement("button");
        makeAdminBtn.className = "admin-btn-sm";
        makeAdminBtn.textContent = "–ê–¥–º–∏–Ω";
        makeAdminBtn.addEventListener("click", async () => {
          if (!confirm(`–°–¥–µ–ª–∞—Ç—å ${user.nick} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?`)) return;
          if (await updateUserRole(user.id, "admin")) {
            if (currentUser && currentUser.serverId === user.id) {
              currentUser.role = "admin";
              saveUser(currentUser);
              updateTopBar();
              updateAdminVisibility();
            }
            renderAdminUsers();
          }
        });

        const avatarInput = document.createElement("input");
        avatarInput.type = "file";
        avatarInput.accept = "image/*";
        avatarInput.className = "admin-avatar-input";
        avatarInput.addEventListener("change", () => {
          const file = avatarInput.files[0];
          if (!file) return;
          adminChangeAvatarForUser(user, file);
        });

        actions.appendChild(makeUserBtn);
        actions.appendChild(makeModBtn);
        actions.appendChild(makeAdminBtn);
        actions.appendChild(avatarInput);

        main.appendChild(header);
        main.appendChild(meta);
        main.appendChild(actions);

        card.appendChild(avatar);
        card.appendChild(main);

        adminUsersList.appendChild(card);
      });
    }

    // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    downloadBinderBtn.addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = "binder.zip";
      a.download = "binder.zip";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    personalFileBtn.addEventListener("click", () => {
      downloadBinderBtn.classList.remove("active-tab");
      adminPanelBtn.classList.remove("active-tab");
      personalFileBtn.classList.add("active-tab");
      setActiveSection("personal");
    });

    adminPanelBtn.addEventListener("click", () => {
      downloadBinderBtn.classList.remove("active-tab");
      personalFileBtn.classList.remove("active-tab");
      adminPanelBtn.classList.add("active-tab");
      setActiveSection("admin");
    });

    stepOpenBinder.addEventListener("click", () => {
      onboardingModal.classList.remove("active");
      setActiveSection("home");
      personalFileBtn.classList.remove("active-tab");
      adminPanelBtn.classList.remove("active-tab");
      downloadBinderBtn.classList.add("active-tab");
      downloadBinderBtn.scrollIntoView({ behavior: "smooth", block: "center" });
      downloadBinderBtn.focus();
    });

    onboardingClose.addEventListener("click", () => {
      onboardingModal.classList.remove("active");
      if (currentUser) {
        currentUser.justRegistered = false;
        saveUser(currentUser);
      }
    });

    onboardingCloseSoft.addEventListener("click", () => {
      onboardingModal.classList.remove("active");
    });

    rookieBtn.addEventListener("click", () => {
      rookieModal.classList.add("active");
    });
    rookieClose.addEventListener("click", () => {
      rookieModal.classList.remove("active");
    });

    sidebarLogout.addEventListener("click", () => {
      showAuthRoot();
      showAuthScreen("login");
      if (currentUser) {
        loginNick.value = currentUser.nick || "";
      }
      loginNick.focus();
    });

    function goToPanel(initialSection) {
      showPanelRoot();
      updateTopBar();
      updateAdminVisibility();
      updatePersonalFileNavButton();

      downloadBinderBtn.classList.remove("active-tab");
      personalFileBtn.classList.remove("active-tab");
      adminPanelBtn.classList.remove("active-tab");

      if (initialSection === "personal") {
        personalFileBtn.classList.add("active-tab");
        setActiveSection("personal");
      } else if (initialSection === "admin") {
        adminPanelBtn.classList.add("active-tab");
        setActiveSection("admin");
      } else {
        downloadBinderBtn.classList.add("active-tab");
        setActiveSection("home");
      }

      if (currentUser && currentUser.justRegistered) {
        onboardingModal.classList.add("active");
      } else {
        onboardingModal.classList.remove("active");
      }
    }

    (function init() {
      updatePersonalFileAuthBtn();
      const user = currentUser;
      const now = Date.now();

      if (!user) {
        showAuthRoot();
        showAuthScreen("register");
        regNick.focus();
        return;
      }

      if (user.lastLoginAt && now - user.lastLoginAt < DAY_MS) {
        showPanelRoot();
        goToPanel("home");
        return;
      }

      showAuthRoot();
      showAuthScreen("login");
      loginNick.value = user.nick || "";
      loginNick.focus();
    })();
  </script>
</body>
</html>
