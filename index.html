<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Police Platinum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ----- –ë–ê–ó–ê ----- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
    }

    body {
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-screen { display: none; }
    .auth-screen.active { display: block; }

    #auth-root {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app-card {
      background: #1e293b;
      padding: 20px;
      width: 360px;
      border-radius: 14px;
      box-shadow: 0 0 25px rgba(0,0,0,.45);
      position: relative;
    }

    .badge {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, #facc15, #e11d48);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-bottom: 12px;
    }

    h1 { font-size: 22px; margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: #9ca3af; margin-bottom: 14px; }

    .switch-link {
      margin-top: 10px;
      font-size: 13px;
      color: #93c5fd;
      cursor: pointer;
      text-align: right;
    }
    .switch-link:hover { text-decoration: underline; }

    /* ----- FORM ----- */
    .field {
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
    }

    .field label {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .field input,
    .field select {
      padding: 8px;
      background: #0f172a;
      border: 1px solid #475569;
      color: white;
      border-radius: 8px;
      font-size: 14px;
    }

    .btn {
      width: 100%;
      padding: 10px;
      background: #2563eb;
      border: none;
      border-radius: 8px;
      color: white;
      margin-top: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { background: #1d4ed8; }

    /* ----- –ü–ê–ù–ï–õ–¨ ----- */
    #panel-root {
      display: none;
      width: 100%;
      max-width: 1200px;
      padding: 14px;
      box-sizing: border-box;
    }

    .frame {
      display: grid;
      grid-template-columns: 220px 1fr;
      width: 100%;
      background: #1e293b;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0,0,0,.6);
      min-height: 460px;
    }

    .sidebar {
      background: #111827;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-right: 1px solid #334155;
    }

    .user-nick {
      font-size: 18px;
      font-weight: 600;
    }
    .user-role {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .nav-btn {
      padding: 10px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #e2e8f0;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .nav-btn:hover { background: #334155; }
    .nav-btn.active { background: #2563eb; border-color: #2563eb; }

    .logout {
      margin-top: auto;
      background: #ef4444;
    }
    .logout:hover { background: #dc2626; }

    /* ----- –°–ï–ö–¶–ò–ò ----- */
    #panel-content {
      padding: 20px;
    }

    .panel-section {
      display: none;
    }

    .panel-section h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    #section-home p {
      font-size: 14px;
    }

    /* ----- –õ–ò–ß–ù–´–ï –î–ï–õ–ê ----- */
    #section-personal .pf-item {
      padding: 10px;
      border: 1px solid #334155;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    #section-personal .pf-item:hover {
      background: #334155;
    }

    .pf-view {
      padding: 16px;
      background: #0f172a;
      border-radius: 10px;
      border: 1px solid #334155;
      margin-top: 12px;
      font-size: 14px;
    }

    .pf-view p { margin: 4px 0; }

    .pf-form .field { margin-bottom: 10px; }

    .pf-form label { font-size: 13px; }

    /* ----- –õ–ò–î–ï–†–´ ----- */
    .leader-card {
      padding: 12px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .leader-name {
      font-size: 16px;
      font-weight: 600;
    }
    .leader-role {
      font-size: 13px;
      color: #9ca3af;
    }
    .leader-notes {
      margin-top: 6px;
      font-size: 13px;
      white-space: pre-line;
    }
    .leader-btns {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .leader-btns .mini-btn {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #e5e7eb;
      cursor: pointer;
    }
    .leader-btns .mini-btn:hover { background: #1e293b; }

    /* ----- –ú–û–î–ê–õ–ö–ê ----- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal-backdrop.active { display: flex; }

    .modal {
      background: #1e293b;
      padding: 18px;
      width: 360px;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,0,0,.6);
      font-size: 14px;
    }

    .modal h3 { margin-bottom: 10px; }

    .modal input[type="text"] {
      margin-bottom: 8px;
      padding: 8px;
      width: 100%;
      background: #0f172a;
      border-radius: 8px;
      border: 1px solid #475569;
      color: white;
      font-size: 14px;
    }

    .modal-color {
      margin: 6px 0 10px 0;
      width: 100%;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #475569;
      cursor: pointer;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-btn {
      padding: 7px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #334155;
      color: white;
      font-size: 13px;
    }

    .modal-btn.primary { background: #2563eb; }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- ======= –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ======= -->
<div id="auth-root">
  <div class="app-card">
    <div class="badge">PD</div>

    <h1>Police Platinum</h1>
    <div class="subtitle">–°–∏—Å—Ç–µ–º–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ PD</div>

    <!-- –í—Ö–æ–¥ -->
    <div id="auth-login" class="auth-screen active">
      <form onsubmit="return false;">
        <div class="field">
          <label>–ù–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)</label>
          <input type="text" id="login-nick">
        </div>
        <div class="field">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="login-pass">
        </div>
        <button type="button" id="login-btn" class="btn">–í–æ–π—Ç–∏</button>
      </form>
      <div class="switch-link" id="link-to-register">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="auth-register" class="auth-screen">
      <form onsubmit="return false;">
        <div class="field">
          <label>–ù–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)</label>
          <input type="text" id="reg-nick">
        </div>
        <div class="field">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="reg-pass">
        </div>
        <div class="field">
          <label>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
          <select id="reg-dept">
            <option value="LSPD">LSPD</option>
            <option value="SFPD">SFPD</option>
            <option value="LVPD">LVPD</option>
          </select>
        </div>
        <button type="button" id="reg-btn" class="btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      </form>
      <div class="switch-link" id="link-to-login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</div>
    </div>
  </div>
</div>


<!-- ======= –û–°–ù–û–í–ù–ê–Ø –ü–ê–ù–ï–õ–¨ ======= -->
<div id="panel-root">
  <div class="frame">
    
    <!-- ===== –õ–ï–í–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø ===== -->
    <aside class="sidebar">
      <div id="user-nick" class="user-nick"></div>
      <div id="user-role" class="user-role"></div>

      <button class="nav-btn" id="btn-home" onclick="openTab('home')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
      <button class="nav-btn" id="btn-personal" onclick="openTab('personal')">üìÇ –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</button>
      <button class="nav-btn" id="btn-leadership" onclick="openTab('leadership')">üìò –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª–∏—Ü–∏–∏</button>

      <button id="logout" class="btn logout">–í—ã–π—Ç–∏</button>
    </aside>

    <!-- ===== –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ (–ö–û–ù–¢–ï–ù–¢ –°–ï–ö–¶–ò–ò) ===== -->
    <main id="panel-content">
      <section id="section-home" class="panel-section">
        <h2>–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ PD. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–≤–æ–µ –º–µ–Ω—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–∏—á–Ω—ã–º–∏ –¥–µ–ª–∞–º–∏ –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º.</p>
      </section>

      <section id="section-personal" class="panel-section"></section>

      <section id="section-leadership" class="panel-section"></section>
    </main>

  </div>
</div>


<!-- ===== –ú–û–î–ê–õ–ö–ê –î–õ–Ø –†–£–ö–û–í–û–î–°–¢–í–ê ===== -->
<div id="leader-edit-modal" class="modal-backdrop">
  <div class="modal">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π</h3>

    <input type="text" id="led-note1" placeholder="–ü–æ–¥–ø–∏—Å—å 1">
    <input type="text" id="led-note2" placeholder="–ü–æ–¥–ø–∏—Å—å 2">
    <input type="text" id="led-note3" placeholder="–ü–æ–¥–ø–∏—Å—å 3">

    <label>–¶–≤–µ—Ç –ø–æ–¥–ø–∏—Å–µ–π</label>
    <input type="color" id="led-color" class="modal-color">

    <div class="modal-footer">
      <button class="modal-btn" onclick="closeLeaderEdit()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-btn primary" onclick="saveLeaderNotes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  /* ===========================
     –ù–ê–°–¢–†–û–ô–ö–ê SUPABASE
  =========================== */
  const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let CURRENT_USER = null;
  let LEADERS_CACHE = [];
  let EDITING_LEADER = null;

  /* ===========================
     –£–¢–ò–õ–ò–¢–´
  =========================== */
  function normalizeNick(n) {
    if (!n) return null;
    n = n.trim().replace(/[^A-Za-z–ê-–Ø–∞-—è–Å—ë_]/g, "");
    if (!n.includes("_")) return null;
    const [a, b] = n.split("_");
    if (!a || !b) return null;
    const cap = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    return cap(a) + "_" + cap(b);
  }

  async function userExists(nick) {
    const { data } = await db.from("users").select("id").eq("nick", nick);
    return data && data.length > 0;
  }

  /* ===========================
     –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í
  =========================== */
  function switchToLogin() {
    document.getElementById("auth-register").classList.remove("active");
    document.getElementById("auth-login").classList.add("active");
  }
  function switchToRegister() {
    document.getElementById("auth-login").classList.remove("active");
    document.getElementById("auth-register").classList.add("active");
  }

  document.getElementById("link-to-register").onclick = switchToRegister;
  document.getElementById("link-to-login").onclick = switchToLogin;

  /* ===========================
     –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
  =========================== */
  document.getElementById("reg-btn").onclick = async () => {
    let nick = normalizeNick(document.getElementById("reg-nick").value);
    let pass = document.getElementById("reg-pass").value;
    let dept = document.getElementById("reg-dept").value;

    if (!nick) {
      alert("–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ò–º—è_–§–∞–º–∏–ª–∏—è");
      return;
    }
    if (pass.length < 4) {
      alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤");
      return;
    }

    if (await userExists(nick)) {
      alert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
      return;
    }

    const { error } = await db.from("users").insert({
      nick,
      password: pass,
      department: dept,
      role: "user",
      notes1: "",
      notes2: "",
      notes3: "",
      notes_color: "#ffffff"
    });

    if (error) {
      console.error(error);
      alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
      return;
    }

    alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
    switchToLogin();
  };

  document.getElementById("login-btn").onclick = async () => {
    let nick = normalizeNick(document.getElementById("login-nick").value);
    let pass = document.getElementById("login-pass").value;

    if (!nick || !pass) {
      alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");
      return;
    }

    const { data, error } = await db
      .from("users")
      .select("*")
      .eq("nick", nick)
      .single();

    if (error || !data || data.password !== pass) {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å");
      return;
    }

    CURRENT_USER = data;
    localStorage.setItem("pd_user", JSON.stringify(CURRENT_USER));
    openPanel();
  };

  document.getElementById("logout").onclick = () => {
    localStorage.removeItem("pd_user");
    CURRENT_USER = null;
    document.getElementById("panel-root").style.display = "none";
    document.getElementById("auth-root").style.display = "flex";
    switchToLogin();
  };

  /* ===========================
     –ü–ê–ù–ï–õ–¨
  =========================== */
  function openPanel() {
    document.getElementById("auth-root").style.display = "none";
    document.getElementById("panel-root").style.display = "block";

    document.getElementById("user-nick").textContent = CURRENT_USER.nick;
    document.getElementById("user-role").textContent =
      CURRENT_USER.role === "admin" ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" :
      CURRENT_USER.role === "moderator" ? "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä" :
      "–°–æ—Ç—Ä—É–¥–Ω–∏–∫";

    openTab("home");
  }

  function setActiveNav(tab) {
    ["home","personal","leadership"].forEach(t => {
      const btn = document.getElementById("btn-" + t);
      if (!btn) return;
      btn.classList.toggle("active", t === tab);
    });
  }

  function openTab(tab) {
    document.querySelectorAll(".panel-section").forEach(s => s.style.display = "none");
    setActiveNav(tab);

    if (tab === "home") {
      document.getElementById("section-home").style.display = "block";
    }
    if (tab === "personal") {
      loadPersonalFiles();
    }
    if (tab === "leadership") {
      loadLeadership();
    }
  }

  /* ===========================
     –õ–ò–ß–ù–´–ï –î–ï–õ–ê
  =========================== */
  async function loadPersonalFiles() {
    const sec = document.getElementById("section-personal");
    sec.innerHTML = "<h2>–õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</h2>";

    const { data, error } = await db.from("personal_files").select("*");
    if (error) {
      console.error(error);
      sec.innerHTML += "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –¥–µ–ª.</p>";
      sec.style.display = "block";
      return;
    }

    const list = data || [];
    const mine = list.find(pf => pf.nick === CURRENT_USER.nick);

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ—ë –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
    if (mine) {
      const mineDiv = document.createElement("div");
      mineDiv.className = "pf-view";
      mineDiv.innerHTML = `
        <h3>–í–∞—à–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ</h3>
        <p><b>–ù–∏–∫:</b> ${mine.nick}</p>
        <p><b>–û—Ç–¥–µ–ª:</b> ${mine.dept || "-"}</p>
        <p><b>–ê–∫–∫–∞—É–Ω—Ç:</b> ${mine.account || "-"}</p>
        <p><b>–ó–≤–∞–Ω–∏–µ:</b> ${mine.rank || "-"}</p>
        <button class="btn" style="background:#dc2626;margin-top:10px" onclick="deleteMyPersonalFile()">–£–¥–∞–ª–∏—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ</button>
      `;
      sec.appendChild(mineDiv);
    } else {
      // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞
      const form = document.createElement("div");
      form.className = "pf-form pf-view";
      form.innerHTML = `
        <h3>–°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ</h3>
        <div class="field">
          <label>–û—Ç–¥–µ–ª</label>
          <input id="pf-dept" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: PD">
        </div>
        <div class="field">
          <label>–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞</label>
          <input id="pf-account" placeholder="–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã">
        </div>
        <div class="field">
          <label>–ó–≤–∞–Ω–∏–µ</label>
          <input id="pf-rank" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ—Ä–∂–∞–Ω—Ç">
        </div>
        <div class="field">
          <label>–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
          <input id="pf-contact" placeholder="VK / Discord">
        </div>
        <div class="field">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input id="pf-birth" placeholder="01.01.2000">
        </div>
        <button class="btn" onclick="createPersonalFile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ</button>
      `;
      sec.appendChild(form);
    }

    // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–∏—á–Ω—ã—Ö –¥–µ–ª
    sec.innerHTML += "<h3 style='margin-top:16px;'>–°–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö –¥–µ–ª</h3>";

    list.forEach(pf => {
      const item = document.createElement("div");
      item.className = "pf-item";
      item.textContent = `[${pf.dept || "-"}] ${pf.nick} [${pf.account || "-"}]`;
      item.onclick = () => openPersonalFile(pf);
      sec.appendChild(item);
    });

    sec.style.display = "block";
  }

  async function createPersonalFile() {
    const dept = document.getElementById("pf-dept").value.trim();
    const account = document.getElementById("pf-account").value.trim();
    const rank = document.getElementById("pf-rank").value.trim();
    const contact = document.getElementById("pf-contact").value.trim();
    const birth = document.getElementById("pf-birth").value.trim();

    if (!dept || !account.match(/^[0-9]+$/)) {
      alert("–£–∫–∞–∂–∏—Ç–µ –æ—Ç–¥–µ–ª –∏ —á–∏—Å–ª–æ–≤–æ–π –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞");
      return;
    }

    const { error } = await db.from("personal_files").insert({
      nick: CURRENT_USER.nick,
      dept,
      account,
      rank,
      contact,
      birth
    });

    if (error) {
      console.error(error);
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞");
      return;
    }

    alert("–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–æ–∑–¥–∞–Ω–æ");
    loadPersonalFiles();
  }

  async function deleteMyPersonalFile() {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤–∞—à–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ?")) return;
    const { error } = await db.from("personal_files")
      .delete()
      .eq("nick", CURRENT_USER.nick);

    if (error) {
      console.error(error);
      alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      return;
    }

    alert("–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ —É–¥–∞–ª–µ–Ω–æ");
    loadPersonalFiles();
  }

  function openPersonalFile(pf) {
    const sec = document.getElementById("section-personal");
    sec.innerHTML = `
      <button class="btn" style="width:auto;margin-bottom:10px" onclick="openTab('personal')">‚¨Ö –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
      <div class="pf-view">
        <h3>${pf.nick}</h3>
        <p><b>–û—Ç–¥–µ–ª:</b> ${pf.dept || "-"}</p>
        <p><b>–ê–∫–∫–∞—É–Ω—Ç:</b> ${pf.account || "-"}</p>
        <p><b>–ó–≤–∞–Ω–∏–µ:</b> ${pf.rank || "-"}</p>
        <p><b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b> ${pf.contact || "-"}</p>
        <p><b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> ${pf.birth || "-"}</p>
      </div>
    `;

    if (CURRENT_USER.role === "admin" || CURRENT_USER.role === "moderator") {
      const btn = document.createElement("button");
      btn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ";
      btn.className = "btn";
      btn.style.marginTop = "10px";
      btn.onclick = () => editPersonalFile(pf.nick);
      sec.querySelector(".pf-view").appendChild(btn);
    }

    sec.style.display = "block";
  }

  async function editPersonalFile(nick) {
    const { data, error } = await db.from("personal_files").select("*").eq("nick", nick).single();
    if (error || !data) {
      alert("–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
      return;
    }

    const sec = document.getElementById("section-personal");
    sec.innerHTML = `
      <button class="btn" style="width:auto;margin-bottom:10px" onclick="openTab('personal')">‚¨Ö –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
      <div class="pf-view pf-form">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞: ${data.nick}</h3>
        <div class="field">
          <label>–û—Ç–¥–µ–ª</label>
          <input id="edit-pf-dept" value="${data.dept || ""}">
        </div>
        <div class="field">
          <label>–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞</label>
          <input id="edit-pf-account" value="${data.account || ""}">
        </div>
        <div class="field">
          <label>–ó–≤–∞–Ω–∏–µ</label>
          <input id="edit-pf-rank" value="${data.rank || ""}">
        </div>
        <div class="field">
          <label>–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
          <input id="edit-pf-contact" value="${data.contact || ""}">
        </div>
        <div class="field">
          <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input id="edit-pf-birth" value="${data.birth || ""}">
        </div>
        <button class="btn" onclick="savePersonalFileEdit('${data.nick}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    `;
  }

  async function savePersonalFileEdit(nick) {
    const dept = document.getElementById("edit-pf-dept").value.trim();
    const account = document.getElementById("edit-pf-account").value.trim();
    const rank = document.getElementById("edit-pf-rank").value.trim();
    const contact = document.getElementById("edit-pf-contact").value.trim();
    const birth = document.getElementById("edit-pf-birth").value.trim();

    if (!dept || !account.match(/^[0-9]+$/)) {
      alert("–£–∫–∞–∂–∏—Ç–µ –æ—Ç–¥–µ–ª –∏ —á–∏—Å–ª–æ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç");
      return;
    }

    const { error } = await db.from("personal_files")
      .update({ dept, account, rank, contact, birth })
      .eq("nick", nick);

    if (error) {
      console.error(error);
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      return;
    }

    alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    loadPersonalFiles();
  }

  /* ===========================
     –†–£–ö–û–í–û–î–°–¢–í–û –ü–û–õ–ò–¶–ò–ò
  =========================== */
  async function loadLeadership() {
    const sec = document.getElementById("section-leadership");
    sec.innerHTML = "<h2>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª–∏—Ü–∏–∏</h2>";

    const { data, error } = await db.from("users").select("*");
    if (error) {
      console.error(error);
      sec.innerHTML += "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞.</p>";
      sec.style.display = "block";
      return;
    }

    LEADERS_CACHE = (data || []).filter(u =>
      u.role === "admin" || u.role === "moderator"
    );

    renderLeadership();
    sec.style.display = "block";
  }

  function renderLeadership() {
    const sec = document.getElementById("section-leadership");
    sec.innerHTML = "<h2>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª–∏—Ü–∏–∏</h2>";

    if (!LEADERS_CACHE.length) {
      sec.innerHTML += "<p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—å—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.</p>";
      return;
    }

    LEADERS_CACHE.forEach((l, index) => {
      const card = document.createElement("div");
      card.className = "leader-card";

      const title = document.createElement("div");
      title.className = "leader-name";
      title.textContent = l.nick;

      const role = document.createElement("div");
      role.className = "leader-role";
      role.textContent = l.role === "admin" ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";

      const notes = document.createElement("div");
      notes.className = "leader-notes";
      notes.style.color = l.notes_color || "#ffffff";
      notes.textContent = [l.notes1, l.notes2, l.notes3].filter(Boolean).join("\n");

      card.appendChild(title);
      card.appendChild(role);
      card.appendChild(notes);

      // –ö–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏ –Ω–µ –Ω–∞ —Å–µ–±–µ —Å–∞–º–æ–º)
      if (CURRENT_USER && CURRENT_USER.role === "admin" && CURRENT_USER.nick !== l.nick) {
        const btnRow = document.createElement("div");
        btnRow.className = "leader-btns";

        const upBtn = document.createElement("button");
        upBtn.className = "mini-btn";
        upBtn.textContent = "‚Üë";
        upBtn.onclick = () => moveLeader(index, -1);

        const downBtn = document.createElement("button");
        downBtn.className = "mini-btn";
        downBtn.textContent = "‚Üì";
        downBtn.onclick = () => moveLeader(index, 1);

        const editBtn = document.createElement("button");
        editBtn.className = "mini-btn";
        editBtn.textContent = "‚úè –ü–æ–¥–ø–∏—Å–∏";
        editBtn.onclick = () => openLeaderEdit(l);

        btnRow.appendChild(upBtn);
        btnRow.appendChild(downBtn);
        btnRow.appendChild(editBtn);

        card.appendChild(btnRow);
      }

      sec.appendChild(card);
    });
  }

  function moveLeader(index, dir) {
    const newIndex = index + dir;
    if (newIndex < 0 || newIndex >= LEADERS_CACHE.length) return;
    const temp = LEADERS_CACHE[index];
    LEADERS_CACHE[index] = LEADERS_CACHE[newIndex];
    LEADERS_CACHE[newIndex] = temp;
    renderLeadership(); // –ø–æ—Ä—è–¥–æ–∫ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î, –Ω–æ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
  }

  function openLeaderEdit(l) {
    EDITING_LEADER = l;
    document.getElementById("led-note1").value = l.notes1 || "";
    document.getElementById("led-note2").value = l.notes2 || "";
    document.getElementById("led-note3").value = l.notes3 || "";
    document.getElementById("led-color").value = l.notes_color || "#ffffff";
    document.getElementById("leader-edit-modal").classList.add("active");
  }

  function closeLeaderEdit() {
    EDITING_LEADER = null;
    document.getElementById("leader-edit-modal").classList.remove("active");
  }

  async function saveLeaderNotes() {
    if (!EDITING_LEADER) return;

    const n1 = document.getElementById("led-note1").value.trim();
    const n2 = document.getElementById("led-note2").value.trim();
    const n3 = document.getElementById("led-note3").value.trim();
    const col = document.getElementById("led-color").value;

    const { error } = await db.from("users")
      .update({
        notes1: n1,
        notes2: n2,
        notes3: n3,
        notes_color: col
      })
      .eq("nick", EDITING_LEADER.nick);

    if (error) {
      console.error(error);
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–µ–π");
      return;
    }

    closeLeaderEdit();
    loadLeadership();
  }

  /* ===========================
     –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  =========================== */
  document.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("pd_user");
    if (saved) {
      try {
        CURRENT_USER = JSON.parse(saved);
        openPanel();
        return;
      } catch {}
    }
    // –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById("auth-root").style.display = "flex";
    document.getElementById("panel-root").style.display = "none";
    switchToLogin();
  });
</script>
</body>
</html>
