<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Police Platinum ‚Äî –ü–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #0b1220;
      --bg-light: #111827;
      --bg-lighter: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #374151;
      --accent: #2563eb;
      --accent-hover: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
      --input-bg: #020617;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    .admin-navbar {
      justify-content: flex-start;
    }

    .exam-history-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    
    .exam-history-card {
      background: var(--bg);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .exam-history-nick {
      font-weight: 600;
      font-size: 14px;
    }
    
    .exam-history-meta {
      font-size: 12px;
      color: var(--muted);
    }
    
    .exam-history-status {
      font-size: 12px;
    }
    
    .exam-history-status.passed {
      color: var(--success);
    }
    
    .exam-history-status.failed {
      color: var(--danger);
    }
    
    .exam-history-comment {
      font-size: 12px;
    }
    
    .exam-history-images {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    
    .exam-history-images img {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      cursor: zoom-in;
    }
    
    @media (max-width: 900px) {
      .exam-history-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 600px) {
      .exam-history-grid {
        grid-template-columns: 1fr;
      }
    }

    
    .exam-question-text {
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .exam-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }
    
    .exam-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .exam-image {
      max-width: 100%;
      max-height: 220px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 8px;
      cursor: zoom-in;
    }
    
    .exam-image-large {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    
    .exam-image-large img {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 12px;
    }

    
    /* --- Read-only –∫–∞—Ä—Ç–æ—á–∫–∞ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞ --- */

    #personal-view {
      margin-top: 6px;
      margin-bottom: 4px;
    }
    
    .pf-view-row {
      display: flex;
      gap: 8px;
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .pf-view-label {
      width: 180px;
      flex-shrink: 0;
      color: var(--muted);
    }
    
    .pf-view-value {
      flex: 1;
      color: var(--text);
    }
    
    /* --- –û—Ç–≤–µ—Ç—ã –ø–æ –ª–∏—á–Ω–æ–º—É –¥–µ–ª—É (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å) --- */

    .pf-separator {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0 10px;
    }
    
    .pf-replies-title {
      font-size: 15px;
      margin-bottom: 6px;
    }
    
    .pf-replies-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }
    
    .pf-reply-card {
      padding: 8px 10px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #4b5563;          /* –æ–±—ã—á–Ω—ã–π —Å–ø–æ–∫–æ–π–Ω—ã–π –±–æ—Ä–¥–µ—Ä */
      font-size: 13px;
    }
    
    /* –†–∞–º–∫–∞ —Ç–æ–ª—å–∫–æ —É –∞–¥–º–∏–Ω–æ–≤ */
    .pf-reply-card.admin-reply {
      border-color: #fbbf24;
      box-shadow: 0 0 0 1px rgba(251,191,36,0.6);
    }
    
    .pf-reply-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 4px;
      color: var(--muted);
    }
    
    .pf-reply-author {
      font-weight: 500;
      color: var(--text);
    }
    
    .pf-reply-text {
      font-size: 13px;
      white-space: pre-wrap;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª–∏—Ç—å) */
    .pf-reply-actions {
      display: flex;
      gap: 6px;
      margin-left: 8px;
    }
    
    .pf-reply-action-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }
    .pf-reply-action-btn:hover {
      color: var(--accent-hover);
      text-decoration: underline;
    }
    
    /* –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ —Å—Ç–∏–ª–µ —Ñ–æ—Ä–º—ã —Ñ–æ—Ä—É–º–∞ */
    #pf-replies-form-wrapper {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
    }
    
    .pf-reply-textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: var(--text);
      padding: 7px 9px;
      font-size: 13px;
      resize: vertical;
    }


    body {
      background: #0f172a;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    #app {
      width: 100%;
      max-width: 1280px;
    }

    a {
      color: var(--accent-hover);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

        /* === –†–æ—Ç–∞—Ç–æ—Ä —Ñ–æ–Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ === */
    #bg-rotator {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #0f172a; /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
      overflow: hidden;
    }

    #bg-rotator img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
    }

    #bg-rotator img.active {
      opacity: 1;
    }


    /* ---------- –ö–Ω–æ–ø–∫–∏ ---------- */

    .btn {
      padding: 8px 16px;
      background: var(--accent);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.7);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-outline {
      padding: 8px 16px;
      background: var(--bg-lighter);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.6);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn-outline:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* ---------- –ò–Ω–ø—É—Ç—ã ---------- */

    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
    }
    .field textarea {
      resize: vertical;
      min-height: 70px;
    }
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
    }
    .error {
      font-size: 11px;
      color: var(--danger);
      margin-top: 3px;
    }

    /* ---------- –ö–∞—Ä—Ç–æ—á–∫–∏ / —Å–µ–∫—Ü–∏–∏ ---------- */

    .card,
    .section,
    .files-list,
    .files-detail,
    .admin-users-list {
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    /* ---------- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---------- */

    #auth-root {
      max-width: 480px;
      margin: 0 auto;
    }

    .card {
      padding: 18px 18px 20px;
      margin-bottom: 16px;
    }

    .card h1 {
      font-size: 22px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .card .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .auth-switch {
      margin-top: 10px;
      font-size: 13px;
      text-align: right;
      color: var(--muted);
      cursor: pointer;
    }
    .auth-switch span {
      color: var(--accent-hover);
    }

    .auth-screen {
      display: none;
    }
    .auth-screen.active {
      display: block;
    }

    /* ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ ---------- */

    #panel-root {
      display: none;
    }

    .navbar {
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .nav-btn {
      padding: 7px 14px;
      background: var(--bg-lighter);
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .nav-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .nav-btn.active {
      background: var(--accent);
    }

    .nav-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* ===== –ú–∞–∫–µ—Ç –ø–∞–Ω–µ–ª–∏: —Å–ª–µ–≤–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è, —Å–ø—Ä–∞–≤–∞ –∫–æ–Ω—Ç–µ–Ω—Ç ===== */

    #panel-layout {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    /* –õ–µ–≤–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å */
    
    .side-nav-panel {
      width: 230px;
      flex-shrink: 0;
      padding: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .side-nav-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .side-nav-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      text-align: left;
    }
    
    .side-nav-btn:hover {
      background: var(--accent-hover);
      transform: translateX(2px);
      box-shadow: 0 6px 14px rgba(15,23,42,0.9);
    }
    
    .side-nav-icon {
      width: 22px;
      display: flex;
      justify-content: center;
      font-size: 15px;
    }
    
    /* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å */
    .panel-main {
      flex: 1;
      min-width: 0;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤: –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —É—Ö–æ–¥–∏—Ç –≤–≤–µ—Ä—Ö –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    @media (max-width: 900px) {
      #panel-layout {
        flex-direction: column;
      }
    
      .side-nav-panel {
        width: 100%;
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
        align-items: center;
      }
    
      .side-nav-title {
        margin-bottom: 0;
        margin-right: 8px;
        white-space: nowrap;
      }
    
      .side-nav-btn {
        white-space: nowrap;
        flex: 0 0 auto;
      }
    }


    .top-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .top-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .top-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .top-name {
      font-size: 13px;
      color: var(--text);
    }

    .top-role {
      font-size: 11px;
      color: var(--muted);
    }

    .back-home-btn {
      padding: 5px 12px;
      font-size: 12px;
      background: var(--bg-lighter);
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .back-home-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    /* ---------- –°–µ–∫—Ü–∏–∏ –ø–∞–Ω–µ–ª–∏ ---------- */

    .section {
      padding: 16px;
      min-height: 420px;
    }
    .section.active {
      display: block;
    }
    .section:not(.active) {
      display: none;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .section p {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .section small {
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------- –ì–ª–∞–≤–Ω–∞—è ---------- */

    .home-actions {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    
    .home-primary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    
    .home-secondary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }



    /* ---------- –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞ ---------- */

    .files-layout {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 16px;
      margin-top: 10px;
    }

    .files-list {
      padding: 10px;
      max-height: 430px;
      overflow-y: auto;
      background: var(--bg);
    }

    .file-item {
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 6px;
    }
    .file-item:hover {
      background: var(--bg-lighter);
    }
    .file-item.me {
      border-color: var(--accent);
      background: rgba(37,99,235,0.15);
    }
    .file-item.active {
      background: var(--accent);
      border-color: var(--accent-hover);
    }

    .file-title {
      font-weight: 500;
    }
    .file-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .files-detail {
      padding: 12px;
      background: var(--bg);
    }

    .files-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .badge-readonly,
    .badge-editable {
      font-size: 11px;
    }
    .badge-readonly {
      color: var(--muted);
    }
    .badge-editable {
      color: var(--success);
    }

    .personal-note {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ---------- */

    .admin-users-list {
      margin-top: 10px;
      padding: 10px;
      max-height: 460px;
      overflow-y: auto;
      background: var(--bg);
    }

    .admin-user-card {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px;
      margin-bottom: 8px;
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: 8px;
      align-items: center;
    }

    .admin-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
    }
    .admin-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admin-user-main {
      font-size: 13px;
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .admin-user-nick {
      font-weight: 500;
    }

    .admin-role-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .admin-role-badge.admin {
      border-color: var(--accent);
      color: var(--accent-hover);
    }
    .admin-role-badge.moderator {
      border-color: #4f46e5;
      color: #a5b4fc;
    }

    .admin-user-meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .admin-user-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }

    .admin-select {
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .admin-color {
      width: 60px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      padding: 0;
    }

    .admin-avatar-input {
      font-size: 11px;
      color: var(--muted);
    }

    .order-input {
      width: 50px;
      padding: 3px 4px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
    }

    /* ---------- –û—Ñ–∏—Ü–µ—Ä—ã ---------- */

    .officer-minister {
      text-align: center;
      margin-bottom: 12px;
    }
    .officer-minister-card {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--bg-lighter);
      font-size: 13px;
    }
    .officer-minister-card .name {
      font-weight: 500;
    }
    .officer-minister-card .label {
      font-size: 12px;
      color: var(--muted);
    }

    .officer-leader-wrapper {
      text-align: center;
      margin-bottom: 6px;
    }
    
    .officer-leader-card {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #facc15;
      background: var(--bg-lighter);
      font-size: 12px;
    }
    
    .officer-leader-card .name {
      font-weight: 500;
    }
    
    .officer-leader-card .label {
      font-size: 11px;
      color: var(--muted);
    }

    .officers-columns {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .officer-column-title {
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .officer-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 13px;
    }
    .officer-card-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .officer-card-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .officer-card-main {
      flex: 1;
    }
    .officer-card-main .nick {
      font-weight: 500;
    }
    .officer-card-main .info {
      font-size: 12px;
      color: var(--muted);
    }
    .officer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .officer-links button {
      padding: 3px 7px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-lighter);
      color: var(--text);
      cursor: pointer;
    }
    .officer-links button:hover {
      background: var(--accent-hover);
    }

    /* ---------- –ú–æ–¥–∞–ª–∫–∏ ---------- */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 16px;
    }
    .modal h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .modal p {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .search-input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .search-result-item {
      padding: 5px 6px;
      border-radius: 6px;
      border: 1px solid transparent;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .search-result-item:hover {
      background: var(--bg-lighter);
    }

    /* ---------- –ê–¥–∞–ø—Ç–∏–≤ ---------- */

    @media (max-width: 900px) {
      .files-layout {
        grid-template-columns: 1fr;
      }
      .officers-columns {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 8px;
      }
      .navbar {
        flex-wrap: wrap;
      }
      .nav-right {
        margin-left: 0;
        margin-top: 6px;
      }
    }
    /* --- –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å: –≤–∞–∂–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ --- */
    
    .btn-critical {
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: #b91c1c;
      color: #f9fafb;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.6), 0 10px 18px rgba(127,29,29,0.9);
      animation: critical-blink 1.2s infinite alternate;
      transition: transform 0.1s ease, box-shadow 0.12s ease, filter 0.1s ease;
    }
    
    .btn-critical:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 0 0 1px rgba(248,113,113,0.9), 0 14px 24px rgba(127,29,29,1);
    }
    
    @keyframes critical-blink {
      0% {
        box-shadow: 0 0 0 1px rgba(248,113,113,0.5), 0 8px 14px rgba(127,29,29,0.7);
        background: #b91c1c;
      }
      100% {
        box-shadow: 0 0 0 2px rgba(248,113,113,0.9), 0 14px 24px rgba(127,29,29,1);
        background: #dc2626;
      }
    }
    
    .btn-glow {
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: #e5e7eb;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.6), 0 8px 16px rgba(15,23,42,0.9);
      animation: soft-glow 2.4s infinite ease-in-out;
      transition: transform 0.1s ease, box-shadow 0.12s ease, filter 0.1s ease;
    }
    
    .btn-glow:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 0 0 1px rgba(96,165,250,0.9), 0 14px 24px rgba(15,23,42,1);
    }
    
    @keyframes soft-glow {
      0%, 100% {
        box-shadow: 0 0 0 1px rgba(59,130,246,0.5), 0 8px 16px rgba(15,23,42,0.8);
      }
      50% {
        box-shadow: 0 0 0 2px rgba(96,165,250,0.9), 0 14px 24px rgba(15,23,42,1);
      }
    }

    /* –ë–æ–ª—å—à–∏–µ –∫—Ä—É–≥–ª—ã–µ –∫–Ω–æ–ø–∫–∏ —Å "–∞–Ω—Ç–∏–≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–µ–π" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */

    .btn-circle {
      padding: 16px 26px;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      box-shadow: 0 10px 18px rgba(15,23,42,0.9);
      border: none;
      cursor: pointer;
      transition: filter 0.15s, box-shadow 0.15s;
    }
    
    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
    .btn-circle.btn-critical {
      /* –±–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –±–µ—Ä—ë–º –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π, –Ω–æ –º–æ–∂–Ω–æ —á—É—Ç—å –¥–æ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å */
      background: #b91c1c;
      color: #f9fafb;
    }
    
    .btn-circle.btn-join {
      background: #1d4ed8;
      color: #e5e7eb;
    }
    
    .btn-circle.btn-download {
      background: #065f46;
      color: #e5e7eb;
    }
    
    /* "–ü–ª–∞–≤–∞—é—â–∞—è" –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    @keyframes floaty-btn {
      0% {
        transform: translate(0, 0) scale(1);
      }
      25% {
        transform: translate(3px, -4px) scale(1.03);
      }
      50% {
        transform: translate(-3px, -2px) scale(1.04);
      }
      75% {
        transform: translate(2px, -5px) scale(1.03);
      }
      100% {
        transform: translate(-2px, -7px) scale(1.05);
      }
    }
    
    .btn-circle:hover {
      animation: floaty-btn 1.6s ease-in-out infinite alternate;
      filter: brightness(1.08);
      box-shadow: 0 14px 26px rgba(15,23,42,1);
    }

    
    /* --- –ö—Ä—É–≥–ª—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: –ú–∏–Ω–∏—Å—Ç—Ä + –ì–µ–Ω–µ—Ä–∞–ª—ã + –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ --- */
    
    .circle-leader-wrapper {
      text-align: center;
      margin-bottom: 12px;
    }
    
    .circle-leader-card {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .circle-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #facc15;
      background: var(--bg-lighter);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .circle-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .circle-label {
      font-size: 12px;
      text-align: center;
    }
    
    .circle-label .name {
      display: block;
      font-weight: 600;
    }
    
    .circle-label .role {
      display: block;
      font-size: 11px;
      color: var(--muted);
    }
    
    /* –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã */
    .circle-avatar-minister {
      border-color: #38bdf8;
    }
    
    .circle-avatar-general {
      border-color: #facc15;
    }
    
    /* –¥–ª—è –±–ª–æ–∫–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ (–æ—Ñ–∏—Ü–µ—Ä—Å–∫–∏–π —Ä–µ–∂–∏–º) */
    .leadership-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .leadership-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
    }
  </style>
</head>
<body>
<div id="bg-rotator"></div>
<div id="app">

  <!-- ===================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===================== -->
  <div id="auth-root">
    <div class="card">
      <section id="register-screen" class="auth-screen active">
        <h1>Police Platinum</h1>
        <p class="subtitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ñ–∏—Ü–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏.</p>

        <form id="register-form" novalidate>
          <div class="field">
            <label for="reg-nick">–ù–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)</label>
            <input id="reg-nick" type="text" placeholder="Marsello_Nelson" autocomplete="off" />
            <div class="hint">–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã + –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ. –ü—Ä–∏–º–µ—Ä: John_Smith</div>
            <div class="error" id="reg-nick-error"></div>
          </div>

          <div class="field">
            <label for="reg-password">–ü–∞—Ä–æ–ª—å</label>
            <input id="reg-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" />
            <div class="error" id="reg-password-error"></div>
          </div>

          <div class="field">
            <label for="reg-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç (–∏–≥—Ä–æ–≤–æ–π)</label>
            <select id="reg-dept">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç‚Ä¶</option>
              <option value="LSPD">LSPD ‚Äî Los Santos PD</option>
              <option value="SFPD">SFPD ‚Äî San Fierro PD</option>
              <option value="LVPD">LVPD ‚Äî Las Venturas PD</option>
            </select>
            <div class="error" id="reg-dept-error"></div>
          </div>

          <div class="field">
            <label for="reg-avatar">–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
            <input id="reg-avatar" type="file" accept="image/*" />
            <div class="hint">–ê–≤–∞—Ç–∞—Ä –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø—Ä—è–º–æ –≤ –±–∞–∑–µ (base64), –±–µ–∑ Supabase Storage.</div>
            <div class="error" id="reg-avatar-error"></div>
          </div>

          <button class="btn" type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>

          <div class="hint" style="margin-top:8px;">
            –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase (—Ç–∞–±–ª–∏—Ü—ã users + personal_files) –∏ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—Å–µ—Å—Å–∏—è).
          </div>
        </form>

        <div class="auth-switch" id="to-login">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span>–í–æ–π—Ç–∏</span>
        </div>
      </section>

      <section id="login-screen" class="auth-screen">
        <h1>Police Platinum</h1>
        <p class="subtitle">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞.</p>

        <form id="login-form" novalidate>
          <div class="field">
            <label for="login-nick">–ù–∏–∫</label>
            <input id="login-nick" type="text" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" autocomplete="off" />
            <div class="error" id="login-nick-error"></div>
          </div>

          <div class="field">
            <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
            <input id="login-password" type="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
            <div class="error" id="login-password-error"></div>
          </div>

          <button class="btn" type="submit">–í–æ–π—Ç–∏</button>
        </form>

        <div class="auth-switch" id="to-register">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
        </div>
      </section>
    </div>
  </div>

  <!-- ===================== –ü–ê–ù–ï–õ–¨ ===================== -->
  <div id="panel-root" style="display:none;">

    <div class="navbar admin-navbar" id="admin-navbar" style="display:none; margin-top:8px;">
      <button class="nav-btn" id="nav-admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
    </div>
  <!-- –û–ë–Å–†–¢–ö–ê: —Å–ª–µ–≤–∞ –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å, —Å–ø—Ä–∞–≤–∞ ‚Äì –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ -->
    <div id="panel-layout">
      <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
      <aside class="side-nav-panel">
        <h3 class="side-nav-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è PD</h3>
  
        <button class="side-nav-btn" id="side-exams">
          <span class="side-nav-icon">üìò</span>
          <span>–ò—Å—Ç–æ—Ä–∏—è —Å–¥–∞—á–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤</span>
        </button>
  
        <button class="side-nav-btn" id="side-forum">
          <span class="side-nav-icon">üí¨</span>
          <span>–†–∞–∑–¥–µ–ª PD –Ω–∞ —Ñ–æ—Ä—É–º–µ</span>
        </button>
  
        <button class="side-nav-btn" id="side-binders">
          <span class="side-nav-icon">üìÇ</span>
          <span>–í—Å–µ –±–∏–Ω–¥–µ—Ä—ã</span>
        </button>
  
        <button class="side-nav-btn" id="side-handbook">
          <span class="side-nav-icon">üìñ</span>
          <span>–ë–æ–ª—å—à–æ–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</span>
        </button>
  
        <button class="side-nav-btn" id="side-blacklist">
          <span class="side-nav-icon">‚õî</span>
          <span>–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ PD</span>
        </button>
  
        <button class="side-nav-btn" id="side-news">
          <span class="side-nav-icon">üì∞</span>
          <span>–ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
        </button>
  
        <button class="side-nav-btn" id="side-swat">
          <span class="side-nav-icon">üõ°Ô∏è</span>
          <span>SWAT</span>
        </button>
  
        <button class="side-nav-btn" id="side-thefts">
          <span class="side-nav-icon">üöî</span>
          <span>–£–≥–æ–Ω—ã</span>
        </button>
      </aside>
  
      <!-- –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨: –≤–µ—Ä—Ö–Ω–∏–π –Ω–∞–≤–±–∞—Ä + —Å–µ–∫—Ü–∏–∏ -->
      <div class="panel-main">
        <!-- –ù–∞–≤–±–∞—Ä -->
        <div class="navbar">
          <button class="nav-btn active" id="nav-home">–ì–ª–∞–≤–Ω–∞—è</button>
          <button class="nav-btn" id="nav-files">–õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</button>
          <button class="nav-btn" id="nav-leadership">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ PD</button>
          <button class="nav-btn" id="nav-officers">–û—Ñ–∏—Ü–µ—Ä—ã</button>
        
          <div class="nav-right">
            <button class="back-home-btn" id="back-home-btn" style="display:none;">‚üµ –ù–∞ –≥–ª–∞–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</button>
          
            <div class="top-user" id="top-user">
              <div class="top-avatar" id="top-avatar">PP</div>
              <div>
                <div class="top-name" id="top-nick">–û—Ñ–∏—Ü–µ—Ä</div>
                <div class="top-role" id="top-role">–†–æ–ª—å</div>
              </div>
            </div>
          
            <!-- –î–ª—è –≥–æ—Å—Ç—è -->
            <button class="btn-outline btn-sm" id="login-open-btn" style="display:none;">–í–æ–π—Ç–∏</button>
            <button class="btn btn-sm" id="register-open-btn" style="display:none;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          
            <!-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ -->
            <button class="btn-outline btn-sm" id="logout-btn" style="display:none;">–í—ã–π—Ç–∏</button>
          </div>
        </div>
    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="section-home" class="section active">
      <h2>–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
      <p>
        –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∏–Ω–¥–∞—Ä–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º –¥–µ–ª–æ–º –æ—Ñ–∏—Ü–µ—Ä–∞.
      </p>
      <small>
        –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ—å –±–∏–Ω–¥–µ—Ä –∏ –æ—Ñ–æ—Ä–º–∏ —Å–≤–æ—ë –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ. –ï—Å–ª–∏ —Ç—ã –Ω–æ–≤–æ–±—Ä–∞–Ω–µ—Ü ‚Äî –ø—Ä–æ—á–∏—Ç–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö.
      </small>

      <div class="home-actions">
        <!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥: —Ç—Ä–∏ –±–æ–ª—å—à–∏–µ –∫—Ä—É–≥–ª—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <div class="home-primary-row">
          <button id="btn-rookie-test" class="btn-circle btn-critical">
            –°–¥–∞—Ç—å –∑–∞—á—ë—Ç —Ä—è–¥–æ–≤–æ–≥–æ
          </button>
      
          <button id="btn-join-pd" class="btn-circle btn-join">
            –í—Å—Ç—É–ø–∏—Ç—å –≤ PD
          </button>
      
          <button id="download-binder-btn" class="btn-circle btn-download">
            –°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä
          </button>
        </div>
      
        <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <div class="home-secondary-row">
          <button id="open-rookie-modal" class="btn-glow">
            –ù–∞—á–∞—Ç—å –æ–±—É—á–∞—Ç—å—Å—è –∏–≥—Ä–µ –∑–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ
          </button>
          <button id="open-files-from-home" class="btn-outline">
            –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞
          </button>
          <button id="btn-captain-exam" class="btn-outline">
            –°–¥–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω –ö–∞–ø–∏—Ç–∞–Ω–∞
          </button>
        </div>
      </div>

    </section>
    <section id="section-exams" class="section">
      <h2>–ò—Å—Ç–æ—Ä–∏—è —ç–∫–∑–∞–º–µ–Ω–æ–≤ –∏ —Ä–µ–∑—é–º–µ</h2>
      <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–≤–æ–∏ –ø–æ–ø—ã—Ç–∫–∏ —Å–¥–∞—á–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤ –∏ –ø–æ–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —Ä–µ–∑—é–º–µ.</p>
    
      <div style="margin-top:10px; margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn-outline btn-sm exam-history-tab" data-type="rookie">–ó–∞—á—ë—Ç —Ä—è–¥–æ–≤–æ–≥–æ</button>
        <button class="btn-outline btn-sm exam-history-tab" data-type="captain">–≠–∫–∑–∞–º–µ–Ω –∫–∞–ø–∏—Ç–∞–Ω–∞</button>
        <button class="btn-outline btn-sm exam-history-tab" data-type="resume">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ</button>
      </div>
    
      <div id="exam-history-list" class="exam-history-grid">
        –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.
      </div>
    </section>
    <section id="section-leadership" class="section">
      <h2>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ PD</h2>
      <p>
        –í –¥–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –ª–∏—á–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–∏—Å–ª—è—Ç—Å—è –≤—ã—à–µ—Å—Ç–æ—è—â–∏–º–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.
      </p>
    
      <div id="leadership-container" class="admin-users-list">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞...
      </div>
    </section>

    <!-- –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞ -->
    <section id="section-files" class="section">
        <div class="files-layout">
        <!-- –°–ø–∏—Å–æ–∫ -->
        <div class="files-list" id="personal-files-list">
          –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª...
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ -->
        <div class="files-detail">
          <div class="files-detail-header">
            <div>
              <strong id="pf-detail-title">–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ</strong>
              <div id="pf-detail-sub" style="font-size:12px; color:var(--muted);"></div>
            </div>

            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
              <div id="pf-edit-badge" class="badge-readonly">
                –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä
              </div>
              <button id="pf-edit-toggle-btn" class="btn btn-sm" style="display:none;">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
              </button>
              <button id="create-personal-btn" class="btn btn-sm" style="margin-top:4px; display:none;">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
              </button>
            </div>
          </div>

          <!-- READ-ONLY –ü–†–û–°–ú–û–¢–† -->
          <div id="personal-view"></div>

          <!-- –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (—Ñ–æ—Ä–º–∞), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ -->
          <form id="personal-form" novalidate style="display:none; margin-top:10px;">
            <div class="field">
              <label for="pf-dept">–û—Ç–¥–µ–ª (—Ñ–æ—Ä—É–º–Ω—ã–π)</label>
              <input id="pf-dept" type="text" placeholder="LSPD / SFPD / LVPD" />
            </div>

            <div class="field">
              <label for="pf-nick">–ò–º—è_–§–∞–º–∏–ª–∏—è (–∫–∞–∫ –≤ –∏–≥—Ä–µ)</label>
              <input id="pf-nick" type="text" placeholder="Marsello_Nelson" />
            </div>

            <div class="field">
              <label for="pf-account">–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞</label>
              <input id="pf-account" type="text" placeholder="123456" />
            </div>

            <div class="field">
              <label for="pf-birth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
              <input id="pf-birth" type="text" placeholder="01.01.2000" />
            </div>

            <div class="field">
              <label for="pf-badge-link">–ù–æ–º–µ—Ä –∑–Ω–∞—á–∫–∞ / –∞–∫–∫–∞—É–Ω—Ç–∞</label>
              <input id="pf-badge-link" type="text" placeholder="–ù–æ–º–µ—Ä –∑–Ω–∞—á–∫–∞" />
            </div>

            <div class="field">
              <label for="pf-rank">–¢–µ–∫—É—â–µ–µ –∑–≤–∞–Ω–∏–µ</label>
              <input id="pf-rank" type="text" placeholder="–ì–µ–Ω–µ—Ä–∞–ª / –ö–∞–ø–∏—Ç–∞–Ω / ..." />
            </div>

            <div class="field">
              <label for="pf-phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
              <input id="pf-phone" type="text" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
            </div>

            <div class="field">
              <label for="pf-contact">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</label>
              <input id="pf-contact" type="text" placeholder="Telegram / VK / Discord" />
            </div>

            <div class="hint" id="personal-save-note" style="margin-bottom:6px;"></div>

            <button id="save-personal-btn" class="btn btn-sm" type="submit">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
            </button>
          </form>

          <div class="personal-note" id="pf-readonly-note" style="display:none;">
            –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —á—É–∂–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
          </div>

          <hr class="pf-separator" />

          <!-- –ë–õ–û–ö –û–¢–í–ï–¢–û–í -->
          <div id="pf-replies-section">
            <h3 class="pf-replies-title">–û—Ç–≤–µ—Ç—ã –ø–æ –ª–∏—á–Ω–æ–º—É –¥–µ–ª—É</h3>
            <div id="pf-replies-list">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞.</div>

            <div id="pf-replies-form-wrapper" style="margin-top:10px; display:none;">
              <textarea id="pf-reply-text" class="pf-reply-textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
              <button id="pf-reply-send" class="btn btn-sm" style="margin-top:6px;">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- –ê–¥–º–∏–Ω / –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ -->
    <section id="section-admin" class="section">
      <h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
      <p>
        –†–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º. –û—Ñ–∏—Ü–µ—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        –∏ –∞–¥–º–∏–Ω–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
      </p>

      <div style="margin-top:10px; margin-bottom:8px;">
        <button id="admin-add-user-btn" class="btn btn-sm" style="display:none;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å / –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>
      </div>

      <div id="admin-users-list" class="admin-users-list">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
      </div>
      <!-- –ü–∞–Ω–µ–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–ª—è —Ä–æ–ª–∏ creator -->
      <div id="creator-theme-panel" style="margin-top:16px; display:none;">
        <h3 style="font-size:16px; margin-bottom:6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
        <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">
          –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –±–ª–æ–∫–æ–≤, —Ä–∞–∑–º—ã—Ç–æ—Å—Ç—å —Ñ–æ–Ω–∞ –∏ —Ü–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏.
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ.
        </p>

        <div class="field">
          <label for="theme-bg-images">–§–æ–Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</label>
          <input id="theme-bg-images" type="file" accept="image/*" multiple />
          <div class="hint">
            –ö–∞—Ä—Ç–∏–Ω–∫–∏ –±—É–¥—É—Ç –ø–ª–∞–≤–Ω–æ —Å–º–µ–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π).
          </div>
        </div>

        <div class="field">
          <label for="theme-border-color">–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏ –±–ª–æ–∫–æ–≤</label>
          <input id="theme-border-color" type="color" value="#374151" />
        </div>

        <div class="field">
          <label for="theme-opacity">
            –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –±–ª–æ–∫–æ–≤:
            <span id="theme-opacity-value">80</span>%
          </label>
          <input id="theme-opacity" type="range" min="30" max="100" step="5" value="80" />
        </div>

        <div class="field">
          <label for="theme-blur">
            –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞:
            <span id="theme-blur-value">0</span> px
          </label>
          <input id="theme-blur" type="range" min="0" max="15" step="1" value="0" />
        </div>

        <div class="field">
        <label for="theme-favicon">–ò–∫–æ–Ω–∫–∞</label>
        <input id="theme-favicon" type="file" accept="image/*" />
        <div class="hint">
          –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ 32√ó32 –∏–ª–∏ 64√ó64. –ë—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑–µ –∫–∞–∫ base64.
        </div>
      </div>
    
      <div class="field">
        <label for="theme-site-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç—É</label>
        <input id="theme-site-title" type="text" placeholder="Police Platinum ‚Äî –ü–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞" />
        <div class="hint">
          –≠—Ç–æ –±—É–¥–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        </div>
      </div>
              <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤ -->
      <div id="exam-admin-panel" style="margin-top:16px; display:none;">
        <h3 style="font-size:16px; margin-bottom:6px;">–í–æ–ø—Ä–æ—Å—ã —ç–∫–∑–∞–º–µ–Ω–æ–≤</h3>
        <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">
          –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∏ –≤—ã—à–µ –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∑–∞—á—ë—Ç–∞ —Ä—è–¥–æ–≤–æ–≥–æ –∏ —ç–∫–∑–∞–º–µ–Ω–∞ –∫–∞–ø–∏—Ç–∞–Ω–∞.
        </p>
      
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
          <select id="exam-admin-type" class="admin-select" style="min-width:160px;">
            <option value="rookie">–ó–∞—á—ë—Ç —Ä—è–¥–æ–≤–æ–≥–æ</option>
            <option value="captain">–≠–∫–∑–∞–º–µ–Ω –∫–∞–ø–∏—Ç–∞–Ω–∞</option>
          </select>
          <button id="exam-admin-new" class="btn btn-sm">‚ûï –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</button>
        </div>
      
        <div id="exam-admin-form" class="card" style="display:none; padding:10px; margin-bottom:10px;">
          <div class="field">
            <label for="exam-question-text">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
            <textarea id="exam-question-text" rows="3"></textarea>
          </div>
      
          <div class="field">
            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</label>
            <input id="exam-option-a" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç A" style="margin-bottom:4px;">
            <input id="exam-option-b" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç B" style="margin-bottom:4px;">
            <input id="exam-option-c" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç C" style="margin-bottom:4px;">
            <input id="exam-option-d" type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç D">
          </div>
      
          <div class="field">
            <label for="exam-correct-option">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</label>
            <select id="exam-correct-option" class="admin-select" style="width:auto;">
              <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
      
          <div class="field">
            <label for="exam-image-input">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∫ –≤–æ–ø—Ä–æ—Å—É (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
            <input id="exam-image-input" type="file" accept="image/*">
            <div class="hint">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –±–∞–∑–µ –∫–∞–∫ base64. –ü—Ä–∏ –∫–ª–∏–∫–µ –≤ —ç–∫–∑–∞–º–µ–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.</div>
          </div>
      
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:6px;">
            <button id="exam-admin-cancel" class="btn-outline btn-sm">–û—Ç–º–µ–Ω–∞</button>
            <button id="exam-admin-save" class="btn btn-sm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          </div>
        </div>
      
        <div id="exam-admin-list" class="admin-users-list" style="margin-top:0;">
          –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...
        </div>
      </div>


        <button id="theme-save-btn" class="btn btn-sm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</button>
      </div>
    </section>

    <!-- –û—Ñ–∏—Ü–µ—Ä—ã -->
    <section id="section-officers" class="section">
      <h2>–û—Ñ–∏—Ü–µ—Ä—ã PD</h2>
      <p>–°–ø–∏—Å–æ–∫ –æ—Ñ–∏—Ü–µ—Ä–æ–≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π LSPD, SFPD –∏ LVPD.</p>

      <div style="margin-top:10px; margin-bottom:8px;">
        <button id="officers-add-btn" class="btn btn-sm" style="display:none;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–µ—Ä–∞
        </button>
      </div>

      <div id="officers-add-block" style="display:none; margin-bottom:10px;">
        <div class="field">
          <label for="officers-add-user-select">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
          <select id="officers-add-user-select"></select>
        </div>
        <div class="field">
          <label for="officers-add-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</label>
          <select id="officers-add-dept">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª‚Ä¶</option>
            <option value="LSPD">LSPD</option>
            <option value="SFPD">SFPD</option>
            <option value="LVPD">LVPD</option>
          </select>
        </div>
        <div class="field">
          <label for="officers-add-vk">VK (—Å—Å—ã–ª–∫–∞)</label>
          <input id="officers-add-vk" type="text" />
        </div>
        <div class="field">
          <label for="officers-add-tg">Telegram (—Å—Å—ã–ª–∫–∞)</label>
          <input id="officers-add-tg" type="text" />
        </div>
        <button class="btn btn-sm" id="officers-add-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div id="officers-minister"></div>

      <div class="officers-columns">
        <div class="officer-column">
          <div class="officer-column-title">LSPD</div>
          <div class="officer-column-body" id="officers-col-lspd"></div>
        </div>
        <div class="officer-column">
          <div class="officer-column-title">SFPD</div>
          <div class="officer-column-body" id="officers-col-sfpd"></div>
        </div>
        <div class="officer-column">
          <div class="officer-column-title">LVPD</div>
          <div class="officer-column-body" id="officers-col-lvpd"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- ============ –ú–û–î–ê–õ–ö–ê: –†–Ø–î–û–í–´–ï ============ -->
  <div id="rookie-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö</h3>
      <p><strong>Police Academy [PA][1-2] ‚Äî –ü–æ–ª–∏—Ü–µ–π—Å–∫–∞—è –∞–∫–∞–¥–µ–º–∏—è</strong></p>
      <p>
        Police Academy [PA][1-2] (–Ω–æ–≤–æ–±—Ä–∞–Ω—Ü—ã) ‚Äî –æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        –Ω–æ–≤–∏—á–∫–æ–≤, —Ç–æ–ª—å–∫–æ –≤—Å—Ç—É–ø–∏–≤—à–∏—Ö –≤ —Ä—è–¥—ã –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞. –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç —ç–∫–∑–∞–º–µ–Ω—ã,
        —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –æ–±—É—á–µ–Ω–∏–µ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é —Å –æ—Ä—É–∂–∏–µ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –ø–∞—Ç—Ä—É–ª–µ.
      </p>
      <p>
        –ê–∫–∞–¥–µ–º–∏—è –≥–æ—Ç–æ–≤–∏—Ç –Ω–æ–≤–æ–±—Ä–∞–Ω—Ü–µ–≤ –≤ –æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (PD), –≤ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–∏
        –±—É–¥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —ç–∫–∑–∞–º–µ–Ω–æ–≤.
      </p>
      <p><strong>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Ü–∏–∏:</strong><br/>
        –ü–æ–∑—ã–≤–Ω–æ–π Police Academy: <code>[PA]</code><br/>
        –ü—Ä–∏–º–µ—Ä: <code>![PA] –ü—Ä–∏–µ–º...</code>
      </p>
      <p><strong>–û—Ç—ã–≥—Ä–æ–≤–∫–∞ –∑–Ω–∞—á–∫–∞ (–ø—Ä–∏–º–µ—Ä):</strong><br/>
        <code>/me –ù–∞ –ø–æ—è—Å–µ –∑–Ω–∞—á–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ LVPD —Å –Ω–æ–º–µ—Ä–æ–º [–Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]</code>
      </p>

      <div class="modal-footer">
        <button class="btn btn-sm" id="rookie-close-btn">–ü–æ–Ω—è–ª, –ø—Ä–∏–Ω—è–ª</button>
      </div>
    </div>
  </div>

    <!-- ============ –ú–û–î–ê–õ–ö–ê: –≠–ö–ó–ê–ú–ï–ù ============ -->
  <div id="exam-modal" class="modal-backdrop">
    <div class="modal" style="max-width:640px;">
      <h3 id="exam-title">–≠–∫–∑–∞–º–µ–Ω</h3>
      <div id="exam-question-body" style="margin-top:8px;"></div>
  
      <div class="modal-footer" id="exam-footer">
        <button class="btn-outline btn-sm" id="exam-cancel-btn">–í—ã–π—Ç–∏</button>
        <button class="btn btn-sm" id="exam-next-btn">–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </div>


  <!-- ============ –ú–û–î–ê–õ–ö–ê: –î–û–ë–ê–í–ò–¢–¨ / –ù–ê–°–¢–†–û–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–ê–î–ú–ò–ù) ============ -->
  <div id="admin-add-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫—É, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –µ–º—É —Å—Ç–∞—Ç—É—Å –∏ —Ü–≤–µ—Ç —Ä–∞–º–∫–∏.</p>

      <input id="admin-add-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." />

      <div id="admin-add-results" style="max-height:200px; overflow-y:auto; margin-bottom:8px;"></div>

      <div class="field">
        <label for="admin-status-select">–°—Ç–∞—Ç—É—Å (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)</label>
        <select id="admin-status-select">
          <option value="">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</option>
          <option value="–ö—É—Ä–∞—Ç–æ—Ä">–ö—É—Ä–∞—Ç–æ—Ä</option>
          <option value="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É</option>
          <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
          <option value="–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª">–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª</option>
          <option value="–ì–µ–Ω–µ—Ä–∞–ª LSPD">–ì–µ–Ω–µ—Ä–∞–ª LSPD</option>
          <option value="–ì–µ–Ω–µ—Ä–∞–ª SFPD">–ì–µ–Ω–µ—Ä–∞–ª SFPD</option>
          <option value="–ì–µ–Ω–µ—Ä–∞–ª LVPD">–ì–µ–Ω–µ—Ä–∞–ª LVPD</option>
        </select>
      </div>

      <div class="field">
        <label for="admin-border-color">–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
        <input id="admin-border-color" type="color" value="#3a7ca5" />
      </div>

      <div class="modal-footer">
        <button class="btn-outline btn-sm" id="admin-add-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-sm" id="admin-add-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ============ –ú–û–î–ê–õ–ö–ê: –û–®–ò–ë–ö–ê ============ -->
  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞!</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

</div> <!-- /app -->
<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* =============== –ù–ê–°–¢–†–û–ô–ö–ê SUPABASE =============== */

const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============== –£–¢–ò–õ–ò–¢–´ =============== */

function normalizeNick(n) {
  if (!n) return "";
  return n.trim().replace(/\s+/g, "_");
}
function showError(id, msg) {
  const el = document.getElementById(id);
  if (el) el.textContent = msg || "";
}
function saveSession(user) {
  localStorage.setItem("pp_user", JSON.stringify(user));
}
function loadSession() {
  try {
    return JSON.parse(localStorage.getItem("pp_user"));
  } catch {
    return null;
  }
}
function clearSession() {
  localStorage.removeItem("pp_user");
}
function roleLabel(role) {
  if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
  if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
  if (role === "creator") return "–†–µ–¥–∞–∫—Ç–æ—Ä";
  return "–û—Ñ–∏—Ü–µ—Ä";
}


/* =============== –ú–û–î–ê–õ–ö–ê –û–®–ò–ë–û–ö =============== */

const errorModal = document.getElementById("error-modal");
const errorModalText = document.getElementById("error-modal-text");
const errorModalClose = document.getElementById("error-modal-close");

function showErrorModal(message) {
  errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
  errorModal.classList.add("active");
}
if (errorModalClose) {
  errorModalClose.onclick = () => {
    errorModal.classList.remove("active");
  };
}

/* =============== –¢–ï–ú–ê: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ / –∑–∞–≥—Ä—É–∑–∫–∞ / –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ =============== */

async function loadThemeFromDB() {
  const { data, error } = await supabaseClient
    .from("theme_settings")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) {
    console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã:", error);
    return;
  }

  themeConfig = {
    images: data.images || [],
    opacity: data.opacity,
    blur: data.blur,
    borderColor: data.border_color,
    favicon: data.favicon || null,
    siteTitle: data.site_title || null
  };
}



async function saveThemeToDB() {
  const { error } = await supabaseClient
    .from("theme_settings")
    .update({
      images: themeConfig.images,
      opacity: themeConfig.opacity,
      blur: themeConfig.blur,
      border_color: themeConfig.borderColor,
      favicon: themeConfig.favicon,
      site_title: themeConfig.siteTitle
    })
    .eq("id", 1);

  if (error) {
    showErrorModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã!");
    console.error(error);
  }
}


function applyThemeToBlocks() {
  const opacity = (themeConfig.opacity || 80) / 100;
  const borderColor = themeConfig.borderColor || "#374151";

  // –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π --border (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö border: var(--border))
  document.documentElement.style.setProperty("--border", borderColor);

  // –º–µ–Ω—è–µ–º —Ñ–æ–Ω –±–ª–æ–∫–æ–≤ –Ω–∞ –æ–¥–∏–Ω —Ü–≤–µ—Ç —Å –Ω—É–∂–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
  const blocks = document.querySelectorAll(
    ".card, .navbar, .section, .files-list, .files-detail, .admin-users-list"
  );
  blocks.forEach((el) => {
    el.style.backgroundColor = `rgba(15, 23, 42, ${opacity})`;
    // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª—ë–≥–∫–∏–π blur –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å
    // el.style.backdropFilter = themeConfig.blur ? `blur(${themeConfig.blur}px)` : "";
  });
}

function applyThemeBackground() {
  if (!bgRotatorEl) return;
  bgRotatorEl.innerHTML = "";

  const images = themeConfig.images || [];
  const blurPx = themeConfig.blur || 0;

  if (!images.length) {
    // –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫ ‚Äî —Ñ–æ–Ω –ø—Ä–æ—Å—Ç–æ —Ü–≤–µ—Ç
    bgRotatorEl.style.background = "#0f172a";
    return;
  }

  images.forEach((src, index) => {
    const img = document.createElement("img");
    img.src = src;
    img.style.filter = `blur(${blurPx}px)`;
    if (index === 0) img.classList.add("active");
    bgRotatorEl.appendChild(img);
  });

  if (bgRotationTimer) {
    clearInterval(bgRotationTimer);
    bgRotationTimer = null;
  }

  if (images.length > 1) {
    const imgs = Array.from(bgRotatorEl.querySelectorAll("img"));
    bgCurrentIndex = 0;

    bgRotationTimer = setInterval(() => {
      const prev = imgs[bgCurrentIndex];
      bgCurrentIndex = (bgCurrentIndex + 1) % imgs.length;
      const next = imgs[bgCurrentIndex];

      if (prev) prev.classList.remove("active");
      if (next) next.classList.add("active");
    }, 60 * 1000); // 60 —Å–µ–∫—É–Ω–¥
  }
}

function applySiteBranding() {
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  if (themeConfig.siteTitle) {
    document.title = themeConfig.siteTitle;
  } else {
    // –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –µ—Å–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
    document.title = "Police Platinum ‚Äî –ü–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞";
  }

  // Favicon
  if (themeConfig.favicon) {
    let link = document.querySelector("link[rel~='icon']");
    if (!link) {
      link = document.createElement("link");
      link.rel = "icon";
      document.head.appendChild(link);
    }
    link.href = themeConfig.favicon;
  }
}


/* UI –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Ç–µ–º—ã (creator) */

function initThemePanel() {
  if (!creatorThemePanel) return;

  // –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ creator
  const isCreator = currentUser && currentUser.role === "creator";
  creatorThemePanel.style.display = isCreator ? "block" : "none";
  if (!isCreator) return;

  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  themeBorderColorInput.value = themeConfig.borderColor || "#374151";
  themeOpacityInput.value = themeConfig.opacity || 80;
  themeOpacityValue.textContent = themeOpacityInput.value;
  themeBlurInput.value = themeConfig.blur || 0;
  themeBlurValue.textContent = themeBlurInput.value;

  themeOpacityInput.oninput = () => {
    themeOpacityValue.textContent = themeOpacityInput.value;
    themeConfig.opacity = Number(themeOpacityInput.value);
    applyThemeToBlocks();
  };

  themeBlurInput.oninput = () => {
    themeBlurValue.textContent = themeBlurInput.value;
    themeConfig.blur = Number(themeBlurInput.value);
    applyThemeBackground();
    applyThemeToBlocks();
  };

  themeBorderColorInput.onchange = () => {
    themeConfig.borderColor = themeBorderColorInput.value || "#374151";
    applyThemeToBlocks();
  };

    // –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  if (themeSiteTitleInput) {
    themeSiteTitleInput.value = themeConfig.siteTitle || "";
    themeSiteTitleInput.oninput = () => {
      themeConfig.siteTitle = themeSiteTitleInput.value.trim() || null;
      applySiteBranding();
    };
  }

  if (themeFaviconInput) {
    themeFaviconInput.onchange = () => {
      const file = themeFaviconInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        themeConfig.favicon = reader.result;   // dataURL
        applySiteBranding();
      };
      reader.onerror = () => {
        showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏–∫–æ–Ω–∫–∏.");
      };
      reader.readAsDataURL(file);
    };
  }


  if (themeSaveBtn) {
    themeSaveBtn.onclick = async () => {
      await saveThemeToDB();
      applyThemeToBlocks();
      showErrorModal("–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.");
    };
  }

  if (themeBgImagesInput) {
    themeBgImagesInput.onchange = async () => {
      const files = Array.from(themeBgImagesInput.files || []);
      if (!files.length) return;

      try {
        const dataUrls = await Promise.all(
          files.map(
            (file) =>
              new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞"));
                reader.readAsDataURL(file);
              })
          )
        );

        themeConfig.images = dataUrls;
        applyThemeToBlocks();
        applyThemeBackground();
      } catch (e) {
        console.error(e);
        showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏.");
      }
    };
  }
}

/* =============== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =============== */

let currentUser = null;
let personalFilesCache = [];
let currentFileId = null;
let currentFileOwnerId = null;
let currentFileEditable = false;

let adminUsersCache = [];
let officersCache = [];
let adminSelectedUserId = null;

/* =============== –¢–ï–ú–ê (CREATOR) =============== */

const THEME_KEY = "pp_theme";

let themeConfig = {
  images: [],          // –º–∞—Å—Å–∏–≤ dataURL —Å—Ç—Ä–æ–∫
  opacity: 80,         // 30‚Äì100
  blur: 0,             // px
  borderColor: "#374151",
  favicon: null,       // dataURL –∏–∫–æ–Ω–∫–∏
  siteTitle: null      // —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
};


let bgRotationTimer = null;
let bgCurrentIndex = 0;

/* =============== –≠–õ–ï–ú–ï–ù–¢–´ DOM =============== */

const authRoot = document.getElementById("auth-root");
const panelRoot = document.getElementById("panel-root");
const regScreen = document.getElementById("register-screen");
const loginScreen = document.getElementById("login-screen");

const topNick = document.getElementById("top-nick");
const topRole = document.getElementById("top-role");
const topAvatar = document.getElementById("top-avatar");

const navAdminBtn = document.getElementById("nav-admin");
const navOfficersBtn = document.getElementById("nav-officers");
const sectionAdminTitle = document.querySelector("#section-admin h2");
const sectionAdminDesc = document.querySelector("#section-admin p");
const navLeadershipBtn = document.getElementById("nav-leadership");
const adminNavbar = document.getElementById("admin-navbar");
const leadershipContainer = document.getElementById("leadership-container");
const loginOpenBtn = document.getElementById("login-open-btn");
const registerOpenBtn = document.getElementById("register-open-btn");
const topUserBox = document.getElementById("top-user");
const logoutBtn = document.getElementById("logout-btn");
const rookieTestBtn = document.getElementById("btn-rookie-test");
const captainExamBtn = document.getElementById("btn-captain-exam");
const joinPdBtn = document.getElementById("btn-join-pd");




/* —ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–∏ —Ç–µ–º—ã */
const creatorThemePanel = document.getElementById("creator-theme-panel");
const themeBgImagesInput = document.getElementById("theme-bg-images");
const themeBorderColorInput = document.getElementById("theme-border-color");
const themeOpacityInput = document.getElementById("theme-opacity");
const themeOpacityValue = document.getElementById("theme-opacity-value");
const themeBlurInput = document.getElementById("theme-blur");
const themeBlurValue = document.getElementById("theme-blur-value");
const themeSaveBtn = document.getElementById("theme-save-btn");

const bgRotatorEl = document.getElementById("bg-rotator");
const pfView = document.getElementById("personal-view");
const pfEditToggleBtn = document.getElementById("pf-edit-toggle-btn");

const pfRepliesList = document.getElementById("pf-replies-list");
const pfRepliesFormWrapper = document.getElementById("pf-replies-form-wrapper");
const pfReplyText = document.getElementById("pf-reply-text");
const pfReplySendBtn = document.getElementById("pf-reply-send");

const themeFaviconInput = document.getElementById("theme-favicon");
const themeSiteTitleInput = document.getElementById("theme-site-title");

let pfEditMode = false;

if (examAdminTypeSelect) {
  examAdminTypeSelect.onchange = () => {
    examAdminCurrentId = null;
    examAdminForm.style.display = "none";
    loadExamQuestionsForAdmin();
  };
}

if (examAdminNewBtn) {
  examAdminNewBtn.onclick = () => {
    examAdminCurrentId = null;
    examQuestionText.value = "";
    examOptionA.value = "";
    examOptionB.value = "";
    examOptionC.value = "";
    examOptionD.value = "";
    examCorrectOption.value = "";
    examImageInput.value = "";
    examAdminImageData = null;
    examAdminForm.style.display = "block";
  };
}

if (examAdminCancel) {
  examAdminCancel.onclick = () => {
    examAdminForm.style.display = "none";
    examAdminCurrentId = null;
  };
}

if (examImageInput) {
  examImageInput.onchange = () => {
    const file = examImageInput.files[0];
    if (!file) {
      examAdminImageData = null;
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      examAdminImageData = reader.result;
    };
    reader.onerror = () => {
      showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–æ–ø—Ä–æ—Å–∞.");
    };
    reader.readAsDataURL(file);
  };
}

if (examAdminSave) {
  examAdminSave.onclick = async () => {
    const examType = examAdminTypeSelect.value;
    const text = examQuestionText.value.trim();
    const a = examOptionA.value.trim();
    const b = examOptionB.value.trim();
    const c = examOptionC.value.trim();
    const d = examOptionD.value.trim();
    const correct = examCorrectOption.value;

    if (!text) {
      showErrorModal("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞.");
      return;
    }

    const hasAnyOption = a || b || c || d;
    if (!hasAnyOption) {
      showErrorModal("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.");
      return;
    }

    if (!correct) {
      showErrorModal("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.");
      return;
    }

    const payload = {
      exam_type: examType,
      question_text: text,
      option_a: a || null,
      option_b: b || null,
      option_c: c || null,
      option_d: d || null,
      correct_option: correct,
      image_data: examAdminImageData,
    };

    let err = null;
    if (examAdminCurrentId) {
      const { error } = await supabaseClient
        .from("exam_questions")
        .update(payload)
        .eq("id", examAdminCurrentId);
      err = error;
    } else {
      const { error } = await supabaseClient
        .from("exam_questions")
        .insert(payload);
      err = error;
    }

    if (err) {
      console.error(err);
      showErrorModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞.");
      return;
    }

    examAdminForm.style.display = "none";
    examAdminCurrentId = null;
    await loadExamQuestionsForAdmin();
  };
}


if (joinPdBtn) {
  joinPdBtn.addEventListener("click", () => {
    showErrorModal(
      "–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª ¬´–í—Å—Ç—É–ø–∏—Ç—å –≤ PD¬ª –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. " +
      "–ü–æ–∑–∂–µ —Å—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ä—É–º –∏–ª–∏ —Ñ–æ—Ä–º—É –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏."
    );
  });
}


if (rookieTestBtn) {
  rookieTestBtn.addEventListener("click", () => {
    startExam("rookie");
  });
}


if (captainExamBtn) {
  captainExamBtn.addEventListener("click", () => {
    showErrorModal(
      "–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫–∑–∞–º–µ–Ω –ö–∞–ø–∏—Ç–∞–Ω–∞ –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. " +
      "–î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–∑–∂–µ."
    );
  });
}

/* =============== –≠–ö–ó–ê–ú–ï–ù–´ (–ó–ê–ß–Å–¢ –†–Ø–î–û–í–û–ì–û) =============== */

const examModal = document.getElementById("exam-modal");
const examTitleEl = document.getElementById("exam-title");
const examBodyEl = document.getElementById("exam-question-body");
const examNextBtn = document.getElementById("exam-next-btn");
const examCancelBtn = document.getElementById("exam-cancel-btn");

let currentExamState = null; 
// { type: 'rookie', questions: [...], index: 0, answers: ['A', 'C', ...] }

function closeExamModal() {
  examModal.classList.remove("active");
  currentExamState = null;
}

if (examCancelBtn) {
  examCancelBtn.onclick = () => {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —ç–∫–∑–∞–º–µ–Ω–∞? –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.")) {
      closeExamModal();
    }
  };
}

function renderExamQuestion() {
  if (!currentExamState || !examBodyEl) return;

  const { questions, index } = currentExamState;
  const q = questions[index];
  if (!q) return;

  examBodyEl.innerHTML = "";

  const container = document.createElement("div");

  // –∫–∞—Ä—Ç–∏–Ω–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
  if (q.image_data) {
    const img = document.createElement("img");
    img.src = q.image_data;
    img.className = "exam-image";
    img.onclick = () => {
      const overlay = document.createElement("div");
      overlay.className = "exam-image-large";
      const bigImg = document.createElement("img");
      bigImg.src = q.image_data;
      overlay.appendChild(bigImg);
      overlay.onclick = () => document.body.removeChild(overlay);
      document.body.appendChild(overlay);
    };
    container.appendChild(img);
  }

  const qText = document.createElement("div");
  qText.className = "exam-question-text";
  qText.textContent = `–í–æ–ø—Ä–æ—Å ${index + 1} –∏–∑ ${questions.length}: ${q.question_text}`;
  container.appendChild(qText);

  const optionsWrap = document.createElement("div");
  optionsWrap.className = "exam-options";

  const options = [
    { key: "A", label: q.option_a },
    { key: "B", label: q.option_b },
    { key: "C", label: q.option_c },
    { key: "D", label: q.option_d },
  ].filter((o) => o.label && o.label.trim() !== "");

  if (!options.length) {
    const warn = document.createElement("div");
    warn.style.color = "#fbbf24";
    warn.style.fontSize = "13px";
    warn.textContent = "‚ö† –î–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞.";
    optionsWrap.appendChild(warn);
  } else {
    options.forEach((opt, idx) => {
      const row = document.createElement("label");
      row.className = "exam-option";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "exam-option";
      input.value = opt.key;

      const saved = currentExamState.answers[index];
      if (saved === opt.key) input.checked = true;

      const span = document.createElement("span");
      span.textContent = opt.label;

      row.appendChild(input);
      row.appendChild(span);
      optionsWrap.appendChild(row);
    });
  }

  container.appendChild(optionsWrap);
  examBodyEl.appendChild(container);

  examNextBtn.textContent =
    index === questions.length - 1 ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å" : "–î–∞–ª—å—à–µ";
}

function collectCurrentAnswer() {
  if (!currentExamState) return;

  const { index } = currentExamState;
  const checked = examBodyEl.querySelector("input[name='exam-option']:checked");
  if (checked) {
    currentExamState.answers[index] = checked.value;
  }
}

async function finishExam() {
  collectCurrentAnswer();

  const { questions, answers, type } = currentExamState;

  let score = 0;
  questions.forEach((q, i) => {
    if (answers[i] && q.correct_option && answers[i] === q.correct_option) {
      score++;
    }
  });

  const total = questions.length || 1;
  const passed = score >= Math.ceil(total * 0.7); // 70%

  if (currentUser) {
    const { error } = await supabaseClient
      .from("exam_attempts")
      .insert({
        user_id: currentUser.id,
        exam_type: type,
        score,
        total_questions: total,
        passed,
      });

    if (error) {
      console.error(error);
      showErrorModal("–≠–∫–∑–∞–º–µ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é.");
    }
  }

  closeExamModal();

  const statusText = passed ? "–°–¥–∞–Ω–æ ‚úÖ" : "–ù–µ —Å–¥–∞–Ω–æ ‚ùå";
  showErrorModal(
    `–ó–∞—á—ë—Ç —Ä—è–¥–æ–≤–æ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω.\n\n` +
    `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${statusText}\n` +
    `–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${score} –∏–∑ ${total} (${Math.round((score / total) * 100)}%)`
  );
}

if (examNextBtn) {
  examNextBtn.onclick = async () => {
    if (!currentExamState) return;

    collectCurrentAnswer();

    if (!currentExamState.answers[currentExamState.index]) {
      if (!confirm("–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞. –ü–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ?")) {
        return;
      }
    }

    if (currentExamState.index === currentExamState.questions.length - 1) {
      await finishExam();
    } else {
      currentExamState.index++;
      renderExamQuestion();
    }
  };
}

async function startExam(examType) {
  if (!currentUser) {
    showErrorModal("–ß—Ç–æ–±—ã —Å–¥–∞–≤–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω, –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
    return;
  }

  const titleMap = {
    rookie: "–ó–∞—á—ë—Ç —Ä—è–¥–æ–≤–æ–≥–æ",
    captain: "–≠–∫–∑–∞–º–µ–Ω –∫–∞–ø–∏—Ç–∞–Ω–∞",
  };

  examTitleEl.textContent = titleMap[examType] || "–≠–∫–∑–∞–º–µ–Ω";

  const { data, error } = await supabaseClient
    .from("exam_questions")
    .select("*")
    .eq("exam_type", examType)
    .order("id", { ascending: true });

  if (error) {
    console.error(error);
    showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã —ç–∫–∑–∞–º–µ–Ω–∞.");
    return;
  }

  if (!data || !data.length) {
    showErrorModal("–î–ª—è —ç—Ç–æ–≥–æ —ç–∫–∑–∞–º–µ–Ω–∞ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤–æ–ø—Ä–æ—Å—ã.");
    return;
  }

  currentExamState = {
    type: examType,
    questions: data,
    index: 0,
    answers: new Array(data.length).fill(null),
  };

  examModal.classList.add("active");
  renderExamQuestion();
}


/* =============== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =============== */

document.getElementById("to-login").onclick = () => {
  regScreen.classList.remove("active");
  loginScreen.classList.add("active");
};
document.getElementById("to-register").onclick = () => {
  loginScreen.classList.remove("active");
  regScreen.classList.add("active");
};

function showAuth(mode) {
  if (panelRoot) panelRoot.style.display = "none";
  if (authRoot) authRoot.style.display = "block";

  if (mode === "login") {
    regScreen.classList.remove("active");
    loginScreen.classList.add("active");
  } else {
    loginScreen.classList.remove("active");
    regScreen.classList.add("active");
  }
}

if (loginOpenBtn) {
  loginOpenBtn.onclick = () => showAuth("login");
}
if (registerOpenBtn) {
  registerOpenBtn.onclick = () => showAuth("register");
}

function enterGuestMode() {
  currentUser = null;
  if (authRoot) authRoot.style.display = "none";
  if (panelRoot) panelRoot.style.display = "block";
  refreshTopBar();
  switchSection("home");
}


/* =============== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =============== */

document.getElementById("register-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  let nick = normalizeNick(document.getElementById("reg-nick").value);
  let password = document.getElementById("reg-password").value;
  let dept = document.getElementById("reg-dept").value;
  let avatarFile = document.getElementById("reg-avatar").files[0];

  showError("reg-nick-error", "");
  showError("reg-password-error", "");
  showError("reg-dept-error", "");
  showError("reg-avatar-error", "");

  if (!nick || !/^[A-Za-z–ê-–Ø–∞-—è–Å—ë]+_[A-Za-z–ê-–Ø–∞-—è–Å—ë]+$/.test(nick)) {
    showError("reg-nick-error", "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)");
    return;
  }
  if (!password || password.length < 6) {
    showError("reg-password-error", "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
    return;
  }
  if (!dept) {
    showError("reg-dept-error", "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç");
    return;
  }
  if (!avatarFile) {
    showError("reg-avatar-error", "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const avatarDataUrl = reader.result;

    const { data: userRow, error } = await supabaseClient
      .from("users")
      .insert({
        nick,
        password_hash: password,
        department: dept,
        avatar_url: avatarDataUrl,
        role: "user"
      })
      .select("*")
      .single();

    if (error) {
      console.error(error);
      showErrorModal("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–∞–±–ª–∏—Ü–∞ users). –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç.");
      return;
    }

    currentUser = userRow;
    saveSession(userRow);
    loadPanelUI(userRow);
  };

  reader.onerror = () => {
    showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∫–∏.");
  };

  reader.readAsDataURL(avatarFile);
});

/* =============== –í–•–û–î =============== */

document.getElementById("login-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  let nick = normalizeNick(document.getElementById("login-nick").value);
  let password = document.getElementById("login-password").value;

  showError("login-nick-error", "");
  showError("login-password-error", "");

  if (!nick) {
    showError("login-nick-error", "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
    return;
  }
  if (!password) {
    showError("login-password-error", "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
    return;
  }

  const { data, error } = await supabaseClient
    .from("users")
    .select("*")
    .eq("nick", nick)
    .single();

  if (error || !data) {
    showError("login-nick-error", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }

  if (data.password_hash !== password) {
    showError("login-password-error", "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    return;
  }

  currentUser = data;
  saveSession(data);
  loadPanelUI(data);
});

// –ö–Ω–æ–ø–∫–∏ –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏)
document.querySelectorAll(".side-nav-btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    const id = btn.id;

    if (id === "side-exams") {
      if (!currentUser) {
        showErrorModal("–ß—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–¥–∞—á–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤ –∏ —Ä–µ–∑—é–º–µ, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
        return;
      }
      switchSection("exams");
      loadExamHistory("rookie");
      return;
    }

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–æ–∫–æ–≤—ã–µ –ø—É–Ω–∫—Ç—ã –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏
    const text = btn.innerText.trim();
    showErrorModal(`–†–∞–∑–¥–µ–ª ¬´${text}¬ª –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∑–∂–µ —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å —Å—Å—ã–ª–∫–∏ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.`);
  });
});



/* =============== –¢–û–ü-–ë–ê–† + –ü–ê–ù–ï–õ–¨ =============== */

function updateAdminTexts() {
  if (!adminNavbar) return;

  if (!currentUser) {
    adminNavbar.style.display = "none";
    return;
  }

  const hasAdminPanelAccess =
    currentUser.role === "admin" ||
    currentUser.role === "moderator" ||
    currentUser.role === "creator";

  adminNavbar.style.display = hasAdminPanelAccess ? "flex" : "none";
}

function refreshTopBar() {
  if (!topNick || !topRole || !topAvatar) return;

  // –ì–æ—Å—Ç—å
  if (!currentUser) {
    topNick.textContent = "–ì–æ—Å—Ç—å";
    topRole.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–í–æ–π—Ç–∏¬ª –∏–ª–∏ ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª";

    topAvatar.innerHTML = "PP";
    topAvatar.style.borderColor = "#374151";

    if (topUserBox) topUserBox.style.display = "flex";
    if (loginOpenBtn) loginOpenBtn.style.display = "inline-block";
    if (registerOpenBtn) registerOpenBtn.style.display = "inline-block";
    if (logoutBtn) logoutBtn.style.display = "none";

    updateAdminTexts();
    return;
  }

  // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π
  topNick.textContent = currentUser.nick || "–û—Ñ–∏—Ü–µ—Ä";
  topRole.textContent = roleLabel(currentUser.role || "user");

  topAvatar.innerHTML = "";
  topAvatar.style.borderColor = currentUser.border_color || "#374151";
  if (currentUser.avatar_url) {
    const img = document.createElement("img");
    img.src = currentUser.avatar_url;
    topAvatar.appendChild(img);
  } else {
    topAvatar.textContent = currentUser.nick ? currentUser.nick[0] : "P";
  }

  if (topUserBox) topUserBox.style.display = "flex";
  if (loginOpenBtn) loginOpenBtn.style.display = "none";
  if (registerOpenBtn) registerOpenBtn.style.display = "none";
  if (logoutBtn) logoutBtn.style.display = "inline-block";

  updateAdminTexts();
}


async function loadPanelUI(user) {
  currentUser = user || null;

  if (authRoot) authRoot.style.display = "none";
  if (panelRoot) panelRoot.style.display = "block";

  refreshTopBar();

  await loadThemeFromDB();
  applyThemeBackground();
  applyThemeToBlocks();
  initThemePanel(); // –µ—Å–ª–∏ creator
  applySiteBranding();


  switchSection("home");
}


/* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ */
window.addEventListener("load", async () => {
  await loadThemeFromDB();
  applyThemeBackground();
  applyThemeToBlocks();
  applySiteBranding();

  const session = loadSession();
  if (session) {
    currentUser = session;
    loadPanelUI(session);
  } else {
    enterGuestMode();
  }
});


/* –≤—ã—Ö–æ–¥ */
document.getElementById("logout-btn").onclick = () => {
  clearSession();
  location.reload();
};

/* =============== –ù–ê–í–ò–ì–ê–¶–ò–Ø –†–ê–ó–î–ï–õ–û–í =============== */

function switchSection(name) {
  const sections = ["home", "files", "leadership", "officers", "admin", "exams"];
  
  sections.forEach((sec) => {
    const sectionEl = document.getElementById(`section-${sec}`);
    if (sectionEl) sectionEl.classList.remove("active");

    const navBtn = document.getElementById(`nav-${sec}`);
    if (navBtn) navBtn.classList.remove("active");
  });

  const targetSection = document.getElementById(`section-${name}`);
  if (targetSection) targetSection.classList.add("active");

  const targetNav = document.getElementById(`nav-${name}`);
  if (targetNav) targetNav.classList.add("active");

  document.getElementById("back-home-btn").style.display =
    name === "home" ? "none" : "inline-block";

  if (name === "files") loadPersonalFiles();
  if (name === "admin") loadAdminPanel();
  if (name === "officers") loadOfficers();
  if (name === "leadership") loadLeadership();
}


document.getElementById("nav-home").onclick = () => switchSection("home");
document.getElementById("nav-files").onclick = () => switchSection("files");
document.getElementById("nav-officers").onclick = () => switchSection("officers");
document.getElementById("nav-leadership").onclick = () => switchSection("leadership");
document.getElementById("nav-admin").onclick = () => switchSection("admin");

document.getElementById("open-files-from-home").onclick = () => switchSection("files");

/* –°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä */
document.getElementById("download-binder-btn").onclick = () => {
  const a = document.createElement("a");
  a.href = "binder.zip";
  a.download = "binder.zip";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

/* =============== –ú–û–î–ê–õ–ö–ê –†–Ø–î–û–í–´–• =============== */

const rookieModal = document.getElementById("rookie-modal");
document.getElementById("open-rookie-modal").onclick = () => {
  rookieModal.classList.add("active");
};
document.getElementById("rookie-close-btn").onclick = () => {
  rookieModal.classList.remove("active");
};

/* =============== –õ–ò–ß–ù–´–ï –î–ï–õ–ê =============== */

const filesListEl = document.getElementById("personal-files-list");
const pfForm = document.getElementById("personal-form");
const pfDept = document.getElementById("pf-dept");
const pfNick = document.getElementById("pf-nick");
const pfAccount = document.getElementById("pf-account");
const pfBirth = document.getElementById("pf-birth");
const pfBadgeLink = document.getElementById("pf-badge-link");
const pfRank = document.getElementById("pf-rank");
const pfPhone = document.getElementById("pf-phone");
const pfContact = document.getElementById("pf-contact");
const pfSaveBtn = document.getElementById("save-personal-btn");
const pfSaveNote = document.getElementById("personal-save-note");
const pfReadonlyNote = document.getElementById("pf-readonly-note");
const pfDetailTitle = document.getElementById("pf-detail-title");
const pfDetailSub = document.getElementById("pf-detail-sub");
const pfEditBadge = document.getElementById("pf-edit-badge");
const createPersonalBtn = document.getElementById("create-personal-btn");

if (createPersonalBtn) {
  createPersonalBtn.onclick = () => {
    if (!currentUser) return;
    currentFileId = null;
    currentFileOwnerId = currentUser.id;
    currentFileEditable = true;

    fillPersonalForm(null, true);  // –≤–∫–ª—é—á–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    pfEditMode = true;
    if (pfForm) pfForm.style.display = "block";
    if (pfView) pfView.style.display = "none";
    if (pfEditToggleBtn) {
      pfEditToggleBtn.style.display = "inline-block";
      pfEditToggleBtn.textContent = "‚¨Ö –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É";
    }
  };
}


function updatePfHeaderPreview() {
  const dept = pfDept.value || "–û—Ç–¥–µ–ª";
  const nick = pfNick.value || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
  const acc = pfAccount.value || "–ù–æ–º–µ—Ä";
  pfDetailTitle.textContent = `[${dept}] ${nick} [${acc}]`;
}

function fillPersonalView(fileRow) {
  if (!pfView) return;

  const dept = fileRow?.forum_dept || (pfDept ? pfDept.value : "") || "–û—Ç–¥–µ–ª";
  const nick =
    fileRow?.forum_nick ||
    (pfNick ? pfNick.value : "") ||
    (currentUser ? currentUser.nick : "–ò–º—è_–§–∞–º–∏–ª–∏—è");
  const acc =
    fileRow?.account_number || (pfAccount ? pfAccount.value : "") || "–ù–æ–º–µ—Ä";

  const rows = [
    { label: "–û—Ç–¥–µ–ª (—Ñ–æ—Ä—É–º–Ω—ã–π)", value: dept },
    { label: "–ò–º—è_–§–∞–º–∏–ª–∏—è (–∫–∞–∫ –≤ –∏–≥—Ä–µ)", value: nick },
    { label: "–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞", value: acc },
    { label: "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", value: fileRow?.birth_date || (pfBirth ? pfBirth.value : "") || "‚Äî" },
    { label: "–ù–æ–º–µ—Ä –∑–Ω–∞—á–∫–∞ / –∞–∫–∫–∞—É–Ω—Ç–∞", value: fileRow?.badge_link || (pfBadgeLink ? pfBadgeLink.value : "") || "‚Äî" },
    { label: "–¢–µ–∫—É—â–µ–µ –∑–≤–∞–Ω–∏–µ", value: fileRow?.rank || (pfRank ? pfRank.value : "") || "‚Äî" },
    { label: "–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω", value: fileRow?.phone || (pfPhone ? pfPhone.value : "") || "‚Äî" },
    { label: "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç", value: fileRow?.contact || (pfContact ? pfContact.value : "") || "‚Äî" },
  ];

  pfView.innerHTML = "";
  rows.forEach((r) => {
    const rowEl = document.createElement("div");
    rowEl.className = "pf-view-row";

    const labelEl = document.createElement("div");
    labelEl.className = "pf-view-label";
    labelEl.textContent = r.label;

    const valueEl = document.createElement("div");
    valueEl.className = "pf-view-value";
    valueEl.textContent = r.value || "‚Äî";

    rowEl.appendChild(labelEl);
    rowEl.appendChild(valueEl);
    pfView.appendChild(rowEl);
  });
}

function fillPersonalForm(fileRow, editable) {
  if (!pfDept) return; // —Ñ–æ—Ä–º–∞ –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

  if (!fileRow) {
    pfDept.value = "";
    pfNick.value = currentUser ? currentUser.nick : "";
    pfAccount.value = "";
    pfBirth.value = "";
    pfBadgeLink.value = "";
    pfRank.value = "";
    pfPhone.value = "";
    pfContact.value = "";
    pfDetailSub.textContent = editable
      ? "–ù–æ–≤–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ"
      : "–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—ë.";
  } else {
    pfDept.value = fileRow.forum_dept || "";
    pfNick.value = fileRow.forum_nick || "";
    pfAccount.value = fileRow.account_number || "";
    pfBirth.value = fileRow.birth_date || "";
    pfBadgeLink.value = fileRow.badge_link || "";
    pfRank.value = fileRow.rank || "";
    pfPhone.value = fileRow.phone || "";
    pfContact.value = fileRow.contact || "";
    pfDetailSub.textContent = fileRow.updated_at
      ? `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date(fileRow.updated_at).toLocaleString()}`
      : "";
  }

  updatePfHeaderPreview();
  fillPersonalView(fileRow || null);

  const controls = [
    pfDept, pfNick, pfAccount, pfBirth,
    pfBadgeLink, pfRank, pfPhone, pfContact
  ].filter(Boolean);
  controls.forEach((el) => (el.disabled = !editable));

  if (pfSaveBtn) {
    pfSaveBtn.style.display = editable ? "inline-block" : "none";
  }

  if (editable) {
    pfEditBadge.textContent = "–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
    pfEditBadge.className = "badge-editable";
    pfReadonlyNote.style.display = "none";
    if (pfEditToggleBtn) {
      pfEditToggleBtn.style.display = "inline-block";
      pfEditToggleBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
    }
  } else {
    pfEditBadge.textContent = "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä";
    pfEditBadge.className = "badge-readonly";
    pfReadonlyNote.style.display = "block";
    if (pfEditToggleBtn) {
      pfEditToggleBtn.style.display = "none";
    }
  }

  pfEditMode = false;
  if (pfView) pfView.style.display = "block";
  if (pfForm) pfForm.style.display = "none";
}

// –Ω–∞–≤–µ—à–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—è –µ—Å—Ç—å
if (pfDept) {
  pfDept.addEventListener("change", updatePfHeaderPreview);
}
if (pfNick) {
  pfNick.addEventListener("input", updatePfHeaderPreview);
}
if (pfAccount) {
  pfAccount.addEventListener("input", () => {
    pfAccount.value = pfAccount.value.replace(/\D+/g, "");
    updatePfHeaderPreview();
  });
}

function openPersonalFile(id) {
  const file = personalFilesCache.find((f) => f.id === id);
  if (!file) return;

  currentFileId = file.id;
  currentFileOwnerId = file.user_id;

  const canEdit =
    currentUser &&
    (currentUser.role === "admin" ||
      currentUser.role === "moderator" ||
      currentUser.id === file.user_id);

  currentFileEditable = !!canEdit;

  const items = filesListEl.querySelectorAll(".file-item");
  items.forEach((item) => {
    item.classList.toggle("active", Number(item.dataset.id) === id);
  });

  fillPersonalForm(file, canEdit);
  updateRepliesAccess();
  loadPersonalReplies(file.id);
}

if (pfEditToggleBtn) {
  pfEditToggleBtn.onclick = () => {
    if (!currentFileEditable) return;

    pfEditMode = !pfEditMode;

    if (pfEditMode) {
      // –≤–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É
      pfForm.style.display = "block";
      pfView.style.display = "none";
      pfEditToggleBtn.textContent = "‚¨Ö –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É";
    } else {
      // –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä
      pfForm.style.display = "none";
      pfView.style.display = "block";
      pfEditToggleBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";

      // –æ–±–Ω–æ–≤–ª—è–µ–º read-only –±–ª–æ–∫ –∏–∑ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–æ—Ä–º—ã
      fillPersonalView({
        forum_dept: pfDept.value.trim(),
        forum_nick: pfNick.value.trim(),
        account_number: pfAccount.value.trim(),
        birth_date: pfBirth.value.trim(),
        badge_link: pfBadgeLink.value.trim(),
        rank: pfRank.value.trim(),
        phone: pfPhone.value.trim(),
        contact: pfContact.value.trim()
      });
    }
  };
}

async function loadPersonalFiles() {
  filesListEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª...";

  const { data, error } = await supabaseClient
    .from("personal_files")
    .select("*")
    .order("updated_at", { ascending: false });

  if (error) {
    console.error(error);
    filesListEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –¥–µ–ª.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –¥–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  // –°–ù–ê–ß–ê–õ–ê —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
  personalFilesCache = data || [];

  // –ï—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ—Ç –¥–µ–ª –≤ –ë–î
  if (!personalFilesCache.length) {
    filesListEl.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    currentFileId = null;
    currentFileOwnerId = currentUser ? currentUser.id : null;
    currentFileEditable = false;
    fillPersonalForm(null, false);
  
    if (pfRepliesList) {
      pfRepliesList.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞.";
    }
    if (pfRepliesFormWrapper) {
      pfRepliesFormWrapper.style.display = "none";
    }
  
    // —Å–æ–∑–¥–∞—Ç—å –¥–µ–ª–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É
    if (createPersonalBtn) {
      createPersonalBtn.style.display = currentUser ? "inline-block" : "none";
    }
    return;
  }


  // ===== –µ—Å—Ç—å –¥–µ–ª–∞ ‚Äì —Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ =====
  filesListEl.innerHTML = "";

  const hasMyFile = currentUser
    ? personalFilesCache.some((f) => f.user_id === currentUser.id)
    : false;
  
  if (createPersonalBtn) {
    // –≥–æ—Å—Ç—å –Ω–µ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É
    createPersonalBtn.style.display = currentUser && !hasMyFile ? "inline-block" : "none";
  }

  const myFiles = personalFilesCache.filter(
  (f) => currentUser && f.user_id === currentUser.id
  );
  const others = personalFilesCache
    .filter((f) => !currentUser || f.user_id !== currentUser.id)
    .sort((a, b) =>
      (a.forum_nick || "").localeCompare(b.forum_nick || "", "ru")
    );

  const ordered = [...myFiles, ...others];

  ordered.forEach((file) => {
    const item = document.createElement("div");
    item.className = "file-item";
    if (file.user_id === currentUser.id) item.classList.add("me");
    item.dataset.id = file.id;

    const title = document.createElement("div");
    title.className = "file-title";
    const dept = file.forum_dept || "–û—Ç–¥–µ–ª";
    const nick = file.forum_nick || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
    const acc = file.account_number || "–Ω–æ–º–µ—Ä";
    title.textContent = `[${dept}] ${nick} [${acc}]`;

    const meta = document.createElement("div");
    meta.className = "file-meta";
    meta.textContent = file.rank
      ? `–ó–≤–∞–Ω–∏–µ: ${file.rank}`
      : "–ó–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ";

    item.appendChild(title);
    item.appendChild(meta);

    item.onclick = () => {
      openPersonalFile(file.id);
    };

    filesListEl.appendChild(item);
  });

  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å –¥–æ –≤—ã–±–æ—Ä–∞ –¥–µ–ª–∞
  currentFileId = null;
  currentFileOwnerId = currentUser.id;
  currentFileEditable = false;
  fillPersonalForm(null, false);
  if (pfRepliesList) {
    pfRepliesList.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞.";
  }
  if (pfRepliesFormWrapper) {
    pfRepliesFormWrapper.style.display = "none";
  }
}

if (pfForm) {
  pfForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser) return;

  pfSaveNote.textContent = "";
  pfSaveNote.style.color = "#9ca3af";

  if (!currentFileEditable) {
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    return;
  }

  const dept = pfDept.value.trim();
  const nick = pfNick.value.trim();
  const acc = pfAccount.value.trim();

  if (!dept || !nick || !acc) {
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º: –û—Ç–¥–µ–ª, –ò–º—è_–§–∞–º–∏–ª–∏—è –∏ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞.";
    return;
  }

  const payload = {
    forum_dept: dept,
    forum_nick: nick,
    account_number: acc,
    birth_date: pfBirth.value.trim(),
    badge_link: pfBadgeLink.value.trim(),
    rank: pfRank.value.trim(),
    phone: pfPhone.value.trim(),
    contact: pfContact.value.trim(),
  };

  let result;
  if (currentFileId) {
    result = await supabaseClient
      .from("personal_files")
      .update(payload)
      .eq("id", currentFileId)
      .select("*")
      .single();
  } else {
    payload.user_id = currentFileOwnerId || currentUser.id;
    result = await supabaseClient
      .from("personal_files")
      .insert(payload)
      .select("*")
      .single();
  }

  const { data, error } = result;
  if (error) {
    console.error(error);
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    showErrorModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  currentFileId = data.id;
  currentFileOwnerId = data.user_id;

  pfSaveNote.style.color = "#22c55e";
  pfSaveNote.textContent = "–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.";
  setTimeout(() => (pfSaveNote.textContent = ""), 2500);

  await loadPersonalFiles();
  pfEditMode = false;
  if (pfForm) pfForm.style.display = "none";
  if (pfView) pfView.style.display = "block";
  if (pfEditToggleBtn && currentFileEditable) {
    pfEditToggleBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
  }
  });
}

/* =============== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ / –†–£–ö–û–í–û–î–°–¢–í–û =============== */

const adminUsersListEl = document.getElementById("admin-users-list");
const adminAddBtn = document.getElementById("admin-add-user-btn");

const adminAddModal = document.getElementById("admin-add-modal");
const adminAddSearchInput = document.getElementById("admin-add-search");
const adminAddResults = document.getElementById("admin-add-results");
const adminStatusSelect = document.getElementById("admin-status-select");
const adminBorderColor = document.getElementById("admin-border-color");
const adminAddCancel = document.getElementById("admin-add-cancel");
const adminAddSave = document.getElementById("admin-add-save");


function isAdminLike(user) {
  if (!user) return false;
  return (
    user.role === "admin" ||
    user.role === "moderator" ||
    user.role === "creator"
  );
}


async function loadPersonalReplies(fileId) {
  if (!pfRepliesList) return;
  if (!fileId) {
    pfRepliesList.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞.";
    return;
  }

  pfRepliesList.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤...";

  const { data: replies, error } = await supabaseClient
    .from("personal_file_replies")
    .select("*")
    .eq("file_id", fileId)
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    pfRepliesList.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –ª–∏—á–Ω–æ–º—É –¥–µ–ª—É.");
    return;
  }

  if (!replies || !replies.length) {
    pfRepliesList.textContent = "–û—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.";
    return;
  }

  const userIds = [...new Set(replies.map((r) => r.user_id).filter(Boolean))];

  let usersMap = {};
  if (userIds.length) {
    const { data: usersData, error: usersError } = await supabaseClient
      .from("users")
      .select("id, nick, avatar_url, border_color, role")
      .in("id", userIds);

    if (!usersError && usersData) {
      usersMap = Object.fromEntries(usersData.map((u) => [u.id, u]));
    }
  }

  pfRepliesList.innerHTML = "";

  replies.forEach((r) => {
    const u = usersMap[r.user_id] || {};
    const isAdminAuthor = isAdminLike(u);
    const canModerate = isAdminLike(currentUser); // –∫—Ç–æ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å

    const card = document.createElement("div");
    card.className = "pf-reply-card";
    if (isAdminAuthor) {
      card.classList.add("admin-reply"); // —Ä–∞–º–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞/–º–æ–¥–∞ –∞–≤—Ç–æ—Ä–∞
    }

    const header = document.createElement("div");
    header.className = "pf-reply-header";

    const left = document.createElement("div");
    left.className = "pf-reply-author";
    left.textContent = u.nick || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.alignItems = "center";

    const dateEl = document.createElement("div");
    dateEl.textContent = r.created_at
      ? new Date(r.created_at).toLocaleString()
      : "";

    right.appendChild(dateEl);

    // –ö–Ω–æ–ø–∫–∏ "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –∏ "—É–¥–∞–ª–∏—Ç—å" —Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    if (canModerate) {
      const actions = document.createElement("div");
      actions.className = "pf-reply-actions";

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "pf-reply-action-btn";
      editBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
      editBtn.onclick = async () => {
        const newText = prompt("–ò–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:", r.message || "");
        if (newText === null) return;

        const trimmed = newText.trim();
        if (!trimmed) {
          if (!confirm("–¢–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π. –£–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç?")) return;
          await supabaseClient
            .from("personal_file_replies")
            .delete()
            .eq("id", r.id);
        } else {
          const { error: updError } = await supabaseClient
            .from("personal_file_replies")
            .update({ message: trimmed })
            .eq("id", r.id);
          if (updError) {
            console.error(updError);
            showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç.");
            return;
          }
        }
        await loadPersonalReplies(fileId);
      };

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "pf-reply-action-btn";
      delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
      delBtn.onclick = async () => {
        if (!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç?")) return;
        const { error: delError } = await supabaseClient
          .from("personal_file_replies")
          .delete()
          .eq("id", r.id);
        if (delError) {
          console.error(delError);
          showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç.");
          return;
        }
        await loadPersonalReplies(fileId);
      };

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      right.appendChild(actions);
    }

    header.appendChild(left);
    header.appendChild(right);

    const text = document.createElement("div");
    text.className = "pf-reply-text";
    text.textContent = r.message;

    card.appendChild(header);
    card.appendChild(text);

    pfRepliesList.appendChild(card);
  });
}

if (pfReplySendBtn) {
  pfReplySendBtn.onclick = async () => {
    if (!currentUser || !currentFileId) return;

    const canReply =
      currentUser.role === "admin" ||
      currentUser.role === "moderator" ||
      currentUser.role === "creator" ||
      currentUser.id === currentFileOwnerId;

    if (!canReply) {
      showErrorModal("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ —ç—Ç–æ–º –ª–∏—á–Ω–æ–º –¥–µ–ª–µ.");
      return;
    }

    const text = (pfReplyText.value || "").trim();
    if (!text) return;

    pfReplySendBtn.disabled = true;
    try {
      const { error } = await supabaseClient
        .from("personal_file_replies")
        .insert({
          file_id: currentFileId,
          user_id: currentUser.id,
          message: text
        });

      if (error) {
        console.error(error);
        showErrorModal("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞.");
        return;
      }

      pfReplyText.value = "";
      await loadPersonalReplies(currentFileId);
    } finally {
      pfReplySendBtn.disabled = false;
    }
  };
}

  
function updateRepliesAccess() {
  if (!pfRepliesFormWrapper) return;
  const canReply =
    currentUser &&
    currentFileId &&
    (
      currentUser.role === "admin" ||
      currentUser.role === "moderator" ||
      currentUser.role === "creator" ||
      currentUser.id === currentFileOwnerId
    );

  pfRepliesFormWrapper.style.display = canReply ? "block" : "none";
}

  
function leadershipPriority(user) {
  const s = (user.status || "").trim();

  if (s === "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É") return 0;
  if (s === "–ú–∏–Ω–∏—Å—Ç—Ä" || s === "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª") return 1;
  if (s === "–ö—É—Ä–∞—Ç–æ—Ä") return 2;
  if (s === "–ì–µ–Ω–µ—Ä–∞–ª LSPD" || s === "–ì–µ–Ω–µ—Ä–∞–ª SFPD" || s === "–ì–µ–Ω–µ—Ä–∞–ª LVPD") return 3;
  return 4;
}

async function loadExamQuestionsForAdmin() {
  if (!examAdminList) return;
  const examType = examAdminTypeSelect.value;

  examAdminList.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...";

  const { data, error } = await supabaseClient
    .from("exam_questions")
    .select("*")
    .eq("exam_type", examType)
    .order("id", { ascending: true });

  if (error) {
    console.error(error);
    examAdminList.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤.";
    return;
  }

  if (!data || !data.length) {
    examAdminList.textContent = "–í–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å¬ª.";
    return;
  }

  examAdminList.innerHTML = "";

  data.forEach((q) => {
    const card = document.createElement("div");
    card.className = "admin-user-card";

    const main = document.createElement("div");
    main.className = "admin-user-main";
    main.style.gridColumn = "1 / -1";

    const title = document.createElement("div");
    title.style.fontSize = "13px";
    title.style.marginBottom = "4px";
    title.textContent = q.question_text;

    const meta = document.createElement("div");
    meta.className = "admin-user-meta";
    meta.textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${q.correct_option || "–Ω–µ —É–∫–∞–∑–∞–Ω"}`;

    main.appendChild(title);
    main.appendChild(meta);

    if (q.image_data) {
      const img = document.createElement("img");
      img.src = q.image_data;
      img.style.maxWidth = "120px";
      img.style.maxHeight = "80px";
      img.style.borderRadius = "6px";
      img.style.border = "1px solid var(--border)";
      img.style.marginTop = "4px";
      img.style.cursor = "zoom-in";
      img.onclick = () => {
        const overlay = document.createElement("div");
        overlay.className = "exam-image-large";
        const bigImg = document.createElement("img");
        bigImg.src = q.image_data;
        overlay.appendChild(bigImg);
        overlay.onclick = () => document.body.removeChild(overlay);
        document.body.appendChild(overlay);
      };
      main.appendChild(img);
    }

    const actions = document.createElement("div");
    actions.className = "admin-user-actions";

    const editBtn = document.createElement("button");
    editBtn.className = "btn-outline btn-sm";
    editBtn.type = "button";
    editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
    editBtn.onclick = () => {
      examAdminCurrentId = q.id;
      examQuestionText.value = q.question_text || "";
      examOptionA.value = q.option_a || "";
      examOptionB.value = q.option_b || "";
      examOptionC.value = q.option_c || "";
      examOptionD.value = q.option_d || "";
      examCorrectOption.value = q.correct_option || "";
      examAdminImageData = q.image_data || null;
      examImageInput.value = "";
      examAdminForm.style.display = "block";
    };

    const delBtn = document.createElement("button");
    delBtn.className = "btn-outline btn-sm";
    delBtn.type = "button";
    delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
    delBtn.onclick = async () => {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?")) return;
      const { error: delError } = await supabaseClient
        .from("exam_questions")
        .delete()
        .eq("id", q.id);
      if (delError) {
        console.error(delError);
        showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å.");
        return;
      }
      await loadExamQuestionsForAdmin();
    };

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    main.appendChild(actions);

    card.appendChild(main);
    examAdminList.appendChild(card);
  });
}

const examHistoryList = document.getElementById("exam-history-list");
const examHistoryTabs = document.querySelectorAll(".exam-history-tab");

if (examHistoryTabs) {
  examHistoryTabs.forEach((btn) => {
    btn.onclick = () => {
      const type = btn.dataset.type;
      examHistoryTabs.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      loadExamHistory(type);
    };
  });
}

async function loadExamHistory(type) {
  if (!examHistoryList) return;
  if (!currentUser) {
    examHistoryList.textContent = "–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.";
    return;
  }

  examHistoryList.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

  if (type === "rookie" || type === "captain") {
    const { data, error } = await supabaseClient
      .from("exam_attempts")
      .select("*")
      .eq("user_id", currentUser.id)
      .eq("exam_type", type)
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      examHistoryList.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.";
      return;
    }

    if (!data || !data.length) {
      examHistoryList.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ —Å–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç–∫–∑–∞–º–µ–Ω–∞.";
      return;
    }

    examHistoryList.innerHTML = "";
    data.forEach((row) => {
      const card = document.createElement("div");
      card.className = "exam-history-card";

      const nickEl = document.createElement("div");
      nickEl.className = "exam-history-nick";
      nickEl.textContent = currentUser.nick;

      const meta = document.createElement("div");
      meta.className = "exam-history-meta";
      meta.textContent = new Date(row.created_at).toLocaleString();

      const status = document.createElement("div");
      status.className =
        "exam-history-status " + (row.passed ? "passed" : "failed");
      status.textContent = row.passed ? "–°–¥–∞–Ω–æ" : "–ù–µ —Å–¥–∞–Ω–æ";

      const score = document.createElement("div");
      score.className = "exam-history-meta";
      score.textContent = `–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${row.score} / ${row.total_questions}`;

      card.appendChild(nickEl);
      card.appendChild(meta);
      card.appendChild(status);
      card.appendChild(score);

      examHistoryList.appendChild(card);
    });

    return;
  }

  if (type === "resume") {
    examHistoryList.textContent =
      "–ò—Å—Ç–æ—Ä–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö —Ä–µ–∑—é–º–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.";
  }
}


/* EXAM ADMIN DOM: DOM-—Å—Å—ã–ª–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û–õ–ñ–ù–´ –∏–¥—Ç–∏ –í–´–®–ï, —á–µ–º –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è */
const examAdminPanel = document.getElementById("exam-admin-panel");
const examAdminTypeSelect = document.getElementById("exam-admin-type");
const examAdminNewBtn = document.getElementById("exam-admin-new");
const examAdminForm = document.getElementById("exam-admin-form");
const examQuestionText = document.getElementById("exam-question-text");
const examOptionA = document.getElementById("exam-option-a");
const examOptionB = document.getElementById("exam-option-b");
const examOptionC = document.getElementById("exam-option-c");
const examOptionD = document.getElementById("exam-option-d");
const examCorrectOption = document.getElementById("exam-correct-option");
const examImageInput = document.getElementById("exam-image-input");
const examAdminCancel = document.getElementById("exam-admin-cancel");
const examAdminSave = document.getElementById("exam-admin-save");
const examAdminList = document.getElementById("exam-admin-list");

let examAdminCurrentId = null;
let examAdminImageData = null;

async function loadAdminPanel() {
  if (!currentUser) {
    adminUsersListEl.textContent = "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.";
    if (adminAddBtn) adminAddBtn.style.display = "none";
    if (examAdminPanel) examAdminPanel.style.display = "none";
    return;
  }

  const isAdminOrMod =
    currentUser.role === "admin" ||
    currentUser.role === "moderator" ||
    currentUser.role === "creator";

  if (!isAdminOrMod) {
    adminUsersListEl.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.";
    if (adminAddBtn) adminAddBtn.style.display = "none";
    if (examAdminPanel) examAdminPanel.style.display = "none";
    return;
  }

  const canUseAddBtn =
    currentUser.role === "admin" || currentUser.role === "creator";

  if (adminAddBtn) {
    adminAddBtn.style.display = canUseAddBtn ? "inline-block" : "none";
  }

  adminUsersListEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, nick, department, role, avatar_url, created_at, status, border_color, sort_order")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    adminUsersListEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  let arr = data || [];
  arr.sort((a, b) => {
    const pA = leadershipPriority(a);
    const pB = leadershipPriority(b);
    if (pA !== pB) return pA - pB;

    const soA = a.sort_order ?? 9999;
    const soB = b.sort_order ?? 9999;
    if (soA !== soB) return soA - soB;

    return (a.nick || "").localeCompare(b.nick || "", "ru");
  });

  adminUsersCache = arr;
  renderAdminUsers();

  // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–ø—Ä—è—Ç–∞—Ç—å –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞–º–∏ —ç–∫–∑–∞–º–µ–Ω–∞
  if (examAdminPanel) {
    examAdminPanel.style.display = isAdminOrMod ? "block" : "none";
    if (isAdminOrMod) {
      loadExamQuestionsForAdmin();
    }
  }
}


  const isAdminOrMod = currentUser &&
  (currentUser.role === "admin" ||
   currentUser.role === "moderator" ||
   currentUser.role === "creator");

  if (!isAdminOrMod) {
    adminUsersListEl.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.";
    if (adminAddBtn) adminAddBtn.style.display = "none";
    return;
  }

  const canUseAddBtn =
    currentUser.role === "admin" || currentUser.role === "creator";

  if (adminAddBtn) {
    adminAddBtn.style.display = canUseAddBtn ? "inline-block" : "none";
  }

  adminUsersListEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, nick, department, role, avatar_url, created_at, status, border_color, sort_order")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    adminUsersListEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  let arr = data || [];

  arr.sort((a, b) => {
    const pA = leadershipPriority(a);
    const pB = leadershipPriority(b);
    if (pA !== pB) return pA - pB;

    const soA = a.sort_order ?? 9999;
    const soB = b.sort_order ?? 9999;
    if (soA !== soB) return soA - soB;

    return (a.nick || "").localeCompare(b.nick || "", "ru");
  });

  adminUsersCache = arr;
  renderAdminUsers();
  // –ü–æ–∫–∞–∑ / —Å–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
  if (examAdminPanel) {
    examAdminPanel.style.display = isAdminOrMod ? "block" : "none";
    if (isAdminOrMod) {
      loadExamQuestionsForAdmin();
    }
  }
}

async function updateUserFields(userId, patch) {
  // –∑–∞–ø—Ä–µ—Ç –∞–¥–º–∏–Ω–∞–º –º–µ–Ω—è—Ç—å —Å–µ–±–µ —Ä–æ–ª—å
  if (patch.role && currentUser && userId === currentUser.id) {
    showErrorModal("–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞.");
    delete patch.role;
  }

  if (Object.keys(patch).length === 0) return;

  const { data, error } = await supabaseClient
    .from("users")
    .update(patch)
    .eq("id", userId)
    .select("*")
    .single();

  if (error) {
    console.error(error);
    showErrorModal("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
    return;
  }

  const idx = adminUsersCache.findIndex((u) => u.id === userId);
  if (idx >= 0) adminUsersCache[idx] = data;

  if (currentUser && currentUser.id === userId) {
    currentUser = { ...currentUser, ...data };
    saveSession(currentUser);
    refreshTopBar();
  }

  renderAdminUsers();
}

async function adminChangeAvatarForUser(user, file) {
  try {
    const reader = new FileReader();
    reader.onload = async () => {
      const avatarDataUrl = reader.result;
      await updateUserFields(user.id, { avatar_url: avatarDataUrl });
    };
    reader.onerror = () => {
      showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞.");
    };
    reader.readAsDataURL(file);
  } catch (e) {
    console.error(e);
    showErrorModal("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.");
  }
}

function renderAdminUsers() {
  adminUsersListEl.innerHTML = "";

  if (!adminUsersCache.length) {
    adminUsersListEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.";
    return;
  }

  const isAdmin = currentUser && (currentUser.role === "admin" || currentUser.role === "creator");
  const isModerator = currentUser && currentUser.role === "moderator";
  const isOfficer = !isAdmin && !isModerator;

  let list = adminUsersCache;

  if (isOfficer) {
    list = adminUsersCache.filter(
      (u) => u.role === "admin" || u.role === "moderator"
    );
    if (!list.length) {
      adminUsersListEl.textContent = "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
      return;
    }
  }

  list.forEach((user) => {
    const card = document.createElement("div");
    card.className = "admin-user-card";

    const avatar = document.createElement("div");
    avatar.className = "admin-user-avatar";
    avatar.style.borderColor = user.border_color || "#374151";
    if (user.avatar_url) {
      const img = document.createElement("img");
      img.src = user.avatar_url;
      avatar.appendChild(img);
    } else {
      avatar.textContent = user.nick ? user.nick[0] : "?";
    }

    const main = document.createElement("div");
    main.className = "admin-user-main";

    const header = document.createElement("div");
    header.className = "admin-user-header";

    const nickEl = document.createElement("div");
    nickEl.className = "admin-user-nick";
    nickEl.textContent = user.nick;

    const roleBadge = document.createElement("div");
    roleBadge.className = "admin-role-badge " + (user.role || "user");
    roleBadge.textContent = roleLabel(user.role || "user");

    header.appendChild(nickEl);
    header.appendChild(roleBadge);

    const meta1 = document.createElement("div");
    meta1.className = "admin-user-meta";
    if (user.role === "admin" && user.status) {
      meta1.textContent = `–°—Ç–∞—Ç—É—Å: ${user.status}`;
    } else if (user.role === "admin" && !user.status) {
      meta1.textContent = "–°—Ç–∞—Ç—É—Å: –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
    } else {
      meta1.textContent = `–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: ${user.department || "‚Äî"}`;
    }

    const meta2 = document.createElement("div");
    meta2.className = "admin-user-meta";
    meta2.textContent = user.created_at
      ? `–°–æ–∑–¥–∞–Ω: ${new Date(user.created_at).toLocaleString()}`
      : "";

    main.appendChild(header);
    main.appendChild(meta1);
    if (meta2.textContent) main.appendChild(meta2);

    if (!isOfficer) {
      const actions = document.createElement("div");
      actions.className = "admin-user-actions";
    
      // creator = —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω
      const isCurrentCreator = currentUser && currentUser.role === "creator";
      const canEdit = isAdmin; // admin + creator
      let canChangeRole = isAdmin && (!currentUser || user.id !== currentUser.id);
    
      // –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–º–µ–Ω–Ω–æ –ê–î–ú–ò–ù–£ –º–µ–Ω—è—Ç—å —Ä–æ–ª—å –¥—Ä—É–≥–∏–º –∞–¥–º–∏–Ω–∞–º –∏ creator'–∞–º
      if (
        currentUser &&
        currentUser.role === "admin" &&
        (user.role === "admin" || user.role === "creator")
      ) {
        canChangeRole = false;
      }
    
      // --- SELECT —Ä–æ–ª–µ–π ---
      const roleSelect = document.createElement("select");
      roleSelect.className = "admin-select";
    
      // –ö–∞–∫–∏–µ —Ä–æ–ª–∏ –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å:
      // creator –º–æ–∂–µ—Ç —Å—Ç–∞–≤–∏—Ç—å user/moderator/admin
      // admin ‚Äî —Ç–æ–ª—å–∫–æ user/moderator (–æ—Ñ–∏—Ü–µ—Ä –∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä)
      let roleOptions;
      if (isCurrentCreator) {
        roleOptions = ["user", "moderator", "admin"];
      } else {
        roleOptions = ["user", "moderator"];
      }
    
      roleOptions.forEach((r) => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = roleLabel(r);
        roleSelect.appendChild(opt);
      });
    
      // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–µ–π—á–∞—Å –∫–∞–∫–∞—è-—Ç–æ —Ä–æ–ª—å –≤–Ω–µ —Å–ø–∏—Å–∫–∞ (admin –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ admin –∏–ª–∏ creator),
      // –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –≤ select
      if (user.role && !roleOptions.includes(user.role)) {
        const opt = document.createElement("option");
        opt.value = user.role;
        opt.textContent = roleLabel(user.role);
        roleSelect.appendChild(opt);
      }
    
      roleSelect.value = user.role || "user";
    
      // creator –≤–æ–æ–±—â–µ –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ select
      if (user.role === "creator") {
        roleSelect.disabled = true;
      } else {
        roleSelect.disabled = !canChangeRole;
      }
    
      if (canChangeRole) {
        roleSelect.onchange = async () => {
          await updateUserFields(user.id, { role: roleSelect.value });
        };
      }
    
      // === –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ actions –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏ ===
      const statusSelect = document.createElement("select");
      statusSelect.className = "admin-select";
      [
        "",
        "–ö—É—Ä–∞—Ç–æ—Ä",
        "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É",
        "–ú–∏–Ω–∏—Å—Ç—Ä",
        "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª",
        "–ì–µ–Ω–µ—Ä–∞–ª LSPD",
        "–ì–µ–Ω–µ—Ä–∞–ª SFPD",
        "–ì–µ–Ω–µ—Ä–∞–ª LVPD"
      ].forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val || "–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞";
        statusSelect.appendChild(opt);
      });
      statusSelect.value = user.status || "";
      statusSelect.disabled = !canEdit;
    
      const colorInput = document.createElement("input");
      colorInput.type = "color";
      colorInput.className = "admin-color";
      colorInput.value = user.border_color || "#3a7ca5";
      colorInput.disabled = !canEdit;
    
      const orderInput = document.createElement("input");
      orderInput.type = "number";
      orderInput.className = "order-input";
      orderInput.value = user.sort_order ?? "";
      orderInput.placeholder = "#";
      orderInput.disabled = !canEdit;
    
      const avatarInput = document.createElement("input");
      avatarInput.type = "file";
      avatarInput.accept = "image/*";
      avatarInput.className = "admin-avatar-input";
      avatarInput.disabled = !canEdit;
    
      if (canEdit) {
        statusSelect.onchange = async () => {
          const newStatus = statusSelect.value;
    
          const patch = { status: newStatus };
    
          if (newStatus === "–ì–µ–Ω–µ—Ä–∞–ª LSPD") {
            patch.is_officer = true;
            patch.department = "LSPD";
          } else if (newStatus === "–ì–µ–Ω–µ—Ä–∞–ª SFPD") {
            patch.is_officer = true;
            patch.department = "SFPD";
          } else if (newStatus === "–ì–µ–Ω–µ—Ä–∞–ª LVPD") {
            patch.is_officer = true;
            patch.department = "LVPD";
          } else if (newStatus === "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª") {
            patch.is_officer = true;
          }
    
          await updateUserFields(user.id, patch);
        };
    
        colorInput.onchange = async () => {
          await updateUserFields(user.id, { border_color: colorInput.value });
        };
    
        orderInput.onchange = async () => {
          const v = orderInput.value === "" ? null : Number(orderInput.value);
          await updateUserFields(user.id, { sort_order: v });
        };
    
        avatarInput.onchange = async () => {
          const file = avatarInput.files[0];
          if (!file) return;
          await adminChangeAvatarForUser(user, file);
        };
      }
    
      actions.appendChild(roleSelect);
      actions.appendChild(statusSelect);
      actions.appendChild(colorInput);
      actions.appendChild(orderInput);
      actions.appendChild(avatarInput);
    
      main.appendChild(actions);
    }

    card.appendChild(avatar);
    card.appendChild(main);
    adminUsersListEl.appendChild(card);
  });
}

function makeCircleCardFromUser(u, customRoleText) {
  const wrap = document.createElement("div");
  wrap.className = "circle-leader-card";

  const avatar = document.createElement("div");
  avatar.className = "circle-avatar";
  // –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –º–æ–∂–Ω–æ –æ—Ç—Ç–µ–Ω–∫–∏
  if ((u.status || "").includes("–ú–∏–Ω–∏—Å—Ç—Ä")) {
    avatar.classList.add("circle-avatar-minister");
  } else if ((u.status || "").includes("–ì–µ–Ω–µ—Ä–∞–ª")) {
    avatar.classList.add("circle-avatar-general");
  }

  avatar.style.borderColor = u.border_color || avatar.style.borderColor || "#facc15";

  if (u.avatar_url) {
    const img = document.createElement("img");
    img.src = u.avatar_url;
    avatar.appendChild(img);
  } else {
    avatar.textContent = u.nick ? u.nick[0] : "?";
  }

  const label = document.createElement("div");
  label.className = "circle-label";

  const spanName = document.createElement("span");
  spanName.className = "name";
  spanName.textContent = u.nick;

  const spanRole = document.createElement("span");
  spanRole.className = "role";
  spanRole.textContent = customRoleText || (u.status || "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ");

  label.appendChild(spanName);
  label.appendChild(spanRole);

  wrap.appendChild(avatar);
  wrap.appendChild(label);

  return wrap;
}

function renderLeadershipTree(targetEl) {
  targetEl.innerHTML = "";

  const all = adminUsersCache || [];

  const responsible = all.find((u) => u.status === "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É");
  const minister = all.find(
    (u) => u.status === "–ú–∏–Ω–∏—Å—Ç—Ä" || u.status === "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª"
  );
  const curators = all.filter((u) => u.status === "–ö—É—Ä–∞—Ç–æ—Ä");
  const generals = all.filter((u) =>
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª LSPD" ||
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª SFPD" ||
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª LVPD"
  );

  const layout = document.createElement("div");
  layout.className = "leadership-layout";

  if (responsible) {
    const wrap = document.createElement("div");
    wrap.className = "circle-leader-wrapper";
    wrap.appendChild(makeCircleCardFromUser(responsible, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É"));
    layout.appendChild(wrap);
  }

  if (minister) {
    const wrap = document.createElement("div");
    wrap.className = "circle-leader-wrapper";
    wrap.appendChild(makeCircleCardFromUser(minister, minister.status || "–ú–∏–Ω–∏—Å—Ç—Ä"));
    layout.appendChild(wrap);
  }

  if (curators.length) {
    const row = document.createElement("div");
    row.className = "leadership-row";
    curators.forEach((u) => {
      row.appendChild(makeCircleCardFromUser(u, "–ö—É—Ä–∞—Ç–æ—Ä"));
    });
    layout.appendChild(row);
  }

  if (generals.length) {
    const row = document.createElement("div");
    row.className = "leadership-row";
    generals.forEach((u) => {
      let roleLabel = u.status;
      if (u.status === "–ì–µ–Ω–µ—Ä–∞–ª LSPD") roleLabel = "–ì–µ–Ω–µ—Ä–∞–ª LSPD";
      if (u.status === "–ì–µ–Ω–µ—Ä–∞–ª SFPD") roleLabel = "–ì–µ–Ω–µ—Ä–∞–ª SFPD";
      if (u.status === "–ì–µ–Ω–µ—Ä–∞–ª LVPD") roleLabel = "–ì–µ–Ω–µ—Ä–∞–ª LVPD";
      row.appendChild(makeCircleCardFromUser(u, roleLabel));
    });
    layout.appendChild(row);
  }

  if (!responsible && !minister && !curators.length && !generals.length) {
    const empty = document.createElement("div");
    empty.className = "panel-note";
    empty.textContent = "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ.";
    layout.appendChild(empty);
  }

  targetEl.appendChild(layout);
}

async function loadLeadership() {
  if (!currentUser || !leadershipContainer) return;

  leadershipContainer.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞...";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, nick, department, role, avatar_url, created_at, status, border_color, sort_order")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    leadershipContainer.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  let arr = data || [];

  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º, –∫–∞–∫ –≤ –∞–¥–º–∏–Ω–∫–µ: –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É, –ø–æ—Ç–æ–º –ø–æ sort_order, –ø–æ—Ç–æ–º –ø–æ –Ω–∏–∫—É
  arr.sort((a, b) => {
    const pA = leadershipPriority(a);
    const pB = leadershipPriority(b);
    if (pA !== pB) return pA - pB;

    const soA = a.sort_order ?? 9999;
    const soB = b.sort_order ?? 9999;
    if (soA !== soB) return soA - soB;

    return (a.nick || "").localeCompare(b.nick || "", "ru");
  });

  adminUsersCache = arr;
  renderLeadershipTree(leadershipContainer);
}


/* ---------- –ú–æ–¥–∞–ª–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å / –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" ---------- */

function renderAdminAddResults(filterText) {
  adminAddResults.innerHTML = "";

  const text = (filterText || "").toLowerCase();
  const list = adminUsersCache.filter((u) =>
    !text ? true : (u.nick || "").toLowerCase().includes(text)
  );

  if (!list.length) {
    adminAddResults.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
    return;
  }

  list.forEach((u) => {
    const item = document.createElement("div");
    item.className = "search-result-item";
    item.dataset.id = u.id;
    item.textContent = `${u.nick} (${roleLabel(u.role)})`;
    if (adminSelectedUserId === u.id) {
      item.style.background = "#1f2937";
    }
    item.onclick = () => {
      adminSelectedUserId = u.id;
      adminStatusSelect.value = u.status || "";
      adminBorderColor.value = u.border_color || "#3a7ca5";
      renderAdminAddResults(text);
    };
    adminAddResults.appendChild(item);
  });
}

function openAdminAddModal() {
  if (!currentUser || currentUser.role !== "admin") return;
  adminSelectedUserId = null;
  adminAddSearchInput.value = "";
  renderAdminAddResults("");
  adminStatusSelect.value = "";
  adminBorderColor.value = "#3a7ca5";
  adminAddModal.classList.add("active");
}
function closeAdminAddModal() {
  adminAddModal.classList.remove("active");
}

adminAddBtn.onclick = openAdminAddModal;
adminAddCancel.onclick = closeAdminAddModal;

adminAddSearchInput.addEventListener("input", (e) => {
  renderAdminAddResults(e.target.value);
});

adminAddSave.onclick = async () => {
  if (!adminSelectedUserId) {
    showErrorModal("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞.");
    return;
  }
  const status = adminStatusSelect.value;
  const color = adminBorderColor.value || "#3a7ca5";

  await updateUserFields(adminSelectedUserId, {
    status,
    border_color: color,
  });

  closeAdminAddModal();
};

/* =============== –û–§–ò–¶–ï–†–´ =============== */

const officersAddBtn = document.getElementById("officers-add-btn");
const officersAddBlock = document.getElementById("officers-add-block");
const officersAddUserSelect = document.getElementById("officers-add-user-select");
const officersAddDept = document.getElementById("officers-add-dept");
const officersAddVk = document.getElementById("officers-add-vk");
const officersAddTg = document.getElementById("officers-add-tg");
const officersMinisterEl = document.getElementById("officers-minister");
const officersColLSPD = document.getElementById("officers-col-lspd");
const officersColSFPD = document.getElementById("officers-col-sfpd");
const officersColLVPD = document.getElementById("officers-col-lvpd");

async function loadOfficers() {
  if (!currentUser) return;

  const isAdminOrMod =
  currentUser.role === "admin" ||
  currentUser.role === "moderator" ||
  currentUser.role === "creator";


  if (officersAddBtn) officersAddBtn.style.display = isAdminOrMod ? "inline-block" : "none";
  if (!isAdminOrMod && officersAddBlock) officersAddBlock.style.display = "none";

  officersMinisterEl.innerHTML = "";
  officersColLSPD.innerHTML = "";
  officersColSFPD.innerHTML = "";
  officersColLVPD.innerHTML = "";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, nick, department, role, avatar_url, status, border_color, vk, telegram, is_officer, officer_order")
    .order("officer_order", { ascending: true })
    .order("nick", { ascending: true });

  if (error) {
    console.error(error);
    officersColLSPD.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ–∏—Ü–µ—Ä–æ–≤.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –æ—Ñ–∏—Ü–µ—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  officersCache = (data || []).filter((u) =>
    u.is_officer ||
    u.status === "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª" ||
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª LSPD" ||
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª SFPD" ||
    u.status === "–ì–µ–Ω–µ—Ä–∞–ª LVPD"
  );

  // ===== –ú–∏–Ω–∏—Å—Ç—Ä (—Å–∞–º—ã–π –≤–µ—Ä—Ö, –∫—Ä—É–≥–ª–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞) =====
  const minister = officersCache.find((u) => u.status === "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª");
  if (minister) {
    const wrap = document.createElement("div");
    wrap.className = "circle-leader-wrapper";

    const card = document.createElement("div");
    card.className = "circle-leader-card";

    const avatar = document.createElement("div");
    avatar.className = "circle-avatar circle-avatar-minister";
    avatar.style.borderColor = minister.border_color || "#38bdf8";
    if (minister.avatar_url) {
      const img = document.createElement("img");
      img.src = minister.avatar_url;
      avatar.appendChild(img);
    } else {
      avatar.textContent = minister.nick ? minister.nick[0] : "?";
    }

    const label = document.createElement("div");
    label.className = "circle-label";
    const spanName = document.createElement("span");
    spanName.className = "name";
    spanName.textContent = minister.nick;
    const spanRole = document.createElement("span");
    spanRole.className = "role";
    spanRole.textContent = "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª";

    label.appendChild(spanName);
    label.appendChild(spanRole);

    card.appendChild(avatar);
    card.appendChild(label);
    wrap.appendChild(card);

    officersMinisterEl.className = "circle-leader-wrapper";
    officersMinisterEl.innerHTML = "";
    officersMinisterEl.appendChild(wrap);
  } else {
    officersMinisterEl.innerHTML = "";
  }

  // ===== –ì–µ–Ω–µ—Ä–∞–ª—ã –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞–º =====
  const generals = {
    LSPD: officersCache.find((u) => u.status === "–ì–µ–Ω–µ—Ä–∞–ª LSPD"),
    SFPD: officersCache.find((u) => u.status === "–ì–µ–Ω–µ—Ä–∞–ª SFPD"),
    LVPD: officersCache.find((u) => u.status === "–ì–µ–Ω–µ—Ä–∞–ª LVPD"),
  };

  function renderOfficerUser(u, colEl, highlightAsGeneral) {
    const card = document.createElement("div");
    card.className = "officer-card";
    if (highlightAsGeneral) {
      card.style.borderColor = "#facc15";
    }

    const avatar = document.createElement("div");
    avatar.className = "officer-card-avatar";
    avatar.style.borderColor = u.border_color || "#374151";
    if (u.avatar_url) {
      const img = document.createElement("img");
      img.src = u.avatar_url;
      avatar.appendChild(img);
    } else {
      avatar.textContent = u.nick ? u.nick[0] : "?";
    }

    const main = document.createElement("div");
    main.className = "officer-card-main";
    const nickEl = document.createElement("div");
    nickEl.className = "nick";
    nickEl.textContent = u.nick;
    const info = document.createElement("div");
    info.className = "info";
    info.textContent = u.status || `–û—Ñ–∏—Ü–µ—Ä ${u.department || ""}`;

    const links = document.createElement("div");
    links.className = "officer-links";
    if (u.vk) {
      const btnVk = document.createElement("button");
      btnVk.type = "button";
      btnVk.textContent = "VK";
      btnVk.onclick = () => window.open(u.vk, "_blank");
      links.appendChild(btnVk);
    }
    if (u.telegram) {
      const btnTg = document.createElement("button");
      btnTg.type = "button";
      btnTg.textContent = "Telegram";
      btnTg.onclick = () => window.open(u.telegram, "_blank");
      links.appendChild(btnTg);
    }

    main.appendChild(nickEl);
    main.appendChild(info);
    if (links.children.length) main.appendChild(links);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.flexDirection = "column";
    right.style.alignItems = "flex-end";
    right.style.gap = "4px";

    const isAdminOrModInner =
      currentUser &&
      (currentUser.role === "admin" ||
       currentUser.role === "moderator" ||
       currentUser.role === "creator");

    const isSelf = currentUser && currentUser.id === u.id;

    if (isAdminOrModInner) {
      const orderInput = document.createElement("input");
      orderInput.type = "number";
      orderInput.className = "order-input";
      orderInput.value = u.officer_order ?? "";
      orderInput.placeholder = "#";
      orderInput.onchange = async () => {
        const v = orderInput.value === "" ? null : Number(orderInput.value);
        await updateUserFields(u.id, { officer_order: v });
      };
      right.appendChild(orderInput);
    }

    if (isAdminOrModInner || isSelf) {
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "btn-outline btn-sm";
      editBtn.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      editBtn.onclick = async () => {
        const newDept = prompt("–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç (LSPD/SFPD/LVPD):", u.department || "");
        if (newDept === null) return;
        const newVk = prompt("VK (—Å—Å—ã–ª–∫–∞):", u.vk || "");
        if (newVk === null) return;
        const newTg = prompt("Telegram (—Å—Å—ã–ª–∫–∞):", u.telegram || "");
        if (newTg === null) return;
        await updateUserFields(u.id, {
          department: newDept.trim(),
          vk: newVk.trim(),
          telegram: newTg.trim(),
        });
        await loadOfficers();
      };
      right.appendChild(editBtn);
    }

    if (isAdminOrModInner) {
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "btn-outline btn-sm";
      removeBtn.textContent = "–£–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞";
      removeBtn.onclick = async () => {
        if (!confirm(`–£–±—Ä–∞—Ç—å ${u.nick} –∏–∑ —Å–ø–∏—Å–∫–∞ –æ—Ñ–∏—Ü–µ—Ä–æ–≤?`)) return;
        await updateUserFields(u.id, { is_officer: false, officer_order: null });
        await loadOfficers();
      };
      right.appendChild(removeBtn);
    }

    card.appendChild(avatar);
    card.appendChild(main);
    card.appendChild(right);

    colEl.appendChild(card);
  }

  function renderDept(deptCode, colEl, labelForLeader) {
    colEl.innerHTML = "";

    const leader = generals[deptCode];

    // –ö—Ä—É–≥–ª–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ì–µ–Ω–µ—Ä–∞–ª–∞ –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
    if (leader) {
      const wrap = document.createElement("div");
      wrap.className = "circle-leader-wrapper";

      const card = document.createElement("div");
      card.className = "circle-leader-card";

      const avatar = document.createElement("div");
      avatar.className = "circle-avatar circle-avatar-general";
      avatar.style.borderColor = leader.border_color || "#facc15";
      if (leader.avatar_url) {
        const img = document.createElement("img");
        img.src = leader.avatar_url;
        avatar.appendChild(img);
      } else {
        avatar.textContent = leader.nick ? leader.nick[0] : "?";
      }

      const label = document.createElement("div");
      label.className = "circle-label";
      const spanName = document.createElement("span");
      spanName.className = "name";
      spanName.textContent = leader.nick;
      const spanRole = document.createElement("span");
      spanRole.className = "role";
      spanRole.textContent = `–ì–µ–Ω–µ—Ä–∞–ª ${labelForLeader}`;

      label.appendChild(spanName);
      label.appendChild(spanRole);

      card.appendChild(avatar);
      card.appendChild(label);
      wrap.appendChild(card);

      colEl.appendChild(wrap);
    }

    // –ù–∏–∂–µ ‚Äî –æ–±—ã—á–Ω—ã–π —Å–æ—Å—Ç–∞–≤
    officersCache
      .filter((u) =>
        u.department === deptCode &&
        (!leader || u.id !== leader.id) &&
        u.status !== "–ú–∏–Ω–∏—Å—Ç—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª"
      )
      .forEach((u) => renderOfficerUser(u, colEl, false));
  }

  renderDept("LSPD", officersColLSPD, "LSPD");
  renderDept("SFPD", officersColSFPD, "SFPD");
  renderDept("LVPD", officersColLVPD, "LVPD");
}

if (officersAddBtn) {
  officersAddBtn.onclick = async () => {
    if (
      !currentUser ||
      !["admin", "moderator", "creator"].includes(currentUser.role)
    ) return;

    officersAddBlock.style.display =
      officersAddBlock.style.display === "none" || !officersAddBlock.style.display
        ? "block"
        : "none";

    if (officersAddBlock.style.display === "block") {
      const { data, error } = await supabaseClient
        .from("users")
        .select("id, nick, is_officer")
        .order("nick", { ascending: true });

      if (error) {
        console.error(error);
        showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ñ–∏—Ü–µ—Ä–∞.");
        return;
      }

      officersAddUserSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶";
      officersAddUserSelect.appendChild(placeholder);

      (data || [])
        .filter((u) => !u.is_officer)
        .forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.nick;
          officersAddUserSelect.appendChild(opt);
        });
    }
  };
}

if (document.getElementById("officers-add-save")) {
  document.getElementById("officers-add-save").onclick = async () => {
    if (!currentUser || !["admin", "moderator", "creator"].includes(currentUser.role)) return;

    const userId = Number(officersAddUserSelect.value);
    const dept = officersAddDept.value.trim();
    const vk = officersAddVk.value.trim();
    const tg = officersAddTg.value.trim();

    if (!userId || !dept) {
      showErrorModal("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–∫–∞–∂–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç.");
      return;
    }

    await updateUserFields(userId, {
      is_officer: true,
      department: dept,
      vk: vk || null,
      telegram: tg || null,
    });

    officersAddBlock.style.display = "none";
    officersAddUserSelect.value = "";
    officersAddDept.value = "";
    officersAddVk.value = "";
    officersAddTg.value = "";

    await loadOfficers();
  };
}
</script>
</body>
</html>















