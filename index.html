<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Police Platinum ‚Äî –ü–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #0b1220;
      --bg-light: #111827;
      --bg-lighter: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #374151;
      --accent: #2563eb;
      --accent-hover: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
      --input-bg: #020617;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      background: #0f172a;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    #app {
      width: 100%;
      max-width: 1280px;
    }

    a {
      color: var(--accent-hover);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* ---------- –ö–Ω–æ–ø–∫–∏ ---------- */

    .btn {
      padding: 8px 16px;
      background: var(--accent);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.7);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-outline {
      padding: 8px 16px;
      background: var(--bg-lighter);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.6);
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
    }
    .btn-outline:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* ---------- –ò–Ω–ø—É—Ç—ã ---------- */

    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
    }
    .field textarea {
      resize: vertical;
      min-height: 70px;
    }
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
    }
    .error {
      font-size: 11px;
      color: var(--danger);
      margin-top: 3px;
    }

    /* ---------- –ö–∞—Ä—Ç–æ—á–∫–∏ ---------- */

    .card,
    .section,
    .files-list,
    .files-detail,
    .admin-users-list {
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    /* ---------- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---------- */

    #auth-root {
      max-width: 480px;
      margin: 0 auto;
    }

    .card {
      padding: 18px 18px 20px;
      margin-bottom: 16px;
    }

    .card h1 {
      font-size: 22px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .card .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .auth-switch {
      margin-top: 10px;
      font-size: 13px;
      text-align: right;
      color: var(--muted);
      cursor: pointer;
    }
    .auth-switch span {
      color: var(--accent-hover);
    }

    .auth-screen {
      display: none;
    }
    .auth-screen.active {
      display: block;
    }

    /* ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ ---------- */

    #panel-root {
      display: none;
    }

    .navbar {
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .nav-btn {
      padding: 7px 14px;
      background: var(--bg-lighter);
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .nav-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .nav-btn.active {
      background: var(--accent);
    }

    .nav-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .top-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .top-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .top-name {
      font-size: 13px;
      color: var(--text);
    }

    .top-role {
      font-size: 11px;
      color: var(--muted);
    }

    .back-home-btn {
      padding: 5px 12px;
      font-size: 12px;
      background: var(--bg-lighter);
      border-radius: 999px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .back-home-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    /* ---------- –°–µ–∫—Ü–∏–∏ –ø–∞–Ω–µ–ª–∏ ---------- */

    .section {
      padding: 16px;
      min-height: 420px;
    }
    .section.active {
      display: block;
    }
    .section:not(.active) {
      display: none;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .section p {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .section small {
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------- –ì–ª–∞–≤–Ω–∞—è ---------- */

    .home-actions {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* ---------- –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞ ---------- */

    .files-layout {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 16px;
      margin-top: 10px;
    }

    .files-list {
      padding: 10px;
      max-height: 430px;
      overflow-y: auto;
      background: var(--bg);
    }

    .file-item {
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 6px;
    }
    .file-item:hover {
      background: var(--bg-lighter);
    }
    .file-item.me {
      border-color: var(--accent);
      background: rgba(37,99,235,0.15);
    }
    .file-item.active {
      background: var(--accent);
      border-color: var(--accent-hover);
    }

    .file-title {
      font-weight: 500;
    }
    .file-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .files-detail {
      padding: 12px;
      background: var(--bg);
    }

    .files-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .badge-readonly,
    .badge-editable {
      font-size: 11px;
    }
    .badge-readonly {
      color: var(--muted);
    }
    .badge-editable {
      color: var(--success);
    }

    .personal-note {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ---------- */

    .admin-users-list {
      margin-top: 10px;
      padding: 10px;
      max-height: 460px;
      overflow-y: auto;
      background: var(--bg);
    }

    .admin-user-card {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px;
      margin-bottom: 8px;
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: 8px;
      align-items: center;
    }

    .admin-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      overflow: hidden;
    }
    .admin-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .admin-user-main {
      font-size: 13px;
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .admin-user-nick {
      font-weight: 500;
    }

    .admin-role-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .admin-role-badge.admin {
      border-color: var(--accent);
      color: var(--accent-hover);
    }
    .admin-role-badge.moderator {
      border-color: #4f46e5;
      color: #a5b4fc;
    }

    .admin-user-meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .admin-user-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }

    .admin-select {
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .admin-color {
      width: 60px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      padding: 0;
    }

    .admin-avatar-input {
      font-size: 11px;
      color: var(--muted);
    }

    /* ---------- –ú–æ–¥–∞–ª–∫–∏ ---------- */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      background: var(--bg-light);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 16px;
    }
    .modal h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .modal p {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .search-input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .search-result-item {
      padding: 5px 6px;
      border-radius: 6px;
      border: 1px solid transparent;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .search-result-item:hover {
      background: var(--bg-lighter);
    }

    /* ---------- –ê–¥–∞–ø—Ç–∏–≤ ---------- */

    @media (max-width: 900px) {
      .files-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 8px;
      }
      .navbar {
        flex-wrap: wrap;
      }
      .nav-right {
        margin-left: 0;
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>
<div id="app">

  <!-- ===================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===================== -->
  <div id="auth-root">
    <div class="card">
      <section id="register-screen" class="auth-screen active">
        <h1>Police Platinum</h1>
        <p class="subtitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ñ–∏—Ü–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏.</p>

        <form id="register-form" novalidate>
          <div class="field">
            <label for="reg-nick">–ù–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)</label>
            <input id="reg-nick" type="text" placeholder="Marsello_Nelson" autocomplete="off" />
            <div class="hint">–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã + –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ. –ü—Ä–∏–º–µ—Ä: John_Smith</div>
            <div class="error" id="reg-nick-error"></div>
          </div>

          <div class="field">
            <label for="reg-password">–ü–∞—Ä–æ–ª—å</label>
            <input id="reg-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" />
            <div class="error" id="reg-password-error"></div>
          </div>

          <div class="field">
            <label for="reg-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç (–∏–≥—Ä–æ–≤–æ–π)</label>
            <select id="reg-dept">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç‚Ä¶</option>
              <option value="LSPD">LSPD ‚Äî Los Santos PD</option>
              <option value="SFPD">SFPD ‚Äî San Fierro PD</option>
              <option value="LVPD">LVPD ‚Äî Las Venturas PD</option>
            </select>
            <div class="error" id="reg-dept-error"></div>
          </div>

          <div class="field">
            <label for="reg-avatar">–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
            <input id="reg-avatar" type="file" accept="image/*" />
            <div class="hint">–ê–≤–∞—Ç–∞—Ä –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø—Ä—è–º–æ –≤ –±–∞–∑–µ (base64), –±–µ–∑ Supabase Storage.</div>
            <div class="error" id="reg-avatar-error"></div>
          </div>

          <button class="btn" type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>

          <div class="hint" style="margin-top:8px;">
            –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase (—Ç–∞–±–ª–∏—Ü—ã users + personal_files) –∏ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—Å–µ—Å—Å–∏—è).
          </div>
        </form>

        <div class="auth-switch" id="to-login">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span>–í–æ–π—Ç–∏</span>
        </div>
      </section>

      <section id="login-screen" class="auth-screen">
        <h1>Police Platinum</h1>
        <p class="subtitle">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –æ—Ñ–∏—Ü–µ—Ä–∞.</p>

        <form id="login-form" novalidate>
          <div class="field">
            <label for="login-nick">–ù–∏–∫</label>
            <input id="login-nick" type="text" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" autocomplete="off" />
            <div class="error" id="login-nick-error"></div>
          </div>

          <div class="field">
            <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
            <input id="login-password" type="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
            <div class="error" id="login-password-error"></div>
          </div>

          <button class="btn" type="submit">–í–æ–π—Ç–∏</button>
        </form>

        <div class="auth-switch" id="to-register">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
        </div>
      </section>
    </div>
  </div>

  <!-- ===================== –ü–ê–ù–ï–õ–¨ ===================== -->
  <div id="panel-root" style="display:none;">

    <!-- –ù–∞–≤–±–∞—Ä -->
    <div class="navbar">
      <button class="nav-btn active" id="nav-home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="nav-btn" id="nav-files">–õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</button>
      <button class="nav-btn" id="nav-admin">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>

      <div class="nav-right">
        <button class="back-home-btn" id="back-home-btn" style="display:none;">‚üµ –ù–∞ –≥–ª–∞–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</button>

        <div class="top-user">
          <div class="top-avatar" id="top-avatar">PP</div>
          <div>
            <div class="top-name" id="top-nick">–û—Ñ–∏—Ü–µ—Ä</div>
            <div class="top-role" id="top-role">–†–æ–ª—å</div>
          </div>
        </div>

        <button class="btn-outline btn-sm" id="logout-btn">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="section-home" class="section active">
      <h2>–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
      <p>
        –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∏–Ω–¥–∞—Ä–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º –¥–µ–ª–æ–º –æ—Ñ–∏—Ü–µ—Ä–∞.
      </p>
      <small>
        –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ—å –±–∏–Ω–¥–µ—Ä –∏ –æ—Ñ–æ—Ä–º–∏ —Å–≤–æ—ë –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ. –ï—Å–ª–∏ —Ç—ã –Ω–æ–≤–æ–±—Ä–∞–Ω–µ—Ü ‚Äî –ø—Ä–æ—á–∏—Ç–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö.
      </small>

      <div class="home-actions">
        <button id="download-binder-btn" class="btn">‚¨á –°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä</button>
        <button id="open-files-from-home" class="btn-outline">–õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</button>
        <button id="open-rookie-modal" class="btn-outline">–ù–∞—á–∞—Ç—å –æ–±—É—á–∞—Ç—å—Å—è –∏–≥—Ä–µ –∑–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ</button>
      </div>
    </section>

    <!-- –õ–∏—á–Ω—ã–µ –¥–µ–ª–∞ -->
    <section id="section-files" class="section">
      <h2>–õ–∏—á–Ω—ã–µ –¥–µ–ª–∞</h2>
      <p>
        –í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–∏—á–Ω—ã–µ –¥–µ–ª–∞ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –í–∞—à–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ –≤—Å–µ–≥–¥–∞
        –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –≤–≤–µ—Ä—Ö—É —Å–ø–∏—Å–∫–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ.
      </p>

      <div style="margin-top:10px; margin-bottom:8px;">
        <button id="create-personal-btn" class="btn btn-sm" style="display:none;">
          ‚ûï –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
        </button>
      </div>

      <div class="files-layout">
        <!-- –°–ø–∏—Å–æ–∫ -->
        <div class="files-list" id="personal-files-list">
          –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª...
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ -->
        <div class="files-detail">
          <div class="files-detail-header">
            <div>
              <strong id="pf-detail-title">–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ</strong>
              <div id="pf-detail-sub" style="font-size:12px; color:var(--muted);"></div>
            </div>
            <div id="pf-edit-badge" class="badge-readonly">
              –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä
            </div>
          </div>

          <form id="personal-form" novalidate>
            <div class="field">
              <label for="pf-dept">–û—Ç–¥–µ–ª (—Ñ–æ—Ä—É–º–Ω—ã–π)</label>
              <select id="pf-dept">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª‚Ä¶</option>
                <option value="SWAT">SWAT</option>
                <option value="PD">PD</option>
                <option value="PA">PA</option>
                <option value="CHIEF">CHIEF</option>
                <option value="IAG">IAG</option>
                <option value="Cmdr.SWAT">Cmdr.SWAT</option>
                <option value="DCmdr.SWAT">DCmdr.SWAT</option>
              </select>
            </div>

            <div class="field">
              <label for="pf-nick">–ò–º—è_–§–∞–º–∏–ª–∏—è (–∫–∞–∫ –≤ –∏–≥—Ä–µ)</label>
              <input id="pf-nick" type="text" placeholder="–ò–º—è_–§–∞–º–∏–ª–∏—è" />
            </div>

            <div class="field">
              <label for="pf-account">–ù–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</label>
              <input id="pf-account" type="text" placeholder="522501" />
            </div>

            <div class="field">
              <label for="pf-birth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
              <input id="pf-birth" type="text" placeholder="01.01.2000" />
            </div>

            <div class="field">
              <label for="pf-badge-link">–ù–æ–º–µ—Ä –∑–Ω–∞—á–∫–∞ / –∞–∫–∫–∞—É–Ω—Ç–∞ (—Å—Å—ã–ª–∫–∞)</label>
              <input id="pf-badge-link" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç / –ø—Ä–æ—Ñ–∏–ª—å" />
            </div>

            <div class="field">
              <label for="pf-rank">–¢–µ–∫—É—â–µ–µ –∑–≤–∞–Ω–∏–µ</label>
              <input id="pf-rank" type="text" placeholder="–°–µ—Ä–∂–∞–Ω—Ç / –ö–∞–ø–∏—Ç–∞–Ω / ..." />
            </div>

            <div class="field">
              <label for="pf-phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
              <input id="pf-phone" type="text" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
            </div>

            <div class="field">
              <label for="pf-contact">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ —Å–≤—è–∑–∏</label>
              <input id="pf-contact" type="text" placeholder="VK / Discord" />
            </div>

            <button type="submit" id="save-personal-btn" class="btn" style="margin-top:6px;">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ
            </button>
            <div id="personal-save-note" class="personal-note"></div>
          </form>

          <div class="personal-note" id="pf-readonly-note" style="display:none;">
            –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —á—É–∂–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
          </div>
        </div>
      </div>
    </section>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <section id="section-admin" class="section">
      <h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
      <p>
        –†–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º. –û—Ñ–∏—Ü–µ—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
        –∏ –∞–¥–º–∏–Ω–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
      </p>

      <div style="margin-top:10px; margin-bottom:8px;">
        <button id="admin-add-user-btn" class="btn btn-sm" style="display:none;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å / –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>
      </div>

      <div id="admin-users-list" class="admin-users-list">
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
      </div>
    </section>
  </div>

  <!-- ============ –ú–û–î–ê–õ–ö–ê: –†–Ø–î–û–í–´–ï ============ -->
  <div id="rookie-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä—è–¥–æ–≤—ã—Ö</h3>
      <p><strong>Police Academy [PA][1-2] ‚Äî –ü–æ–ª–∏—Ü–µ–π—Å–∫–∞—è –∞–∫–∞–¥–µ–º–∏—è</strong></p>
      <p>
        Police Academy [PA][1-2] (–Ω–æ–≤–æ–±—Ä–∞–Ω—Ü—ã) ‚Äî –æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        –Ω–æ–≤–∏—á–∫–æ–≤, —Ç–æ–ª—å–∫–æ –≤—Å—Ç—É–ø–∏–≤—à–∏—Ö –≤ —Ä—è–¥—ã –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞. –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç —ç–∫–∑–∞–º–µ–Ω—ã,
        —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –æ–±—É—á–µ–Ω–∏–µ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é —Å –æ—Ä—É–∂–∏–µ–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –ø–∞—Ç—Ä—É–ª–µ.
      </p>
      <p>
        –ê–∫–∞–¥–µ–º–∏—è –≥–æ—Ç–æ–≤–∏—Ç –Ω–æ–≤–æ–±—Ä–∞–Ω—Ü–µ–≤ –≤ –æ—Ç–¥–µ–ª –ø–∞—Ç—Ä—É–ª—å–Ω–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (PD), –≤ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–∏
        –±—É–¥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —ç–∫–∑–∞–º–µ–Ω–æ–≤.
      </p>
      <p><strong>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Ü–∏–∏:</strong><br/>
        –ü–æ–∑—ã–≤–Ω–æ–π Police Academy: <code>[PA]</code><br/>
        –ü—Ä–∏–º–µ—Ä: <code>![PA] –ü—Ä–∏–µ–º...</code>
      </p>
      <p><strong>–û—Ç—ã–≥—Ä–æ–≤–∫–∞ –∑–Ω–∞—á–∫–∞ (–ø—Ä–∏–º–µ—Ä):</strong><br/>
        <code>/me –ù–∞ –ø–æ—è—Å–µ –∑–Ω–∞—á–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–π –∞–∫–∞–¥–µ–º–∏–∏ LVPD —Å –Ω–æ–º–µ—Ä–æ–º [–Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]</code>
      </p>

      <div class="modal-footer">
        <button class="btn btn-sm" id="rookie-close-btn">–ü–æ–Ω—è–ª, –ø—Ä–∏–Ω—è–ª</button>
      </div>
    </div>
  </div>

  <!-- ============ –ú–û–î–ê–õ–ö–ê: –î–û–ë–ê–í–ò–¢–¨ / –ù–ê–°–¢–†–û–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–ê–î–ú–ò–ù) ============ -->
  <div id="admin-add-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫—É, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –µ–º—É —Å—Ç–∞—Ç—É—Å –∏ —Ü–≤–µ—Ç —Ä–∞–º–∫–∏.</p>

      <input id="admin-add-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." />

      <div id="admin-add-results" style="max-height:200px; overflow-y:auto; margin-bottom:8px;"></div>

      <div class="field">
        <label for="admin-status-select">–°—Ç–∞—Ç—É—Å (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)</label>
        <select id="admin-status-select">
          <option value="">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</option>
          <option value="–ö—É—Ä–∞—Ç–æ—Ä">–ö—É—Ä–∞—Ç–æ—Ä</option>
          <option value="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É</option>
          <option value="–ú–∏–Ω–∏—Å—Ç—Ä">–ú–∏–Ω–∏—Å—Ç—Ä</option>
        </select>
      </div>

      <div class="field">
        <label for="admin-border-color">–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
        <input id="admin-border-color" type="color" value="#3a7ca5" />
      </div>

      <div class="modal-footer">
        <button class="btn-outline btn-sm" id="admin-add-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-sm" id="admin-add-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ============ –ú–û–î–ê–õ–ö–ê: –û–®–ò–ë–ö–ê ============ -->
  <div id="error-modal" class="modal-backdrop">
    <div class="modal">
      <h3>–û—à–∏–±–∫–∞!</h3>
      <p id="error-modal-text"></p>
      <div class="modal-footer">
        <button class="btn btn-sm" id="error-modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

</div> <!-- /app -->
<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* =============== –ù–ê–°–¢–†–û–ô–ö–ê SUPABASE =============== */

const SUPABASE_URL = "https://qjbhflpoelgusfhymipi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYmhmbHBvZWxndXNmaHltaXBpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzEzODMsImV4cCI6MjA4MDQ0NzM4M30.OUBE062cKr4p4KpKlZlWIYCmqCBpXK43tQq9m-laDfg";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============== –£–¢–ò–õ–ò–¢–´ =============== */

function normalizeNick(n) {
  if (!n) return "";
  return n.trim().replace(/\s+/g, "_");
}
function showError(id, msg) {
  const el = document.getElementById(id);
  if (el) el.textContent = msg || "";
}
function saveSession(user) {
  localStorage.setItem("pp_user", JSON.stringify(user));
}
function loadSession() {
  try {
    return JSON.parse(localStorage.getItem("pp_user"));
  } catch {
    return null;
  }
}
function clearSession() {
  localStorage.removeItem("pp_user");
}
function roleLabel(role) {
  if (role === "admin") return "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
  if (role === "moderator") return "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä";
  return "–û—Ñ–∏—Ü–µ—Ä";
}

/* =============== –ú–û–î–ê–õ–ö–ê –û–®–ò–ë–û–ö =============== */

const errorModal = document.getElementById("error-modal");
const errorModalText = document.getElementById("error-modal-text");
const errorModalClose = document.getElementById("error-modal-close");

function showErrorModal(message) {
  errorModalText.textContent = message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.";
  errorModal.classList.add("active");
}
if (errorModalClose) {
  errorModalClose.onclick = () => {
    errorModal.classList.remove("active");
  };
}

/* =============== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =============== */

let currentUser = null;
let personalFilesCache = [];
let currentFileId = null;
let currentFileOwnerId = null;
let currentFileEditable = false;

let adminUsersCache = [];
let adminSelectedUserId = null;

/* =============== –≠–õ–ï–ú–ï–ù–¢–´ DOM =============== */

const authRoot = document.getElementById("auth-root");
const panelRoot = document.getElementById("panel-root");
const regScreen = document.getElementById("register-screen");
const loginScreen = document.getElementById("login-screen");

const topNick = document.getElementById("top-nick");
const topRole = document.getElementById("top-role");
const topAvatar = document.getElementById("top-avatar");

/* =============== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =============== */

document.getElementById("to-login").onclick = () => {
  regScreen.classList.remove("active");
  loginScreen.classList.add("active");
};
document.getElementById("to-register").onclick = () => {
  loginScreen.classList.remove("active");
  regScreen.classList.add("active");
};

/* =============== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =============== */

document.getElementById("register-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  let nick = normalizeNick(document.getElementById("reg-nick").value);
  let password = document.getElementById("reg-password").value;
  let dept = document.getElementById("reg-dept").value;
  let avatarFile = document.getElementById("reg-avatar").files[0];

  showError("reg-nick-error", "");
  showError("reg-password-error", "");
  showError("reg-dept-error", "");
  showError("reg-avatar-error", "");

  if (!nick || !/^[A-Za-z–ê-–Ø–∞-—è–Å—ë]+_[A-Za-z–ê-–Ø–∞-—è–Å—ë]+$/.test(nick)) {
    showError("reg-nick-error", "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫ (–ò–º—è_–§–∞–º–∏–ª–∏—è)");
    return;
  }
  if (!password || password.length < 6) {
    showError("reg-password-error", "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
    return;
  }
  if (!dept) {
    showError("reg-dept-error", "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç");
    return;
  }
  if (!avatarFile) {
    showError("reg-avatar-error", "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const avatarDataUrl = reader.result;

    const { data: userRow, error } = await supabaseClient
      .from("users")
      .insert({
        nick,
        password_hash: password,
        department: dept,
        avatar_url: avatarDataUrl,
        role: "user"
      })
      .select("*")
      .single();

    if (error) {
      console.error(error);
      showErrorModal("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ç–∞–±–ª–∏—Ü–∞ users). –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç.");
      return;
    }

    currentUser = userRow;
    saveSession(userRow);
    loadPanelUI(userRow);
  };

  reader.onerror = () => {
    showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∫–∏.");
  };

  reader.readAsDataURL(avatarFile);
});

/* =============== –í–•–û–î =============== */

document.getElementById("login-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  let nick = normalizeNick(document.getElementById("login-nick").value);
  let password = document.getElementById("login-password").value;

  showError("login-nick-error", "");
  showError("login-password-error", "");

  if (!nick) {
    showError("login-nick-error", "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
    return;
  }
  if (!password) {
    showError("login-password-error", "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
    return;
  }

  const { data, error } = await supabaseClient
    .from("users")
    .select("*")
    .eq("nick", nick)
    .single();

  if (error || !data) {
    showError("login-nick-error", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }

  if (data.password_hash !== password) {
    showError("login-password-error", "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    return;
  }

  currentUser = data;
  saveSession(data);
  loadPanelUI(data);
});

/* =============== –¢–û–ü-–ë–ê–† + –ü–ê–ù–ï–õ–¨ =============== */

function refreshTopBar() {
  if (!currentUser) return;
  topNick.textContent = currentUser.nick || "–û—Ñ–∏—Ü–µ—Ä";
  topRole.textContent = roleLabel(currentUser.role || "user");

  topAvatar.innerHTML = "";
  topAvatar.style.borderColor = currentUser.border_color || "#374151";
  if (currentUser.avatar_url) {
    const img = document.createElement("img");
    img.src = currentUser.avatar_url;
    topAvatar.appendChild(img);
  } else {
    topAvatar.textContent = currentUser.nick ? currentUser.nick[0] : "P";
  }

  // –ö–Ω–æ–ø–∫–∞ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –≤–∏–¥–Ω–∞ –≤—Å–µ–º, –ª–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–Ω—É—Ç—Ä–∏
  const navAdmin = document.getElementById("nav-admin");
  if (navAdmin) {
    navAdmin.style.display = "inline-block";
  }
}

function loadPanelUI(user) {
  authRoot.style.display = "none";
  panelRoot.style.display = "block";
  refreshTopBar();
  switchSection("home");
}

/* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ */
window.addEventListener("load", () => {
  const session = loadSession();
  if (session) {
    currentUser = session;
    loadPanelUI(session);
  }
});

/* –≤—ã—Ö–æ–¥ */
document.getElementById("logout-btn").onclick = () => {
  clearSession();
  location.reload();
};

/* =============== –ù–ê–í–ò–ì–ê–¶–ò–Ø –†–ê–ó–î–ï–õ–û–í =============== */

function switchSection(name) {
  const sections = ["home", "files", "admin"];
  sections.forEach((sec) => {
    document.getElementById(`section-${sec}`).classList.remove("active");
    document.getElementById(`nav-${sec}`).classList.remove("active");
  });

  document.getElementById(`section-${name}`).classList.add("active");
  document.getElementById(`nav-${name}`).classList.add("active");

  document.getElementById("back-home-btn").style.display =
    name === "home" ? "none" : "inline-block";

  if (name === "files") loadPersonalFiles();
  if (name === "admin") loadAdminPanel();
}

document.getElementById("nav-home").onclick = () => switchSection("home");
document.getElementById("nav-files").onclick = () => switchSection("files");
document.getElementById("nav-admin").onclick = () => switchSection("admin");
document.getElementById("back-home-btn").onclick = () => switchSection("home");

document.getElementById("open-files-from-home").onclick = () => switchSection("files");

/* –°–∫–∞—á–∞—Ç—å –±–∏–Ω–¥–µ—Ä */
document.getElementById("download-binder-btn").onclick = () => {
  const a = document.createElement("a");
  a.href = "binder.zip";
  a.download = "binder.zip";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

/* =============== –ú–û–î–ê–õ–ö–ê –†–Ø–î–û–í–´–• =============== */

const rookieModal = document.getElementById("rookie-modal");
document.getElementById("open-rookie-modal").onclick = () => {
  rookieModal.classList.add("active");
};
document.getElementById("rookie-close-btn").onclick = () => {
  rookieModal.classList.remove("active");
};

/* =============== –õ–ò–ß–ù–´–ï –î–ï–õ–ê =============== */

const filesListEl = document.getElementById("personal-files-list");
const pfForm = document.getElementById("personal-form");
const pfDept = document.getElementById("pf-dept");
const pfNick = document.getElementById("pf-nick");
const pfAccount = document.getElementById("pf-account");
const pfBirth = document.getElementById("pf-birth");
const pfBadgeLink = document.getElementById("pf-badge-link");
const pfRank = document.getElementById("pf-rank");
const pfPhone = document.getElementById("pf-phone");
const pfContact = document.getElementById("pf-contact");
const pfSaveBtn = document.getElementById("save-personal-btn");
const pfSaveNote = document.getElementById("personal-save-note");
const pfReadonlyNote = document.getElementById("pf-readonly-note");
const pfDetailTitle = document.getElementById("pf-detail-title");
const pfDetailSub = document.getElementById("pf-detail-sub");
const pfEditBadge = document.getElementById("pf-edit-badge");
const createPersonalBtn = document.getElementById("create-personal-btn");

function updatePfHeaderPreview() {
  const dept = pfDept.value || "–û—Ç–¥–µ–ª";
  const nick = pfNick.value || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
  const acc = pfAccount.value || "–ù–æ–º–µ—Ä";
  pfDetailTitle.textContent = `[${dept}] ${nick} [${acc}]`;
}

pfDept.addEventListener("change", updatePfHeaderPreview);
pfNick.addEventListener("input", updatePfHeaderPreview);
pfAccount.addEventListener("input", () => {
  pfAccount.value = pfAccount.value.replace(/\D+/g, "");
  updatePfHeaderPreview();
});

function fillPersonalForm(fileRow, editable) {
  if (!fileRow) {
    pfDept.value = "";
    pfNick.value = currentUser ? currentUser.nick : "";
    pfAccount.value = "";
    pfBirth.value = "";
    pfBadgeLink.value = "";
    pfRank.value = "";
    pfPhone.value = "";
    pfContact.value = "";
    pfDetailSub.textContent = editable
      ? "–ù–æ–≤–æ–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ"
      : "–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—ë.";
    updatePfHeaderPreview();
  } else {
    pfDept.value = fileRow.forum_dept || "";
    pfNick.value = fileRow.forum_nick || "";
    pfAccount.value = fileRow.account_number || "";
    pfBirth.value = fileRow.birth_date || "";
    pfBadgeLink.value = fileRow.badge_link || "";
    pfRank.value = fileRow.rank || "";
    pfPhone.value = fileRow.phone || "";
    pfContact.value = fileRow.contact || "";
    pfDetailSub.textContent = fileRow.updated_at
      ? `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date(fileRow.updated_at).toLocaleString()}`
      : "";
    updatePfHeaderPreview();
  }

  const controls = [
    pfDept, pfNick, pfAccount, pfBirth,
    pfBadgeLink, pfRank, pfPhone, pfContact
  ];
  controls.forEach((el) => (el.disabled = !editable));
  pfSaveBtn.style.display = editable ? "inline-block" : "none";

  if (editable) {
    pfEditBadge.textContent = "–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
    pfEditBadge.className = "badge-editable";
    pfReadonlyNote.style.display = "none";
  } else {
    pfEditBadge.textContent = "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä";
    pfEditBadge.className = "badge-readonly";
    pfReadonlyNote.style.display = "block";
  }
}

function openPersonalFile(id) {
  const file = personalFilesCache.find((f) => f.id === id);
  if (!file) return;

  currentFileId = file.id;
  currentFileOwnerId = file.user_id;

  const canEdit =
    currentUser &&
    (currentUser.role === "admin" ||
      currentUser.role === "moderator" ||
      currentUser.id === file.user_id);

  currentFileEditable = !!canEdit;

  const items = filesListEl.querySelectorAll(".file-item");
  items.forEach((item) => {
    item.classList.toggle("active", Number(item.dataset.id) === id);
  });

  fillPersonalForm(file, canEdit);
}

async function loadPersonalFiles() {
  if (!currentUser) return;

  filesListEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—á–Ω—ã—Ö –¥–µ–ª...";

  const { data, error } = await supabaseClient
    .from("personal_files")
    .select("*")
    .order("updated_at", { ascending: false });

  if (error) {
    console.error(error);
    filesListEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –¥–µ–ª.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –¥–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  personalFilesCache = data || [];
  filesListEl.innerHTML = "";

  const hasMyFile = personalFilesCache.some((f) => f.user_id === currentUser.id);
  if (createPersonalBtn) {
    createPersonalBtn.style.display = hasMyFile ? "none" : "inline-block";
  }

  if (!personalFilesCache.length) {
    filesListEl.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    currentFileId = null;
    currentFileOwnerId = currentUser.id;
    currentFileEditable = false;
    fillPersonalForm(null, false);
    return;
  }

  const myFiles = personalFilesCache.filter(
    (f) => f.user_id === currentUser.id
  );
  const others = personalFilesCache
    .filter((f) => f.user_id !== currentUser.id)
    .sort((a, b) =>
      (a.forum_nick || "").localeCompare(b.forum_nick || "", "ru")
    );

  const ordered = [...myFiles, ...others];

  ordered.forEach((file) => {
    const item = document.createElement("div");
    item.className = "file-item";
    if (file.user_id === currentUser.id) item.classList.add("me");
    item.dataset.id = file.id;

    const title = document.createElement("div");
    title.className = "file-title";
    const dept = file.forum_dept || "–û—Ç–¥–µ–ª";
    const nick = file.forum_nick || "–ò–º—è_–§–∞–º–∏–ª–∏—è";
    const acc = file.account_number || "–Ω–æ–º–µ—Ä";
    title.textContent = `[${dept}] ${nick} [${acc}]`;

    const meta = document.createElement("div");
    meta.className = "file-meta";
    meta.textContent = file.rank
      ? `–ó–≤–∞–Ω–∏–µ: ${file.rank}`
      : "–ó–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ";

    item.appendChild(title);
    item.appendChild(meta);

    item.onclick = () => {
      openPersonalFile(file.id);
    };

    filesListEl.appendChild(item);
  });

  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
  currentFileId = null;
  currentFileOwnerId = currentUser.id;
  currentFileEditable = false;
  fillPersonalForm(null, false);
}

if (createPersonalBtn) {
  createPersonalBtn.onclick = () => {
    if (!currentUser) return;
    currentFileId = null;
    currentFileOwnerId = currentUser.id;
    currentFileEditable = true;
    fillPersonalForm(null, true);
  };
}

pfForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser) return;

  pfSaveNote.textContent = "";
  pfSaveNote.style.color = "#9ca3af";

  if (!currentFileEditable) {
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    return;
  }

  const dept = pfDept.value.trim();
  const nick = pfNick.value.trim();
  const acc = pfAccount.value.trim();

  if (!dept || !nick || !acc) {
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º: –û—Ç–¥–µ–ª, –ò–º—è_–§–∞–º–∏–ª–∏—è –∏ –Ω–æ–º–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞.";
    return;
  }

  const payload = {
    forum_dept: dept,
    forum_nick: nick,
    account_number: acc,
    birth_date: pfBirth.value.trim(),
    badge_link: pfBadgeLink.value.trim(),
    rank: pfRank.value.trim(),
    phone: pfPhone.value.trim(),
    contact: pfContact.value.trim(),
  };

  let result;
  if (currentFileId) {
    result = await supabaseClient
      .from("personal_files")
      .update(payload)
      .eq("id", currentFileId)
      .select("*")
      .single();
  } else {
    payload.user_id = currentFileOwnerId || currentUser.id;
    result = await supabaseClient
      .from("personal_files")
      .insert(payload)
      .select("*")
      .single();
  }

  const { data, error } = result;
  if (error) {
    console.error(error);
    pfSaveNote.style.color = "#ef4444";
    pfSaveNote.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞.";
    showErrorModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ –¥–µ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  currentFileId = data.id;
  currentFileOwnerId = data.user_id;

  pfSaveNote.style.color = "#22c55e";
  pfSaveNote.textContent = "–õ–∏—á–Ω–æ–µ –¥–µ–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.";
  setTimeout(() => (pfSaveNote.textContent = ""), 2500);

  await loadPersonalFiles();
});

/* =============== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ =============== */

const adminUsersListEl = document.getElementById("admin-users-list");
const adminAddBtn = document.getElementById("admin-add-user-btn");

const adminAddModal = document.getElementById("admin-add-modal");
const adminAddSearchInput = document.getElementById("admin-add-search");
const adminAddResults = document.getElementById("admin-add-results");
const adminStatusSelect = document.getElementById("admin-status-select");
const adminBorderColor = document.getElementById("admin-border-color");
const adminAddCancel = document.getElementById("admin-add-cancel");
const adminAddSave = document.getElementById("admin-add-save");

async function loadAdminPanel() {
  if (!currentUser) {
    adminUsersListEl.textContent = "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.";
    adminAddBtn.style.display = "none";
    return;
  }

  const isAdmin = currentUser.role === "admin";
  const isModerator = currentUser.role === "moderator";
  const isOfficer = !isAdmin && !isModerator;

  adminUsersListEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...";
  adminAddBtn.style.display = isAdmin ? "inline-block" : "none";

  const { data, error } = await supabaseClient
    .from("users")
    .select("id, nick, department, role, avatar_url, created_at, status, border_color")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    adminUsersListEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.";
    showErrorModal("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    return;
  }

  adminUsersCache = data || [];
  renderAdminUsers();
}

function renderAdminUsers() {
  adminUsersListEl.innerHTML = "";

  if (!adminUsersCache.length) {
    adminUsersListEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.";
    return;
  }

  const isAdmin = currentUser && currentUser.role === "admin";
  const isModerator = currentUser && currentUser.role === "moderator";
  const isOfficer = !isAdmin && !isModerator;

  let list = adminUsersCache;

  if (isOfficer) {
    list = adminUsersCache.filter(
      (u) => u.role === "admin" || u.role === "moderator"
    );
    if (!list.length) {
      adminUsersListEl.textContent = "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
      return;
    }
  }

  list.forEach((user) => {
    const card = document.createElement("div");
    card.className = "admin-user-card";

    const avatar = document.createElement("div");
    avatar.className = "admin-user-avatar";
    avatar.style.borderColor = user.border_color || "#374151";
    if (user.avatar_url) {
      const img = document.createElement("img");
      img.src = user.avatar_url;
      avatar.appendChild(img);
    } else {
      avatar.textContent = user.nick ? user.nick[0] : "?";
    }

    const main = document.createElement("div");
    main.className = "admin-user-main";

    const header = document.createElement("div");
    header.className = "admin-user-header";

    const nickEl = document.createElement("div");
    nickEl.className = "admin-user-nick";
    nickEl.textContent = user.nick;

    const roleBadge = document.createElement("div");
    roleBadge.className = "admin-role-badge " + (user.role || "user");
    roleBadge.textContent = roleLabel(user.role || "user");

    header.appendChild(nickEl);
    header.appendChild(roleBadge);

    const meta1 = document.createElement("div");
    meta1.className = "admin-user-meta";
    if (user.role === "admin" && user.status) {
      meta1.textContent = `–°—Ç–∞—Ç—É—Å: ${user.status}`;
    } else if (user.role === "admin" && !user.status) {
      meta1.textContent = "–°—Ç–∞—Ç—É—Å: –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
    } else {
      meta1.textContent = `–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: ${user.department || "‚Äî"}`;
    }

    const meta2 = document.createElement("div");
    meta2.className = "admin-user-meta";
    meta2.textContent = user.created_at
      ? `–°–æ–∑–¥–∞–Ω: ${new Date(user.created_at).toLocaleString()}`
      : "";

    main.appendChild(header);
    main.appendChild(meta1);
    if (meta2.textContent) main.appendChild(meta2);

    if (!isOfficer) {
      const actions = document.createElement("div");
      actions.className = "admin-user-actions";

      const canEdit = isAdmin;

      const roleSelect = document.createElement("select");
      roleSelect.className = "admin-select";
      ["user", "moderator", "admin"].forEach((r) => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = roleLabel(r);
        roleSelect.appendChild(opt);
      });
      roleSelect.value = user.role || "user";
      roleSelect.disabled = !canEdit;

      const statusSelect = document.createElement("select");
      statusSelect.className = "admin-select";
      ["", "–ö—É—Ä–∞—Ç–æ—Ä", "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É", "–ú–∏–Ω–∏—Å—Ç—Ä"].forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val || "–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞";
        statusSelect.appendChild(opt);
      });
      statusSelect.value = user.status || "";
      statusSelect.disabled = !canEdit;

      const colorInput = document.createElement("input");
      colorInput.type = "color";
      colorInput.className = "admin-color";
      colorInput.value = user.border_color || "#3a7ca5";
      colorInput.disabled = !canEdit;

      const avatarInput = document.createElement("input");
      avatarInput.type = "file";
      avatarInput.accept = "image/*";
      avatarInput.className = "admin-avatar-input";
      avatarInput.disabled = !canEdit;

      if (canEdit) {
        roleSelect.onchange = async () => {
          await updateUserFields(user.id, { role: roleSelect.value });
        };
        statusSelect.onchange = async () => {
          await updateUserFields(user.id, { status: statusSelect.value });
        };
        colorInput.onchange = async () => {
          await updateUserFields(user.id, { border_color: colorInput.value });
        };
        avatarInput.onchange = async () => {
          const file = avatarInput.files[0];
          if (!file) return;
          await adminChangeAvatarForUser(user, file);
        };
      }

      actions.appendChild(roleSelect);
      actions.appendChild(statusSelect);
      actions.appendChild(colorInput);
      actions.appendChild(avatarInput);

      main.appendChild(actions);
    }

    card.appendChild(avatar);
    card.appendChild(main);
    adminUsersListEl.appendChild(card);
  });
}

async function updateUserFields(userId, patch) {
  const { data, error } = await supabaseClient
    .from("users")
    .update(patch)
    .eq("id", userId)
    .select("*")
    .single();

  if (error) {
    console.error(error);
    showErrorModal("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
    return;
  }

  const idx = adminUsersCache.findIndex((u) => u.id === userId);
  if (idx >= 0) adminUsersCache[idx] = data;

  if (currentUser && currentUser.id === userId) {
    currentUser = { ...currentUser, ...patch };
    saveSession(currentUser);
    refreshTopBar();
  }

  renderAdminUsers();
}

async function adminChangeAvatarForUser(user, file) {
  try {
    const reader = new FileReader();
    reader.onload = async () => {
      const avatarDataUrl = reader.result;
      await updateUserFields(user.id, { avatar_url: avatarDataUrl });
    };
    reader.onerror = () => {
      showErrorModal("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞.");
    };
    reader.readAsDataURL(file);
  } catch (e) {
    console.error(e);
    showErrorModal("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–≤–∞—Ç–∞—Ä–∞.");
  }
}

/* ---------- –ú–æ–¥–∞–ª–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å / –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" ---------- */

function renderAdminAddResults(filterText) {
  adminAddResults.innerHTML = "";

  const text = (filterText || "").toLowerCase();
  const list = adminUsersCache.filter((u) =>
    !text ? true : (u.nick || "").toLowerCase().includes(text)
  );

  if (!list.length) {
    adminAddResults.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
    return;
  }

  list.forEach((u) => {
    const item = document.createElement("div");
    item.className = "search-result-item";
    item.dataset.id = u.id;
    item.textContent = `${u.nick} (${roleLabel(u.role)})`;
    if (adminSelectedUserId === u.id) {
      item.style.background = "#1f2937";
    }
    item.onclick = () => {
      adminSelectedUserId = u.id;
      adminStatusSelect.value = u.status || "";
      adminBorderColor.value = u.border_color || "#3a7ca5";
      renderAdminAddResults(text);
    };
    adminAddResults.appendChild(item);
  });
}

function openAdminAddModal() {
  if (!currentUser || currentUser.role !== "admin") return;
  adminSelectedUserId = null;
  adminAddSearchInput.value = "";
  renderAdminAddResults("");
  adminStatusSelect.value = "";
  adminBorderColor.value = "#3a7ca5";
  adminAddModal.classList.add("active");
}
function closeAdminAddModal() {
  adminAddModal.classList.remove("active");
}

adminAddBtn.onclick = openAdminAddModal;
adminAddCancel.onclick = closeAdminAddModal;

adminAddSearchInput.addEventListener("input", (e) => {
  renderAdminAddResults(e.target.value);
});

adminAddSave.onclick = async () => {
  if (!adminSelectedUserId) {
    showErrorModal("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞.");
    return;
  }
  const status = adminStatusSelect.value;
  const color = adminBorderColor.value || "#3a7ca5";

  await updateUserFields(adminSelectedUserId, {
    status,
    border_color: color,
  });

  closeAdminAddModal();
};
</script>
</body>
</html>
