<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>PD Neural Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon1.ico">
  <link rel="apple-touch-icon" href="favicon1.ico">

  <style>
    /* =========================
       CYBER-NEON CHAT UI
       ========================= */
    :root{
      --text:#f3f6ff;

      --accent1:#ff2d7a;  /* neon pink */
      --accent2:#2ef9ff;  /* neon cyan */
      --accent3:#a855f7;  /* neon violet */
      --accent4:#ff4d5e;

      --bg0:#06070f;
      --glass: rgba(8, 10, 24, .60);
      --glass2: rgba(0,0,0,.28);

      --b1: rgba(255,255,255,.10);
      --b2: rgba(255,255,255,.16);
      --ring: rgba(46,249,255,.42);

      --shadow-s: 0 10px 32px rgba(0,0,0,.28);
      --shadow-m: 0 18px 64px rgba(0,0,0,.44);
      --shadow-l: 0 28px 96px rgba(0,0,0,.62);

      --rXL: 28px;
      --rL: 20px;
      --rM: 16px;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body{
      min-height:100vh;
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px;
      overflow-x:hidden;

      background: url("fon.png") center / cover no-repeat fixed;
      background-color: var(--bg0);
      position:relative;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-4;
      background:
        radial-gradient(1200px 560px at 50% 0%, rgba(168,85,247,.26), transparent 62%),
        radial-gradient(900px 520px at 12% 12%, rgba(255,45,122,.22), transparent 58%),
        radial-gradient(900px 520px at 88% 18%, rgba(46,249,255,.18), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.52) 0%, rgba(0,0,0,.28) 45%, rgba(0,0,0,.68) 100%);
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-3;
      background:
        radial-gradient(740px 480px at 18% 18%, rgba(255,45,122,.18), transparent 62%),
        radial-gradient(820px 520px at 82% 22%, rgba(46,249,255,.14), transparent 64%),
        linear-gradient(120deg,
          rgba(255,45,122,.10) 0%,
          rgba(46,249,255,.08) 42%,
          rgba(168,85,247,.10) 100%
        );
      mix-blend-mode: screen;
      opacity: .68;
      filter: blur(.2px);
    }

    .bg-live{
      position: fixed;
      inset: 0;
      z-index: -3;
      pointer-events:none;
      overflow:hidden;
    }
    .bg-live .scanlines{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      opacity:.055;
      mix-blend-mode: overlay;
      animation: scanMove 7.5s linear infinite;
    }
    @keyframes scanMove{
      0%   { transform: translateY(0); }
      100% { transform: translateY(18px); }
    }
    .bg-live .particles{
      position:absolute; inset:0;
      opacity:.14;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 42% 76%, rgba(255,255,255,.10) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 66%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 52%, rgba(255,45,122,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 30% 62%, rgba(46,249,255,.16) 0 1px, transparent 2px);
      background-size: 520px 520px, 680px 680px, 760px 760px, 900px 900px, 700px 700px, 820px 820px;
      animation: particlesDrift 52s linear infinite;
    }
    @keyframes particlesDrift{
      0%   { transform: translate3d(0,0,0); }
      100% { transform: translate3d(-3%, 2%, 0); }
    }
    .bg-live .vignette{
      position:absolute; inset:-2px;
      background: radial-gradient(circle at center, transparent 0 52%, rgba(0,0,0,.52) 78%, rgba(0,0,0,.88) 100%);
      opacity:.92;
    }

    @media (max-width: 900px){
      body{ background-attachment: scroll; }
    }

    :focus-visible{
      outline: 2px solid var(--ring);
      outline-offset: 3px;
      border-radius: 10px;
    }

    /* =========================
       APP LAYOUT
       ========================= */
    #app{
      width:100%;
      max-width: 1280px;
      position:relative;
      z-index:1;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 14px;
      padding: 6px 2px 0;
    }

    .titleblock{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .title{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: .02em;
      text-shadow:
        0 0 16px rgba(255,45,122,.22),
        0 0 34px rgba(46,249,255,.14),
        0 0 52px rgba(168,85,247,.10);
    }

    .subtitle{
      font-size: 12px;
      color: rgba(243,246,255,.64);
      letter-spacing: .10em;
      text-transform: uppercase;
    }

    .topbar-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid rgba(46,249,255,.22);
      background: rgba(0,0,0,.14);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 26px rgba(46,249,255,.10),
        0 0 24px rgba(255,45,122,.08);
      color: rgba(243,246,255,.92);
      cursor:pointer;
      border-radius: 12px;
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      padding: 11px 16px;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,45,122,.55);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 34px rgba(46,249,255,.16),
        0 0 54px rgba(255,45,122,.18),
        0 0 62px rgba(168,85,247,.10);
    }
    .btn:active{ transform: translateY(0); }

    .btn-ghost{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
    }
    .btn-ghost:hover{
      border-color: rgba(46,249,255,.30);
      box-shadow: 0 0 22px rgba(46,249,255,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      position:relative;
      border-radius: var(--rXL);
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(46,249,255,.14);
      box-shadow: 0 18px 70px rgba(0,0,0,.42);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--rXL) + 2px);
      background: linear-gradient(90deg,
        rgba(46,249,255,0) 0%,
        rgba(46,249,255,.40) 22%,
        rgba(255,45,122,.44) 50%,
        rgba(168,85,247,.36) 78%,
        rgba(46,249,255,0) 100%
      );
      filter: blur(.20px);
      opacity: .70;
      pointer-events:none;

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 2px;
    }

    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .panel-title{
      font-weight: 950;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(243,246,255,.78);
      text-shadow: 0 0 14px rgba(46,249,255,.10);
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }
    .panel-title .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(46,249,255,.90);
      box-shadow: 0 0 14px rgba(46,249,255,.30);
      flex: 0 0 auto;
    }

    .panel-body{
      padding: 12px;
    }

    /* =========================
       SIDEBAR (sessions)
       ========================= */
    .session-list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-height: calc(100vh - 230px);
      overflow:auto;
      padding-right: 6px;
    }
    .session-list::-webkit-scrollbar{ width: 8px; }
    .session-list::-webkit-scrollbar-thumb{
      background: rgba(46,249,255,.14);
      border-radius: 999px;
    }

    .session{
      position:relative;
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      transition: transform .12s ease, border-color .18s ease, box-shadow .18s ease, background .18s ease;
      overflow:hidden;
    }
    .session:hover{
      transform: translateY(-1px);
      border-color: rgba(46,249,255,.18);
      box-shadow: 0 0 24px rgba(46,249,255,.10);
      background: rgba(0,0,0,.14);
    }
    .session.active{
      border-color: rgba(255,45,122,.36);
      box-shadow:
        0 0 22px rgba(255,45,122,.12),
        0 0 26px rgba(46,249,255,.10);
    }

    .session-name{
      font-weight: 900;
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-shadow: 0 0 14px rgba(46,249,255,.08);
    }
    .session-meta{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(243,246,255,.62);
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }

    .session-tools{
      display:flex;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      color: rgba(243,246,255,.86);
      transition: transform .12s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .chip:hover{
      transform: translateY(-1px);
      border-color: rgba(46,249,255,.22);
      box-shadow: 0 0 18px rgba(46,249,255,.10);
    }
    .chip.danger:hover{
      border-color: rgba(255,45,122,.40);
      box-shadow: 0 0 18px rgba(255,45,122,.10);
    }

    /* =========================
       CHAT
       ========================= */
    .chat-wrap{
      display:flex;
      flex-direction:column;
      height: calc(100vh - 190px);
      min-height: 520px;
    }

    @media (max-width: 980px){
      .chat-wrap{
        height: calc(100vh - 220px);
      }
    }

    .chat{
      flex: 1;
      overflow:auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    .chat::-webkit-scrollbar{ width: 10px; }
    .chat::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
    }
    .chat::-webkit-scrollbar-thumb:hover{
      background: rgba(46,249,255,.14);
    }

    .msg{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      max-width: 980px;
    }
    .msg.you{ margin-left:auto; flex-direction: row-reverse; }
    .avatar{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      flex: 0 0 auto;
      box-shadow: 0 0 20px rgba(46,249,255,.08);
      user-select:none;
    }
    .you .avatar{
      border-color: rgba(255,45,122,.24);
      box-shadow: 0 0 20px rgba(255,45,122,.08);
    }

    .bubble{
      position:relative;
      border-radius: 18px;
      padding: 12px 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      line-height: 1.35;
      overflow:hidden;
      min-width: 120px;
    }

    .msg.ai .bubble{
      border-color: rgba(46,249,255,.14);
    }

    .msg.you .bubble{
      background: rgba(0,0,0,.20);
      border-color: rgba(255,45,122,.18);
    }

    .bubble::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 20px;
      background: linear-gradient(90deg,
        rgba(46,249,255,0) 0%,
        rgba(46,249,255,.32) 20%,
        rgba(255,45,122,.38) 52%,
        rgba(168,85,247,.28) 82%,
        rgba(46,249,255,0) 100%
      );
      opacity: .58;
      pointer-events:none;

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding: 1.5px;
    }

    .msg.you .bubble::before{
      opacity: .48;
      background: linear-gradient(90deg,
        rgba(255,45,122,0) 0%,
        rgba(255,45,122,.40) 30%,
        rgba(46,249,255,.26) 70%,
        rgba(255,45,122,0) 100%
      );
    }

    .msg-meta{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(243,246,255,.58);
      margin: 0 6px 2px;
      user-select:none;
    }

    .bubble pre{
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      color: rgba(243,246,255,.94);
    }
    .bubble code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      color: rgba(46,249,255,.92);
    }

    .typing{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      color: rgba(243,246,255,.78);
      font-weight: 800;
      letter-spacing: .06em;
    }
    .dots{
      display:inline-flex;
      gap: 4px;
      align-items:center;
    }
    .dot{
      width: 6px; height: 6px;
      border-radius: 999px;
      background: rgba(46,249,255,.85);
      box-shadow: 0 0 12px rgba(46,249,255,.26);
      animation: dotPulse 1.1s infinite;
    }
    .dot:nth-child(2){ animation-delay: .15s; opacity:.9; }
    .dot:nth-child(3){ animation-delay: .30s; opacity:.8; }
    @keyframes dotPulse{
      0%, 100% { transform: translateY(0); opacity:.55; }
      50%      { transform: translateY(-3px); opacity:1; }
    }

    /* =========================
       COMPOSER
       ========================= */
    .composer{
      border-top: 1px solid rgba(255,255,255,.08);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      background: rgba(0,0,0,.10);
    }

    .composer-row{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }

    textarea{
      width:100%;
      min-height: 52px;
      max-height: 160px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(243,246,255,.92);
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
      line-height: 1.35;
      font-size: 14px;
    }
    textarea:focus{
      border-color: rgba(46,249,255,.30);
      box-shadow: 0 0 0 3px rgba(46,249,255,.10);
    }

    .composer-actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }

    .hint{
      font-size: 12px;
      color: rgba(243,246,255,.62);
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .kbd{
      display:inline-flex;
      gap: 6px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 900;
      font-size: 11px;
    }

    /* =========================
       MODAL (small)
       ========================= */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width:100%;
      max-width: 520px;
      border-radius: 18px;
      border: 1px solid rgba(46,249,255,.16);
      background: rgba(0,0,0,.24);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 34px 100px rgba(0,0,0,.78),
        0 0 34px rgba(46,249,255,.10),
        0 0 34px rgba(255,45,122,.08);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }

    .modal h3{
      letter-spacing:.04em;
      text-shadow: 0 0 14px rgba(46,249,255,.12);
      margin-bottom: 8px;
    }

    .field{ margin-top: 10px; }
    .field label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color: rgba(243,246,255,.76);
      letter-spacing: .06em;
      text-transform: uppercase;
      font-weight: 900;
    }
    .field input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(243,246,255,.92);
    }

    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 14px;
    }

    .error-text{
      margin-top: 10px;
      font-size:12px;
      color:#ff7b7b;
      display:none;
    }

    @media (prefers-reduced-motion: reduce){
      .bg-live .scanlines,
      .bg-live .particles,
      .dot{
        animation: none !important;
      }
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="bg-live" aria-hidden="true">
    <div class="particles"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
  </div>

  <div id="app">
    <div class="topbar">
      <div class="titleblock">
        <div class="title">PD NEURAL TERMINAL</div>
        <div class="subtitle">история запросов • сессии • кибер-неон</div>
      </div>

      <div class="topbar-actions">
        <button class="btn btn-ghost" id="btn-new">Новый диалог</button>
        <button class="btn" id="btn-clear">Очистить чат</button>
      </div>
    </div>

    <div class="grid">
      <!-- SIDEBAR -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title"><span class="dot"></span>Диалоги</div>
          <button class="btn btn-ghost" id="btn-rename">Переимен.</button>
        </div>
        <div class="panel-body">
          <div class="session-list" id="session-list"></div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title" style="min-width:0;">
            <span class="dot"></span>
            <span id="chat-title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Диалог</span>
          </div>
          <button class="btn btn-ghost" id="btn-delete">Удалить</button>
        </div>

        <div class="chat-wrap">
          <div class="chat" id="chat"></div>

          <div class="composer">
            <div class="composer-row">
              <textarea id="input" placeholder="Напиши запрос… (Enter — отправить, Shift+Enter — перенос)"></textarea>
              <button class="btn" id="btn-send">Отправить</button>
            </div>
            <div class="composer-actions">
              <div class="hint">
                <span class="kbd">Enter</span> отправить
                <span class="kbd">Shift + Enter</span> перенос
                <span class="kbd">Ctrl + K</span> новый диалог
              </div>
              <div class="hint" id="status" style="justify-content:flex-end;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- RENAME MODAL -->
  <div id="rename-modal" class="modal-backdrop">
    <div class="modal">
      <h3>Переименование диалога</h3>
      <div class="field">
        <label>Новое имя</label>
        <input id="rename-input" placeholder="Например: идеи для PD..." />
      </div>
      <div class="error-text" id="rename-error"></div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="rename-cancel">Отмена</button>
        <button class="btn" id="rename-save">Сохранить</button>
      </div>
    </div>
  </div>

  <script>
    /* =====================================================
       CONFIG: подключение к "нейросети"
       =====================================================

       ВАРИАНТ A (твой бэк уже умеет):
         AI_ENDPOINT = "https://world-script-api.onrender.com/api/ai/chat"
         Ожидаемый ответ: { reply: "..." }

       ВАРИАНТ B (пока нет бэка):
         оставь как есть — будет "демо-ответ" локально.

       Если твой API принимает другой формат — подстрой в callAI().
    */
    const AI_ENDPOINT = ""; // <- поставь сюда URL, если есть
    const AI_TIMEOUT_MS = 35000;

    /* =====================================================
       STORAGE
       ===================================================== */
    const STORE_KEY = "pd_neural_terminal_v1";

    function uid(){
      return (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random().toString(16).slice(2)));
    }

    function nowTs(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{
        return null;
      }
    }

    function saveStore(store){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    function createDefaultStore(){
      const first = {
        id: uid(),
        name: "Новый диалог",
        createdAt: Date.now(),
        updatedAt: Date.now(),
        messages: [
          { role:"ai", text:"Я на связи. Напиши запрос — я отвечу. История сохраняется локально.", ts: nowTs() }
        ]
      };
      return { activeId: first.id, sessions: [first] };
    }

    let STORE = loadStore() || createDefaultStore();
    saveStore(STORE);

    /* =====================================================
       DOM
       ===================================================== */
    const elList = document.getElementById("session-list");
    const elChat = document.getElementById("chat");
    const elTitle = document.getElementById("chat-title");
    const elInput = document.getElementById("input");
    const elStatus = document.getElementById("status");

    const btnNew = document.getElementById("btn-new");
    const btnClear = document.getElementById("btn-clear");
    const btnRename = document.getElementById("btn-rename");
    const btnDelete = document.getElementById("btn-delete");
    const btnSend = document.getElementById("btn-send");

    const renameModal = document.getElementById("rename-modal");
    const renameInput = document.getElementById("rename-input");
    const renameSave = document.getElementById("rename-save");
    const renameCancel = document.getElementById("rename-cancel");
    const renameError = document.getElementById("rename-error");

    /* =====================================================
       HELPERS
       ===================================================== */
    function getActiveSession(){
      return STORE.sessions.find(s => s.id === STORE.activeId) || STORE.sessions[0];
    }

    function setActive(id){
      STORE.activeId = id;
      saveStore(STORE);
      renderAll();
    }

    function formatDateShort(ms){
      const d = new Date(ms);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${dd}.${mm}`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function scrollChatBottom(){
      elChat.scrollTop = elChat.scrollHeight;
    }

    function setStatus(text){
      elStatus.textContent = text || "";
    }

    function setTyping(on){
      if(on){
        elStatus.innerHTML = `<span class="typing">Печатает<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>`;
      }else{
        elStatus.textContent = "";
      }
    }

    /* =====================================================
       RENDER
       ===================================================== */
    function renderSessions(){
      const sessions = [...STORE.sessions].sort((a,b) => b.updatedAt - a.updatedAt);
      elList.innerHTML = "";

      sessions.forEach(s => {
        const div = document.createElement("div");
        div.className = "session" + (s.id === STORE.activeId ? " active" : "");
        div.onclick = () => setActive(s.id);

        const name = document.createElement("div");
        name.className = "session-name";
        name.textContent = s.name || "Диалог";

        const meta = document.createElement("div");
        meta.className = "session-meta";
        const left = document.createElement("span");
        left.textContent = formatDateShort(s.updatedAt);
        const right = document.createElement("span");
        right.textContent = `${s.messages?.length || 0} msg`;
        meta.appendChild(left);
        meta.appendChild(right);

        const tools = document.createElement("div");
        tools.className = "session-tools";

        const chipOpen = document.createElement("div");
        chipOpen.className = "chip";
        chipOpen.textContent = "Открыть";
        chipOpen.onclick = (e) => { e.stopPropagation(); setActive(s.id); };

        const chipDel = document.createElement("div");
        chipDel.className = "chip danger";
        chipDel.textContent = "Удалить";
        chipDel.onclick = (e) => { e.stopPropagation(); deleteSession(s.id); };

        tools.appendChild(chipOpen);
        tools.appendChild(chipDel);

        div.appendChild(name);
        div.appendChild(meta);
        div.appendChild(tools);

        elList.appendChild(div);
      });
    }

    function renderChat(){
      const s = getActiveSession();
      elTitle.textContent = s?.name || "Диалог";

      elChat.innerHTML = "";
      (s.messages || []).forEach(m => {
        const wrap = document.createElement("div");
        wrap.className = "msg " + (m.role === "you" ? "you" : "ai");

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = (m.role === "you" ? "YOU" : "AI");

        const col = document.createElement("div");
        col.style.display = "flex";
        col.style.flexDirection = "column";
        col.style.gap = "4px";
        col.style.minWidth = "0";

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.textContent = (m.role === "you" ? "запрос" : "ответ") + " • " + (m.ts || "");

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        // простой рендер: если много переносов — как pre
        const isPre = (m.text || "").includes("\n");
        if(isPre){
          bubble.innerHTML = `<pre>${escapeHtml(m.text || "")}</pre>`;
        }else{
          bubble.textContent = m.text || "";
        }

        col.appendChild(meta);
        col.appendChild(bubble);

        wrap.appendChild(avatar);
        wrap.appendChild(col);

        elChat.appendChild(wrap);
      });

      requestAnimationFrame(scrollChatBottom);
    }

    function renderAll(){
      renderSessions();
      renderChat();
    }

    /* =====================================================
       SESSIONS ACTIONS
       ===================================================== */
    function newSession(){
      const s = {
        id: uid(),
        name: "Новый диалог",
        createdAt: Date.now(),
        updatedAt: Date.now(),
        messages: [
          { role:"ai", text:"Новый диалог создан. Напиши запрос.", ts: nowTs() }
        ]
      };
      STORE.sessions.unshift(s);
      STORE.activeId = s.id;
      saveStore(STORE);
      renderAll();
      elInput.focus();
    }

    function clearChat(){
      const s = getActiveSession();
      s.messages = [
        { role:"ai", text:"Чат очищен. Пиши новый запрос.", ts: nowTs() }
      ];
      s.updatedAt = Date.now();
      saveStore(STORE);
      renderAll();
    }

    function deleteSession(id){
      if(STORE.sessions.length <= 1){
        // нельзя удалить последний
        const s = getActiveSession();
        s.messages.push({ role:"ai", text:"Нельзя удалить последний диалог. Создай новый и удаляй старый.", ts: nowTs() });
        s.updatedAt = Date.now();
        saveStore(STORE);
        renderAll();
        return;
      }

      STORE.sessions = STORE.sessions.filter(x => x.id !== id);
      if(STORE.activeId === id){
        STORE.activeId = STORE.sessions[0].id;
      }
      saveStore(STORE);
      renderAll();
    }

    function openRenameModal(){
      const s = getActiveSession();
      renameInput.value = s.name || "";
      renameError.style.display = "none";
      renameError.textContent = "";
      renameModal.classList.add("active");
      setTimeout(() => renameInput.focus(), 0);
    }

    function closeRenameModal(){
      renameModal.classList.remove("active");
    }

    function saveRename(){
      const v = (renameInput.value || "").trim();
      if(!v){
        renameError.style.display = "block";
        renameError.textContent = "Имя не может быть пустым.";
        return;
      }
      const s = getActiveSession();
      s.name = v.slice(0, 64);
      s.updatedAt = Date.now();
      saveStore(STORE);
      closeRenameModal();
      renderAll();
    }

    /* =====================================================
       AI CALL
       ===================================================== */
    async function callAI(userText, history){
      // history: массив сообщений активного диалога
      // Подстрой под свой API:
      // { message: userText, history: [{role,text}, ...] } -> { reply: "..." }

      // DEMO MODE
      if(!AI_ENDPOINT){
        await new Promise(r => setTimeout(r, 600));
        const demo = [
          "Принял. Сформулирую коротко: " + userText,
          "Если хочешь — могу оформить это в виде плана или чек-листа.",
          "Вариант решения: 1) ... 2) ... 3) ... (это демо-ответ, подключи AI_ENDPOINT)."
        ];
        return demo.join("\n");
      }

      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), AI_TIMEOUT_MS);

      try{
        const res = await fetch(AI_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          signal: ctrl.signal,
          body: JSON.stringify({
            message: userText,
            history: (history || []).slice(-20).map(m => ({ role: m.role, text: m.text }))
          })
        });
        if(!res.ok){
          const txt = await res.text().catch(() => "");
          throw new Error(txt || ("HTTP " + res.status));
        }
        const data = await res.json();
        return (data?.reply ?? data?.text ?? data?.answer ?? "").toString() || "Пустой ответ.";
      } finally {
        clearTimeout(t);
      }
    }

    /* =====================================================
       SEND FLOW
       ===================================================== */
    let sending = false;

    async function send(){
      if(sending) return;
      const text = (elInput.value || "").trim();
      if(!text) return;

      const s = getActiveSession();
      s.messages.push({ role:"you", text, ts: nowTs() });
      s.updatedAt = Date.now();
      saveStore(STORE);

      elInput.value = "";
      renderAll();

      sending = true;
      setTyping(true);
      btnSend.disabled = true;

      try{
        const reply = await callAI(text, s.messages);

        const s2 = getActiveSession(); // на случай переключения диалога
        s2.messages.push({ role:"ai", text: reply, ts: nowTs() });
        s2.updatedAt = Date.now();
        saveStore(STORE);
        renderAll();
      } catch(e){
        const s2 = getActiveSession();
        s2.messages.push({ role:"ai", text: "Ошибка получения ответа: " + (e?.message || e), ts: nowTs() });
        s2.updatedAt = Date.now();
        saveStore(STORE);
        renderAll();
      } finally {
        sending = false;
        setTyping(false);
        btnSend.disabled = false;
        elInput.focus();
      }
    }

    /* =====================================================
       EVENTS
       ===================================================== */
    btnNew.onclick = newSession;
    btnClear.onclick = clearChat;
    btnRename.onclick = openRenameModal;
    btnDelete.onclick = () => deleteSession(STORE.activeId);
    btnSend.onclick = send;

    renameCancel.onclick = closeRenameModal;
    renameSave.onclick = saveRename;
    renameModal.addEventListener("click", (e) => {
      if(e.target === renameModal) closeRenameModal();
    });

    elInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault();
        newSession();
      }
    });

    window.addEventListener("load", () => {
      renderAll();
      elInput.focus();
    });
  </script>
</body>
</html>
